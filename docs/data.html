<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Data | Prediction of Delisting using a Machine Learning Ensemble</title>
  <meta name="description" content="<p>R markdown file for the project “Prediction of Delisting using a Machine
Learning Ensemble”</p>" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Data | Prediction of Delisting using a Machine Learning Ensemble" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>R markdown file for the project “Prediction of Delisting using a Machine
Learning Ensemble”</p>" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Data | Prediction of Delisting using a Machine Learning Ensemble" />
  
  <meta name="twitter:description" content="<p>R markdown file for the project “Prediction of Delisting using a Machine
Learning Ensemble”</p>" />
  

<meta name="author" content="David Neuhäusler, Jungyeon Yoon, Richard A. Levine, Juanjuan Fan" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="empirical-results.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/testrmd-0.0.1.9000/testrmd.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Predicition of Delisting</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>2</b> Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data.html"><a href="data.html#delisting-financial-and-macroeconomic-data"><i class="fa fa-check"></i><b>2.1</b> Delisting, financial and macroeconomic data</a></li>
<li class="chapter" data-level="2.2" data-path="data.html"><a href="data.html#exploratory-data-analysis"><i class="fa fa-check"></i><b>2.2</b> Exploratory Data Analysis</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data.html"><a href="data.html#overview-over-deslisting-dates"><i class="fa fa-check"></i><b>2.2.1</b> Overview over deslisting dates</a></li>
<li class="chapter" data-level="2.2.2" data-path="data.html"><a href="data.html#correlation-analysis"><i class="fa fa-check"></i><b>2.2.2</b> Correlation analysis</a></li>
<li class="chapter" data-level="2.2.3" data-path="data.html"><a href="data.html#summary-statistics-for-features"><i class="fa fa-check"></i><b>2.2.3</b> Summary statistics for features</a></li>
<li class="chapter" data-level="2.2.4" data-path="data.html"><a href="data.html#features-and-delisting-frequency"><i class="fa fa-check"></i><b>2.2.4</b> Features and delisting frequency</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data.html"><a href="data.html#predictor-data-set"><i class="fa fa-check"></i><b>2.3</b> Predictor data set</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="data.html"><a href="data.html#identifiy-duplicates"><i class="fa fa-check"></i><b>2.3.1</b> Identifiy duplicates</a></li>
<li class="chapter" data-level="2.3.2" data-path="data.html"><a href="data.html#missing-data"><i class="fa fa-check"></i><b>2.3.2</b> Missing data</a></li>
<li class="chapter" data-level="2.3.3" data-path="data.html"><a href="data.html#predictior-data-set"><i class="fa fa-check"></i><b>2.3.3</b> Predictior data set</a></li>
<li class="chapter" data-level="2.3.4" data-path="data.html"><a href="data.html#prepare-predictor-data-set"><i class="fa fa-check"></i><b>2.3.4</b> Prepare predictor data set</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="empirical-results.html"><a href="empirical-results.html"><i class="fa fa-check"></i><b>3</b> Empirical Results</a>
<ul>
<li class="chapter" data-level="3.1" data-path="empirical-results.html"><a href="empirical-results.html#random-forest"><i class="fa fa-check"></i><b>3.1</b> Random forest</a></li>
<li class="chapter" data-level="3.2" data-path="empirical-results.html"><a href="empirical-results.html#logistic-regression"><i class="fa fa-check"></i><b>3.2</b> Logistic Regression</a></li>
<li class="chapter" data-level="3.3" data-path="empirical-results.html"><a href="empirical-results.html#support-vector-machine"><i class="fa fa-check"></i><b>3.3</b> Support Vector Machine</a></li>
<li class="chapter" data-level="3.4" data-path="empirical-results.html"><a href="empirical-results.html#neural-net"><i class="fa fa-check"></i><b>3.4</b> Neural net</a></li>
<li class="chapter" data-level="3.5" data-path="empirical-results.html"><a href="empirical-results.html#boosting"><i class="fa fa-check"></i><b>3.5</b> Boosting</a></li>
<li class="chapter" data-level="3.6" data-path="empirical-results.html"><a href="empirical-results.html#ensemble"><i class="fa fa-check"></i><b>3.6</b> Ensemble</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Prediction of Delisting using a Machine Learning Ensemble</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">2</span> Data<a href="data.html#data" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="delisting-financial-and-macroeconomic-data" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Delisting, financial and macroeconomic data<a href="data.html#delisting-financial-and-macroeconomic-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The data sources for this code chunk are the two databases of the Center for
Research in Security Prices (CRSP) and Wharton Research Data Services (WRDS).
The code snippet creates a data frame containing delisting and quarterly
financial information for securities. <code>com_ratio</code> is the name of the resulting
data frame.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="data.html#cb4-1" tabindex="-1"></a><span class="cf">if</span> (REBUILD_INITIAL_DATA_SET) {</span>
<span id="cb4-2"><a href="data.html#cb4-2" tabindex="-1"></a>  <span class="co"># Author: Jungyeon Yoon</span></span>
<span id="cb4-3"><a href="data.html#cb4-3" tabindex="-1"></a>  <span class="co">#-----------------------------------------------</span></span>
<span id="cb4-4"><a href="data.html#cb4-4" tabindex="-1"></a>  <span class="co"># [delist file] : CRSP - Annual Update - Stock / Events - Delist</span></span>
<span id="cb4-5"><a href="data.html#cb4-5" tabindex="-1"></a>  <span class="co"># variables : permno, dlstdt, dlstcd, nwperm, nwcomp, cusip</span></span>
<span id="cb4-6"><a href="data.html#cb4-6" tabindex="-1"></a>  <span class="co"># - permno  double    CRSP Permanent Issue Number (permno)</span></span>
<span id="cb4-7"><a href="data.html#cb4-7" tabindex="-1"></a>  <span class="co"># - dlstdt    date    Delisting Date (dlstdt)</span></span>
<span id="cb4-8"><a href="data.html#cb4-8" tabindex="-1"></a>  <span class="co"># - dlstcd    double  Delisting Code (dlstcd)</span></span>
<span id="cb4-9"><a href="data.html#cb4-9" tabindex="-1"></a>  <span class="co"># - nwperm    double  New CRSP Permno (nwperm)</span></span>
<span id="cb4-10"><a href="data.html#cb4-10" tabindex="-1"></a>  <span class="co"># - nwcomp    double  New CRSP Permco (nwcomp)</span></span>
<span id="cb4-11"><a href="data.html#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="data.html#cb4-12" tabindex="-1"></a>  <span class="co"># [com_info file] : CRSP - Annual Update - Stock / Security Files - Stock Header Info</span></span>
<span id="cb4-13"><a href="data.html#cb4-13" tabindex="-1"></a>  <span class="co"># variables : permno, permco, hsiccd, hshrcd, hcomnam, begdat, enddat</span></span>
<span id="cb4-14"><a href="data.html#cb4-14" tabindex="-1"></a>  <span class="co"># - permno  double    CRSP Permanent Issue Number (permno)</span></span>
<span id="cb4-15"><a href="data.html#cb4-15" tabindex="-1"></a>  <span class="co"># - permco    double  CRSP Permanent Company Number (permco)</span></span>
<span id="cb4-16"><a href="data.html#cb4-16" tabindex="-1"></a>  <span class="co"># - hsiccd    double  Header SIC Code (hsiccd)</span></span>
<span id="cb4-17"><a href="data.html#cb4-17" tabindex="-1"></a>  <span class="co"># - HSHRCD    double  Share Code Header (HSHRCD)</span></span>
<span id="cb4-18"><a href="data.html#cb4-18" tabindex="-1"></a>  <span class="co"># - HCOMNAM   string  Company Name Header (HCOMNAM)</span></span>
<span id="cb4-19"><a href="data.html#cb4-19" tabindex="-1"></a>  <span class="co"># - BEGDAT    date    Begin of Stock Data (BEGDAT)</span></span>
<span id="cb4-20"><a href="data.html#cb4-20" tabindex="-1"></a>  <span class="co"># - ENDDAT    date    End of Stock Data (ENDDAT)</span></span>
<span id="cb4-21"><a href="data.html#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a href="data.html#cb4-22" tabindex="-1"></a>  <span class="co">#------------------------------------------------</span></span>
<span id="cb4-23"><a href="data.html#cb4-23" tabindex="-1"></a>  <span class="co"># loading saved delist and com_info datasets</span></span>
<span id="cb4-24"><a href="data.html#cb4-24" tabindex="-1"></a></span>
<span id="cb4-25"><a href="data.html#cb4-25" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/delist.RData&quot;</span>) <span class="co"># delist : permno</span></span>
<span id="cb4-26"><a href="data.html#cb4-26" tabindex="-1"></a>  <span class="co"># dim(delist) # 36945     6</span></span>
<span id="cb4-27"><a href="data.html#cb4-27" tabindex="-1"></a></span>
<span id="cb4-28"><a href="data.html#cb4-28" tabindex="-1"></a>  <span class="fu">load</span>(<span class="at">file =</span> <span class="st">&quot;../data/com_info.RData&quot;</span>) <span class="co"># com_info : permno permco</span></span>
<span id="cb4-29"><a href="data.html#cb4-29" tabindex="-1"></a>  <span class="co"># dim(com_info) # 36974     7</span></span>
<span id="cb4-30"><a href="data.html#cb4-30" tabindex="-1"></a></span>
<span id="cb4-31"><a href="data.html#cb4-31" tabindex="-1"></a>  <span class="co">#----------------------------</span></span>
<span id="cb4-32"><a href="data.html#cb4-32" tabindex="-1"></a>  <span class="co"># combine delist and com_info and make one combined dataset(comp)</span></span>
<span id="cb4-33"><a href="data.html#cb4-33" tabindex="-1"></a>  comp0 <span class="ot">&lt;-</span> com_info <span class="sc">%&gt;%</span></span>
<span id="cb4-34"><a href="data.html#cb4-34" tabindex="-1"></a>    <span class="fu">left_join</span>(delist, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;permno&quot;</span> <span class="ot">=</span> <span class="st">&quot;permno&quot;</span>))</span>
<span id="cb4-35"><a href="data.html#cb4-35" tabindex="-1"></a></span>
<span id="cb4-36"><a href="data.html#cb4-36" tabindex="-1"></a>  <span class="co"># data ranges</span></span>
<span id="cb4-37"><a href="data.html#cb4-37" tabindex="-1"></a>  <span class="fu">range</span>(comp0<span class="sc">$</span>begdat) <span class="co"># &quot;1925-12-31&quot; &quot;2022-12-30&quot;</span></span>
<span id="cb4-38"><a href="data.html#cb4-38" tabindex="-1"></a>  <span class="fu">range</span>(comp0<span class="sc">$</span>enddat) <span class="co"># &quot;1926-02-24&quot; &quot;2022-12-30&quot;</span></span>
<span id="cb4-39"><a href="data.html#cb4-39" tabindex="-1"></a></span>
<span id="cb4-40"><a href="data.html#cb4-40" tabindex="-1"></a>  <span class="co"># remove obs with Delisting Date (dlstdt) is missing</span></span>
<span id="cb4-41"><a href="data.html#cb4-41" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> comp0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dlstdt))</span>
<span id="cb4-42"><a href="data.html#cb4-42" tabindex="-1"></a></span>
<span id="cb4-43"><a href="data.html#cb4-43" tabindex="-1"></a>  <span class="co"># nrow(comp) # 29 observations removed</span></span>
<span id="cb4-44"><a href="data.html#cb4-44" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> comp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">days =</span> enddat <span class="sc">-</span> begdat)</span>
<span id="cb4-45"><a href="data.html#cb4-45" tabindex="-1"></a></span>
<span id="cb4-46"><a href="data.html#cb4-46" tabindex="-1"></a>  <span class="co"># subset companies that listed from 1970</span></span>
<span id="cb4-47"><a href="data.html#cb4-47" tabindex="-1"></a>  start_d <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;1970-01-01&quot;</span>)</span>
<span id="cb4-48"><a href="data.html#cb4-48" tabindex="-1"></a>  end_d <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;2022-12-30&quot;</span>)</span>
<span id="cb4-49"><a href="data.html#cb4-49" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> comp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(days <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> begdat <span class="sc">&gt;=</span> start_d)</span>
<span id="cb4-50"><a href="data.html#cb4-50" tabindex="-1"></a></span>
<span id="cb4-51"><a href="data.html#cb4-51" tabindex="-1"></a>  <span class="fu">nrow</span>(comp) <span class="co"># 33336</span></span>
<span id="cb4-52"><a href="data.html#cb4-52" tabindex="-1"></a></span>
<span id="cb4-53"><a href="data.html#cb4-53" tabindex="-1"></a>  <span class="fu">range</span>(comp<span class="sc">$</span>begdat) <span class="co"># &quot;1970-01-06&quot; &quot;2022-12-29&quot;</span></span>
<span id="cb4-54"><a href="data.html#cb4-54" tabindex="-1"></a>  <span class="fu">range</span>(comp<span class="sc">$</span>enddat) <span class="co"># &quot;1970-12-29&quot; &quot;2022-12-30&quot;</span></span>
<span id="cb4-55"><a href="data.html#cb4-55" tabindex="-1"></a></span>
<span id="cb4-56"><a href="data.html#cb4-56" tabindex="-1"></a>  <span class="co"># delisting code as group</span></span>
<span id="cb4-57"><a href="data.html#cb4-57" tabindex="-1"></a>  <span class="fu">range</span>(comp<span class="sc">$</span>dlstcd) <span class="co"># 100-591</span></span>
<span id="cb4-58"><a href="data.html#cb4-58" tabindex="-1"></a></span>
<span id="cb4-59"><a href="data.html#cb4-59" tabindex="-1"></a>  <span class="co"># categorize delisting group (Active, Mergers, Exchanges, Liquidation, Dropped)</span></span>
<span id="cb4-60"><a href="data.html#cb4-60" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> comp <span class="sc">%&gt;%</span></span>
<span id="cb4-61"><a href="data.html#cb4-61" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">substr</span>(dlstcd, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-62"><a href="data.html#cb4-62" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">event_group =</span> <span class="fu">factor</span>(event,</span>
<span id="cb4-63"><a href="data.html#cb4-63" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">c</span>(<span class="st">&quot;active&quot;</span>, <span class="st">&quot;mergers&quot;</span>, <span class="st">&quot;exchanges&quot;</span>, <span class="st">&quot;liquidation&quot;</span>, <span class="st">&quot;dropped&quot;</span>)</span>
<span id="cb4-64"><a href="data.html#cb4-64" tabindex="-1"></a>    ))</span>
<span id="cb4-65"><a href="data.html#cb4-65" tabindex="-1"></a></span>
<span id="cb4-66"><a href="data.html#cb4-66" tabindex="-1"></a>  <span class="fu">table</span>(comp<span class="sc">$</span>event_group)</span>
<span id="cb4-67"><a href="data.html#cb4-67" tabindex="-1"></a>  <span class="co">#   Active     Mergers   Exchanges Liquidation     Dropped</span></span>
<span id="cb4-68"><a href="data.html#cb4-68" tabindex="-1"></a>  <span class="co">#     9259       11868         857        1916        9436</span></span>
<span id="cb4-69"><a href="data.html#cb4-69" tabindex="-1"></a></span>
<span id="cb4-70"><a href="data.html#cb4-70" tabindex="-1"></a>  <span class="co"># [US listing gap] To obtain annual counts of the number of U.S. listed domestic firms, we use the Center for Research in Security Prices (CRSP) and Compustat databases because information on firm characteristics such as size and industry is not available from the WDI/WFE data set. We use CRSP to identify firms listed on Amex, Nasdaq, or NYSE. We include U.S. common stocks (share codes 10 and 11) and exclude investment funds and trusts (Standard Industrial Classification (SIC) codes 6722, 6726, 6798, and 6799).</span></span>
<span id="cb4-71"><a href="data.html#cb4-71" tabindex="-1"></a></span>
<span id="cb4-72"><a href="data.html#cb4-72" tabindex="-1"></a>  <span class="fu">range</span>(comp<span class="sc">$</span>hsiccd) <span class="co"># SIC code :  0-9999</span></span>
<span id="cb4-73"><a href="data.html#cb4-73" tabindex="-1"></a>  <span class="fu">table</span>(comp<span class="sc">$</span>hshrcd) <span class="co"># Share Code Header</span></span>
<span id="cb4-74"><a href="data.html#cb4-74" tabindex="-1"></a></span>
<span id="cb4-75"><a href="data.html#cb4-75" tabindex="-1"></a>  <span class="co"># filtering data : exclude SIC code(hsiccd) = 6722, 6726, 6798, and 6799 and include Share Code(hshrcd) = 10, 11</span></span>
<span id="cb4-76"><a href="data.html#cb4-76" tabindex="-1"></a></span>
<span id="cb4-77"><a href="data.html#cb4-77" tabindex="-1"></a>  <span class="co"># [re-categorize delisting, US listing gap] We follow Fama and French (2004) in categorizing CRSP delist codes 200&lt;U+2013&gt;399 as mergers and codes 400 and above as delists for cause, except for codes 570 and 573 (voluntary delists), we include them as well</span></span>
<span id="cb4-78"><a href="data.html#cb4-78" tabindex="-1"></a>  <span class="co"># For now, I include Active, Liquidation, Dropped</span></span>
<span id="cb4-79"><a href="data.html#cb4-79" tabindex="-1"></a></span>
<span id="cb4-80"><a href="data.html#cb4-80" tabindex="-1"></a>  com_sub <span class="ot">&lt;-</span> comp <span class="sc">%&gt;%</span></span>
<span id="cb4-81"><a href="data.html#cb4-81" tabindex="-1"></a>    <span class="fu">filter</span>(hshrcd <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">11</span>) <span class="sc">&amp;</span></span>
<span id="cb4-82"><a href="data.html#cb4-82" tabindex="-1"></a>      <span class="sc">!</span>hsiccd <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6722</span>, <span class="dv">6726</span>, <span class="dv">6798</span>, <span class="dv">6799</span>) <span class="sc">&amp;</span></span>
<span id="cb4-83"><a href="data.html#cb4-83" tabindex="-1"></a>      event_group <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;active&quot;</span>, <span class="st">&quot;liquidation&quot;</span>, <span class="st">&quot;dropped&quot;</span>))</span>
<span id="cb4-84"><a href="data.html#cb4-84" tabindex="-1"></a>  <span class="co"># mutate(event_group_new = ifelse(event_group == &#39;Active&#39;, &#39;NotActive&#39;, &#39;NotActive&#39;))</span></span>
<span id="cb4-85"><a href="data.html#cb4-85" tabindex="-1"></a></span>
<span id="cb4-86"><a href="data.html#cb4-86" tabindex="-1"></a>  <span class="fu">save</span>(com_sub, <span class="at">file =</span> <span class="st">&quot;../data/com_sub.RData&quot;</span>)</span>
<span id="cb4-87"><a href="data.html#cb4-87" tabindex="-1"></a></span>
<span id="cb4-88"><a href="data.html#cb4-88" tabindex="-1"></a>  <span class="co">#-----------------------------------------------</span></span>
<span id="cb4-89"><a href="data.html#cb4-89" tabindex="-1"></a>  <span class="co"># wrds ratios</span></span>
<span id="cb4-90"><a href="data.html#cb4-90" tabindex="-1"></a>  <span class="co"># company identifiers :</span></span>
<span id="cb4-91"><a href="data.html#cb4-91" tabindex="-1"></a>  <span class="co"># PERMNO :    PERMNO</span></span>
<span id="cb4-92"><a href="data.html#cb4-92" tabindex="-1"></a>  <span class="co"># GVKEY   :   Global Company Key</span></span>
<span id="cb4-93"><a href="data.html#cb4-93" tabindex="-1"></a>  <span class="co"># CUSIP   :   CUSIP IDENTIFIER - HISTORICAL</span></span>
<span id="cb4-94"><a href="data.html#cb4-94" tabindex="-1"></a>  <span class="co"># TICKER : EXCHANGE TICKER SYMBOL - HISTORICAL</span></span>
<span id="cb4-95"><a href="data.html#cb4-95" tabindex="-1"></a>  <span class="co"># Dates :</span></span>
<span id="cb4-96"><a href="data.html#cb4-96" tabindex="-1"></a>  <span class="co"># adate : fiscal year end</span></span>
<span id="cb4-97"><a href="data.html#cb4-97" tabindex="-1"></a>  <span class="co"># qdate : fiscal quarter end</span></span>
<span id="cb4-98"><a href="data.html#cb4-98" tabindex="-1"></a>  <span class="co"># public_date : public date (date when the information becomes public)</span></span>
<span id="cb4-99"><a href="data.html#cb4-99" tabindex="-1"></a>  <span class="co">#----------------------------------------------</span></span>
<span id="cb4-100"><a href="data.html#cb4-100" tabindex="-1"></a></span>
<span id="cb4-101"><a href="data.html#cb4-101" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/comp_ratio.RData&quot;</span>) <span class="co"># comp_ratio : permno / monthly time series</span></span>
<span id="cb4-102"><a href="data.html#cb4-102" tabindex="-1"></a>  <span class="fu">dim</span>(comp_ratio) <span class="co"># 2752175      98</span></span>
<span id="cb4-103"><a href="data.html#cb4-103" tabindex="-1"></a>  <span class="co"># head(comp_ratio)</span></span>
<span id="cb4-104"><a href="data.html#cb4-104" tabindex="-1"></a>  <span class="fu">range</span>(comp_ratio<span class="sc">$</span>public_date) <span class="co"># &quot;1970-01-31&quot; &quot;2022-12-31&quot;</span></span>
<span id="cb4-105"><a href="data.html#cb4-105" tabindex="-1"></a></span>
<span id="cb4-106"><a href="data.html#cb4-106" tabindex="-1"></a>  <span class="co"># gvkey and permno can be different. PERMNO is a unique stock (share class) level identifier assigned by CRSP to all companies listed in CRSP dataset. GVKEY (Global Company Key) is a unique number assigned to each company in the Compustat-Capital IQ database. =&gt; I will use permno. so keep one gvkey if one permno has two gvkey (e.g. permno == 10258 / gvkey = 012381, 179598)</span></span>
<span id="cb4-107"><a href="data.html#cb4-107" tabindex="-1"></a></span>
<span id="cb4-108"><a href="data.html#cb4-108" tabindex="-1"></a>  com_ratio <span class="ot">&lt;-</span> comp_ratio <span class="sc">%&gt;%</span></span>
<span id="cb4-109"><a href="data.html#cb4-109" tabindex="-1"></a>    <span class="fu">arrange</span>(permno, public_date) <span class="sc">%&gt;%</span></span>
<span id="cb4-110"><a href="data.html#cb4-110" tabindex="-1"></a>    <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb4-111"><a href="data.html#cb4-111" tabindex="-1"></a>    <span class="fu">distinct</span>(public_date, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-112"><a href="data.html#cb4-112" tabindex="-1"></a></span>
<span id="cb4-113"><a href="data.html#cb4-113" tabindex="-1"></a>  <span class="fu">load</span>(<span class="at">file =</span> <span class="st">&quot;../data/com_sub.RData&quot;</span>) <span class="co"># com_sub</span></span>
<span id="cb4-114"><a href="data.html#cb4-114" tabindex="-1"></a>  no1 <span class="ot">&lt;-</span> <span class="fu">unique</span>(com_sub<span class="sc">$</span>permno)</span>
<span id="cb4-115"><a href="data.html#cb4-115" tabindex="-1"></a>  no2 <span class="ot">&lt;-</span> <span class="fu">unique</span>(com_ratio<span class="sc">$</span>permno)</span>
<span id="cb4-116"><a href="data.html#cb4-116" tabindex="-1"></a></span>
<span id="cb4-117"><a href="data.html#cb4-117" tabindex="-1"></a>  <span class="fu">length</span>(no1) <span class="co"># 12186</span></span>
<span id="cb4-118"><a href="data.html#cb4-118" tabindex="-1"></a>  <span class="fu">length</span>(no2) <span class="co"># 20691</span></span>
<span id="cb4-119"><a href="data.html#cb4-119" tabindex="-1"></a>  overlap_no <span class="ot">&lt;-</span> <span class="fu">intersect</span>(no1, no2)</span>
<span id="cb4-120"><a href="data.html#cb4-120" tabindex="-1"></a>  <span class="fu">length</span>(overlap_no) <span class="co"># 9474</span></span>
<span id="cb4-121"><a href="data.html#cb4-121" tabindex="-1"></a></span>
<span id="cb4-122"><a href="data.html#cb4-122" tabindex="-1"></a>  com_ratio <span class="ot">&lt;-</span> com_ratio <span class="sc">%&gt;%</span> <span class="fu">select</span>(</span>
<span id="cb4-123"><a href="data.html#cb4-123" tabindex="-1"></a>    <span class="sc">-</span>ffi10, <span class="sc">-</span>ffi10_desc, <span class="sc">-</span>ffi12, <span class="sc">-</span>ffi12_desc, <span class="sc">-</span>ffi17, <span class="sc">-</span>ffi17_desc, <span class="sc">-</span>ffi30, <span class="sc">-</span>ffi30_desc, <span class="sc">-</span>ffi38, <span class="sc">-</span>ffi38_desc, <span class="sc">-</span>ffi48, <span class="sc">-</span>ffi48_desc, <span class="sc">-</span>ffi49, <span class="sc">-</span>ffi49_desc, <span class="sc">-</span>ffi5, <span class="sc">-</span>ffi5_desc, <span class="sc">-</span>gicdesc,</span>
<span id="cb4-124"><a href="data.html#cb4-124" tabindex="-1"></a>    <span class="sc">-</span>gsector, <span class="sc">-</span>gvkey, <span class="sc">-</span>price, <span class="sc">-</span>ticker, <span class="sc">-</span>adate, <span class="sc">-</span>qdate</span>
<span id="cb4-125"><a href="data.html#cb4-125" tabindex="-1"></a>  )</span>
<span id="cb4-126"><a href="data.html#cb4-126" tabindex="-1"></a></span>
<span id="cb4-127"><a href="data.html#cb4-127" tabindex="-1"></a>  <span class="co"># combining financial ratios with company listing information</span></span>
<span id="cb4-128"><a href="data.html#cb4-128" tabindex="-1"></a>  <span class="co"># filtering financial ratios whose dates are later than end date (use only the info available up to delisting)</span></span>
<span id="cb4-129"><a href="data.html#cb4-129" tabindex="-1"></a></span>
<span id="cb4-130"><a href="data.html#cb4-130" tabindex="-1"></a>  com_ratio_monthly <span class="ot">&lt;-</span> com_ratio <span class="sc">%&gt;%</span></span>
<span id="cb4-131"><a href="data.html#cb4-131" tabindex="-1"></a>    <span class="fu">inner_join</span>(com_sub, <span class="at">by =</span> <span class="st">&quot;permno&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-132"><a href="data.html#cb4-132" tabindex="-1"></a>    <span class="fu">arrange</span>(permno, public_date) <span class="sc">%&gt;%</span></span>
<span id="cb4-133"><a href="data.html#cb4-133" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb4-134"><a href="data.html#cb4-134" tabindex="-1"></a>      <span class="sc">-</span>dlstcd, <span class="sc">-</span>nwperm, <span class="sc">-</span>nwcomp, <span class="sc">-</span>cusip.y, <span class="sc">-</span>days, <span class="sc">-</span>event, <span class="co">#-event_group,</span></span>
<span id="cb4-135"><a href="data.html#cb4-135" tabindex="-1"></a>      <span class="sc">-</span>dlstdt, <span class="sc">-</span>cusip.x</span>
<span id="cb4-136"><a href="data.html#cb4-136" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb4-137"><a href="data.html#cb4-137" tabindex="-1"></a>    <span class="fu">filter</span>(enddat <span class="sc">&gt;</span> public_date)</span>
<span id="cb4-138"><a href="data.html#cb4-138" tabindex="-1"></a></span>
<span id="cb4-139"><a href="data.html#cb4-139" tabindex="-1"></a>  <span class="fu">save</span>(com_ratio_monthly, <span class="at">file =</span> <span class="st">&quot;../data/monthly.RData&quot;</span>)</span>
<span id="cb4-140"><a href="data.html#cb4-140" tabindex="-1"></a></span>
<span id="cb4-141"><a href="data.html#cb4-141" tabindex="-1"></a>  <span class="co">#----------------------</span></span>
<span id="cb4-142"><a href="data.html#cb4-142" tabindex="-1"></a>  <span class="co"># load(&#39;Data/monthly.RData&#39;) # com_ratio_monthly</span></span>
<span id="cb4-143"><a href="data.html#cb4-143" tabindex="-1"></a>  <span class="co">#----------------------</span></span>
<span id="cb4-144"><a href="data.html#cb4-144" tabindex="-1"></a>  <span class="cf">if</span> (IS_QUARTERLY_DATA) {</span>
<span id="cb4-145"><a href="data.html#cb4-145" tabindex="-1"></a>    <span class="co"># quarterly data (checked quarterly data has month = 3, 6, 9 , 12)</span></span>
<span id="cb4-146"><a href="data.html#cb4-146" tabindex="-1"></a>    com_ratio_q <span class="ot">&lt;-</span> com_ratio_monthly <span class="sc">%&gt;%</span></span>
<span id="cb4-147"><a href="data.html#cb4-147" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(public_date, <span class="at">format =</span> <span class="st">&quot;%Y-%m-%d&quot;</span>), <span class="st">&quot;%m&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-148"><a href="data.html#cb4-148" tabindex="-1"></a>      <span class="fu">filter</span>(month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;03&quot;</span>, <span class="st">&quot;06&quot;</span>, <span class="st">&quot;09&quot;</span>, <span class="st">&quot;12&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-149"><a href="data.html#cb4-149" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>month)</span>
<span id="cb4-150"><a href="data.html#cb4-150" tabindex="-1"></a></span>
<span id="cb4-151"><a href="data.html#cb4-151" tabindex="-1"></a>    <span class="fu">save</span>(com_ratio_q, <span class="at">file =</span> <span class="st">&quot;../data/quarterly.RData&quot;</span>)</span>
<span id="cb4-152"><a href="data.html#cb4-152" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-153"><a href="data.html#cb4-153" tabindex="-1"></a>    <span class="co"># annual data (checked annual data has dates = year-12-31)</span></span>
<span id="cb4-154"><a href="data.html#cb4-154" tabindex="-1"></a>    com_ratio_a <span class="ot">&lt;-</span> com_ratio_monthly <span class="sc">%&gt;%</span></span>
<span id="cb4-155"><a href="data.html#cb4-155" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(public_date, <span class="at">format =</span> <span class="st">&quot;%Y-%m-%d&quot;</span>), <span class="st">&quot;%m&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-156"><a href="data.html#cb4-156" tabindex="-1"></a>      <span class="fu">filter</span>(month <span class="sc">==</span> <span class="st">&quot;12&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-157"><a href="data.html#cb4-157" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>month)</span>
<span id="cb4-158"><a href="data.html#cb4-158" tabindex="-1"></a></span>
<span id="cb4-159"><a href="data.html#cb4-159" tabindex="-1"></a>    <span class="fu">save</span>(com_ratio_a, <span class="at">file =</span> <span class="st">&quot;../data/annually.RData&quot;</span>)</span>
<span id="cb4-160"><a href="data.html#cb4-160" tabindex="-1"></a>  }</span>
<span id="cb4-161"><a href="data.html#cb4-161" tabindex="-1"></a>  <span class="fu">remove</span>(com_info, com_ratio_monthly, com_sub, comp, comp_ratio, comp0, delist)</span>
<span id="cb4-162"><a href="data.html#cb4-162" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-163"><a href="data.html#cb4-163" tabindex="-1"></a>  <span class="cf">if</span> (IS_QUARTERLY_DATA) {</span>
<span id="cb4-164"><a href="data.html#cb4-164" tabindex="-1"></a>    <span class="fu">load</span>(<span class="st">&quot;../data/quarterly.RData&quot;</span>)</span>
<span id="cb4-165"><a href="data.html#cb4-165" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-166"><a href="data.html#cb4-166" tabindex="-1"></a>    <span class="fu">load</span>(<span class="st">&quot;../data/annually.RData&quot;</span>)</span>
<span id="cb4-167"><a href="data.html#cb4-167" tabindex="-1"></a>  }</span>
<span id="cb4-168"><a href="data.html#cb4-168" tabindex="-1"></a>}</span>
<span id="cb4-169"><a href="data.html#cb4-169" tabindex="-1"></a></span>
<span id="cb4-170"><a href="data.html#cb4-170" tabindex="-1"></a><span class="co"># load initial data set</span></span>
<span id="cb4-171"><a href="data.html#cb4-171" tabindex="-1"></a>com_ratio <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-172"><a href="data.html#cb4-172" tabindex="-1"></a><span class="cf">if</span> (IS_QUARTERLY_DATA) {</span>
<span id="cb4-173"><a href="data.html#cb4-173" tabindex="-1"></a>  com_ratio <span class="ot">&lt;-</span> com_ratio_q</span>
<span id="cb4-174"><a href="data.html#cb4-174" tabindex="-1"></a>  <span class="fu">remove</span>(com_ratio_q)</span>
<span id="cb4-175"><a href="data.html#cb4-175" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-176"><a href="data.html#cb4-176" tabindex="-1"></a>  com_ratio <span class="ot">&lt;-</span> com_ratio_a</span>
<span id="cb4-177"><a href="data.html#cb4-177" tabindex="-1"></a>  <span class="fu">remove</span>(com_ratio_a)</span>
<span id="cb4-178"><a href="data.html#cb4-178" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests of completeness and coherence of data frame <code>com_ratio</code>.

<div class="testrmd-badge-container-outer">
  <div class="testrmd-badge-container-inner">
      <span class="testrmd-badge label label-info" data-toggle="collapse" data-target="#testrmd-chunk-0856018" aria-expanded="false" aria-controls="testrmd-chunk-0856018">Tests passed</span>
  </div>
</div>
<div id="testrmd-chunk-0856018" class="testrmd-chunk panel panel-info collapse">
  <div class="panel-heading">
</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="data.html#cb5-1" tabindex="-1"></a>com_ratio <span class="ot">&lt;-</span> com_ratio <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb5-2"><a href="data.html#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="data.html#cb5-3" tabindex="-1"></a><span class="co"># test: public_date &lt;= LAST_TRADING_DATE_AVAILABLE</span></span>
<span id="cb5-4"><a href="data.html#cb5-4" tabindex="-1"></a><span class="fu">expect_true</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">select</span>(public_date) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="data.html#cb5-5" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">max =</span> <span class="fu">max</span>(public_date)) <span class="sc">&lt;=</span> LAST_TRADING_DATE_AVAILABLE)</span>
<span id="cb5-6"><a href="data.html#cb5-6" tabindex="-1"></a><span class="co"># test: public_date &gt;= FIRST_TRADING_DATE_AVAILABLE</span></span>
<span id="cb5-7"><a href="data.html#cb5-7" tabindex="-1"></a><span class="fu">expect_true</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">select</span>(public_date) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="data.html#cb5-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">min =</span> <span class="fu">min</span>(public_date)) <span class="sc">&gt;=</span> FIRST_TRADING_DATE_AVAILABLE)</span>
<span id="cb5-9"><a href="data.html#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="data.html#cb5-10" tabindex="-1"></a><span class="co"># test: enddat &lt;= LAST_TRADING_DATE_AVAILABLE</span></span>
<span id="cb5-11"><a href="data.html#cb5-11" tabindex="-1"></a><span class="fu">expect_true</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">select</span>(enddat) <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href="data.html#cb5-12" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">max =</span> <span class="fu">max</span>(enddat)) <span class="sc">&lt;=</span> LAST_TRADING_DATE_AVAILABLE)</span>
<span id="cb5-13"><a href="data.html#cb5-13" tabindex="-1"></a><span class="co"># test: enddat &gt;= FIRST_TRADING_DATE_AVAILABLE</span></span>
<span id="cb5-14"><a href="data.html#cb5-14" tabindex="-1"></a><span class="fu">expect_true</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">select</span>(enddat) <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href="data.html#cb5-15" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">min =</span> <span class="fu">min</span>(enddat)) <span class="sc">&gt;=</span> FIRST_TRADING_DATE_AVAILABLE)</span>
<span id="cb5-16"><a href="data.html#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="data.html#cb5-17" tabindex="-1"></a><span class="co"># test: every company has exactly one begdat</span></span>
<span id="cb5-18"><a href="data.html#cb5-18" tabindex="-1"></a><span class="fu">expect_true</span>(<span class="fu">all</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="data.html#cb5-19" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">begdat_diff =</span> <span class="fu">as.numeric</span>(<span class="fu">max</span>(begdat) <span class="sc">-</span> <span class="fu">min</span>(begdat))) <span class="sc">%&gt;%</span> <span class="fu">select</span>(begdat_diff) <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb5-20"><a href="data.html#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a href="data.html#cb5-21" tabindex="-1"></a><span class="co"># test: every company has exactly one enddat</span></span>
<span id="cb5-22"><a href="data.html#cb5-22" tabindex="-1"></a><span class="fu">expect_true</span>(<span class="fu">all</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="data.html#cb5-23" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">begdat_diff =</span> <span class="fu">as.numeric</span>(<span class="fu">max</span>(enddat) <span class="sc">-</span> <span class="fu">min</span>(enddat))) <span class="sc">%&gt;%</span> <span class="fu">select</span>(begdat_diff) <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb5-24"><a href="data.html#cb5-24" tabindex="-1"></a></span>
<span id="cb5-25"><a href="data.html#cb5-25" tabindex="-1"></a><span class="co"># test: every company is listed for a positive amount of days</span></span>
<span id="cb5-26"><a href="data.html#cb5-26" tabindex="-1"></a><span class="fu">expect_true</span>(<span class="fu">all</span>(com_ratio <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">days_listed =</span> <span class="fu">as.numeric</span>(enddat <span class="sc">-</span> begdat)) <span class="sc">%&gt;%</span> <span class="fu">select</span>(days_listed) <span class="sc">&gt;</span> <span class="dv">0</span>))</span></code></pre></div>
</div>
</div>
<p>Select columns of interest for further analyses</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="data.html#cb6-1" tabindex="-1"></a><span class="co"># store information about company feature names and their identifiers</span></span>
<span id="cb6-2"><a href="data.html#cb6-2" tabindex="-1"></a>com.features <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-3"><a href="data.html#cb6-3" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(</span>
<span id="cb6-4"><a href="data.html#cb6-4" tabindex="-1"></a>    <span class="st">&quot;Permanent Security Identification Number (unique)&quot;</span>,</span>
<span id="cb6-5"><a href="data.html#cb6-5" tabindex="-1"></a>    <span class="st">&quot;Public Date&quot;</span>,</span>
<span id="cb6-6"><a href="data.html#cb6-6" tabindex="-1"></a>    <span class="st">&quot;Standard Industrial Classification (SIC) Code - Header&quot;</span>,</span>
<span id="cb6-7"><a href="data.html#cb6-7" tabindex="-1"></a>    <span class="st">&quot;Share Code - Header&quot;</span>,</span>
<span id="cb6-8"><a href="data.html#cb6-8" tabindex="-1"></a>    <span class="st">&quot;Company Name - Header&quot;</span>,</span>
<span id="cb6-9"><a href="data.html#cb6-9" tabindex="-1"></a>    <span class="st">&quot;Begin of Stock Data&quot;</span>,</span>
<span id="cb6-10"><a href="data.html#cb6-10" tabindex="-1"></a>    <span class="st">&quot;End of Stock Data&quot;</span>,</span>
<span id="cb6-11"><a href="data.html#cb6-11" tabindex="-1"></a>    <span class="st">&quot;Delisting Indicator&quot;</span></span>
<span id="cb6-12"><a href="data.html#cb6-12" tabindex="-1"></a>  ),</span>
<span id="cb6-13"><a href="data.html#cb6-13" tabindex="-1"></a>  <span class="at">identifier =</span> <span class="fu">c</span>(</span>
<span id="cb6-14"><a href="data.html#cb6-14" tabindex="-1"></a>    <span class="st">&quot;permno&quot;</span>,</span>
<span id="cb6-15"><a href="data.html#cb6-15" tabindex="-1"></a>    <span class="st">&quot;public_date&quot;</span>,</span>
<span id="cb6-16"><a href="data.html#cb6-16" tabindex="-1"></a>    <span class="st">&quot;hsiccd&quot;</span>,</span>
<span id="cb6-17"><a href="data.html#cb6-17" tabindex="-1"></a>    <span class="st">&quot;hshrcd&quot;</span>,</span>
<span id="cb6-18"><a href="data.html#cb6-18" tabindex="-1"></a>    <span class="st">&quot;hcomnam&quot;</span>,</span>
<span id="cb6-19"><a href="data.html#cb6-19" tabindex="-1"></a>    <span class="st">&quot;begdat&quot;</span>,</span>
<span id="cb6-20"><a href="data.html#cb6-20" tabindex="-1"></a>    <span class="st">&quot;enddat&quot;</span>,</span>
<span id="cb6-21"><a href="data.html#cb6-21" tabindex="-1"></a>    <span class="st">&quot;event_group&quot;</span></span>
<span id="cb6-22"><a href="data.html#cb6-22" tabindex="-1"></a>  )</span>
<span id="cb6-23"><a href="data.html#cb6-23" tabindex="-1"></a>)</span>
<span id="cb6-24"><a href="data.html#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="data.html#cb6-25" tabindex="-1"></a><span class="co"># store information about financial ratio feature names and their identifiers</span></span>
<span id="cb6-26"><a href="data.html#cb6-26" tabindex="-1"></a>com.features.fin <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-27"><a href="data.html#cb6-27" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(</span>
<span id="cb6-28"><a href="data.html#cb6-28" tabindex="-1"></a>    <span class="st">&quot;Capitalization Ratio&quot;</span>,</span>
<span id="cb6-29"><a href="data.html#cb6-29" tabindex="-1"></a>    <span class="st">&quot;Asset Turnover&quot;</span>,</span>
<span id="cb6-30"><a href="data.html#cb6-30" tabindex="-1"></a>    <span class="st">&quot;Inventory Turnover&quot;</span>,</span>
<span id="cb6-31"><a href="data.html#cb6-31" tabindex="-1"></a>    <span class="st">&quot;Receivables Turnover&quot;</span>,</span>
<span id="cb6-32"><a href="data.html#cb6-32" tabindex="-1"></a>    <span class="st">&quot;Payables Turnover&quot;</span>,</span>
<span id="cb6-33"><a href="data.html#cb6-33" tabindex="-1"></a>    <span class="st">&quot;Cash Ratio&quot;</span>,</span>
<span id="cb6-34"><a href="data.html#cb6-34" tabindex="-1"></a>    <span class="st">&quot;Current Ratio&quot;</span>,</span>
<span id="cb6-35"><a href="data.html#cb6-35" tabindex="-1"></a>    <span class="st">&quot;Quick Ratio&quot;</span>,</span>
<span id="cb6-36"><a href="data.html#cb6-36" tabindex="-1"></a>    <span class="st">&quot;After-tax Return on Average Common Equity&quot;</span>,</span>
<span id="cb6-37"><a href="data.html#cb6-37" tabindex="-1"></a>    <span class="st">&quot;After-tax Return on Total Stockholders&lt;U+2019&gt; Equity&quot;</span>,</span>
<span id="cb6-38"><a href="data.html#cb6-38" tabindex="-1"></a>    <span class="st">&quot;Gross Profit Margin&quot;</span>,</span>
<span id="cb6-39"><a href="data.html#cb6-39" tabindex="-1"></a>    <span class="st">&quot;Operating Profit Margin After Depreciation&quot;</span>,</span>
<span id="cb6-40"><a href="data.html#cb6-40" tabindex="-1"></a>    <span class="st">&quot;Operating Profit Margin Before Depreciation&quot;</span>,</span>
<span id="cb6-41"><a href="data.html#cb6-41" tabindex="-1"></a>    <span class="st">&quot;Return on Assets&quot;</span>,</span>
<span id="cb6-42"><a href="data.html#cb6-42" tabindex="-1"></a>    <span class="st">&quot;Return on Equity&quot;</span>,</span>
<span id="cb6-43"><a href="data.html#cb6-43" tabindex="-1"></a>    <span class="st">&quot;Debt to Equity Ratio&quot;</span>,</span>
<span id="cb6-44"><a href="data.html#cb6-44" tabindex="-1"></a>    <span class="st">&quot;Debt Ratio&quot;</span>,</span>
<span id="cb6-45"><a href="data.html#cb6-45" tabindex="-1"></a>    <span class="st">&quot;Solvency Ratio (Liabilities / Total Assets)&quot;</span>,</span>
<span id="cb6-46"><a href="data.html#cb6-46" tabindex="-1"></a>    <span class="st">&quot;Price-to-Earnings&quot;</span></span>
<span id="cb6-47"><a href="data.html#cb6-47" tabindex="-1"></a>  ),</span>
<span id="cb6-48"><a href="data.html#cb6-48" tabindex="-1"></a>  <span class="at">identifier =</span> <span class="fu">c</span>(</span>
<span id="cb6-49"><a href="data.html#cb6-49" tabindex="-1"></a>    <span class="st">&quot;capital_ratio&quot;</span>,</span>
<span id="cb6-50"><a href="data.html#cb6-50" tabindex="-1"></a>    <span class="st">&quot;at_turn&quot;</span>,</span>
<span id="cb6-51"><a href="data.html#cb6-51" tabindex="-1"></a>    <span class="st">&quot;inv_turn&quot;</span>,</span>
<span id="cb6-52"><a href="data.html#cb6-52" tabindex="-1"></a>    <span class="st">&quot;rect_turn&quot;</span>,</span>
<span id="cb6-53"><a href="data.html#cb6-53" tabindex="-1"></a>    <span class="st">&quot;pay_turn&quot;</span>,</span>
<span id="cb6-54"><a href="data.html#cb6-54" tabindex="-1"></a>    <span class="st">&quot;cash_ratio&quot;</span>,</span>
<span id="cb6-55"><a href="data.html#cb6-55" tabindex="-1"></a>    <span class="st">&quot;curr_ratio&quot;</span>,</span>
<span id="cb6-56"><a href="data.html#cb6-56" tabindex="-1"></a>    <span class="st">&quot;quick_ratio&quot;</span>,</span>
<span id="cb6-57"><a href="data.html#cb6-57" tabindex="-1"></a>    <span class="st">&quot;aftret_eq&quot;</span>,</span>
<span id="cb6-58"><a href="data.html#cb6-58" tabindex="-1"></a>    <span class="st">&quot;aftret_equity&quot;</span>,</span>
<span id="cb6-59"><a href="data.html#cb6-59" tabindex="-1"></a>    <span class="st">&quot;gpm&quot;</span>,</span>
<span id="cb6-60"><a href="data.html#cb6-60" tabindex="-1"></a>    <span class="st">&quot;opmad&quot;</span>,</span>
<span id="cb6-61"><a href="data.html#cb6-61" tabindex="-1"></a>    <span class="st">&quot;opmbd&quot;</span>,</span>
<span id="cb6-62"><a href="data.html#cb6-62" tabindex="-1"></a>    <span class="st">&quot;roa&quot;</span>,</span>
<span id="cb6-63"><a href="data.html#cb6-63" tabindex="-1"></a>    <span class="st">&quot;roe&quot;</span>,</span>
<span id="cb6-64"><a href="data.html#cb6-64" tabindex="-1"></a>    <span class="st">&quot;de_ratio&quot;</span>,</span>
<span id="cb6-65"><a href="data.html#cb6-65" tabindex="-1"></a>    <span class="st">&quot;debt_assets&quot;</span>,</span>
<span id="cb6-66"><a href="data.html#cb6-66" tabindex="-1"></a>    <span class="st">&quot;debt_at&quot;</span>,</span>
<span id="cb6-67"><a href="data.html#cb6-67" tabindex="-1"></a>    <span class="st">&quot;pe_exi&quot;</span></span>
<span id="cb6-68"><a href="data.html#cb6-68" tabindex="-1"></a>  )</span>
<span id="cb6-69"><a href="data.html#cb6-69" tabindex="-1"></a>)</span>
<span id="cb6-70"><a href="data.html#cb6-70" tabindex="-1"></a></span>
<span id="cb6-71"><a href="data.html#cb6-71" tabindex="-1"></a>com <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(com_ratio) <span class="sc">%&gt;%</span></span>
<span id="cb6-72"><a href="data.html#cb6-72" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-73"><a href="data.html#cb6-73" tabindex="-1"></a>    com.features<span class="sc">$</span>identifier, com.features.fin<span class="sc">$</span>identifier</span>
<span id="cb6-74"><a href="data.html#cb6-74" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-75"><a href="data.html#cb6-75" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-76"><a href="data.html#cb6-76" tabindex="-1"></a>    <span class="at">event_group =</span> <span class="fu">factor</span>(</span>
<span id="cb6-77"><a href="data.html#cb6-77" tabindex="-1"></a>      <span class="fu">ifelse</span>(event_group <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;liquidation&quot;</span>, <span class="st">&quot;dropped&quot;</span>), <span class="st">&quot;delisted&quot;</span>, <span class="st">&quot;active&quot;</span>),</span>
<span id="cb6-78"><a href="data.html#cb6-78" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;delisted&quot;</span>, <span class="st">&quot;active&quot;</span>)</span>
<span id="cb6-79"><a href="data.html#cb6-79" tabindex="-1"></a>    ),</span>
<span id="cb6-80"><a href="data.html#cb6-80" tabindex="-1"></a>    <span class="at">years_to_delisting =</span></span>
<span id="cb6-81"><a href="data.html#cb6-81" tabindex="-1"></a>    <span class="co"># convention: use the year MAX_DATE as delisting date</span></span>
<span id="cb6-82"><a href="data.html#cb6-82" tabindex="-1"></a>    <span class="co"># if &#39;2022-12-31&#39; set as enddat in initial data set</span></span>
<span id="cb6-83"><a href="data.html#cb6-83" tabindex="-1"></a>      <span class="fu">ifelse</span>(enddat <span class="sc">&gt;=</span> LAST_TRADING_DATE_AVAILABLE,</span>
<span id="cb6-84"><a href="data.html#cb6-84" tabindex="-1"></a>        <span class="fu">time_length</span>(<span class="fu">interval</span>(public_date, MAX_DATE), <span class="st">&quot;year&quot;</span>),</span>
<span id="cb6-85"><a href="data.html#cb6-85" tabindex="-1"></a>        <span class="fu">time_length</span>(<span class="fu">interval</span>(public_date, enddat), <span class="st">&quot;year&quot;</span>)</span>
<span id="cb6-86"><a href="data.html#cb6-86" tabindex="-1"></a>      )</span>
<span id="cb6-87"><a href="data.html#cb6-87" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-88"><a href="data.html#cb6-88" tabindex="-1"></a>  <span class="fu">arrange</span>(public_date)</span>
<span id="cb6-89"><a href="data.html#cb6-89" tabindex="-1"></a></span>
<span id="cb6-90"><a href="data.html#cb6-90" tabindex="-1"></a><span class="fu">remove</span>(com_ratio)</span></code></pre></div>
<p>Macroeconomic features may improve model accuracy if delistings are affected by the overall economic situation. This behavior seems reasonable and will be checked in the exploratory data analysis. The data set with macroeconomic data contains the annual rate of change of four indices quarterly.<br />
* <strong>gdpc1</strong>: rate of change of the <a href="https://fred.stlouisfed.org/series/GDPC1">Real Gross Domestic Product</a>, the inflation adjusted value of the goods and services produced by labor and property located in the United States<br />
* <strong>cpiaucsl</strong>: rate of change of the <a href="https://fred.stlouisfed.org/series/CPIAUCSL">Consumer Price Index for All Urban Consumers</a><br />
* <strong>fredfunds</strong>: rate of change of the <a href="https://fred.stlouisfed.org/series/FEDFUNDS">Federal Funds Effective Rate</a>, the average interest rate at which depository institutions trade federal funds (balances held at Federal Reserve Banks) with each other overnight<br />
* <strong>sp500</strong>: rate of change of the <a href="https://www.spglobal.com/spdji/en/indices/equity/sp-500">S&amp;P 500</a> index which includes 500 leading companies in the United States and covers approximately 80% of the available market capitalization. The source of these index values is Bloomberg.</p>
<p>This chunk loads annual changes of macroeconomic data into the data frame <code>macro.ratios</code> in quartetly intervals.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="data.html#cb7-1" tabindex="-1"></a><span class="co"># compute rate of change for a vector with quarterly entries</span></span>
<span id="cb7-2"><a href="data.html#cb7-2" tabindex="-1"></a>rate_of_change <span class="ot">&lt;-</span> <span class="cf">function</span>(vector) {</span>
<span id="cb7-3"><a href="data.html#cb7-3" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(vector)</span>
<span id="cb7-4"><a href="data.html#cb7-4" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, vector[<span class="dv">5</span><span class="sc">:</span>n] <span class="sc">/</span> vector[<span class="dv">1</span><span class="sc">:</span>(n <span class="sc">-</span> <span class="dv">4</span>)] <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb7-5"><a href="data.html#cb7-5" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="data.html#cb7-6" tabindex="-1"></a></span>
<span id="cb7-7"><a href="data.html#cb7-7" tabindex="-1"></a><span class="co"># compute absolute annual difference for a vector with quarterly entries</span></span>
<span id="cb7-8"><a href="data.html#cb7-8" tabindex="-1"></a>one_year_difference <span class="ot">&lt;-</span> <span class="cf">function</span>(vector) {</span>
<span id="cb7-9"><a href="data.html#cb7-9" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(vector)</span>
<span id="cb7-10"><a href="data.html#cb7-10" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, vector[<span class="dv">5</span><span class="sc">:</span>n] <span class="sc">-</span> vector[<span class="dv">1</span><span class="sc">:</span>(n <span class="sc">-</span> <span class="dv">4</span>)]))</span>
<span id="cb7-11"><a href="data.html#cb7-11" tabindex="-1"></a>}</span>
<span id="cb7-12"><a href="data.html#cb7-12" tabindex="-1"></a></span>
<span id="cb7-13"><a href="data.html#cb7-13" tabindex="-1"></a><span class="co"># gdpc1 Real Gross Domestic Product (https://fred.stlouisfed.org/series/GDPC1)</span></span>
<span id="cb7-14"><a href="data.html#cb7-14" tabindex="-1"></a><span class="co"># cpiaucsl Consumer Price Index for All Urban Consumers: All Items in U.S. City Average (https://fred.stlouisfed.org/series/CPIAUCSL)</span></span>
<span id="cb7-15"><a href="data.html#cb7-15" tabindex="-1"></a><span class="co"># fredfunds Federal Funds Effective Rate (https://fred.stlouisfed.org/series/FEDFUNDS)</span></span>
<span id="cb7-16"><a href="data.html#cb7-16" tabindex="-1"></a><span class="co"># sp500 annual rate of return from Bloomberg Terminal</span></span>
<span id="cb7-17"><a href="data.html#cb7-17" tabindex="-1"></a>macro.measures <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;../data/macroeconomic_measures.csv&quot;</span>)</span>
<span id="cb7-18"><a href="data.html#cb7-18" tabindex="-1"></a>macro.ratios <span class="ot">&lt;-</span> macro.measures <span class="sc">%&gt;%</span></span>
<span id="cb7-19"><a href="data.html#cb7-19" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-20"><a href="data.html#cb7-20" tabindex="-1"></a>    <span class="at">gdpc1_chg =</span> <span class="fu">rate_of_change</span>(gdpc1),</span>
<span id="cb7-21"><a href="data.html#cb7-21" tabindex="-1"></a>    <span class="at">cpiaucsl_chg =</span> <span class="fu">rate_of_change</span>(cpiaucsl),</span>
<span id="cb7-22"><a href="data.html#cb7-22" tabindex="-1"></a>    <span class="at">fredfunds_chg =</span> <span class="fu">one_year_difference</span>(fredfunds),</span>
<span id="cb7-23"><a href="data.html#cb7-23" tabindex="-1"></a>    <span class="at">sp500_chg =</span> <span class="fu">rate_of_change</span>(sp500)</span>
<span id="cb7-24"><a href="data.html#cb7-24" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-25"><a href="data.html#cb7-25" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>gdpc1, <span class="sc">-</span>cpiaucsl, <span class="sc">-</span>fredfunds, <span class="sc">-</span>sp500) <span class="sc">%&gt;%</span></span>
<span id="cb7-26"><a href="data.html#cb7-26" tabindex="-1"></a>  <span class="fu">filter</span>(FIRST_TRADING_DATE_AVAILABLE <span class="sc">&lt;=</span> observation_date <span class="sc">&amp;</span></span>
<span id="cb7-27"><a href="data.html#cb7-27" tabindex="-1"></a>    observation_date <span class="sc">&lt;=</span> LAST_TRADING_DATE_AVAILABLE)</span>
<span id="cb7-28"><a href="data.html#cb7-28" tabindex="-1"></a></span>
<span id="cb7-29"><a href="data.html#cb7-29" tabindex="-1"></a>macro.ratios.name <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb7-30"><a href="data.html#cb7-30" tabindex="-1"></a>  <span class="at">gdpc1_chg =</span> <span class="st">&quot;GDP (rate of change)&quot;</span>,</span>
<span id="cb7-31"><a href="data.html#cb7-31" tabindex="-1"></a>  <span class="at">cpiaucsl_chg =</span> <span class="st">&quot;CPI (rate of change)&quot;</span>,</span>
<span id="cb7-32"><a href="data.html#cb7-32" tabindex="-1"></a>  <span class="at">fredfunds_chg =</span> <span class="st">&quot;federal funds rate (1-year diff.)&quot;</span>,</span>
<span id="cb7-33"><a href="data.html#cb7-33" tabindex="-1"></a>  <span class="at">sp500_chg =</span> <span class="st">&quot;S&amp;P 500 (rate of change)&quot;</span></span>
<span id="cb7-34"><a href="data.html#cb7-34" tabindex="-1"></a>)</span>
<span id="cb7-35"><a href="data.html#cb7-35" tabindex="-1"></a></span>
<span id="cb7-36"><a href="data.html#cb7-36" tabindex="-1"></a><span class="fu">pander</span>(<span class="fu">head</span>(macro.ratios))</span></code></pre></div>
<table>
<colgroup>
<col width="25%" />
<col width="16%" />
<col width="20%" />
<col width="21%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">observation_date</th>
<th align="center">gdpc1_chg</th>
<th align="center">cpiaucsl_chg</th>
<th align="center">fredfunds_chg</th>
<th align="center">sp500_chg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1970-03-31</td>
<td align="center">0.001628</td>
<td align="center">0.06038</td>
<td align="center">-0.44</td>
<td align="center">-0.117</td>
</tr>
<tr class="even">
<td align="center">1970-06-30</td>
<td align="center">0.004226</td>
<td align="center">0.05686</td>
<td align="center">-2.27</td>
<td align="center">-0.2558</td>
</tr>
<tr class="odd">
<td align="center">1970-09-30</td>
<td align="center">-0.001667</td>
<td align="center">0.056</td>
<td align="center">-3.37</td>
<td align="center">-0.09568</td>
</tr>
<tr class="even">
<td align="center">1970-12-31</td>
<td align="center">0.02697</td>
<td align="center">0.04811</td>
<td align="center">-4.71</td>
<td align="center">0.0009776</td>
</tr>
<tr class="odd">
<td align="center">1971-03-31</td>
<td align="center">0.03107</td>
<td align="center">0.04315</td>
<td align="center">-3.32</td>
<td align="center">0.1192</td>
</tr>
<tr class="even">
<td align="center">1971-06-30</td>
<td align="center">0.03006</td>
<td align="center">0.04271</td>
<td align="center">-1.23</td>
<td align="center">0.371</td>
</tr>
</tbody>
</table>

</div>
<div id="exploratory-data-analysis" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Exploratory Data Analysis<a href="data.html#exploratory-data-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Helper functions to truncate data</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="data.html#cb8-1" tabindex="-1"></a><span class="co">#&#39; winsorizes/truncates values for a given vector and quantile ranges</span></span>
<span id="cb8-2"><a href="data.html#cb8-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb8-3"><a href="data.html#cb8-3" tabindex="-1"></a><span class="co">#&#39; @param vector vector with numerical values</span></span>
<span id="cb8-4"><a href="data.html#cb8-4" tabindex="-1"></a><span class="co">#&#39; @param lower_quantile_boundary lower quantile boundary</span></span>
<span id="cb8-5"><a href="data.html#cb8-5" tabindex="-1"></a><span class="co">#&#39; @param upper_quantile_boundary upper quantile boundary</span></span>
<span id="cb8-6"><a href="data.html#cb8-6" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb8-7"><a href="data.html#cb8-7" tabindex="-1"></a><span class="co">#&#39; @return winsorized vector with min(vector) = lower_quantile and</span></span>
<span id="cb8-8"><a href="data.html#cb8-8" tabindex="-1"></a><span class="co">#&#39;         max(vector) = upper_quantile</span></span>
<span id="cb8-9"><a href="data.html#cb8-9" tabindex="-1"></a>winsorize <span class="ot">&lt;-</span> <span class="cf">function</span>(vector, <span class="at">lower_quantile_boundary =</span> <span class="fl">0.05</span>,</span>
<span id="cb8-10"><a href="data.html#cb8-10" tabindex="-1"></a>                      <span class="at">upper_quantile_boundary =</span> <span class="fl">0.95</span>) {</span>
<span id="cb8-11"><a href="data.html#cb8-11" tabindex="-1"></a>  <span class="cf">if</span> (lower_quantile_boundary <span class="sc">&gt;</span> upper_quantile_boundary) {</span>
<span id="cb8-12"><a href="data.html#cb8-12" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;Lower quantile boundary is greater than upper quantile boundary.&quot;</span>)</span>
<span id="cb8-13"><a href="data.html#cb8-13" tabindex="-1"></a>  }</span>
<span id="cb8-14"><a href="data.html#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="data.html#cb8-15" tabindex="-1"></a>  lower_quantile <span class="ot">&lt;-</span> <span class="fu">quantile</span>(vector, lower_quantile_boundary, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-16"><a href="data.html#cb8-16" tabindex="-1"></a>  upper_quantile <span class="ot">&lt;-</span> <span class="fu">quantile</span>(vector, upper_quantile_boundary, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-17"><a href="data.html#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="data.html#cb8-18" tabindex="-1"></a>  vector[<span class="sc">!</span><span class="fu">is.na</span>(vector) <span class="sc">&amp;</span> vector <span class="sc">&lt;</span> lower_quantile] <span class="ot">&lt;-</span> lower_quantile</span>
<span id="cb8-19"><a href="data.html#cb8-19" tabindex="-1"></a>  vector[<span class="sc">!</span><span class="fu">is.na</span>(vector) <span class="sc">&amp;</span> vector <span class="sc">&gt;</span> upper_quantile] <span class="ot">&lt;-</span> upper_quantile</span>
<span id="cb8-20"><a href="data.html#cb8-20" tabindex="-1"></a></span>
<span id="cb8-21"><a href="data.html#cb8-21" tabindex="-1"></a>  <span class="fu">return</span>(vector)</span>
<span id="cb8-22"><a href="data.html#cb8-22" tabindex="-1"></a>}</span>
<span id="cb8-23"><a href="data.html#cb8-23" tabindex="-1"></a></span>
<span id="cb8-24"><a href="data.html#cb8-24" tabindex="-1"></a><span class="co">#&#39; winsorizes/truncate columns of a given tibble</span></span>
<span id="cb8-25"><a href="data.html#cb8-25" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb8-26"><a href="data.html#cb8-26" tabindex="-1"></a><span class="co">#&#39; @param data tibble with data</span></span>
<span id="cb8-27"><a href="data.html#cb8-27" tabindex="-1"></a><span class="co">#&#39; @param feature_identifier vector with strings of column names of tibble</span></span>
<span id="cb8-28"><a href="data.html#cb8-28" tabindex="-1"></a><span class="co">#&#39;        which should be winsorized</span></span>
<span id="cb8-29"><a href="data.html#cb8-29" tabindex="-1"></a><span class="co">#&#39; @param lower_quantile_boundary lower quantile boundary</span></span>
<span id="cb8-30"><a href="data.html#cb8-30" tabindex="-1"></a><span class="co">#&#39; @param upper_quantile_boundary upper quantile boundary</span></span>
<span id="cb8-31"><a href="data.html#cb8-31" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb8-32"><a href="data.html#cb8-32" tabindex="-1"></a><span class="co">#&#39; @return tibble of the same structure as given with winsorized columns</span></span>
<span id="cb8-33"><a href="data.html#cb8-33" tabindex="-1"></a>data.prepare.winsorize <span class="ot">&lt;-</span> <span class="cf">function</span>(data, feature_identifier,</span>
<span id="cb8-34"><a href="data.html#cb8-34" tabindex="-1"></a>                                   <span class="at">lower_quantile_boundary =</span> <span class="fl">0.05</span>,</span>
<span id="cb8-35"><a href="data.html#cb8-35" tabindex="-1"></a>                                   <span class="at">upper_quantile_boundary =</span> <span class="fl">0.95</span>) {</span>
<span id="cb8-36"><a href="data.html#cb8-36" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-37"><a href="data.html#cb8-37" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-38"><a href="data.html#cb8-38" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(feature_identifier),</span>
<span id="cb8-39"><a href="data.html#cb8-39" tabindex="-1"></a>      <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">winsorize</span>(.x, lower_quantile_boundary, upper_quantile_boundary)</span>
<span id="cb8-40"><a href="data.html#cb8-40" tabindex="-1"></a>    ))</span>
<span id="cb8-41"><a href="data.html#cb8-41" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb8-42"><a href="data.html#cb8-42" tabindex="-1"></a>}</span></code></pre></div>
<div id="overview-over-deslisting-dates" class="section level3 hasAnchor" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Overview over deslisting dates<a href="data.html#overview-over-deslisting-dates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="data.html#cb9-1" tabindex="-1"></a><span class="co"># histogram with number of years until delisting</span></span>
<span id="cb9-2"><a href="data.html#cb9-2" tabindex="-1"></a>com <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="data.html#cb9-3" tabindex="-1"></a>  <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="data.html#cb9-4" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">max_years_to_delisting =</span> <span class="fu">max</span>(years_to_delisting)) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="data.html#cb9-5" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> max_years_to_delisting)) <span class="sc">+</span></span>
<span id="cb9-6"><a href="data.html#cb9-6" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-7"><a href="data.html#cb9-7" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">ceiling</span>(NUMBER_YEARS_AVAILABLE))) <span class="sc">+</span></span>
<span id="cb9-8"><a href="data.html#cb9-8" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-9"><a href="data.html#cb9-9" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Number of years until delisting&quot;</span>,</span>
<span id="cb9-10"><a href="data.html#cb9-10" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;number of years until delisting&quot;</span>,</span>
<span id="cb9-11"><a href="data.html#cb9-11" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;number of companies&quot;</span></span>
<span id="cb9-12"><a href="data.html#cb9-12" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/number_years_until_delisting-1.png" width="672" /></p>
<p>The histogram displays the number of years until delisting for each data row of the delisted companies in the period from 1970 to 2022.</p>
<p>This chunk creates a plot that displays the number of listed and delisted companies over time and compares them to changes in four macroeconomic ratios.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="data.html#cb10-1" tabindex="-1"></a><span class="co"># Function to scale secondary axis</span></span>
<span id="cb10-2"><a href="data.html#cb10-2" tabindex="-1"></a>scale_function <span class="ot">&lt;-</span> <span class="cf">function</span>(x, scale, shift) {</span>
<span id="cb10-3"><a href="data.html#cb10-3" tabindex="-1"></a>  <span class="fu">return</span>(x <span class="sc">*</span> scale <span class="sc">+</span> shift)</span>
<span id="cb10-4"><a href="data.html#cb10-4" tabindex="-1"></a>}</span>
<span id="cb10-5"><a href="data.html#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="data.html#cb10-6" tabindex="-1"></a><span class="co"># Function to scale secondary variable values</span></span>
<span id="cb10-7"><a href="data.html#cb10-7" tabindex="-1"></a>inv_scale_function <span class="ot">&lt;-</span> <span class="cf">function</span>(x, scale, shift) {</span>
<span id="cb10-8"><a href="data.html#cb10-8" tabindex="-1"></a>  <span class="fu">return</span>((x <span class="sc">+</span> shift) <span class="sc">/</span> scale)</span>
<span id="cb10-9"><a href="data.html#cb10-9" tabindex="-1"></a>}</span>
<span id="cb10-10"><a href="data.html#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="data.html#cb10-11" tabindex="-1"></a><span class="co"># number of delistings in subsequent year</span></span>
<span id="cb10-12"><a href="data.html#cb10-12" tabindex="-1"></a>com.listed_years <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb10-13"><a href="data.html#cb10-13" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(public_date) <span class="sc">==</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-14"><a href="data.html#cb10-14" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">year =</span> <span class="fu">floor_date</span>(public_date, <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-15"><a href="data.html#cb10-15" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">number_of_listed_companies =</span> <span class="fu">n</span>())</span>
<span id="cb10-16"><a href="data.html#cb10-16" tabindex="-1"></a></span>
<span id="cb10-17"><a href="data.html#cb10-17" tabindex="-1"></a><span class="co"># number of delistings in subsequent year</span></span>
<span id="cb10-18"><a href="data.html#cb10-18" tabindex="-1"></a>com.delisting_years <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb10-19"><a href="data.html#cb10-19" tabindex="-1"></a>  <span class="fu">filter</span>(event_group <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-20"><a href="data.html#cb10-20" tabindex="-1"></a>  <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb10-21"><a href="data.html#cb10-21" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-22"><a href="data.html#cb10-22" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-23"><a href="data.html#cb10-23" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">year =</span> <span class="fu">floor_date</span>(enddat, <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-24"><a href="data.html#cb10-24" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">number_of_delistings =</span> <span class="fu">n</span>())</span>
<span id="cb10-25"><a href="data.html#cb10-25" tabindex="-1"></a></span>
<span id="cb10-26"><a href="data.html#cb10-26" tabindex="-1"></a>com.delisting_years <span class="ot">&lt;-</span> com.delisting_years <span class="sc">%&gt;%</span></span>
<span id="cb10-27"><a href="data.html#cb10-27" tabindex="-1"></a>  <span class="fu">left_join</span>(com.listed_years, <span class="at">by =</span> <span class="fu">join_by</span>(year)) <span class="sc">%&gt;%</span></span>
<span id="cb10-28"><a href="data.html#cb10-28" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rel_delisting_frequency =</span> number_of_delistings <span class="sc">/</span> number_of_listed_companies)</span>
<span id="cb10-29"><a href="data.html#cb10-29" tabindex="-1"></a></span>
<span id="cb10-30"><a href="data.html#cb10-30" tabindex="-1"></a>subtitle <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb10-31"><a href="data.html#cb10-31" tabindex="-1"></a>  <span class="st">&#39;&lt;span style = &quot;color:{colors[&quot;gray&quot;]}&quot;&gt;**Number of listed companies**&lt;/span&gt;, &#39;</span>,</span>
<span id="cb10-32"><a href="data.html#cb10-32" tabindex="-1"></a>  <span class="st">&#39;&lt;span style = &quot;color:{colors[&quot;blue&quot;]}&quot;&gt;**absolute delisting frequency**&lt;/span&gt; and &lt;br&gt;&#39;</span>,</span>
<span id="cb10-33"><a href="data.html#cb10-33" tabindex="-1"></a>  <span class="st">&#39;&lt;span style = &quot;color:{colors[&quot;orange&quot;]}&quot;&gt;**relative delisting frequency** (proportion of delisted companies)&lt;/span&gt;&#39;</span></span>
<span id="cb10-34"><a href="data.html#cb10-34" tabindex="-1"></a>)</span>
<span id="cb10-35"><a href="data.html#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="data.html#cb10-36" tabindex="-1"></a>min_y_first <span class="ot">&lt;-</span> <span class="fu">min</span>(com.delisting_years<span class="sc">$</span>number_of_delistings)</span>
<span id="cb10-37"><a href="data.html#cb10-37" tabindex="-1"></a>max_y_first <span class="ot">&lt;-</span> <span class="fu">max</span>(com.delisting_years<span class="sc">$</span>number_of_delistings)</span>
<span id="cb10-38"><a href="data.html#cb10-38" tabindex="-1"></a>min_y_second <span class="ot">&lt;-</span> <span class="fu">min</span>(com.delisting_years<span class="sc">$</span>rel_delisting_frequency)</span>
<span id="cb10-39"><a href="data.html#cb10-39" tabindex="-1"></a>max_y_second <span class="ot">&lt;-</span> <span class="fu">max</span>(com.delisting_years<span class="sc">$</span>rel_delisting_frequency)</span>
<span id="cb10-40"><a href="data.html#cb10-40" tabindex="-1"></a><span class="co"># scale and shift variables calculated based on desired mins and maxes</span></span>
<span id="cb10-41"><a href="data.html#cb10-41" tabindex="-1"></a>scale <span class="ot">&lt;-</span> (max_y_second <span class="sc">-</span> min_y_second) <span class="sc">/</span> (max_y_first <span class="sc">-</span> min_y_first)</span>
<span id="cb10-42"><a href="data.html#cb10-42" tabindex="-1"></a>shift <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-43"><a href="data.html#cb10-43" tabindex="-1"></a></span>
<span id="cb10-44"><a href="data.html#cb10-44" tabindex="-1"></a>scale1 <span class="ot">&lt;-</span> (<span class="fu">max</span>(com.delisting_years<span class="sc">$</span>number_of_listed_companies) <span class="sc">-</span> <span class="fu">min</span>(com.delisting_years<span class="sc">$</span>number_of_listed_companies)) <span class="sc">/</span> (max_y_first <span class="sc">-</span> min_y_first)</span>
<span id="cb10-45"><a href="data.html#cb10-45" tabindex="-1"></a>shift1 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-46"><a href="data.html#cb10-46" tabindex="-1"></a></span>
<span id="cb10-47"><a href="data.html#cb10-47" tabindex="-1"></a>plot_stock_listings_delistings <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> com.delisting_years, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> year)) <span class="sc">+</span></span>
<span id="cb10-48"><a href="data.html#cb10-48" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;1985-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;1987-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-49"><a href="data.html#cb10-49" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;2000-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;2002-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-50"><a href="data.html#cb10-50" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;2008-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;2010-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-51"><a href="data.html#cb10-51" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;1990-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;1992-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-52"><a href="data.html#cb10-52" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb10-53"><a href="data.html#cb10-53" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">inv_scale_function</span>(number_of_listed_companies, scale1, shift1), <span class="at">color =</span> <span class="st">&quot;number of listings&quot;</span>),</span>
<span id="cb10-54"><a href="data.html#cb10-54" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb10-55"><a href="data.html#cb10-55" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-56"><a href="data.html#cb10-56" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb10-57"><a href="data.html#cb10-57" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">max</span>(com.delisting_years<span class="sc">$</span>year),</span>
<span id="cb10-58"><a href="data.html#cb10-58" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">inv_scale_function</span>(<span class="fu">max</span>(com.delisting_years<span class="sc">$</span>number_of_listed_companies), scale1, shift1),</span>
<span id="cb10-59"><a href="data.html#cb10-59" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">max</span>(com.delisting_years<span class="sc">$</span>number_of_listed_companies), <span class="at">hjust =</span> <span class="fl">1.2</span></span>
<span id="cb10-60"><a href="data.html#cb10-60" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-61"><a href="data.html#cb10-61" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb10-62"><a href="data.html#cb10-62" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">min</span>(com.delisting_years<span class="sc">$</span>year),</span>
<span id="cb10-63"><a href="data.html#cb10-63" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">inv_scale_function</span>(<span class="fu">min</span>(com.delisting_years<span class="sc">$</span>number_of_listed_companies), scale1, shift1),</span>
<span id="cb10-64"><a href="data.html#cb10-64" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">min</span>(com.delisting_years<span class="sc">$</span>number_of_listed_companies), <span class="at">hjust =</span> <span class="fl">1.2</span></span>
<span id="cb10-65"><a href="data.html#cb10-65" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-66"><a href="data.html#cb10-66" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb10-67"><a href="data.html#cb10-67" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">inv_scale_function</span>(rel_delisting_frequency, scale, shift), <span class="at">color =</span> <span class="st">&quot;relative delisting frequncy&quot;</span>),</span>
<span id="cb10-68"><a href="data.html#cb10-68" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;longdash&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb10-69"><a href="data.html#cb10-69" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-70"><a href="data.html#cb10-70" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb10-71"><a href="data.html#cb10-71" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> number_of_delistings, <span class="at">color =</span> <span class="st">&quot;Absolute delisting frequency&quot;</span>),</span>
<span id="cb10-72"><a href="data.html#cb10-72" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb10-73"><a href="data.html#cb10-73" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-74"><a href="data.html#cb10-74" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb10-75"><a href="data.html#cb10-75" tabindex="-1"></a>    <span class="st">&quot;number of listings&quot;</span> <span class="ot">=</span> <span class="fu">as.character</span>(colors[<span class="st">&quot;gray&quot;</span>]),</span>
<span id="cb10-76"><a href="data.html#cb10-76" tabindex="-1"></a>    <span class="st">&quot;Absolute delisting frequency&quot;</span> <span class="ot">=</span> <span class="fu">as.character</span>(colors[<span class="st">&quot;blue&quot;</span>]),</span>
<span id="cb10-77"><a href="data.html#cb10-77" tabindex="-1"></a>    <span class="st">&quot;relative delisting frequncy&quot;</span> <span class="ot">=</span> <span class="fu">as.character</span>(colors[<span class="st">&quot;orange&quot;</span>])</span>
<span id="cb10-78"><a href="data.html#cb10-78" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb10-79"><a href="data.html#cb10-79" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb10-80"><a href="data.html#cb10-80" tabindex="-1"></a>    <span class="st">&quot;Abslolute delisting frequency&quot;</span>,</span>
<span id="cb10-81"><a href="data.html#cb10-81" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> <span class="fu">scale_function</span>(., scale, shift), <span class="at">name =</span> <span class="st">&quot;Relative delisting frequency&quot;</span>, <span class="at">labels =</span> <span class="fu">waiver</span>())</span>
<span id="cb10-82"><a href="data.html#cb10-82" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-83"><a href="data.html#cb10-83" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-84"><a href="data.html#cb10-84" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Delistings vs. calendar year&quot;</span>,</span>
<span id="cb10-85"><a href="data.html#cb10-85" tabindex="-1"></a>    <span class="at">subtitle =</span> subtitle,</span>
<span id="cb10-86"><a href="data.html#cb10-86" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;calendar year&quot;</span>,</span>
<span id="cb10-87"><a href="data.html#cb10-87" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-88"><a href="data.html#cb10-88" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb10-89"><a href="data.html#cb10-89" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_markdown</span>(),</span>
<span id="cb10-90"><a href="data.html#cb10-90" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_markdown</span>(<span class="at">color =</span> colors[<span class="st">&quot;blue&quot;</span>]),</span>
<span id="cb10-91"><a href="data.html#cb10-91" tabindex="-1"></a>    <span class="at">axis.title.y.right =</span> <span class="fu">element_markdown</span>(<span class="at">color =</span> colors[<span class="st">&quot;orange&quot;</span>]),</span>
<span id="cb10-92"><a href="data.html#cb10-92" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb10-93"><a href="data.html#cb10-93" tabindex="-1"></a>  )</span>
<span id="cb10-94"><a href="data.html#cb10-94" tabindex="-1"></a></span>
<span id="cb10-95"><a href="data.html#cb10-95" tabindex="-1"></a>plot_macro_ratios <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb10-96"><a href="data.html#cb10-96" tabindex="-1"></a>  <span class="at">data =</span> macro.ratios <span class="sc">%&gt;%</span></span>
<span id="cb10-97"><a href="data.html#cb10-97" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb10-98"><a href="data.html#cb10-98" tabindex="-1"></a>      <span class="at">cols =</span> <span class="sc">-</span>observation_date,</span>
<span id="cb10-99"><a href="data.html#cb10-99" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">&quot;index_chg&quot;</span>,</span>
<span id="cb10-100"><a href="data.html#cb10-100" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb10-101"><a href="data.html#cb10-101" tabindex="-1"></a>    ),</span>
<span id="cb10-102"><a href="data.html#cb10-102" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> observation_date, <span class="at">y =</span> value)</span>
<span id="cb10-103"><a href="data.html#cb10-103" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb10-104"><a href="data.html#cb10-104" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;1985-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;1987-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-105"><a href="data.html#cb10-105" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;2000-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;2002-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-106"><a href="data.html#cb10-106" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;2008-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;2010-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-107"><a href="data.html#cb10-107" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;rect&quot;</span>, <span class="at">xmin =</span> <span class="fu">ymd</span>(<span class="st">&quot;1990-01-01&quot;</span>), <span class="at">xmax =</span> <span class="fu">ymd</span>(<span class="st">&quot;1992-01-01&quot;</span>), <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> colors[<span class="st">&quot;green&quot;</span>], <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-108"><a href="data.html#cb10-108" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-109"><a href="data.html#cb10-109" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> index_chg, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">index_chg =</span> macro.ratios.name)) <span class="sc">+</span></span>
<span id="cb10-110"><a href="data.html#cb10-110" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-111"><a href="data.html#cb10-111" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Macro economic index changes&quot;</span>,</span>
<span id="cb10-112"><a href="data.html#cb10-112" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;calendar year&quot;</span>,</span>
<span id="cb10-113"><a href="data.html#cb10-113" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;one-year change of index&quot;</span></span>
<span id="cb10-114"><a href="data.html#cb10-114" tabindex="-1"></a>  )</span>
<span id="cb10-115"><a href="data.html#cb10-115" tabindex="-1"></a></span>
<span id="cb10-116"><a href="data.html#cb10-116" tabindex="-1"></a><span class="fu">ggarrange</span>(plot_stock_listings_delistings, plot_macro_ratios,</span>
<span id="cb10-117"><a href="data.html#cb10-117" tabindex="-1"></a>          <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/number_of_delisting_subsequent_year-1.png" width="672" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="data.html#cb11-1" tabindex="-1"></a><span class="co"># months of delisting</span></span>
<span id="cb11-2"><a href="data.html#cb11-2" tabindex="-1"></a>com <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="data.html#cb11-3" tabindex="-1"></a>  <span class="co"># filter only last quarter before delisting</span></span>
<span id="cb11-4"><a href="data.html#cb11-4" tabindex="-1"></a>  <span class="fu">filter</span>(years_to_delisting <span class="sc">&lt;=</span> <span class="fl">0.25</span> <span class="sc">&amp;</span> event_group <span class="sc">!=</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="data.html#cb11-5" tabindex="-1"></a>  <span class="fu">group_by</span>(permno, enddat) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="data.html#cb11-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">delisting_month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(enddat, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="data.html#cb11-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> delisting_month)) <span class="sc">+</span></span>
<span id="cb11-8"><a href="data.html#cb11-8" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb11-9"><a href="data.html#cb11-9" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-10"><a href="data.html#cb11-10" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Number of delistings&quot;</span>,</span>
<span id="cb11-11"><a href="data.html#cb11-11" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;month&quot;</span>,</span>
<span id="cb11-12"><a href="data.html#cb11-12" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Frequency&quot;</span></span>
<span id="cb11-13"><a href="data.html#cb11-13" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/months_of_delisting-1.png" width="672" /></p>
<p>Systematic seasonality of delistings is not observable.</p>
</div>
<div id="correlation-analysis" class="section level3 hasAnchor" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Correlation analysis<a href="data.html#correlation-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="data.html#cb12-1" tabindex="-1"></a>correlation.info <span class="ot">&lt;-</span> <span class="cf">function</span>(data, feature_identifier) {</span>
<span id="cb12-2"><a href="data.html#cb12-2" tabindex="-1"></a>  correlation.matrix <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="data.html#cb12-3" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(feature_identifier)) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="data.html#cb12-4" tabindex="-1"></a>    <span class="fu">cor</span>(<span class="at">x =</span> , <span class="at">use =</span> <span class="st">&quot;pairwise.complete.obs&quot;</span>, <span class="at">method =</span> <span class="st">&quot;pearson&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="data.html#cb12-5" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="data.html#cb12-6" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;rowname&quot;</span>)</span>
<span id="cb12-7"><a href="data.html#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="data.html#cb12-8" tabindex="-1"></a>  correlation.plot <span class="ot">&lt;-</span> correlation.matrix <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="data.html#cb12-9" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb12-10"><a href="data.html#cb12-10" tabindex="-1"></a>      <span class="at">cols =</span> <span class="sc">-</span>rowname,</span>
<span id="cb12-11"><a href="data.html#cb12-11" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">&quot;rowname1&quot;</span>,</span>
<span id="cb12-12"><a href="data.html#cb12-12" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">&quot;correlation&quot;</span></span>
<span id="cb12-13"><a href="data.html#cb12-13" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="data.html#cb12-14" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(rowname, rowname1, <span class="at">fill =</span> correlation)) <span class="sc">+</span></span>
<span id="cb12-15"><a href="data.html#cb12-15" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb12-16"><a href="data.html#cb12-16" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb12-17"><a href="data.html#cb12-17" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">high =</span> <span class="st">&quot;red&quot;</span>, <span class="at">mid =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb12-18"><a href="data.html#cb12-18" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">space =</span> <span class="st">&quot;Lab&quot;</span>,</span>
<span id="cb12-19"><a href="data.html#cb12-19" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;Pearson</span><span class="sc">\n</span><span class="st">Correlation&quot;</span></span>
<span id="cb12-20"><a href="data.html#cb12-20" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb12-21"><a href="data.html#cb12-21" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb12-22"><a href="data.html#cb12-22" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Correlation Matrix&quot;</span>,</span>
<span id="cb12-23"><a href="data.html#cb12-23" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb12-24"><a href="data.html#cb12-24" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb12-25"><a href="data.html#cb12-25" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb12-26"><a href="data.html#cb12-26" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb12-27"><a href="data.html#cb12-27" tabindex="-1"></a>      <span class="at">aspect.ratio =</span> <span class="dv">1</span>,</span>
<span id="cb12-28"><a href="data.html#cb12-28" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb12-29"><a href="data.html#cb12-29" tabindex="-1"></a>    )</span>
<span id="cb12-30"><a href="data.html#cb12-30" tabindex="-1"></a></span>
<span id="cb12-31"><a href="data.html#cb12-31" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">matrix =</span> correlation.matrix, <span class="at">plot =</span> correlation.plot))</span>
<span id="cb12-32"><a href="data.html#cb12-32" tabindex="-1"></a>}</span>
<span id="cb12-33"><a href="data.html#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="data.html#cb12-34" tabindex="-1"></a>correlation.info.initial <span class="ot">&lt;-</span> <span class="fu">correlation.info</span>(com, com.features.fin<span class="sc">$</span>identifier)</span>
<span id="cb12-35"><a href="data.html#cb12-35" tabindex="-1"></a>correlation.info.initial<span class="sc">$</span>plot</span></code></pre></div>
<p><img src="_main_files/figure-html/correlation_analysis-1.png" width="672" /></p>
<p>The majority of features is not correlated with a Pearson’s correlation coefficient of around 0. The operative profit
margin ratios <code>opmad</code> and <code>opmbd</code> as well as the liquidity ratios <code>curr_ratio</code> and <code>quick_ratio</code> are perfectly positively correlated. The correlation coefficient between the debt ratios <code>debt_assets</code> and <code>debt_at</code> is 0.76. The remaining correlation coefficients are all lower than 0.75. Therefore, the next chunk searches all pairwise correlations and removes one of the pairs if its absolute value is higher than the <code>CORRELATION_THRESHOLD</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="data.html#cb13-1" tabindex="-1"></a><span class="co"># winsorize features</span></span>
<span id="cb13-2"><a href="data.html#cb13-2" tabindex="-1"></a>com.winsorized <span class="ot">&lt;-</span> <span class="fu">data.prepare.winsorize</span>(com, com.features.fin<span class="sc">$</span>identifier,</span>
<span id="cb13-3"><a href="data.html#cb13-3" tabindex="-1"></a>  <span class="at">lower_quantile_boundary =</span> <span class="fl">0.05</span>,</span>
<span id="cb13-4"><a href="data.html#cb13-4" tabindex="-1"></a>  <span class="at">upper_quantile_boundary =</span> <span class="fl">0.95</span></span>
<span id="cb13-5"><a href="data.html#cb13-5" tabindex="-1"></a>)</span>
<span id="cb13-6"><a href="data.html#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="data.html#cb13-7" tabindex="-1"></a>n_features <span class="ot">&lt;-</span> <span class="fu">length</span>(com.features.fin<span class="sc">$</span>identifier)</span>
<span id="cb13-8"><a href="data.html#cb13-8" tabindex="-1"></a>feature_indicators_to_remove <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb13-9"><a href="data.html#cb13-9" tabindex="-1"></a><span class="co"># check features mutually if they meet CORRELATION_THRESHOLD and remove one of them</span></span>
<span id="cb13-10"><a href="data.html#cb13-10" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(n_features <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb13-11"><a href="data.html#cb13-11" tabindex="-1"></a>  feature_identifier_i <span class="ot">&lt;-</span> com.features.fin<span class="sc">$</span>identifier[i]</span>
<span id="cb13-12"><a href="data.html#cb13-12" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> (i <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n_features) {</span>
<span id="cb13-13"><a href="data.html#cb13-13" tabindex="-1"></a>    feature_identifier_j <span class="ot">&lt;-</span> com.features.fin<span class="sc">$</span>identifier[j]</span>
<span id="cb13-14"><a href="data.html#cb13-14" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">abs</span>(correlation.info.initial<span class="sc">$</span>matrix[i, j <span class="sc">+</span> <span class="dv">1</span>]) <span class="sc">&gt;=</span> CORRELATION_THRESHOLD) {</span>
<span id="cb13-15"><a href="data.html#cb13-15" tabindex="-1"></a>      <span class="co"># scatter plot of correlated features &gt; truncation tbd</span></span>
<span id="cb13-16"><a href="data.html#cb13-16" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">ggplot</span>(com.winsorized, <span class="fu">aes_string</span>(<span class="at">x =</span> feature_identifier_i, <span class="at">y =</span> feature_identifier_j)) <span class="sc">+</span></span>
<span id="cb13-17"><a href="data.html#cb13-17" tabindex="-1"></a>        <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-18"><a href="data.html#cb13-18" tabindex="-1"></a>        <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb13-19"><a href="data.html#cb13-19" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">&quot;Scatterplot of&quot;</span>, feature_identifier_i, <span class="st">&quot;vs&quot;</span>, feature_identifier_j)))</span>
<span id="cb13-20"><a href="data.html#cb13-20" tabindex="-1"></a></span>
<span id="cb13-21"><a href="data.html#cb13-21" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste0</span>(</span>
<span id="cb13-22"><a href="data.html#cb13-22" tabindex="-1"></a>        <span class="st">&quot;Correlation between features &quot;</span>, feature_identifier_i,</span>
<span id="cb13-23"><a href="data.html#cb13-23" tabindex="-1"></a>        <span class="st">&quot; and &quot;</span>, feature_identifier_j, <span class="st">&quot; is &quot;</span>,</span>
<span id="cb13-24"><a href="data.html#cb13-24" tabindex="-1"></a>        <span class="fu">formatC</span>(correlation.info.initial<span class="sc">$</span>matrix[i, j <span class="sc">+</span> <span class="dv">1</span>], <span class="at">digits =</span> <span class="dv">4</span>),</span>
<span id="cb13-25"><a href="data.html#cb13-25" tabindex="-1"></a>        <span class="st">&quot;. Therefore, feature &quot;</span>, feature_identifier_j, <span class="st">&quot; will be removed in further analyses.&quot;</span></span>
<span id="cb13-26"><a href="data.html#cb13-26" tabindex="-1"></a>      ))</span>
<span id="cb13-27"><a href="data.html#cb13-27" tabindex="-1"></a></span>
<span id="cb13-28"><a href="data.html#cb13-28" tabindex="-1"></a>      feature_indicators_to_remove <span class="ot">&lt;-</span> <span class="fu">c</span>(feature_indicators_to_remove, feature_identifier_j)</span>
<span id="cb13-29"><a href="data.html#cb13-29" tabindex="-1"></a>    }</span>
<span id="cb13-30"><a href="data.html#cb13-30" tabindex="-1"></a>  }</span>
<span id="cb13-31"><a href="data.html#cb13-31" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/correlated_features_detect_removals-1.png" width="672" /></p>
<pre><code>## [1] &quot;Correlation between features curr_ratio and quick_ratio is 0.9965. Therefore, feature quick_ratio will be removed in further analyses.&quot;</code></pre>
<p><img src="_main_files/figure-html/correlated_features_detect_removals-2.png" width="672" /></p>
<pre><code>## [1] &quot;Correlation between features opmad and opmbd is     1. Therefore, feature opmbd will be removed in further analyses.&quot;</code></pre>
<p><img src="_main_files/figure-html/correlated_features_detect_removals-3.png" width="672" /></p>
<pre><code>## [1] &quot;Correlation between features debt_assets and debt_at is 0.7643. Therefore, feature debt_at will be removed in further analyses.&quot;</code></pre>
<p>The two scatterplots of the highly correlated (winsorized) features <code>opmad</code> and <code>opmbd</code> as well as <code>curr_ratio</code> and <code>quick_ratio</code> confirm linear relationship between them. The scatterplot between <code>debt_assets</code> and <code>debt_at</code> shows non-linear structures for higher values.</p>
</div>
<div id="summary-statistics-for-features" class="section level3 hasAnchor" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Summary statistics for features<a href="data.html#summary-statistics-for-features" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="data.html#cb17-1" tabindex="-1"></a>com.summary <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="data.html#cb17-2" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb17-3"><a href="data.html#cb17-3" tabindex="-1"></a>    <span class="at">cols =</span> com.features.fin<span class="sc">$</span>identifier,</span>
<span id="cb17-4"><a href="data.html#cb17-4" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;feature&quot;</span>,</span>
<span id="cb17-5"><a href="data.html#cb17-5" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb17-6"><a href="data.html#cb17-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="data.html#cb17-7" tabindex="-1"></a>  <span class="fu">group_by</span>(feature) <span class="sc">%&gt;%</span></span>
<span id="cb17-8"><a href="data.html#cb17-8" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb17-9"><a href="data.html#cb17-9" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">min</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-10"><a href="data.html#cb17-10" tabindex="-1"></a>    <span class="at">quantile1 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.01</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-11"><a href="data.html#cb17-11" tabindex="-1"></a>    <span class="at">quantile25 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-12"><a href="data.html#cb17-12" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-13"><a href="data.html#cb17-13" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-14"><a href="data.html#cb17-14" tabindex="-1"></a>    <span class="at">quantile75 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-15"><a href="data.html#cb17-15" tabindex="-1"></a>    <span class="at">quantile99 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-16"><a href="data.html#cb17-16" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">max</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-17"><a href="data.html#cb17-17" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb17-18"><a href="data.html#cb17-18" tabindex="-1"></a>  )</span>
<span id="cb17-19"><a href="data.html#cb17-19" tabindex="-1"></a></span>
<span id="cb17-20"><a href="data.html#cb17-20" tabindex="-1"></a><span class="fu">pander</span>(com.summary)</span></code></pre></div>
<table>
<caption>Table continues below</caption>
<colgroup>
<col width="20%" />
<col width="16%" />
<col width="15%" />
<col width="16%" />
<col width="12%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">feature</th>
<th align="center">min</th>
<th align="center">quantile1</th>
<th align="center">quantile25</th>
<th align="center">median</th>
<th align="center">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">aftret_eq</td>
<td align="center">-19953</td>
<td align="center">-5.571</td>
<td align="center">-0.1625</td>
<td align="center">0.06951</td>
<td align="center">-0.1111</td>
</tr>
<tr class="even">
<td align="center">aftret_equity</td>
<td align="center">-3462</td>
<td align="center">-5.028</td>
<td align="center">-0.1707</td>
<td align="center">0.06657</td>
<td align="center">-0.03336</td>
</tr>
<tr class="odd">
<td align="center">at_turn</td>
<td align="center">1.864e-17</td>
<td align="center">0.007323</td>
<td align="center">0.3119</td>
<td align="center">0.8545</td>
<td align="center">1.052</td>
</tr>
<tr class="even">
<td align="center">capital_ratio</td>
<td align="center">-1730</td>
<td align="center">0</td>
<td align="center">0.01598</td>
<td align="center">0.2046</td>
<td align="center">0.2998</td>
</tr>
<tr class="odd">
<td align="center">cash_ratio</td>
<td align="center">-0.1999</td>
<td align="center">0.002325</td>
<td align="center">0.1199</td>
<td align="center">0.4543</td>
<td align="center">2.087</td>
</tr>
<tr class="even">
<td align="center">curr_ratio</td>
<td align="center">-0.002398</td>
<td align="center">0.2088</td>
<td align="center">1.314</td>
<td align="center">2.048</td>
<td align="center">3.513</td>
</tr>
<tr class="odd">
<td align="center">de_ratio</td>
<td align="center">-43363</td>
<td align="center">-12.28</td>
<td align="center">0.4065</td>
<td align="center">1.052</td>
<td align="center">2.455</td>
</tr>
<tr class="even">
<td align="center">debt_assets</td>
<td align="center">0</td>
<td align="center">0.03813</td>
<td align="center">0.3243</td>
<td align="center">0.5387</td>
<td align="center">0.5883</td>
</tr>
<tr class="odd">
<td align="center">debt_at</td>
<td align="center">-0.000114</td>
<td align="center">0</td>
<td align="center">0.04189</td>
<td align="center">0.1809</td>
<td align="center">0.2523</td>
</tr>
<tr class="even">
<td align="center">gpm</td>
<td align="center">-29326</td>
<td align="center">-30</td>
<td align="center">0.1836</td>
<td align="center">0.3323</td>
<td align="center">-4.023</td>
</tr>
<tr class="odd">
<td align="center">inv_turn</td>
<td align="center">-49.38</td>
<td align="center">0.09632</td>
<td align="center">2.612</td>
<td align="center">4.87</td>
<td align="center">49.23</td>
</tr>
<tr class="even">
<td align="center">opmad</td>
<td align="center">-1.91e+16</td>
<td align="center">-54.76</td>
<td align="center">-0.05254</td>
<td align="center">0.05746</td>
<td align="center">-5.159e+10</td>
</tr>
<tr class="odd">
<td align="center">opmbd</td>
<td align="center">-1.845e+16</td>
<td align="center">-52.46</td>
<td align="center">-0.005601</td>
<td align="center">0.0922</td>
<td align="center">-4.984e+10</td>
</tr>
<tr class="even">
<td align="center">pay_turn</td>
<td align="center">-49450</td>
<td align="center">-0.03247</td>
<td align="center">3.834</td>
<td align="center">8.089</td>
<td align="center">22.27</td>
</tr>
<tr class="odd">
<td align="center">pe_exi</td>
<td align="center">-2375</td>
<td align="center">-446.3</td>
<td align="center">-4.186</td>
<td align="center">8.391</td>
<td align="center">0.1431</td>
</tr>
<tr class="even">
<td align="center">quick_ratio</td>
<td align="center">-0.02353</td>
<td align="center">0.1265</td>
<td align="center">0.8619</td>
<td align="center">1.409</td>
<td align="center">2.914</td>
</tr>
<tr class="odd">
<td align="center">rect_turn</td>
<td align="center">9.09e-17</td>
<td align="center">0.05799</td>
<td align="center">3.777</td>
<td align="center">6.044</td>
<td align="center">21.52</td>
</tr>
<tr class="even">
<td align="center">roa</td>
<td align="center">-1315</td>
<td align="center">-1.373</td>
<td align="center">-0.01829</td>
<td align="center">0.07031</td>
<td align="center">-0.02089</td>
</tr>
<tr class="odd">
<td align="center">roe</td>
<td align="center">-15951</td>
<td align="center">-4.396</td>
<td align="center">-0.153</td>
<td align="center">0.0631</td>
<td align="center">3.573</td>
</tr>
</tbody>
</table>
<table style="width:49%;">
<colgroup>
<col width="18%" />
<col width="18%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">quantile75</th>
<th align="center">quantile99</th>
<th align="center">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.1617</td>
<td align="center">3.877</td>
<td align="center">21775</td>
</tr>
<tr class="even">
<td align="center">0.1576</td>
<td align="center">3.06</td>
<td align="center">21775</td>
</tr>
<tr class="odd">
<td align="center">1.496</td>
<td align="center">4.368</td>
<td align="center">543</td>
</tr>
<tr class="even">
<td align="center">0.4508</td>
<td align="center">1.518</td>
<td align="center">6722</td>
</tr>
<tr class="odd">
<td align="center">1.542</td>
<td align="center">23.19</td>
<td align="center">9084</td>
</tr>
<tr class="even">
<td align="center">3.406</td>
<td align="center">25.09</td>
<td align="center">1584</td>
</tr>
<tr class="odd">
<td align="center">2.532</td>
<td align="center">25.24</td>
<td align="center">56626</td>
</tr>
<tr class="even">
<td align="center">0.7523</td>
<td align="center">1.538</td>
<td align="center">937.5</td>
</tr>
<tr class="odd">
<td align="center">0.3639</td>
<td align="center">1.022</td>
<td align="center">496.5</td>
</tr>
<tr class="even">
<td align="center">0.5261</td>
<td align="center">0.9464</td>
<td align="center">2.628</td>
</tr>
<tr class="odd">
<td align="center">12.41</td>
<td align="center">420.9</td>
<td align="center">581233</td>
</tr>
<tr class="even">
<td align="center">0.1455</td>
<td align="center">0.5756</td>
<td align="center">37.45</td>
</tr>
<tr class="odd">
<td align="center">0.1991</td>
<td align="center">0.6589</td>
<td align="center">37.45</td>
</tr>
<tr class="even">
<td align="center">13.68</td>
<td align="center">87.48</td>
<td align="center">878016</td>
</tr>
<tr class="odd">
<td align="center">19.31</td>
<td align="center">299.6</td>
<td align="center">722.5</td>
</tr>
<tr class="even">
<td align="center">2.614</td>
<td align="center">24.36</td>
<td align="center">1584</td>
</tr>
<tr class="odd">
<td align="center">9.207</td>
<td align="center">205.8</td>
<td align="center">702131</td>
</tr>
<tr class="even">
<td align="center">0.1539</td>
<td align="center">0.4779</td>
<td align="center">102</td>
</tr>
<tr class="odd">
<td align="center">0.1482</td>
<td align="center">1.111</td>
<td align="center">377126</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="data.html#cb18-1" tabindex="-1"></a><span class="co"># qq-plots for features</span></span>
<span id="cb18-2"><a href="data.html#cb18-2" tabindex="-1"></a>com <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="data.html#cb18-3" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb18-4"><a href="data.html#cb18-4" tabindex="-1"></a>    <span class="at">cols =</span> com.features.fin<span class="sc">$</span>identifier,</span>
<span id="cb18-5"><a href="data.html#cb18-5" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;feature&quot;</span>,</span>
<span id="cb18-6"><a href="data.html#cb18-6" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb18-7"><a href="data.html#cb18-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="data.html#cb18-8" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb18-9"><a href="data.html#cb18-9" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb18-10"><a href="data.html#cb18-10" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>feature, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/features_qqplot-1.png" width="672" /></p>
<p>The summary table and boxplots show that the features <span class="math inline">\(\texttt{inv_turn}\)</span>, <span class="math inline">\(\texttt{opmad}\)</span>, <span class="math inline">\(\texttt{opmbd}\)</span> and <span class="math inline">\(\texttt{rect_turn}\)</span> and <span class="math inline">\(\texttt{roe}\)</span> contain extremely large values in absolute values.</p>
<!-- **BENGAL OIL & GAS CORP (1982)**: No financial data for 1982 found on the internet
- **LINEAGE CELL THERAPEUTICS INC (2017)**: Cost of Goods Sold = ; Average Inventories (of most recent two years) = -->
</div>
<div id="features-and-delisting-frequency" class="section level3 hasAnchor" number="2.2.4">
<h3><span class="header-section-number">2.2.4</span> Features and delisting frequency<a href="data.html#features-and-delisting-frequency" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following histograms show for each feature in the data set the number of data rows that fall in a specific range in gray (x-axis). The blue bars represent the number of financial ratio rows in a specific range that belong to a company which delisted in the subsequent year (gap of three month included). For example, if a company was delisted in April 2002, then the financial ratios from January 2001 to January 2002 would be attributed to the blue bar. The ratio between the blue and gray bar, named relative delisting frequency, is displayed by the orange points and a corresponding smoothed line (method <code>LOESS</code> with tri-cubic kernel). The right y-axis is the scale for the relative frequency values. The feature values are winsorized at the 5% and 95% quantile.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="data.html#cb19-1" tabindex="-1"></a><span class="co">#&#39; creates a histogram of features vs delisting frequency</span></span>
<span id="cb19-2"><a href="data.html#cb19-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb19-3"><a href="data.html#cb19-3" tabindex="-1"></a><span class="co">#&#39; @param data tibble containing financial ratios for companies with a column</span></span>
<span id="cb19-4"><a href="data.html#cb19-4" tabindex="-1"></a><span class="co">#&#39;             named feature_identifier and years_to_delisting</span></span>
<span id="cb19-5"><a href="data.html#cb19-5" tabindex="-1"></a><span class="co">#&#39; @param feature_identifier technical identifier of feature of interest</span></span>
<span id="cb19-6"><a href="data.html#cb19-6" tabindex="-1"></a><span class="co">#&#39; @param feature_description readable name of feature for title</span></span>
<span id="cb19-7"><a href="data.html#cb19-7" tabindex="-1"></a><span class="co">#&#39; @param marginal.data vector of predicted delistings</span></span>
<span id="cb19-8"><a href="data.html#cb19-8" tabindex="-1"></a><span class="co">#&#39; @param marginal.legend legend for marginal plots</span></span>
<span id="cb19-9"><a href="data.html#cb19-9" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb19-10"><a href="data.html#cb19-10" tabindex="-1"></a><span class="co">#&#39; @return histogram of fincancial ratio features with up to two smoothed</span></span>
<span id="cb19-11"><a href="data.html#cb19-11" tabindex="-1"></a><span class="co">#&#39;         relative delisting frequencies</span></span>
<span id="cb19-12"><a href="data.html#cb19-12" tabindex="-1"></a>hist_delisting_frequency <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb19-13"><a href="data.html#cb19-13" tabindex="-1"></a>    data,</span>
<span id="cb19-14"><a href="data.html#cb19-14" tabindex="-1"></a>    feature_identifier,</span>
<span id="cb19-15"><a href="data.html#cb19-15" tabindex="-1"></a>    feature_description,</span>
<span id="cb19-16"><a href="data.html#cb19-16" tabindex="-1"></a>    <span class="at">marginal.data =</span> <span class="cn">NULL</span>, <span class="at">marginal.legend =</span> <span class="st">&quot;Modeled delisting frequency&quot;</span>,</span>
<span id="cb19-17"><a href="data.html#cb19-17" tabindex="-1"></a>    <span class="at">marginal.data2 =</span> <span class="cn">NULL</span>, <span class="at">marginal.legend2 =</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb19-18"><a href="data.html#cb19-18" tabindex="-1"></a>  feature <span class="ot">&lt;-</span> data[[feature_identifier]] <span class="co"># first column</span></span>
<span id="cb19-19"><a href="data.html#cb19-19" tabindex="-1"></a>  years_to_delisting <span class="ot">&lt;-</span> data<span class="sc">$</span>years_to_delisting <span class="co"># first column</span></span>
<span id="cb19-20"><a href="data.html#cb19-20" tabindex="-1"></a>  max_x <span class="ot">&lt;-</span> <span class="fu">max</span>(feature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-21"><a href="data.html#cb19-21" tabindex="-1"></a>  min_x <span class="ot">&lt;-</span> <span class="fu">min</span>(feature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-22"><a href="data.html#cb19-22" tabindex="-1"></a>  n_bins <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb19-23"><a href="data.html#cb19-23" tabindex="-1"></a>  bin_boundaries <span class="ot">&lt;-</span> <span class="fu">seq</span>(min_x, max_x, <span class="at">length.out =</span> n_bins <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb19-24"><a href="data.html#cb19-24" tabindex="-1"></a>  bin_width <span class="ot">&lt;-</span> bin_boundaries[<span class="dv">2</span>] <span class="sc">-</span> bin_boundaries[<span class="dv">1</span>]</span>
<span id="cb19-25"><a href="data.html#cb19-25" tabindex="-1"></a></span>
<span id="cb19-26"><a href="data.html#cb19-26" tabindex="-1"></a>  plot.data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-27"><a href="data.html#cb19-27" tabindex="-1"></a>    <span class="at">feature =</span> feature,</span>
<span id="cb19-28"><a href="data.html#cb19-28" tabindex="-1"></a>    <span class="at">years_to_delisting =</span> years_to_delisting,</span>
<span id="cb19-29"><a href="data.html#cb19-29" tabindex="-1"></a>    <span class="at">feature_bin_index =</span> <span class="fu">findInterval</span>(feature, bin_boundaries),</span>
<span id="cb19-30"><a href="data.html#cb19-30" tabindex="-1"></a>    <span class="at">bin_centers =</span> bin_boundaries[<span class="dv">1</span>] <span class="sc">+</span> bin_width <span class="sc">*</span> (feature_bin_index <span class="sc">-</span> <span class="fl">1.5</span>)</span>
<span id="cb19-31"><a href="data.html#cb19-31" tabindex="-1"></a>  )</span>
<span id="cb19-32"><a href="data.html#cb19-32" tabindex="-1"></a></span>
<span id="cb19-33"><a href="data.html#cb19-33" tabindex="-1"></a>  <span class="co"># compute points</span></span>
<span id="cb19-34"><a href="data.html#cb19-34" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(marginal.data)) {</span>
<span id="cb19-35"><a href="data.html#cb19-35" tabindex="-1"></a>    marginal.data <span class="ot">&lt;-</span> plot.data <span class="sc">%&gt;%</span></span>
<span id="cb19-36"><a href="data.html#cb19-36" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">pred =</span> marginal.data) <span class="sc">%&gt;%</span></span>
<span id="cb19-37"><a href="data.html#cb19-37" tabindex="-1"></a>      <span class="fu">group_by</span>(bin_centers) <span class="sc">%&gt;%</span></span>
<span id="cb19-38"><a href="data.html#cb19-38" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">relative_frequency_delisting_pred =</span> <span class="fu">mean</span>(pred)) <span class="sc">%&gt;%</span></span>
<span id="cb19-39"><a href="data.html#cb19-39" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">x =</span> bin_centers, <span class="at">yhat =</span> relative_frequency_delisting_pred)</span>
<span id="cb19-40"><a href="data.html#cb19-40" tabindex="-1"></a>  }</span>
<span id="cb19-41"><a href="data.html#cb19-41" tabindex="-1"></a></span>
<span id="cb19-42"><a href="data.html#cb19-42" tabindex="-1"></a>  <span class="co"># compute points</span></span>
<span id="cb19-43"><a href="data.html#cb19-43" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(marginal.data2)) {</span>
<span id="cb19-44"><a href="data.html#cb19-44" tabindex="-1"></a>    marginal.data2 <span class="ot">&lt;-</span> plot.data <span class="sc">%&gt;%</span></span>
<span id="cb19-45"><a href="data.html#cb19-45" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">pred =</span> marginal.data2) <span class="sc">%&gt;%</span></span>
<span id="cb19-46"><a href="data.html#cb19-46" tabindex="-1"></a>      <span class="fu">group_by</span>(bin_centers) <span class="sc">%&gt;%</span></span>
<span id="cb19-47"><a href="data.html#cb19-47" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">relative_frequency_delisting_pred =</span> <span class="fu">mean</span>(pred)) <span class="sc">%&gt;%</span></span>
<span id="cb19-48"><a href="data.html#cb19-48" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">x =</span> bin_centers, <span class="at">yhat =</span> relative_frequency_delisting_pred)</span>
<span id="cb19-49"><a href="data.html#cb19-49" tabindex="-1"></a>  }</span>
<span id="cb19-50"><a href="data.html#cb19-50" tabindex="-1"></a></span>
<span id="cb19-51"><a href="data.html#cb19-51" tabindex="-1"></a>  <span class="co"># max of first y axis</span></span>
<span id="cb19-52"><a href="data.html#cb19-52" tabindex="-1"></a>  max_y_first <span class="ot">&lt;-</span> plot.data <span class="sc">%&gt;%</span></span>
<span id="cb19-53"><a href="data.html#cb19-53" tabindex="-1"></a>    <span class="fu">group_by</span>(feature_bin_index) <span class="sc">%&gt;%</span></span>
<span id="cb19-54"><a href="data.html#cb19-54" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">frequency =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb19-55"><a href="data.html#cb19-55" tabindex="-1"></a>    <span class="fu">select</span>(frequency) <span class="sc">%&gt;%</span></span>
<span id="cb19-56"><a href="data.html#cb19-56" tabindex="-1"></a>    <span class="fu">max</span>()</span>
<span id="cb19-57"><a href="data.html#cb19-57" tabindex="-1"></a>  max_y_second <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="co"># max of second y axis</span></span>
<span id="cb19-58"><a href="data.html#cb19-58" tabindex="-1"></a>  min_y_first <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># min of first y axis</span></span>
<span id="cb19-59"><a href="data.html#cb19-59" tabindex="-1"></a>  min_y_second <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># min of second y axis</span></span>
<span id="cb19-60"><a href="data.html#cb19-60" tabindex="-1"></a></span>
<span id="cb19-61"><a href="data.html#cb19-61" tabindex="-1"></a>  <span class="co"># scale and shift variables calculated based on desired mins and maxes</span></span>
<span id="cb19-62"><a href="data.html#cb19-62" tabindex="-1"></a>  scale <span class="ot">&lt;-</span> (max_y_second <span class="sc">-</span> min_y_second) <span class="sc">/</span> (max_y_first <span class="sc">-</span> min_y_first)</span>
<span id="cb19-63"><a href="data.html#cb19-63" tabindex="-1"></a>  shift <span class="ot">&lt;-</span> min_y_first <span class="sc">-</span> min_y_second</span>
<span id="cb19-64"><a href="data.html#cb19-64" tabindex="-1"></a></span>
<span id="cb19-65"><a href="data.html#cb19-65" tabindex="-1"></a>  com.frequency_delisting <span class="ot">&lt;-</span> plot.data <span class="sc">%&gt;%</span></span>
<span id="cb19-66"><a href="data.html#cb19-66" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">delisting_indicator =</span> <span class="fu">determine_delisting_property</span>(years_to_delisting)) <span class="sc">%&gt;%</span></span>
<span id="cb19-67"><a href="data.html#cb19-67" tabindex="-1"></a>    <span class="fu">group_by</span>(bin_centers) <span class="sc">%&gt;%</span></span>
<span id="cb19-68"><a href="data.html#cb19-68" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb19-69"><a href="data.html#cb19-69" tabindex="-1"></a>      <span class="at">frequency =</span> <span class="fu">n</span>(),</span>
<span id="cb19-70"><a href="data.html#cb19-70" tabindex="-1"></a>      <span class="at">frequency_delisting =</span> <span class="fu">sum</span>(delisting_indicator)</span>
<span id="cb19-71"><a href="data.html#cb19-71" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb19-72"><a href="data.html#cb19-72" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">relative_frequency_delisting =</span> frequency_delisting <span class="sc">/</span> frequency)</span>
<span id="cb19-73"><a href="data.html#cb19-73" tabindex="-1"></a></span>
<span id="cb19-74"><a href="data.html#cb19-74" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot.data) <span class="sc">+</span></span>
<span id="cb19-75"><a href="data.html#cb19-75" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(</span>
<span id="cb19-76"><a href="data.html#cb19-76" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">x =</span> feature, <span class="at">color =</span> <span class="st">&quot;Absolute frequency&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;Absolute frequency&quot;</span>),</span>
<span id="cb19-77"><a href="data.html#cb19-77" tabindex="-1"></a>      <span class="at">binwidth =</span> bin_width</span>
<span id="cb19-78"><a href="data.html#cb19-78" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb19-79"><a href="data.html#cb19-79" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(</span>
<span id="cb19-80"><a href="data.html#cb19-80" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb19-81"><a href="data.html#cb19-81" tabindex="-1"></a>        <span class="at">x =</span> feature <span class="sc">*</span> <span class="fu">ifelse</span>(<span class="fu">determine_delisting_property</span>(years_to_delisting), <span class="dv">1</span>, <span class="cn">NA</span>),</span>
<span id="cb19-82"><a href="data.html#cb19-82" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;Absolute delisting frequency&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;Absolute delisting frequency&quot;</span></span>
<span id="cb19-83"><a href="data.html#cb19-83" tabindex="-1"></a>      ),</span>
<span id="cb19-84"><a href="data.html#cb19-84" tabindex="-1"></a>      <span class="at">binwidth =</span> bin_width</span>
<span id="cb19-85"><a href="data.html#cb19-85" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb19-86"><a href="data.html#cb19-86" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb19-87"><a href="data.html#cb19-87" tabindex="-1"></a>      <span class="at">data =</span> com.frequency_delisting,</span>
<span id="cb19-88"><a href="data.html#cb19-88" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-89"><a href="data.html#cb19-89" tabindex="-1"></a>        <span class="at">x =</span> bin_centers, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(relative_frequency_delisting, scale, shift),</span>
<span id="cb19-90"><a href="data.html#cb19-90" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;Relative delisting frequency&quot;</span></span>
<span id="cb19-91"><a href="data.html#cb19-91" tabindex="-1"></a>      )</span>
<span id="cb19-92"><a href="data.html#cb19-92" tabindex="-1"></a>    )</span>
<span id="cb19-93"><a href="data.html#cb19-93" tabindex="-1"></a></span>
<span id="cb19-94"><a href="data.html#cb19-94" tabindex="-1"></a>  <span class="cf">if</span> (feature_identifier <span class="sc">==</span> <span class="st">&quot;pe_exi&quot;</span>) {</span>
<span id="cb19-95"><a href="data.html#cb19-95" tabindex="-1"></a>    plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">geom_smooth</span>(</span>
<span id="cb19-96"><a href="data.html#cb19-96" tabindex="-1"></a>      <span class="at">data =</span> com.frequency_delisting <span class="sc">%&gt;%</span> <span class="fu">filter</span>(bin_centers <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb19-97"><a href="data.html#cb19-97" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">&quot;loess&quot;</span>,</span>
<span id="cb19-98"><a href="data.html#cb19-98" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-99"><a href="data.html#cb19-99" tabindex="-1"></a>        <span class="at">x =</span> bin_centers, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(relative_frequency_delisting, scale, shift),</span>
<span id="cb19-100"><a href="data.html#cb19-100" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;Relative delisting frequency&quot;</span></span>
<span id="cb19-101"><a href="data.html#cb19-101" tabindex="-1"></a>      )</span>
<span id="cb19-102"><a href="data.html#cb19-102" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb19-103"><a href="data.html#cb19-103" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(</span>
<span id="cb19-104"><a href="data.html#cb19-104" tabindex="-1"></a>        <span class="at">data =</span> com.frequency_delisting <span class="sc">%&gt;%</span> <span class="fu">filter</span>(bin_centers <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb19-105"><a href="data.html#cb19-105" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-106"><a href="data.html#cb19-106" tabindex="-1"></a>          <span class="at">x =</span> bin_centers, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(relative_frequency_delisting, scale, shift),</span>
<span id="cb19-107"><a href="data.html#cb19-107" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;Relative delisting frequency&quot;</span></span>
<span id="cb19-108"><a href="data.html#cb19-108" tabindex="-1"></a>        )</span>
<span id="cb19-109"><a href="data.html#cb19-109" tabindex="-1"></a>      )</span>
<span id="cb19-110"><a href="data.html#cb19-110" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(marginal.data)) {</span>
<span id="cb19-111"><a href="data.html#cb19-111" tabindex="-1"></a>      plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb19-112"><a href="data.html#cb19-112" tabindex="-1"></a>        <span class="at">data =</span> marginal.data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb19-113"><a href="data.html#cb19-113" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-114"><a href="data.html#cb19-114" tabindex="-1"></a>          <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-115"><a href="data.html#cb19-115" tabindex="-1"></a>          <span class="at">color =</span> marginal.legend</span>
<span id="cb19-116"><a href="data.html#cb19-116" tabindex="-1"></a>        )</span>
<span id="cb19-117"><a href="data.html#cb19-117" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb19-118"><a href="data.html#cb19-118" tabindex="-1"></a>        <span class="fu">geom_smooth</span>(</span>
<span id="cb19-119"><a href="data.html#cb19-119" tabindex="-1"></a>          <span class="at">data =</span> marginal.data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb19-120"><a href="data.html#cb19-120" tabindex="-1"></a>          <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-121"><a href="data.html#cb19-121" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-122"><a href="data.html#cb19-122" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-123"><a href="data.html#cb19-123" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend</span>
<span id="cb19-124"><a href="data.html#cb19-124" tabindex="-1"></a>          ), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb19-125"><a href="data.html#cb19-125" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb19-126"><a href="data.html#cb19-126" tabindex="-1"></a>        <span class="fu">geom_point</span>(</span>
<span id="cb19-127"><a href="data.html#cb19-127" tabindex="-1"></a>          <span class="at">data =</span> marginal.data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb19-128"><a href="data.html#cb19-128" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-129"><a href="data.html#cb19-129" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-130"><a href="data.html#cb19-130" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend</span>
<span id="cb19-131"><a href="data.html#cb19-131" tabindex="-1"></a>          )</span>
<span id="cb19-132"><a href="data.html#cb19-132" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb19-133"><a href="data.html#cb19-133" tabindex="-1"></a>        <span class="fu">geom_smooth</span>(</span>
<span id="cb19-134"><a href="data.html#cb19-134" tabindex="-1"></a>          <span class="at">data =</span> marginal.data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb19-135"><a href="data.html#cb19-135" tabindex="-1"></a>          <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-136"><a href="data.html#cb19-136" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-137"><a href="data.html#cb19-137" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-138"><a href="data.html#cb19-138" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend</span>
<span id="cb19-139"><a href="data.html#cb19-139" tabindex="-1"></a>          ), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb19-140"><a href="data.html#cb19-140" tabindex="-1"></a>        )</span>
<span id="cb19-141"><a href="data.html#cb19-141" tabindex="-1"></a>    }</span>
<span id="cb19-142"><a href="data.html#cb19-142" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(marginal.data2)) {</span>
<span id="cb19-143"><a href="data.html#cb19-143" tabindex="-1"></a>      plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb19-144"><a href="data.html#cb19-144" tabindex="-1"></a>        <span class="at">data =</span> marginal.data2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb19-145"><a href="data.html#cb19-145" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-146"><a href="data.html#cb19-146" tabindex="-1"></a>          <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-147"><a href="data.html#cb19-147" tabindex="-1"></a>          <span class="at">color =</span> marginal.legend2</span>
<span id="cb19-148"><a href="data.html#cb19-148" tabindex="-1"></a>        )</span>
<span id="cb19-149"><a href="data.html#cb19-149" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb19-150"><a href="data.html#cb19-150" tabindex="-1"></a>        <span class="fu">geom_smooth</span>(</span>
<span id="cb19-151"><a href="data.html#cb19-151" tabindex="-1"></a>          <span class="at">data =</span> marginal.data2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb19-152"><a href="data.html#cb19-152" tabindex="-1"></a>          <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-153"><a href="data.html#cb19-153" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-154"><a href="data.html#cb19-154" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-155"><a href="data.html#cb19-155" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend2</span>
<span id="cb19-156"><a href="data.html#cb19-156" tabindex="-1"></a>          ), <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb19-157"><a href="data.html#cb19-157" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb19-158"><a href="data.html#cb19-158" tabindex="-1"></a>        <span class="fu">geom_point</span>(</span>
<span id="cb19-159"><a href="data.html#cb19-159" tabindex="-1"></a>          <span class="at">data =</span> marginal.data2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb19-160"><a href="data.html#cb19-160" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-161"><a href="data.html#cb19-161" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-162"><a href="data.html#cb19-162" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend2</span>
<span id="cb19-163"><a href="data.html#cb19-163" tabindex="-1"></a>          )</span>
<span id="cb19-164"><a href="data.html#cb19-164" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb19-165"><a href="data.html#cb19-165" tabindex="-1"></a>        <span class="fu">geom_smooth</span>(</span>
<span id="cb19-166"><a href="data.html#cb19-166" tabindex="-1"></a>          <span class="at">data =</span> marginal.data2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb19-167"><a href="data.html#cb19-167" tabindex="-1"></a>          <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-168"><a href="data.html#cb19-168" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-169"><a href="data.html#cb19-169" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-170"><a href="data.html#cb19-170" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend2</span>
<span id="cb19-171"><a href="data.html#cb19-171" tabindex="-1"></a>          ), <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb19-172"><a href="data.html#cb19-172" tabindex="-1"></a>        )</span>
<span id="cb19-173"><a href="data.html#cb19-173" tabindex="-1"></a>    }</span>
<span id="cb19-174"><a href="data.html#cb19-174" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-175"><a href="data.html#cb19-175" tabindex="-1"></a>    plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">geom_smooth</span>(</span>
<span id="cb19-176"><a href="data.html#cb19-176" tabindex="-1"></a>      <span class="at">data =</span> com.frequency_delisting,</span>
<span id="cb19-177"><a href="data.html#cb19-177" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-178"><a href="data.html#cb19-178" tabindex="-1"></a>        <span class="at">x =</span> bin_centers, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(relative_frequency_delisting, scale, shift),</span>
<span id="cb19-179"><a href="data.html#cb19-179" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;Relative delisting frequency&quot;</span></span>
<span id="cb19-180"><a href="data.html#cb19-180" tabindex="-1"></a>      )</span>
<span id="cb19-181"><a href="data.html#cb19-181" tabindex="-1"></a>    )</span>
<span id="cb19-182"><a href="data.html#cb19-182" tabindex="-1"></a></span>
<span id="cb19-183"><a href="data.html#cb19-183" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(marginal.data)) {</span>
<span id="cb19-184"><a href="data.html#cb19-184" tabindex="-1"></a>      plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb19-185"><a href="data.html#cb19-185" tabindex="-1"></a>        <span class="at">data =</span> marginal.data,</span>
<span id="cb19-186"><a href="data.html#cb19-186" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-187"><a href="data.html#cb19-187" tabindex="-1"></a>          <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-188"><a href="data.html#cb19-188" tabindex="-1"></a>          <span class="at">color =</span> marginal.legend</span>
<span id="cb19-189"><a href="data.html#cb19-189" tabindex="-1"></a>        )</span>
<span id="cb19-190"><a href="data.html#cb19-190" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb19-191"><a href="data.html#cb19-191" tabindex="-1"></a>        <span class="fu">geom_smooth</span>(</span>
<span id="cb19-192"><a href="data.html#cb19-192" tabindex="-1"></a>          <span class="at">data =</span> marginal.data,</span>
<span id="cb19-193"><a href="data.html#cb19-193" tabindex="-1"></a>          <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-194"><a href="data.html#cb19-194" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-195"><a href="data.html#cb19-195" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-196"><a href="data.html#cb19-196" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend</span>
<span id="cb19-197"><a href="data.html#cb19-197" tabindex="-1"></a>          ), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb19-198"><a href="data.html#cb19-198" tabindex="-1"></a>        )</span>
<span id="cb19-199"><a href="data.html#cb19-199" tabindex="-1"></a>    }</span>
<span id="cb19-200"><a href="data.html#cb19-200" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(marginal.data2)) {</span>
<span id="cb19-201"><a href="data.html#cb19-201" tabindex="-1"></a>      plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb19-202"><a href="data.html#cb19-202" tabindex="-1"></a>        <span class="at">data =</span> marginal.data2,</span>
<span id="cb19-203"><a href="data.html#cb19-203" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-204"><a href="data.html#cb19-204" tabindex="-1"></a>          <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-205"><a href="data.html#cb19-205" tabindex="-1"></a>          <span class="at">color =</span> marginal.legend2</span>
<span id="cb19-206"><a href="data.html#cb19-206" tabindex="-1"></a>        )</span>
<span id="cb19-207"><a href="data.html#cb19-207" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb19-208"><a href="data.html#cb19-208" tabindex="-1"></a>        <span class="fu">geom_smooth</span>(</span>
<span id="cb19-209"><a href="data.html#cb19-209" tabindex="-1"></a>          <span class="at">data =</span> marginal.data2,</span>
<span id="cb19-210"><a href="data.html#cb19-210" tabindex="-1"></a>          <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-211"><a href="data.html#cb19-211" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb19-212"><a href="data.html#cb19-212" tabindex="-1"></a>            <span class="at">x =</span> x, <span class="at">y =</span> <span class="fu">inv_scale_function</span>(yhat, scale, shift),</span>
<span id="cb19-213"><a href="data.html#cb19-213" tabindex="-1"></a>            <span class="at">color =</span> marginal.legend2</span>
<span id="cb19-214"><a href="data.html#cb19-214" tabindex="-1"></a>          ), <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb19-215"><a href="data.html#cb19-215" tabindex="-1"></a>        )</span>
<span id="cb19-216"><a href="data.html#cb19-216" tabindex="-1"></a>    }</span>
<span id="cb19-217"><a href="data.html#cb19-217" tabindex="-1"></a>  }</span>
<span id="cb19-218"><a href="data.html#cb19-218" tabindex="-1"></a></span>
<span id="cb19-219"><a href="data.html#cb19-219" tabindex="-1"></a>  subtitle <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb19-220"><a href="data.html#cb19-220" tabindex="-1"></a>    <span class="st">&#39;&lt;span style=&quot;color:{colors[&quot;gray&quot;]}&quot;&gt;**Absolute frequency (active and delisted)**&lt;/span&gt;, &#39;</span>,</span>
<span id="cb19-221"><a href="data.html#cb19-221" tabindex="-1"></a>    <span class="st">&#39;&lt;span style=&quot;color:{colors[&quot;blue&quot;]}&quot;&gt;**Absolute delisting frequency**&lt;/span&gt;, &lt;br&gt;&#39;</span>,</span>
<span id="cb19-222"><a href="data.html#cb19-222" tabindex="-1"></a>    <span class="st">&#39;&lt;span style=&quot;color:{colors[&quot;orange&quot;]}&quot;&gt;**Relative delisting frequency**&lt;/span&gt;&#39;</span>,</span>
<span id="cb19-223"><a href="data.html#cb19-223" tabindex="-1"></a>    <span class="fu">ifelse</span>(marginal.legend <span class="sc">==</span> <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">paste0</span>(<span class="st">&#39;, &lt;span style=&quot;color:{colors[&quot;magenta&quot;]}&quot;&gt;**&#39;</span>, marginal.legend, <span class="st">&quot;**&lt;/span&gt;&quot;</span>)),</span>
<span id="cb19-224"><a href="data.html#cb19-224" tabindex="-1"></a>    <span class="fu">ifelse</span>(marginal.legend2 <span class="sc">==</span> <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">paste0</span>(<span class="st">&#39;,&lt;br&gt;&lt;span style=&quot;color:{colors[&quot;lightblue&quot;]}&quot;&gt;**&#39;</span>, marginal.legend2, <span class="st">&quot;**&lt;/span&gt;&quot;</span>))</span>
<span id="cb19-225"><a href="data.html#cb19-225" tabindex="-1"></a>  )</span>
<span id="cb19-226"><a href="data.html#cb19-226" tabindex="-1"></a></span>
<span id="cb19-227"><a href="data.html#cb19-227" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> plot <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(</span>
<span id="cb19-228"><a href="data.html#cb19-228" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Frequency&quot;</span>,</span>
<span id="cb19-229"><a href="data.html#cb19-229" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(min_y_first, max_y_first),</span>
<span id="cb19-230"><a href="data.html#cb19-230" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> <span class="fu">scale_function</span>(., scale, shift),</span>
<span id="cb19-231"><a href="data.html#cb19-231" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;Relative delisting frequency&quot;</span></span>
<span id="cb19-232"><a href="data.html#cb19-232" tabindex="-1"></a>    ),</span>
<span id="cb19-233"><a href="data.html#cb19-233" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>rescale_none</span>
<span id="cb19-234"><a href="data.html#cb19-234" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-235"><a href="data.html#cb19-235" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb19-236"><a href="data.html#cb19-236" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(</span>
<span id="cb19-237"><a href="data.html#cb19-237" tabindex="-1"></a>      <span class="st">&quot;Absolute frequency&quot;</span>, <span class="st">&quot;Absolute delisting frequency&quot;</span>,</span>
<span id="cb19-238"><a href="data.html#cb19-238" tabindex="-1"></a>      <span class="st">&quot;Relative delisting frequency&quot;</span>, marginal.legend, marginal.legend2</span>
<span id="cb19-239"><a href="data.html#cb19-239" tabindex="-1"></a>    ),</span>
<span id="cb19-240"><a href="data.html#cb19-240" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb19-241"><a href="data.html#cb19-241" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;gray&quot;</span>]),</span>
<span id="cb19-242"><a href="data.html#cb19-242" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;blue&quot;</span>]),</span>
<span id="cb19-243"><a href="data.html#cb19-243" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;orange&quot;</span>]),</span>
<span id="cb19-244"><a href="data.html#cb19-244" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;magenta&quot;</span>]),</span>
<span id="cb19-245"><a href="data.html#cb19-245" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;lightblue&quot;</span>])</span>
<span id="cb19-246"><a href="data.html#cb19-246" tabindex="-1"></a>    )</span>
<span id="cb19-247"><a href="data.html#cb19-247" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-248"><a href="data.html#cb19-248" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb19-249"><a href="data.html#cb19-249" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb19-250"><a href="data.html#cb19-250" tabindex="-1"></a>      <span class="st">&quot;Absolute frequency&quot;</span> <span class="ot">=</span> <span class="fu">as.character</span>(colors[<span class="st">&quot;gray&quot;</span>]),</span>
<span id="cb19-251"><a href="data.html#cb19-251" tabindex="-1"></a>      <span class="st">&quot;Absolute delisting frequency&quot;</span> <span class="ot">=</span> <span class="fu">as.character</span>(colors[<span class="st">&quot;blue&quot;</span>]),</span>
<span id="cb19-252"><a href="data.html#cb19-252" tabindex="-1"></a>      <span class="st">&quot;Relative delisting frequency&quot;</span> <span class="ot">=</span> <span class="fu">as.character</span>(colors[<span class="st">&quot;orange&quot;</span>]),</span>
<span id="cb19-253"><a href="data.html#cb19-253" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;magenta&quot;</span>]),</span>
<span id="cb19-254"><a href="data.html#cb19-254" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;lightblue&quot;</span>])</span>
<span id="cb19-255"><a href="data.html#cb19-255" tabindex="-1"></a>    )</span>
<span id="cb19-256"><a href="data.html#cb19-256" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-257"><a href="data.html#cb19-257" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-258"><a href="data.html#cb19-258" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Histogram of &quot;</span>, feature_description),</span>
<span id="cb19-259"><a href="data.html#cb19-259" tabindex="-1"></a>    <span class="at">subtitle =</span> subtitle,</span>
<span id="cb19-260"><a href="data.html#cb19-260" tabindex="-1"></a>    <span class="at">x =</span> feature_identifier</span>
<span id="cb19-261"><a href="data.html#cb19-261" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-262"><a href="data.html#cb19-262" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb19-263"><a href="data.html#cb19-263" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_markdown</span>(),</span>
<span id="cb19-264"><a href="data.html#cb19-264" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_markdown</span>(<span class="at">color =</span> colors[<span class="st">&quot;gray&quot;</span>]),</span>
<span id="cb19-265"><a href="data.html#cb19-265" tabindex="-1"></a>    <span class="at">axis.title.y.right =</span> <span class="fu">element_markdown</span>(<span class="at">color =</span> colors[<span class="st">&quot;orange&quot;</span>]),</span>
<span id="cb19-266"><a href="data.html#cb19-266" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb19-267"><a href="data.html#cb19-267" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-268"><a href="data.html#cb19-268" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb19-269"><a href="data.html#cb19-269" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb19-270"><a href="data.html#cb19-270" tabindex="-1"></a>      <span class="at">x =</span> max_x, <span class="at">y =</span> max_y_first,</span>
<span id="cb19-271"><a href="data.html#cb19-271" tabindex="-1"></a>      <span class="at">label =</span> <span class="st">&quot;outliers are winsorized&quot;</span></span>
<span id="cb19-272"><a href="data.html#cb19-272" tabindex="-1"></a>    ),</span>
<span id="cb19-273"><a href="data.html#cb19-273" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;unique&quot;</span>,</span>
<span id="cb19-274"><a href="data.html#cb19-274" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb19-275"><a href="data.html#cb19-275" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb19-276"><a href="data.html#cb19-276" tabindex="-1"></a>  )</span>
<span id="cb19-277"><a href="data.html#cb19-277" tabindex="-1"></a></span>
<span id="cb19-278"><a href="data.html#cb19-278" tabindex="-1"></a>  <span class="fu">return</span>(plot)</span>
<span id="cb19-279"><a href="data.html#cb19-279" tabindex="-1"></a>}</span>
<span id="cb19-280"><a href="data.html#cb19-280" tabindex="-1"></a></span>
<span id="cb19-281"><a href="data.html#cb19-281" tabindex="-1"></a><span class="co"># winsorize features</span></span>
<span id="cb19-282"><a href="data.html#cb19-282" tabindex="-1"></a>com.winsorized <span class="ot">&lt;-</span> <span class="fu">data.prepare.winsorize</span>(com, com.features.fin<span class="sc">$</span>identifier,</span>
<span id="cb19-283"><a href="data.html#cb19-283" tabindex="-1"></a>  <span class="at">lower_quantile_boundary =</span> <span class="fl">0.05</span>,</span>
<span id="cb19-284"><a href="data.html#cb19-284" tabindex="-1"></a>  <span class="at">upper_quantile_boundary =</span> <span class="fl">0.95</span></span>
<span id="cb19-285"><a href="data.html#cb19-285" tabindex="-1"></a>)</span>
<span id="cb19-286"><a href="data.html#cb19-286" tabindex="-1"></a></span>
<span id="cb19-287"><a href="data.html#cb19-287" tabindex="-1"></a><span class="co"># plot histogram of features and delisting frequency</span></span>
<span id="cb19-288"><a href="data.html#cb19-288" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb19-289"><a href="data.html#cb19-289" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(com.features.fin<span class="sc">$</span>identifier)) {</span>
<span id="cb19-290"><a href="data.html#cb19-290" tabindex="-1"></a>  feature_description <span class="ot">&lt;-</span> com.features.fin[[i, <span class="dv">1</span>]]</span>
<span id="cb19-291"><a href="data.html#cb19-291" tabindex="-1"></a>  feature_identifier <span class="ot">&lt;-</span> com.features.fin[[i, <span class="dv">2</span>]]</span>
<span id="cb19-292"><a href="data.html#cb19-292" tabindex="-1"></a></span>
<span id="cb19-293"><a href="data.html#cb19-293" tabindex="-1"></a>  plots[[feature_identifier]] <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb19-294"><a href="data.html#cb19-294" tabindex="-1"></a>    com.winsorized <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(feature_identifier), years_to_delisting),</span>
<span id="cb19-295"><a href="data.html#cb19-295" tabindex="-1"></a>    feature_identifier,</span>
<span id="cb19-296"><a href="data.html#cb19-296" tabindex="-1"></a>    feature_description</span>
<span id="cb19-297"><a href="data.html#cb19-297" tabindex="-1"></a>  )</span>
<span id="cb19-298"><a href="data.html#cb19-298" tabindex="-1"></a>  <span class="fu">print</span>(plots[[feature_identifier]])</span>
<span id="cb19-299"><a href="data.html#cb19-299" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-1.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-2.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-3.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-4.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-5.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-6.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-7.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-8.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-9.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-10.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-11.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-12.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-13.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-14.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-15.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-16.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-17.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-18.png" width="672" /><img src="_main_files/figure-html/features_distribution_delisting_frequency.function-19.png" width="672" /></p>
<ul>
<li><p>Capitalization and Solvency ratios - <strong>capital_ratio, de_ratio, debt_assets, debt_at</strong>: The higher the ratio of debt to assets or liabilities, the higher the relative delisting frequency in the subsequent year.</p></li>
<li><p>Efficiency - <strong>at_turn, inv_turn, rect_turn, pay_turn</strong>: These efficiency ratios but <em>pay_turn</em> seem to have no observable marginal effect on delisting. However, if the ratio between cost of goods sold plus the change in inventories and accounts payable gets larger, the observed delisting frequency for the subsequent year decreases.</p></li>
<li><p>Liquidity - <strong>cash_ratio, curr_ratio, quick_ratio</strong>: The ratio between cash plus short-term investments (<em>cash_ratio</em>) seems to have no marginal predictive power for delisting. However, if the ratioto current liabilities (<em>curr_ratio</em>, <em>quick_ratio</em>) increases, the relative frequency of delistings in the subsequent year decreases</p></li>
<li><p>Profitability - <strong>aftret_eq, aftret_equity, gpm, opmad, opmbd, roa, roe</strong>: If these profitability ratios are negative, the observed relative frequency for delisting in the subsequent year is relatively high compared to the cases in which the ratios are positive. The denominators of these profitability ratios contain assets or sales key figures which are greater than or equal to zero. So if the income or sales key figures in the numerator of the ratios are negative, the company’s situation is on average more problematic with respect to delisting.</p></li>
<li><p>Valuation - <strong>pe_exi</strong>: For positive price-to-earnings ratios (per share) the observed delisting frequency in the subsequent year becomes smaller for increasing ratios. The higher the price-to-earnings ratio, the better is a share valued. If the price-to-earnings ratio is negative, then the earnings in the denominator of the ratio are negative. If the loss per share is relatively small, then the price-to-earnings ratio is ≪ −1. Hence, decreasing ratios are associated with a lower relative delisting frequency.</p></li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="data.html#cb20-1" tabindex="-1"></a>(plots[[<span class="st">&quot;capital_ratio&quot;</span>]] <span class="sc">|</span> plots[[<span class="st">&quot;curr_ratio&quot;</span>]]) <span class="sc">/</span> (plots[[<span class="st">&quot;roe&quot;</span>]] <span class="sc">|</span> plots[[<span class="st">&quot;pe_exi&quot;</span>]])</span></code></pre></div>
<p><img src="_main_files/figure-html/features_distribution_delisting_frequency.plot-1.png" width="672" /></p>

</div>
</div>
<div id="predictor-data-set" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Predictor data set<a href="data.html#predictor-data-set" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!--### Validate data set
 - How much efforts and details for data validation? How many (randomized) rows should be checked?
 - Example: Immuogen Inc 2019 ([Annual Report 2019]( https://investor.immunogen.com/static-files/53288d18-b7b6-4900-b215-f51c3bda9468]))
-->
<div id="identifiy-duplicates" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Identifiy duplicates<a href="data.html#identifiy-duplicates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="data.html#cb21-1" tabindex="-1"></a><span class="co"># number of duplicate rows</span></span>
<span id="cb21-2"><a href="data.html#cb21-2" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Number of duplicate rows:&quot;</span>, com <span class="sc">%&gt;%</span> <span class="fu">duplicated</span>() <span class="sc">%&gt;%</span> <span class="fu">sum</span>())</span></code></pre></div>
<pre><code>## [1] &quot;Number of duplicate rows: 0&quot;</code></pre>
</div>
<div id="missing-data" class="section level3 hasAnchor" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Missing data<a href="data.html#missing-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="data.html#cb23-1" tabindex="-1"></a><span class="co">#&#39; Missing data profile as bar chart</span></span>
<span id="cb23-2"><a href="data.html#cb23-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb23-3"><a href="data.html#cb23-3" tabindex="-1"></a><span class="co">#&#39; @param data tibble containing financial ratios for companies</span></span>
<span id="cb23-4"><a href="data.html#cb23-4" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb23-5"><a href="data.html#cb23-5" tabindex="-1"></a><span class="co">#&#39; @return bar chart showing percentages of missing data for each feature in data</span></span>
<span id="cb23-6"><a href="data.html#cb23-6" tabindex="-1"></a>plot_missing_data_profile <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb23-7"><a href="data.html#cb23-7" tabindex="-1"></a>  data_missing_data_profile <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="data.html#cb23-8" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.x)))) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="data.html#cb23-9" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb23-10"><a href="data.html#cb23-10" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb23-11"><a href="data.html#cb23-11" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">&quot;variable&quot;</span>,</span>
<span id="cb23-12"><a href="data.html#cb23-12" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">&quot;number_missing_values&quot;</span></span>
<span id="cb23-13"><a href="data.html#cb23-13" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="data.html#cb23-14" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">percent_missing_values =</span> number_missing_values <span class="sc">/</span> <span class="fu">nrow</span>(com))</span>
<span id="cb23-15"><a href="data.html#cb23-15" tabindex="-1"></a></span>
<span id="cb23-16"><a href="data.html#cb23-16" tabindex="-1"></a>  plot_missing_data_profile <span class="ot">&lt;-</span> data_missing_data_profile <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(</span>
<span id="cb23-17"><a href="data.html#cb23-17" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(variable, <span class="sc">-</span>number_missing_values), <span class="at">y =</span> percent_missing_values)</span>
<span id="cb23-18"><a href="data.html#cb23-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-19"><a href="data.html#cb23-19" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-20"><a href="data.html#cb23-20" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb23-21"><a href="data.html#cb23-21" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="dv">100</span> <span class="sc">*</span> percent_missing_values, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">&quot;%&quot;</span>)),</span>
<span id="cb23-22"><a href="data.html#cb23-22" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb23-23"><a href="data.html#cb23-23" tabindex="-1"></a>      <span class="at">colour =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb23-24"><a href="data.html#cb23-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb23-25"><a href="data.html#cb23-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb23-26"><a href="data.html#cb23-26" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Missing data profile&quot;</span>,</span>
<span id="cb23-27"><a href="data.html#cb23-27" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">&quot;Percentage of missing rows&quot;</span>,</span>
<span id="cb23-28"><a href="data.html#cb23-28" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;Features&quot;</span></span>
<span id="cb23-29"><a href="data.html#cb23-29" tabindex="-1"></a>    )</span>
<span id="cb23-30"><a href="data.html#cb23-30" tabindex="-1"></a></span>
<span id="cb23-31"><a href="data.html#cb23-31" tabindex="-1"></a>  <span class="fu">return</span>(plot_missing_data_profile)</span>
<span id="cb23-32"><a href="data.html#cb23-32" tabindex="-1"></a>}</span>
<span id="cb23-33"><a href="data.html#cb23-33" tabindex="-1"></a></span>
<span id="cb23-34"><a href="data.html#cb23-34" tabindex="-1"></a><span class="fu">plot_missing_data_profile</span>(com <span class="sc">%&gt;%</span> <span class="fu">select</span>(com.features.fin<span class="sc">$</span>identifier))</span></code></pre></div>
<p><img src="_main_files/figure-html/missing_data_profile-1.png" width="672" /></p>
<p>More than every fourth value for the feature <span class="math inline">\(\textt{inv_turn}\)</span> (inventory turnover) is missing.<br />
</p>
</div>
<div id="predictior-data-set" class="section level3 hasAnchor" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Predictior data set<a href="data.html#predictior-data-set" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="data.html#cb24-1" tabindex="-1"></a><span class="co">#&#39; imputes missing values for a specific data set given</span></span>
<span id="cb24-2"><a href="data.html#cb24-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-3"><a href="data.html#cb24-3" tabindex="-1"></a><span class="co">#&#39; @param data company data including financial ratio columns</span></span>
<span id="cb24-4"><a href="data.html#cb24-4" tabindex="-1"></a><span class="co">#&#39; @param test_indicator indicator vector with the same length as nrow(data) containing</span></span>
<span id="cb24-5"><a href="data.html#cb24-5" tabindex="-1"></a><span class="co">#&#39;        TRUE if corresponding row in data belongs to the test set</span></span>
<span id="cb24-6"><a href="data.html#cb24-6" tabindex="-1"></a><span class="co">#&#39;        otherwise FALSE</span></span>
<span id="cb24-7"><a href="data.html#cb24-7" tabindex="-1"></a><span class="co">#&#39; @param method method to use for imputation, currently &quot;pm&quot; predictive mean matching</span></span>
<span id="cb24-8"><a href="data.html#cb24-8" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-9"><a href="data.html#cb24-9" tabindex="-1"></a><span class="co">#&#39; @return imputed data set</span></span>
<span id="cb24-10"><a href="data.html#cb24-10" tabindex="-1"></a>data.prepare.impute <span class="ot">&lt;-</span> <span class="cf">function</span>(data, test_indicator, <span class="at">method =</span> <span class="st">&quot;pmm&quot;</span>) {</span>
<span id="cb24-11"><a href="data.html#cb24-11" tabindex="-1"></a>  data_imputed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb24-12"><a href="data.html#cb24-12" tabindex="-1"></a></span>
<span id="cb24-13"><a href="data.html#cb24-13" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">&quot;pmm&quot;</span>) {</span>
<span id="cb24-14"><a href="data.html#cb24-14" tabindex="-1"></a>    <span class="cf">if</span> (REDO_MICE_IMPUTATION_PPM) {</span>
<span id="cb24-15"><a href="data.html#cb24-15" tabindex="-1"></a>      data_imputed <span class="ot">&lt;-</span> <span class="fu">complete</span>(<span class="fu">mice</span>(data,</span>
<span id="cb24-16"><a href="data.html#cb24-16" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">&quot;pmm&quot;</span>,</span>
<span id="cb24-17"><a href="data.html#cb24-17" tabindex="-1"></a>        <span class="at">ignore =</span> test_indicator,</span>
<span id="cb24-18"><a href="data.html#cb24-18" tabindex="-1"></a>        <span class="at">m =</span> <span class="dv">5</span>,</span>
<span id="cb24-19"><a href="data.html#cb24-19" tabindex="-1"></a>        <span class="at">visitSequence =</span> <span class="st">&quot;monotone&quot;</span>,</span>
<span id="cb24-20"><a href="data.html#cb24-20" tabindex="-1"></a>        <span class="at">maxit =</span> <span class="dv">5</span></span>
<span id="cb24-21"><a href="data.html#cb24-21" tabindex="-1"></a>      ))</span>
<span id="cb24-22"><a href="data.html#cb24-22" tabindex="-1"></a>      <span class="fu">save</span>(data_imputed, <span class="at">file =</span> <span class="st">&quot;../data/com_imputed.RData&quot;</span>)</span>
<span id="cb24-23"><a href="data.html#cb24-23" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-24"><a href="data.html#cb24-24" tabindex="-1"></a>      <span class="fu">load</span>(<span class="st">&quot;../data/com_imputed.RData&quot;</span>)</span>
<span id="cb24-25"><a href="data.html#cb24-25" tabindex="-1"></a>    }</span>
<span id="cb24-26"><a href="data.html#cb24-26" tabindex="-1"></a>  }</span>
<span id="cb24-27"><a href="data.html#cb24-27" tabindex="-1"></a>  <span class="fu">return</span>(data_imputed)</span>
<span id="cb24-28"><a href="data.html#cb24-28" tabindex="-1"></a>}</span>
<span id="cb24-29"><a href="data.html#cb24-29" tabindex="-1"></a></span>
<span id="cb24-30"><a href="data.html#cb24-30" tabindex="-1"></a><span class="co">#&#39;  computes historical change features for several features listed in</span></span>
<span id="cb24-31"><a href="data.html#cb24-31" tabindex="-1"></a><span class="co">#&#39;  feature_identifier</span></span>
<span id="cb24-32"><a href="data.html#cb24-32" tabindex="-1"></a><span class="co">#&#39;  performs regression of financial ratio values on the available report dates</span></span>
<span id="cb24-33"><a href="data.html#cb24-33" tabindex="-1"></a><span class="co">#&#39;  of the past five years for each company and takes the fitted slope</span></span>
<span id="cb24-34"><a href="data.html#cb24-34" tabindex="-1"></a><span class="co">#&#39;  coefficient as historical change feature</span></span>
<span id="cb24-35"><a href="data.html#cb24-35" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-36"><a href="data.html#cb24-36" tabindex="-1"></a><span class="co">#&#39; @param data company data including financial ratio columns and column</span></span>
<span id="cb24-37"><a href="data.html#cb24-37" tabindex="-1"></a><span class="co">#&#39;             public_date_selected</span></span>
<span id="cb24-38"><a href="data.html#cb24-38" tabindex="-1"></a><span class="co">#&#39; @param feature_identifier list of technical feature identifier of interest</span></span>
<span id="cb24-39"><a href="data.html#cb24-39" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-40"><a href="data.html#cb24-40" tabindex="-1"></a><span class="co">#&#39; @return data set with historical change features</span></span>
<span id="cb24-41"><a href="data.html#cb24-41" tabindex="-1"></a>data.prepare.history <span class="ot">&lt;-</span> <span class="cf">function</span>(data, feature_identifier) {</span>
<span id="cb24-42"><a href="data.html#cb24-42" tabindex="-1"></a>  <span class="co"># add features containing slope of historical financial data</span></span>
<span id="cb24-43"><a href="data.html#cb24-43" tabindex="-1"></a>  <span class="cf">for</span> (feature <span class="cf">in</span> feature_identifier) {</span>
<span id="cb24-44"><a href="data.html#cb24-44" tabindex="-1"></a>    feature_history_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(feature, <span class="st">&quot;_h&quot;</span>)</span>
<span id="cb24-45"><a href="data.html#cb24-45" tabindex="-1"></a>    com_slope <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb24-46"><a href="data.html#cb24-46" tabindex="-1"></a>      <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb24-47"><a href="data.html#cb24-47" tabindex="-1"></a>      <span class="co"># use at most 5 years of history of financial ratios</span></span>
<span id="cb24-48"><a href="data.html#cb24-48" tabindex="-1"></a>      <span class="fu">filter</span>(public_date_selected <span class="sc">-</span> <span class="fu">years</span>(<span class="dv">5</span>) <span class="sc">&lt;=</span> public_date <span class="sc">&amp;</span> public_date <span class="sc">&lt;=</span> public_date_selected) <span class="sc">%&gt;%</span></span>
<span id="cb24-49"><a href="data.html#cb24-49" tabindex="-1"></a>      <span class="co"># compute slope coefficient on filtered and grouped subset for a 5-year time period</span></span>
<span id="cb24-50"><a href="data.html#cb24-50" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="sc">!!</span><span class="at">feature_history_name :=</span></span>
<span id="cb24-51"><a href="data.html#cb24-51" tabindex="-1"></a>        <span class="fu">lm</span>((<span class="sc">!!</span><span class="fu">as.symbol</span>(feature)) <span class="sc">~</span> public_date)<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb24-52"><a href="data.html#cb24-52" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(com_slope, <span class="at">by =</span> <span class="fu">join_by</span>(permno))</span>
<span id="cb24-53"><a href="data.html#cb24-53" tabindex="-1"></a>  }</span>
<span id="cb24-54"><a href="data.html#cb24-54" tabindex="-1"></a></span>
<span id="cb24-55"><a href="data.html#cb24-55" tabindex="-1"></a>  <span class="fu">return</span>(data <span class="sc">%&gt;%</span> <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)) <span class="co"># !!!!!!!!!!!!!!!!!!!!</span></span>
<span id="cb24-56"><a href="data.html#cb24-56" tabindex="-1"></a>}</span>
<span id="cb24-57"><a href="data.html#cb24-57" tabindex="-1"></a></span>
<span id="cb24-58"><a href="data.html#cb24-58" tabindex="-1"></a><span class="co">#&#39; prepares company data for model training and testing purposes</span></span>
<span id="cb24-59"><a href="data.html#cb24-59" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-60"><a href="data.html#cb24-60" tabindex="-1"></a><span class="co">#&#39; @param com_data company data including financial ratio columns</span></span>
<span id="cb24-61"><a href="data.html#cb24-61" tabindex="-1"></a><span class="co">#&#39; @param response company data including columns permno and response which</span></span>
<span id="cb24-62"><a href="data.html#cb24-62" tabindex="-1"></a><span class="co">#&#39;                 determines response variable for each company in com_data</span></span>
<span id="cb24-63"><a href="data.html#cb24-63" tabindex="-1"></a><span class="co">#&#39; @param com_subset company data with permno and public_date of a (sub)set of</span></span>
<span id="cb24-64"><a href="data.html#cb24-64" tabindex="-1"></a><span class="co">#&#39;                   companies</span></span>
<span id="cb24-65"><a href="data.html#cb24-65" tabindex="-1"></a><span class="co">#&#39; @param macro_data macro-economic data</span></span>
<span id="cb24-66"><a href="data.html#cb24-66" tabindex="-1"></a><span class="co">#&#39; @param feature_identifier vector containing column names of financial ratio</span></span>
<span id="cb24-67"><a href="data.html#cb24-67" tabindex="-1"></a><span class="co">#&#39;                           features to select column in com_data</span></span>
<span id="cb24-68"><a href="data.html#cb24-68" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-69"><a href="data.html#cb24-69" tabindex="-1"></a><span class="co">#&#39; @return data set with four subsequent report dates for each company and</span></span>
<span id="cb24-70"><a href="data.html#cb24-70" tabindex="-1"></a><span class="co">#&#39;         public_date specified in com_subset joined with macro-economic features</span></span>
<span id="cb24-71"><a href="data.html#cb24-71" tabindex="-1"></a>data.prepare <span class="ot">&lt;-</span> <span class="cf">function</span>(com_data, com.subset, macro.data, feature.identifier) {</span>
<span id="cb24-72"><a href="data.html#cb24-72" tabindex="-1"></a>  <span class="co"># number of companies in com_data</span></span>
<span id="cb24-73"><a href="data.html#cb24-73" tabindex="-1"></a>  <span class="fu">print</span>(com_data<span class="sc">$</span>permno <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span>
<span id="cb24-74"><a href="data.html#cb24-74" tabindex="-1"></a></span>
<span id="cb24-75"><a href="data.html#cb24-75" tabindex="-1"></a>  data.prepared <span class="ot">&lt;-</span> com_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(public_date))</span>
<span id="cb24-76"><a href="data.html#cb24-76" tabindex="-1"></a></span>
<span id="cb24-77"><a href="data.html#cb24-77" tabindex="-1"></a>  <span class="co"># join financial ratios with selected permno and public_date rows</span></span>
<span id="cb24-78"><a href="data.html#cb24-78" tabindex="-1"></a>  data.prepared <span class="ot">&lt;-</span> com_data <span class="sc">%&gt;%</span></span>
<span id="cb24-79"><a href="data.html#cb24-79" tabindex="-1"></a>    <span class="fu">right_join</span>(com.subset, <span class="at">by =</span> <span class="fu">join_by</span>(permno), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;_selected&quot;</span>))</span>
<span id="cb24-80"><a href="data.html#cb24-80" tabindex="-1"></a></span>
<span id="cb24-81"><a href="data.html#cb24-81" tabindex="-1"></a>  <span class="co"># add historic development features (5 year history)</span></span>
<span id="cb24-82"><a href="data.html#cb24-82" tabindex="-1"></a>  data.prepared <span class="ot">&lt;-</span> <span class="fu">data.prepare.history</span>(data.prepared, feature.identifier) <span class="sc">%&gt;%</span></span>
<span id="cb24-83"><a href="data.html#cb24-83" tabindex="-1"></a>    <span class="fu">filter</span>(public_date <span class="sc">==</span> public_date_selected) <span class="sc">%&gt;%</span></span>
<span id="cb24-84"><a href="data.html#cb24-84" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>public_date_selected)</span>
<span id="cb24-85"><a href="data.html#cb24-85" tabindex="-1"></a></span>
<span id="cb24-86"><a href="data.html#cb24-86" tabindex="-1"></a>  <span class="co"># add features with macro data ratios (gdp, inflation, interest, sp500)</span></span>
<span id="cb24-87"><a href="data.html#cb24-87" tabindex="-1"></a>  data.prepared <span class="ot">&lt;-</span> data.prepared <span class="sc">%&gt;%</span></span>
<span id="cb24-88"><a href="data.html#cb24-88" tabindex="-1"></a>    <span class="fu">left_join</span>(macro.data,</span>
<span id="cb24-89"><a href="data.html#cb24-89" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(<span class="fu">closest</span>(x<span class="sc">$</span>public_date <span class="sc">&gt;=</span> y<span class="sc">$</span>observation_date))</span>
<span id="cb24-90"><a href="data.html#cb24-90" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb24-91"><a href="data.html#cb24-91" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>observation_date)</span>
<span id="cb24-92"><a href="data.html#cb24-92" tabindex="-1"></a></span>
<span id="cb24-93"><a href="data.html#cb24-93" tabindex="-1"></a>  <span class="co"># check if n_companies reduced -&gt; should not change</span></span>
<span id="cb24-94"><a href="data.html#cb24-94" tabindex="-1"></a>  <span class="co"># number of companies in com_data</span></span>
<span id="cb24-95"><a href="data.html#cb24-95" tabindex="-1"></a>  <span class="fu">print</span>(data.prepared<span class="sc">$</span>permno <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span>
<span id="cb24-96"><a href="data.html#cb24-96" tabindex="-1"></a>  <span class="co"># check for one row per company</span></span>
<span id="cb24-97"><a href="data.html#cb24-97" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(</span>
<span id="cb24-98"><a href="data.html#cb24-98" tabindex="-1"></a>    <span class="st">&quot;Does every company have exactly one row in data.prepared? -&quot;</span>,</span>
<span id="cb24-99"><a href="data.html#cb24-99" tabindex="-1"></a>    <span class="fu">nrow</span>(data.prepared) <span class="sc">==</span> (data.prepared<span class="sc">$</span>permno <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span>
<span id="cb24-100"><a href="data.html#cb24-100" tabindex="-1"></a>  ))</span>
<span id="cb24-101"><a href="data.html#cb24-101" tabindex="-1"></a></span>
<span id="cb24-102"><a href="data.html#cb24-102" tabindex="-1"></a>  <span class="fu">return</span>(data.prepared)</span>
<span id="cb24-103"><a href="data.html#cb24-103" tabindex="-1"></a>}</span>
<span id="cb24-104"><a href="data.html#cb24-104" tabindex="-1"></a></span>
<span id="cb24-105"><a href="data.html#cb24-105" tabindex="-1"></a><span class="co">#&#39; sample random report date (public_date) for each company</span></span>
<span id="cb24-106"><a href="data.html#cb24-106" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-107"><a href="data.html#cb24-107" tabindex="-1"></a><span class="co">#&#39; @param data company data including columns permno, public_date</span></span>
<span id="cb24-108"><a href="data.html#cb24-108" tabindex="-1"></a><span class="co">#&#39; @return tibble with columns permno and public_date containing companies and</span></span>
<span id="cb24-109"><a href="data.html#cb24-109" tabindex="-1"></a><span class="co">#&#39;         public_date for train set</span></span>
<span id="cb24-110"><a href="data.html#cb24-110" tabindex="-1"></a>com.time_points <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb24-111"><a href="data.html#cb24-111" tabindex="-1"></a>  <span class="co"># contains exactly one random report date for every company, for every</span></span>
<span id="cb24-112"><a href="data.html#cb24-112" tabindex="-1"></a>  <span class="co"># delisted company a report date which is more than 3 months before delisting</span></span>
<span id="cb24-113"><a href="data.html#cb24-113" tabindex="-1"></a>  com.time_points.result <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb24-114"><a href="data.html#cb24-114" tabindex="-1"></a>    <span class="fu">arrange</span>(public_date) <span class="sc">%&gt;%</span></span>
<span id="cb24-115"><a href="data.html#cb24-115" tabindex="-1"></a>    <span class="fu">group_by</span>(permno, event_group) <span class="sc">%&gt;%</span></span>
<span id="cb24-116"><a href="data.html#cb24-116" tabindex="-1"></a>    <span class="co"># require at least 3 subsequent quarters of financial ratios</span></span>
<span id="cb24-117"><a href="data.html#cb24-117" tabindex="-1"></a>    <span class="fu">filter</span>((event_group <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span> <span class="sc">&amp;</span> <span class="fu">row_number</span>() <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">|</span></span>
<span id="cb24-118"><a href="data.html#cb24-118" tabindex="-1"></a>      (event_group <span class="sc">==</span> <span class="st">&quot;active&quot;</span> <span class="sc">&amp;</span> <span class="fu">row_number</span>() <span class="sc">&gt;=</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-119"><a href="data.html#cb24-119" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-120"><a href="data.html#cb24-120" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-121"><a href="data.html#cb24-121" tabindex="-1"></a>    <span class="fu">select</span>(permno, public_date, response)</span>
<span id="cb24-122"><a href="data.html#cb24-122" tabindex="-1"></a></span>
<span id="cb24-123"><a href="data.html#cb24-123" tabindex="-1"></a>  <span class="fu">return</span>(com.time_points.result)</span>
<span id="cb24-124"><a href="data.html#cb24-124" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="prepare-predictor-data-set" class="section level3 hasAnchor" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> Prepare predictor data set<a href="data.html#prepare-predictor-data-set" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="data.html#cb25-1" tabindex="-1"></a><span class="co"># remove features that meet threshold in chunk correlated_features_detect_removals</span></span>
<span id="cb25-2"><a href="data.html#cb25-2" tabindex="-1"></a>com.features.fin <span class="ot">&lt;-</span> com.features.fin <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>identifier <span class="sc">%in%</span> feature_indicators_to_remove)</span>
<span id="cb25-3"><a href="data.html#cb25-3" tabindex="-1"></a><span class="co"># com &lt;- com %&gt;% select(-feature_indicators_to_remove)</span></span>
<span id="cb25-4"><a href="data.html#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="data.html#cb25-5" tabindex="-1"></a><span class="co"># list companies and the number of quarters in which they reported financial ratio dates</span></span>
<span id="cb25-6"><a href="data.html#cb25-6" tabindex="-1"></a>com.quarters_per_company <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb25-7"><a href="data.html#cb25-7" tabindex="-1"></a>  <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="data.html#cb25-8" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb25-9"><a href="data.html#cb25-9" tabindex="-1"></a>    <span class="at">n_quarters =</span> <span class="fu">n</span>(),</span>
<span id="cb25-10"><a href="data.html#cb25-10" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb25-11"><a href="data.html#cb25-11" tabindex="-1"></a>  )</span>
<span id="cb25-12"><a href="data.html#cb25-12" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Number of companies in data set:&quot;</span>, com<span class="sc">$</span>permno <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span></code></pre></div>
<pre><code>## [1] &quot;Number of companies in data set: 9424&quot;</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="data.html#cb27-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb27-2"><a href="data.html#cb27-2" tabindex="-1"></a>  <span class="st">&quot;Number of companies &lt; 4 financial ratio dates:&quot;</span>,</span>
<span id="cb27-3"><a href="data.html#cb27-3" tabindex="-1"></a>  <span class="fu">nrow</span>(com.quarters_per_company <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n_quarters <span class="sc">&lt;</span> N_QUARTERS_FIN_RATIOS))</span>
<span id="cb27-4"><a href="data.html#cb27-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Number of companies &lt; 4 financial ratio dates: 409&quot;</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="data.html#cb29-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb29-2"><a href="data.html#cb29-2" tabindex="-1"></a>  <span class="st">&quot;Number of companies &gt;= 4 financial ratio dates:&quot;</span>,</span>
<span id="cb29-3"><a href="data.html#cb29-3" tabindex="-1"></a>  <span class="fu">nrow</span>(com.quarters_per_company <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n_quarters <span class="sc">&gt;=</span> N_QUARTERS_FIN_RATIOS))</span>
<span id="cb29-4"><a href="data.html#cb29-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Number of companies &gt;= 4 financial ratio dates: 9015&quot;</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="data.html#cb31-1" tabindex="-1"></a><span class="co"># remove companies that have less than N_QUARTERS_FIN_RATIO_REQUIRED reported financial ratio dates</span></span>
<span id="cb31-2"><a href="data.html#cb31-2" tabindex="-1"></a>com <span class="ot">&lt;-</span> com.quarters_per_company <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="data.html#cb31-3" tabindex="-1"></a>  <span class="fu">inner_join</span>(com, <span class="at">by =</span> <span class="fu">join_by</span>(permno)) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="data.html#cb31-4" tabindex="-1"></a>  <span class="fu">filter</span>((n_quarters <span class="sc">&gt;=</span> N_QUARTERS_FIN_RATIOS <span class="sc">&amp;</span> event_group <span class="sc">==</span> <span class="st">&quot;active&quot;</span>) <span class="sc">|</span></span>
<span id="cb31-5"><a href="data.html#cb31-5" tabindex="-1"></a>    (n_quarters <span class="sc">&gt;=</span> N_QUARTERS_FIN_RATIOS_REQUIRED <span class="sc">&amp;</span> event_group <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="data.html#cb31-6" tabindex="-1"></a>  <span class="co"># exclude gap of 3 months from predictor data set</span></span>
<span id="cb31-7"><a href="data.html#cb31-7" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">time_length</span>(<span class="fu">interval</span>(public_date, enddat), <span class="st">&quot;year&quot;</span>) <span class="sc">&gt;=</span> <span class="fl">0.25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="data.html#cb31-8" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_quarters)</span>
<span id="cb31-9"><a href="data.html#cb31-9" tabindex="-1"></a></span>
<span id="cb31-10"><a href="data.html#cb31-10" tabindex="-1"></a><span class="co"># winsorize features</span></span>
<span id="cb31-11"><a href="data.html#cb31-11" tabindex="-1"></a>com <span class="ot">&lt;-</span> <span class="fu">data.prepare.winsorize</span>(com, com.features.fin<span class="sc">$</span>identifier)</span>
<span id="cb31-12"><a href="data.html#cb31-12" tabindex="-1"></a></span>
<span id="cb31-13"><a href="data.html#cb31-13" tabindex="-1"></a><span class="co"># determine response variable associated with company: &quot;delisted&quot; or &quot;active&quot;</span></span>
<span id="cb31-14"><a href="data.html#cb31-14" tabindex="-1"></a>com.response <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb31-15"><a href="data.html#cb31-15" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">ifelse</span>(</span>
<span id="cb31-16"><a href="data.html#cb31-16" tabindex="-1"></a>    <span class="fu">determine_delisting_property</span>(<span class="fu">time_length</span>(<span class="fu">interval</span>(public_date, enddat), <span class="st">&quot;year&quot;</span>)) <span class="sc">&amp;</span></span>
<span id="cb31-17"><a href="data.html#cb31-17" tabindex="-1"></a>      event_group <span class="sc">!=</span> <span class="st">&quot;active&quot;</span>,</span>
<span id="cb31-18"><a href="data.html#cb31-18" tabindex="-1"></a>    <span class="st">&quot;delisted&quot;</span>,</span>
<span id="cb31-19"><a href="data.html#cb31-19" tabindex="-1"></a>    <span class="st">&quot;active&quot;</span></span>
<span id="cb31-20"><a href="data.html#cb31-20" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb31-21"><a href="data.html#cb31-21" tabindex="-1"></a>  <span class="fu">select</span>(permno, public_date, event_group, response)</span>
<span id="cb31-22"><a href="data.html#cb31-22" tabindex="-1"></a></span>
<span id="cb31-23"><a href="data.html#cb31-23" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb31-24"><a href="data.html#cb31-24" tabindex="-1"></a><span class="co"># sample one random public_date for each company</span></span>
<span id="cb31-25"><a href="data.html#cb31-25" tabindex="-1"></a><span class="co"># tibble containing columns permno and public_date for each company in com</span></span>
<span id="cb31-26"><a href="data.html#cb31-26" tabindex="-1"></a>com.time_points.sample <span class="ot">&lt;-</span> <span class="fu">com.time_points</span>(com.response)</span>
<span id="cb31-27"><a href="data.html#cb31-27" tabindex="-1"></a></span>
<span id="cb31-28"><a href="data.html#cb31-28" tabindex="-1"></a><span class="co"># train test split (75%|25%), stratified sampling based on response feature</span></span>
<span id="cb31-29"><a href="data.html#cb31-29" tabindex="-1"></a>com.split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(com.time_points.sample, <span class="at">strata =</span> response, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb31-30"><a href="data.html#cb31-30" tabindex="-1"></a>com.train <span class="ot">&lt;-</span> <span class="fu">training</span>(com.split)</span>
<span id="cb31-31"><a href="data.html#cb31-31" tabindex="-1"></a>com.test <span class="ot">&lt;-</span> <span class="fu">testing</span>(com.split)</span>
<span id="cb31-32"><a href="data.html#cb31-32" tabindex="-1"></a></span>
<span id="cb31-33"><a href="data.html#cb31-33" tabindex="-1"></a><span class="co"># indicate for each company if it belongs to training or testing set</span></span>
<span id="cb31-34"><a href="data.html#cb31-34" tabindex="-1"></a>com <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">test_indicator =</span> <span class="sc">!</span>permno <span class="sc">%in%</span> com.train<span class="sc">$</span>permno)</span>
<span id="cb31-35"><a href="data.html#cb31-35" tabindex="-1"></a>test_indicator <span class="ot">&lt;-</span> com<span class="sc">$</span>test_indicator</span>
<span id="cb31-36"><a href="data.html#cb31-36" tabindex="-1"></a></span>
<span id="cb31-37"><a href="data.html#cb31-37" tabindex="-1"></a><span class="co"># impute data</span></span>
<span id="cb31-38"><a href="data.html#cb31-38" tabindex="-1"></a>com.imputed <span class="ot">&lt;-</span> <span class="fu">data.prepare.impute</span>(</span>
<span id="cb31-39"><a href="data.html#cb31-39" tabindex="-1"></a>    com <span class="sc">%&gt;%</span> <span class="fu">select</span>(com.features.fin<span class="sc">$</span>identifier),</span>
<span id="cb31-40"><a href="data.html#cb31-40" tabindex="-1"></a>    com<span class="sc">$</span>test_indicator, <span class="st">&quot;pmm&quot;</span></span>
<span id="cb31-41"><a href="data.html#cb31-41" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-42"><a href="data.html#cb31-42" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-43"><a href="data.html#cb31-43" tabindex="-1"></a>    <span class="at">permno =</span> com<span class="sc">$</span>permno,</span>
<span id="cb31-44"><a href="data.html#cb31-44" tabindex="-1"></a>    <span class="at">public_date =</span> com<span class="sc">$</span>public_date</span>
<span id="cb31-45"><a href="data.html#cb31-45" tabindex="-1"></a>  )</span>
<span id="cb31-46"><a href="data.html#cb31-46" tabindex="-1"></a></span>
<span id="cb31-47"><a href="data.html#cb31-47" tabindex="-1"></a><span class="cf">if</span> (REBUILD_PREDICTOR_DATA_SET) {</span>
<span id="cb31-48"><a href="data.html#cb31-48" tabindex="-1"></a>  <span class="co"># training set</span></span>
<span id="cb31-49"><a href="data.html#cb31-49" tabindex="-1"></a>  data.training <span class="ot">&lt;-</span> <span class="fu">data.prepare</span>(</span>
<span id="cb31-50"><a href="data.html#cb31-50" tabindex="-1"></a>    com.imputed <span class="sc">%&gt;%</span></span>
<span id="cb31-51"><a href="data.html#cb31-51" tabindex="-1"></a>      <span class="fu">select</span>(permno, public_date, com.features.fin<span class="sc">$</span>identifier) <span class="sc">%&gt;%</span></span>
<span id="cb31-52"><a href="data.html#cb31-52" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span>test_indicator),</span>
<span id="cb31-53"><a href="data.html#cb31-53" tabindex="-1"></a>    com.train,</span>
<span id="cb31-54"><a href="data.html#cb31-54" tabindex="-1"></a>    macro.ratios,</span>
<span id="cb31-55"><a href="data.html#cb31-55" tabindex="-1"></a>    com.features.fin<span class="sc">$</span>identifier</span>
<span id="cb31-56"><a href="data.html#cb31-56" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">as.factor</span>(response))</span>
<span id="cb31-57"><a href="data.html#cb31-57" tabindex="-1"></a>  <span class="fu">save</span>(data.training, <span class="at">file =</span> <span class="st">&quot;../data/data.training.RData&quot;</span>)</span>
<span id="cb31-58"><a href="data.html#cb31-58" tabindex="-1"></a>  </span>
<span id="cb31-59"><a href="data.html#cb31-59" tabindex="-1"></a>  <span class="co"># test set</span></span>
<span id="cb31-60"><a href="data.html#cb31-60" tabindex="-1"></a>  data.test <span class="ot">&lt;-</span> <span class="fu">data.prepare</span>(</span>
<span id="cb31-61"><a href="data.html#cb31-61" tabindex="-1"></a>    com.imputed <span class="sc">%&gt;%</span></span>
<span id="cb31-62"><a href="data.html#cb31-62" tabindex="-1"></a>      <span class="fu">select</span>(permno, public_date, com.features.fin<span class="sc">$</span>identifier) <span class="sc">%&gt;%</span></span>
<span id="cb31-63"><a href="data.html#cb31-63" tabindex="-1"></a>      <span class="fu">filter</span>(test_indicator),</span>
<span id="cb31-64"><a href="data.html#cb31-64" tabindex="-1"></a>    com.test,</span>
<span id="cb31-65"><a href="data.html#cb31-65" tabindex="-1"></a>    macro.ratios,</span>
<span id="cb31-66"><a href="data.html#cb31-66" tabindex="-1"></a>    com.features.fin<span class="sc">$</span>identifier</span>
<span id="cb31-67"><a href="data.html#cb31-67" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">as.factor</span>(response))</span>
<span id="cb31-68"><a href="data.html#cb31-68" tabindex="-1"></a>  <span class="fu">save</span>(data.test, <span class="at">file =</span> <span class="st">&quot;../data/data.test.RData&quot;</span>)</span>
<span id="cb31-69"><a href="data.html#cb31-69" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb31-70"><a href="data.html#cb31-70" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/data.training.RData&quot;</span>)</span>
<span id="cb31-71"><a href="data.html#cb31-71" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/data.test.RData&quot;</span>)</span>
<span id="cb31-72"><a href="data.html#cb31-72" tabindex="-1"></a>}</span></code></pre></div>
<p>Test historical features of predictor data set for coherence by choosing random sample row

<div class="testrmd-badge-container-outer">
  <div class="testrmd-badge-container-inner">
      <span class="testrmd-badge label label-info" data-toggle="collapse" data-target="#testrmd-chunk-4327947" aria-expanded="false" aria-controls="testrmd-chunk-4327947">Tests passed</span>
  </div>
</div>
<div id="testrmd-chunk-4327947" class="testrmd-chunk panel panel-info collapse">
  <div class="panel-heading">
</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="data.html#cb32-1" tabindex="-1"></a>data.sample <span class="ot">&lt;-</span> data.training[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data.training), <span class="at">size =</span> <span class="dv">1</span>), ]</span>
<span id="cb32-2"><a href="data.html#cb32-2" tabindex="-1"></a></span>
<span id="cb32-3"><a href="data.html#cb32-3" tabindex="-1"></a>data.sample.history <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="data.html#cb32-4" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb32-5"><a href="data.html#cb32-5" tabindex="-1"></a>    permno <span class="sc">==</span> data.sample<span class="sc">$</span>permno,</span>
<span id="cb32-6"><a href="data.html#cb32-6" tabindex="-1"></a>    data.sample<span class="sc">$</span>public_date <span class="sc">-</span> <span class="fu">years</span>(<span class="dv">5</span>) <span class="sc">&lt;=</span> public_date <span class="sc">&amp;</span></span>
<span id="cb32-7"><a href="data.html#cb32-7" tabindex="-1"></a>      public_date <span class="sc">&lt;=</span> data.sample<span class="sc">$</span>public_date</span>
<span id="cb32-8"><a href="data.html#cb32-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-9"><a href="data.html#cb32-9" tabindex="-1"></a>  <span class="fu">select</span>(public_date, capital_ratio)</span>
<span id="cb32-10"><a href="data.html#cb32-10" tabindex="-1"></a>data.sample.history.lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(capital_ratio <span class="sc">~</span> public_date, <span class="at">data =</span> data.sample.history)</span>
<span id="cb32-11"><a href="data.html#cb32-11" tabindex="-1"></a></span>
<span id="cb32-12"><a href="data.html#cb32-12" tabindex="-1"></a><span class="co"># ggplot(data = data.sample.history, aes(public_date, capital_ratio)) +</span></span>
<span id="cb32-13"><a href="data.html#cb32-13" tabindex="-1"></a><span class="co">#   geom_point() +</span></span>
<span id="cb32-14"><a href="data.html#cb32-14" tabindex="-1"></a><span class="co">#   geom_abline(slope = data.sample.history.lm$coefficients[2],</span></span>
<span id="cb32-15"><a href="data.html#cb32-15" tabindex="-1"></a><span class="co">#               intercept = data.sample.history.lm$coefficients[1])</span></span>
<span id="cb32-16"><a href="data.html#cb32-16" tabindex="-1"></a></span>
<span id="cb32-17"><a href="data.html#cb32-17" tabindex="-1"></a><span class="fu">expect_true</span>(data.sample<span class="sc">$</span>capital_ratio_h <span class="sc">==</span> data.sample.history.lm<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span></code></pre></div>
</div>
</div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="data.html#cb33-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb33-2"><a href="data.html#cb33-2" tabindex="-1"></a>  <span class="st">&quot;Total number of companies:&quot;</span>,</span>
<span id="cb33-3"><a href="data.html#cb33-3" tabindex="-1"></a>  com.quarters_per_company <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb33-4"><a href="data.html#cb33-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Total number of companies: 9424&quot;</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="data.html#cb35-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb35-2"><a href="data.html#cb35-2" tabindex="-1"></a>  <span class="st">&quot;Number of delisted companies:&quot;</span>,</span>
<span id="cb35-3"><a href="data.html#cb35-3" tabindex="-1"></a>  com <span class="sc">%&gt;%</span> <span class="fu">filter</span>(event_group <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb35-4"><a href="data.html#cb35-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Number of delisted companies: 5417&quot;</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="data.html#cb37-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb37-2"><a href="data.html#cb37-2" tabindex="-1"></a>  <span class="st">&quot;Total number of companies w/ at least five quarters:&quot;</span>,</span>
<span id="cb37-3"><a href="data.html#cb37-3" tabindex="-1"></a>  com <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb37-4"><a href="data.html#cb37-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Total number of companies w/ at least five quarters: 8870&quot;</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="data.html#cb39-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb39-2"><a href="data.html#cb39-2" tabindex="-1"></a>  <span class="st">&quot;Proportion of delisted companies:&quot;</span>,</span>
<span id="cb39-3"><a href="data.html#cb39-3" tabindex="-1"></a>  <span class="fu">formatC</span>(com <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>event_group <span class="sc">%in%</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span></span>
<span id="cb39-4"><a href="data.html#cb39-4" tabindex="-1"></a>    com <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="data.html#cb39-5" tabindex="-1"></a>      <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="data.html#cb39-6" tabindex="-1"></a>      <span class="fu">count</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-7"><a href="data.html#cb39-7" tabindex="-1"></a>      <span class="fu">nrow</span>(), <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb39-8"><a href="data.html#cb39-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Proportion of delisted companies: 0.6107&quot;</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="data.html#cb41-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb41-2"><a href="data.html#cb41-2" tabindex="-1"></a>  <span class="st">&quot;Median number of years of financial ratios for active companies:&quot;</span>,</span>
<span id="cb41-3"><a href="data.html#cb41-3" tabindex="-1"></a>  (com <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="data.html#cb41-4" tabindex="-1"></a>    <span class="fu">filter</span>(event_group <span class="sc">==</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="data.html#cb41-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_active_years =</span> <span class="fu">time_length</span>(<span class="fu">interval</span>(begdat, LAST_TRADING_DATE_AVAILABLE), <span class="st">&quot;year&quot;</span>)))<span class="sc">$</span>n_active_years <span class="sc">%&gt;%</span></span>
<span id="cb41-6"><a href="data.html#cb41-6" tabindex="-1"></a>    <span class="fu">median</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-7"><a href="data.html#cb41-7" tabindex="-1"></a>    <span class="fu">formatC</span>(., <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb41-8"><a href="data.html#cb41-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Median number of years of financial ratios for active companies: 28.89&quot;</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="data.html#cb43-1" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Proportion of companies in train set:&quot;</span>, <span class="fu">formatC</span>(<span class="fu">nrow</span>(data.training) <span class="sc">/</span></span>
<span id="cb43-2"><a href="data.html#cb43-2" tabindex="-1"></a>  (<span class="fu">nrow</span>(data.training) <span class="sc">+</span> <span class="fu">nrow</span>(data.test)), <span class="at">digits =</span> <span class="dv">2</span>))</span></code></pre></div>
<pre><code>## [1] &quot;Proportion of companies in train set: 0.75&quot;</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="data.html#cb45-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb45-2"><a href="data.html#cb45-2" tabindex="-1"></a>  <span class="st">&quot;Number of companies in train set:&quot;</span>,</span>
<span id="cb45-3"><a href="data.html#cb45-3" tabindex="-1"></a>  data.training <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb45-4"><a href="data.html#cb45-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Number of companies in train set: 6652&quot;</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="data.html#cb47-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb47-2"><a href="data.html#cb47-2" tabindex="-1"></a>  <span class="st">&quot;Number of delisted companies in train set:&quot;</span>,</span>
<span id="cb47-3"><a href="data.html#cb47-3" tabindex="-1"></a>  data.training <span class="sc">%&gt;%</span> <span class="fu">filter</span>(response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb47-4"><a href="data.html#cb47-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Number of delisted companies in train set: 1409&quot;</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="data.html#cb49-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb49-2"><a href="data.html#cb49-2" tabindex="-1"></a>  <span class="st">&quot;Number of active companies in train set:&quot;</span>,</span>
<span id="cb49-3"><a href="data.html#cb49-3" tabindex="-1"></a>  data.training <span class="sc">%&gt;%</span> <span class="fu">filter</span>(response <span class="sc">==</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb49-4"><a href="data.html#cb49-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Number of active companies in train set: 5243&quot;</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="data.html#cb51-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb51-2"><a href="data.html#cb51-2" tabindex="-1"></a>  <span class="st">&quot;Proportion of delisted responses in train set:&quot;</span>,</span>
<span id="cb51-3"><a href="data.html#cb51-3" tabindex="-1"></a>  <span class="fu">formatC</span>(data.training <span class="sc">%&gt;%</span> <span class="fu">filter</span>(response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span></span>
<span id="cb51-4"><a href="data.html#cb51-4" tabindex="-1"></a>    data.training <span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="data.html#cb51-5" tabindex="-1"></a>      <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb51-6"><a href="data.html#cb51-6" tabindex="-1"></a>      <span class="fu">count</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-7"><a href="data.html#cb51-7" tabindex="-1"></a>      <span class="fu">nrow</span>(), <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb51-8"><a href="data.html#cb51-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Proportion of delisted responses in train set: 0.2118&quot;</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="data.html#cb53-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb53-2"><a href="data.html#cb53-2" tabindex="-1"></a>  <span class="st">&quot;Proportion of delisted responses in test set:&quot;</span>,</span>
<span id="cb53-3"><a href="data.html#cb53-3" tabindex="-1"></a>  <span class="fu">formatC</span>(data.test <span class="sc">%&gt;%</span> <span class="fu">filter</span>(response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span></span>
<span id="cb53-4"><a href="data.html#cb53-4" tabindex="-1"></a>    data.test <span class="sc">%&gt;%</span></span>
<span id="cb53-5"><a href="data.html#cb53-5" tabindex="-1"></a>      <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb53-6"><a href="data.html#cb53-6" tabindex="-1"></a>      <span class="fu">count</span>() <span class="sc">%&gt;%</span></span>
<span id="cb53-7"><a href="data.html#cb53-7" tabindex="-1"></a>      <span class="fu">nrow</span>(), <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb53-8"><a href="data.html#cb53-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Proportion of delisted responses in test set: 0.1966&quot;</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="data.html#cb55-1" tabindex="-1"></a><span class="fu">paste</span>(</span>
<span id="cb55-2"><a href="data.html#cb55-2" tabindex="-1"></a>  <span class="st">&quot;Median number of years of financial ratios for active companies in train set:&quot;</span>,</span>
<span id="cb55-3"><a href="data.html#cb55-3" tabindex="-1"></a>  <span class="fu">formatC</span>((data.training <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="data.html#cb55-4" tabindex="-1"></a>    <span class="fu">left_join</span>(com, <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date)) <span class="sc">%&gt;%</span></span>
<span id="cb55-5"><a href="data.html#cb55-5" tabindex="-1"></a>    <span class="fu">filter</span>(response <span class="sc">==</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-6"><a href="data.html#cb55-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_active_years =</span> <span class="fu">time_length</span>(<span class="fu">interval</span>(begdat, public_date), <span class="st">&quot;year&quot;</span>)))<span class="sc">$</span>n_active_years <span class="sc">%&gt;%</span></span>
<span id="cb55-7"><a href="data.html#cb55-7" tabindex="-1"></a>    <span class="fu">median</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb55-8"><a href="data.html#cb55-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Median number of years of financial ratios for active companies in train set: 3.923&quot;</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="data.html#cb57-1" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Are there missing cells in train set? -&quot;</span>, <span class="fu">any</span>(<span class="fu">colSums</span>(<span class="fu">is.na</span>(data.training)) <span class="sc">&gt;</span> <span class="dv">0</span>))</span></code></pre></div>
<pre><code>## [1] &quot;Are there missing cells in train set? - FALSE&quot;</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="data.html#cb59-1" tabindex="-1"></a><span class="co"># sampled time points of financial ratios of active companies</span></span>
<span id="cb59-2"><a href="data.html#cb59-2" tabindex="-1"></a>com.active.years <span class="ot">&lt;-</span> com.time_points.sample <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="data.html#cb59-3" tabindex="-1"></a>  <span class="fu">left_join</span>(com, <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date)) <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="data.html#cb59-4" tabindex="-1"></a>  <span class="fu">filter</span>(event_group <span class="sc">==</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="data.html#cb59-5" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">year =</span> <span class="fu">floor_date</span>(public_date, <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-6"><a href="data.html#cb59-6" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">number_of_companies =</span> <span class="fu">n</span>())</span>
<span id="cb59-7"><a href="data.html#cb59-7" tabindex="-1"></a></span>
<span id="cb59-8"><a href="data.html#cb59-8" tabindex="-1"></a>com.active.frequency <span class="ot">&lt;-</span> com <span class="sc">%&gt;%</span></span>
<span id="cb59-9"><a href="data.html#cb59-9" tabindex="-1"></a>  <span class="fu">filter</span>(event_group <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-10"><a href="data.html#cb59-10" tabindex="-1"></a>  <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb59-11"><a href="data.html#cb59-11" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-12"><a href="data.html#cb59-12" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-13"><a href="data.html#cb59-13" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">floor_date</span>(<span class="fu">ymd</span>(enddat), <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-14"><a href="data.html#cb59-14" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb59-15"><a href="data.html#cb59-15" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb59-16"><a href="data.html#cb59-16" tabindex="-1"></a>    <span class="at">number_of_delistings =</span> <span class="fu">n</span>(),</span>
<span id="cb59-17"><a href="data.html#cb59-17" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb59-18"><a href="data.html#cb59-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb59-19"><a href="data.html#cb59-19" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb59-20"><a href="data.html#cb59-20" tabindex="-1"></a>    <span class="at">proportion_wanted =</span> number_of_delistings <span class="sc">/</span> <span class="fu">sum</span>(number_of_delistings)</span>
<span id="cb59-21"><a href="data.html#cb59-21" tabindex="-1"></a>  )</span>
<span id="cb59-22"><a href="data.html#cb59-22" tabindex="-1"></a></span>
<span id="cb59-23"><a href="data.html#cb59-23" tabindex="-1"></a>com.active.begdat <span class="ot">&lt;-</span> com.time_points.sample <span class="sc">%&gt;%</span></span>
<span id="cb59-24"><a href="data.html#cb59-24" tabindex="-1"></a>  <span class="fu">left_join</span>(com, <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date)) <span class="sc">%&gt;%</span></span>
<span id="cb59-25"><a href="data.html#cb59-25" tabindex="-1"></a>  <span class="fu">filter</span>(event_group <span class="sc">==</span> <span class="st">&quot;active&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-26"><a href="data.html#cb59-26" tabindex="-1"></a>  <span class="fu">group_by</span>(permno) <span class="sc">%&gt;%</span></span>
<span id="cb59-27"><a href="data.html#cb59-27" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-28"><a href="data.html#cb59-28" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-29"><a href="data.html#cb59-29" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">year =</span> <span class="fu">floor_date</span>(begdat, <span class="st">&quot;year&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-30"><a href="data.html#cb59-30" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">number_of_companies =</span> <span class="fu">n</span>())</span>
<span id="cb59-31"><a href="data.html#cb59-31" tabindex="-1"></a></span>
<span id="cb59-32"><a href="data.html#cb59-32" tabindex="-1"></a>subtitle <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb59-33"><a href="data.html#cb59-33" tabindex="-1"></a>    <span class="st">&#39;&lt;span style=&quot;color:{colors[&quot;blue&quot;]}&quot;&gt;**Number of companies by begdat**&lt;/span&gt;, &#39;</span>,</span>
<span id="cb59-34"><a href="data.html#cb59-34" tabindex="-1"></a>    <span class="st">&#39;&lt;span style=&quot;color:{colors[&quot;orange&quot;]}&quot;&gt;**number of companies by public_date**&lt;/span&gt;,&lt;br&gt;&#39;</span>,</span>
<span id="cb59-35"><a href="data.html#cb59-35" tabindex="-1"></a>    <span class="st">&#39;&lt;span style=&quot;color:{colors[&quot;magenta&quot;]}&quot;&gt;**ideal number of companies proportional to delisting**&lt;/span&gt;&#39;</span></span>
<span id="cb59-36"><a href="data.html#cb59-36" tabindex="-1"></a>  )</span>
<span id="cb59-37"><a href="data.html#cb59-37" tabindex="-1"></a></span>
<span id="cb59-38"><a href="data.html#cb59-38" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb59-39"><a href="data.html#cb59-39" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb59-40"><a href="data.html#cb59-40" tabindex="-1"></a>    <span class="at">data =</span> com.active.years,</span>
<span id="cb59-41"><a href="data.html#cb59-41" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> number_of_companies, <span class="at">color =</span> <span class="st">&quot;# companies by public_date&quot;</span>),</span>
<span id="cb59-42"><a href="data.html#cb59-42" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb59-43"><a href="data.html#cb59-43" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-44"><a href="data.html#cb59-44" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb59-45"><a href="data.html#cb59-45" tabindex="-1"></a>    <span class="at">data =</span> com.active.frequency,</span>
<span id="cb59-46"><a href="data.html#cb59-46" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb59-47"><a href="data.html#cb59-47" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> proportion_wanted <span class="sc">*</span> <span class="fu">sum</span>(com.active.years<span class="sc">$</span>number_of_companies),</span>
<span id="cb59-48"><a href="data.html#cb59-48" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;ideal # companies proportional to delisting&quot;</span></span>
<span id="cb59-49"><a href="data.html#cb59-49" tabindex="-1"></a>    ),</span>
<span id="cb59-50"><a href="data.html#cb59-50" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb59-51"><a href="data.html#cb59-51" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-52"><a href="data.html#cb59-52" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb59-53"><a href="data.html#cb59-53" tabindex="-1"></a>    <span class="at">data =</span> com.active.begdat,</span>
<span id="cb59-54"><a href="data.html#cb59-54" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> number_of_companies, <span class="at">color =</span> <span class="st">&quot;# companies by begdat&quot;</span>),</span>
<span id="cb59-55"><a href="data.html#cb59-55" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb59-56"><a href="data.html#cb59-56" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-57"><a href="data.html#cb59-57" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb59-58"><a href="data.html#cb59-58" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(</span>
<span id="cb59-59"><a href="data.html#cb59-59" tabindex="-1"></a>      <span class="st">&quot;# companies by begdat&quot;</span>, <span class="st">&quot;# companies by public_date&quot;</span>,</span>
<span id="cb59-60"><a href="data.html#cb59-60" tabindex="-1"></a>      <span class="st">&quot;ideal # companies proportional to delisting&quot;</span></span>
<span id="cb59-61"><a href="data.html#cb59-61" tabindex="-1"></a>    ),</span>
<span id="cb59-62"><a href="data.html#cb59-62" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb59-63"><a href="data.html#cb59-63" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;blue&quot;</span>]),</span>
<span id="cb59-64"><a href="data.html#cb59-64" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;orange&quot;</span>]),</span>
<span id="cb59-65"><a href="data.html#cb59-65" tabindex="-1"></a>      <span class="fu">as.character</span>(colors[<span class="st">&quot;magenta&quot;</span>])</span>
<span id="cb59-66"><a href="data.html#cb59-66" tabindex="-1"></a>    )</span>
<span id="cb59-67"><a href="data.html#cb59-67" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-68"><a href="data.html#cb59-68" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb59-69"><a href="data.html#cb59-69" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Number of active and listed companies&quot;</span>,</span>
<span id="cb59-70"><a href="data.html#cb59-70" tabindex="-1"></a>    <span class="at">subtitle =</span> subtitle,</span>
<span id="cb59-71"><a href="data.html#cb59-71" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;year of financial ratios&quot;</span>,</span>
<span id="cb59-72"><a href="data.html#cb59-72" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Frequency&quot;</span></span>
<span id="cb59-73"><a href="data.html#cb59-73" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-74"><a href="data.html#cb59-74" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb59-75"><a href="data.html#cb59-75" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_markdown</span>(),</span>
<span id="cb59-76"><a href="data.html#cb59-76" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb59-77"><a href="data.html#cb59-77" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/demo-1.png" width="672" />
### Histograms of original vs imputed features
The left histograms are based on features without imputation, the right histograms are based on imputed features.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="data.html#cb60-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(com.features.fin)) {</span>
<span id="cb60-2"><a href="data.html#cb60-2" tabindex="-1"></a>  feature_description <span class="ot">&lt;-</span> com.features.fin[[i, <span class="dv">1</span>]]</span>
<span id="cb60-3"><a href="data.html#cb60-3" tabindex="-1"></a>  feature_identifier <span class="ot">&lt;-</span> com.features.fin[[i, <span class="dv">2</span>]]</span>
<span id="cb60-4"><a href="data.html#cb60-4" tabindex="-1"></a></span>
<span id="cb60-5"><a href="data.html#cb60-5" tabindex="-1"></a>  plot_without_imputation <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb60-6"><a href="data.html#cb60-6" tabindex="-1"></a>    com.winsorized,</span>
<span id="cb60-7"><a href="data.html#cb60-7" tabindex="-1"></a>    feature_identifier,</span>
<span id="cb60-8"><a href="data.html#cb60-8" tabindex="-1"></a>    feature_description</span>
<span id="cb60-9"><a href="data.html#cb60-9" tabindex="-1"></a>  )</span>
<span id="cb60-10"><a href="data.html#cb60-10" tabindex="-1"></a></span>
<span id="cb60-11"><a href="data.html#cb60-11" tabindex="-1"></a>  plot_with_imputation_pmm <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb60-12"><a href="data.html#cb60-12" tabindex="-1"></a>    com.imputed <span class="sc">%&gt;%</span></span>
<span id="cb60-13"><a href="data.html#cb60-13" tabindex="-1"></a>      <span class="fu">left_join</span>(com.winsorized <span class="sc">%&gt;%</span> <span class="fu">select</span>(permno, public_date, years_to_delisting), <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date)),</span>
<span id="cb60-14"><a href="data.html#cb60-14" tabindex="-1"></a>    feature_identifier,</span>
<span id="cb60-15"><a href="data.html#cb60-15" tabindex="-1"></a>    feature_description</span>
<span id="cb60-16"><a href="data.html#cb60-16" tabindex="-1"></a>  )</span>
<span id="cb60-17"><a href="data.html#cb60-17" tabindex="-1"></a></span>
<span id="cb60-18"><a href="data.html#cb60-18" tabindex="-1"></a>  <span class="fu">print</span>(plot_without_imputation <span class="sc">|</span> plot_with_imputation_pmm)</span>
<span id="cb60-19"><a href="data.html#cb60-19" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/histrograms.imputed-1.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-2.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-3.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-4.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-5.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-6.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-7.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-8.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-9.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-10.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-11.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-12.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-13.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-14.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-15.png" width="672" /><img src="_main_files/figure-html/histrograms.imputed-16.png" width="672" /></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="data.html#cb61-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(</span>
<span id="cb61-2"><a href="data.html#cb61-2" tabindex="-1"></a>  <span class="st">&quot;Number of missing cells in original data set: &quot;</span>,</span>
<span id="cb61-3"><a href="data.html#cb61-3" tabindex="-1"></a>  com <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.)))</span>
<span id="cb61-4"><a href="data.html#cb61-4" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## [1] &quot;Number of missing cells in original data set:  543630&quot;</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="data.html#cb63-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(</span>
<span id="cb63-2"><a href="data.html#cb63-2" tabindex="-1"></a>  <span class="st">&quot;Number of missing cells in imputed data set: &quot;</span>,</span>
<span id="cb63-3"><a href="data.html#cb63-3" tabindex="-1"></a>  com.imputed <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.)))</span>
<span id="cb63-4"><a href="data.html#cb63-4" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## [1] &quot;Number of missing cells in imputed data set:  0&quot;</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="empirical-results.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/index.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
