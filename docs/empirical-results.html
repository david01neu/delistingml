<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Empirical Results | Prediction of Delisting using a Machine Learning Ensemble</title>
  <meta name="description" content="<p>R markdown file for the project “Prediction of Delisting using a Machine
Learning Ensemble”</p>" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Empirical Results | Prediction of Delisting using a Machine Learning Ensemble" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>R markdown file for the project “Prediction of Delisting using a Machine
Learning Ensemble”</p>" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Empirical Results | Prediction of Delisting using a Machine Learning Ensemble" />
  
  <meta name="twitter:description" content="<p>R markdown file for the project “Prediction of Delisting using a Machine
Learning Ensemble”</p>" />
  

<meta name="author" content="David Neuhäusler, Jungyeon Yoon, Richard A. Levine, Juanjuan Fan" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/testrmd-0.0.1.9000/testrmd.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Predicition of Delisting</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>2</b> Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data.html"><a href="data.html#delisting-financial-and-macroeconomic-data"><i class="fa fa-check"></i><b>2.1</b> Delisting, financial and macroeconomic data</a></li>
<li class="chapter" data-level="2.2" data-path="data.html"><a href="data.html#exploratory-data-analysis"><i class="fa fa-check"></i><b>2.2</b> Exploratory Data Analysis</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data.html"><a href="data.html#overview-over-deslisting-dates"><i class="fa fa-check"></i><b>2.2.1</b> Overview over deslisting dates</a></li>
<li class="chapter" data-level="2.2.2" data-path="data.html"><a href="data.html#correlation-analysis"><i class="fa fa-check"></i><b>2.2.2</b> Correlation analysis</a></li>
<li class="chapter" data-level="2.2.3" data-path="data.html"><a href="data.html#summary-statistics-for-features"><i class="fa fa-check"></i><b>2.2.3</b> Summary statistics for features</a></li>
<li class="chapter" data-level="2.2.4" data-path="data.html"><a href="data.html#features-and-delisting-frequency"><i class="fa fa-check"></i><b>2.2.4</b> Features and delisting frequency</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data.html"><a href="data.html#predictor-data-set"><i class="fa fa-check"></i><b>2.3</b> Predictor data set</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="data.html"><a href="data.html#identifiy-duplicates"><i class="fa fa-check"></i><b>2.3.1</b> Identifiy duplicates</a></li>
<li class="chapter" data-level="2.3.2" data-path="data.html"><a href="data.html#missing-data"><i class="fa fa-check"></i><b>2.3.2</b> Missing data</a></li>
<li class="chapter" data-level="2.3.3" data-path="data.html"><a href="data.html#predictior-data-set"><i class="fa fa-check"></i><b>2.3.3</b> Predictior data set</a></li>
<li class="chapter" data-level="2.3.4" data-path="data.html"><a href="data.html#prepare-predictor-data-set"><i class="fa fa-check"></i><b>2.3.4</b> Prepare predictor data set</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="empirical-results.html"><a href="empirical-results.html"><i class="fa fa-check"></i><b>3</b> Empirical Results</a>
<ul>
<li class="chapter" data-level="3.1" data-path="empirical-results.html"><a href="empirical-results.html#random-forest"><i class="fa fa-check"></i><b>3.1</b> Random forest</a></li>
<li class="chapter" data-level="3.2" data-path="empirical-results.html"><a href="empirical-results.html#logistic-regression"><i class="fa fa-check"></i><b>3.2</b> Logistic Regression</a></li>
<li class="chapter" data-level="3.3" data-path="empirical-results.html"><a href="empirical-results.html#support-vector-machine"><i class="fa fa-check"></i><b>3.3</b> Support Vector Machine</a></li>
<li class="chapter" data-level="3.4" data-path="empirical-results.html"><a href="empirical-results.html#neural-net"><i class="fa fa-check"></i><b>3.4</b> Neural net</a></li>
<li class="chapter" data-level="3.5" data-path="empirical-results.html"><a href="empirical-results.html#boosting"><i class="fa fa-check"></i><b>3.5</b> Boosting</a></li>
<li class="chapter" data-level="3.6" data-path="empirical-results.html"><a href="empirical-results.html#ensemble"><i class="fa fa-check"></i><b>3.6</b> Ensemble</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Prediction of Delisting using a Machine Learning Ensemble</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="empirical-results" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> Empirical Results<a href="empirical-results.html#empirical-results" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><strong>Metrics</strong></p>
<p>Contingency table</p>
<table>
<thead>
<tr class="header">
<th>observation</th>
<th>prediction delisted</th>
<th>prediction active</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>delisted</td>
<td>TP</td>
<td>FN</td>
</tr>
<tr class="even">
<td>active</td>
<td>FP</td>
<td>TN</td>
</tr>
</tbody>
</table>
<p><span class="math display">\[
\text{Accuracy} = \frac{TP+TN}{TP+TN+FP+FN}
\]</span>
<span class="math display">\[
\text{Precision} = \frac{\text{# true positives}}{\text{# predicted positives}} = \frac{TP}{TP+FP}
\]</span>
<span class="math display">\[
\text{Recall} = \text{Sensitivity} = \frac{\text{# true positives}}{\text{# actual positives}} = \frac{TP}{TP+FN}
\]</span>
<span class="math display">\[F_1\text{ score} = 2 \cdot \frac{\text{precision} \cdot \text{recall}}{\text{precision} + \text{recall}} \qquad \text{(harmonic mean of precision and recall)}
\]</span>
<span class="math display">\[
\text{Specificity} = \frac{\text{# true negatives}}{\text{# actual negatives}} = \frac{TN}{TN+FP}
\]</span>
<span class="math display">\[
\text{Matthew&#39;s Correlation Coefficient} = \text{MCC} = \frac{TN \cdot TP - FN \cdot FP}{\sqrt{(TP+FP)\cdot (TP+FN)\cdot (TN+FP)\cdot (TN+FN)}}
\]</span></p>
<p><strong>Helper functions</strong></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="empirical-results.html#cb65-1" tabindex="-1"></a><span class="co">#&#39; computes performance metrics true positives (tp), false negatives (fn),</span></span>
<span id="cb65-2"><a href="empirical-results.html#cb65-2" tabindex="-1"></a><span class="co">#&#39; false positives (fp), true negatives (tn), accuracy, precision, recall,</span></span>
<span id="cb65-3"><a href="empirical-results.html#cb65-3" tabindex="-1"></a><span class="co">#&#39; F1 score (f1), specificity and Matthew&#39;s correlation coefficient (mcc)</span></span>
<span id="cb65-4"><a href="empirical-results.html#cb65-4" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-5"><a href="empirical-results.html#cb65-5" tabindex="-1"></a><span class="co">#&#39; @param actuals vector containing {0,1} values representing the actual response</span></span>
<span id="cb65-6"><a href="empirical-results.html#cb65-6" tabindex="-1"></a><span class="co">#&#39; @param preds vector containing {0,1} values with predicted response</span></span>
<span id="cb65-7"><a href="empirical-results.html#cb65-7" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-8"><a href="empirical-results.html#cb65-8" tabindex="-1"></a><span class="co">#&#39; @return list/tibble of computed metrics</span></span>
<span id="cb65-9"><a href="empirical-results.html#cb65-9" tabindex="-1"></a>compute.metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(actuals, preds) {</span>
<span id="cb65-10"><a href="empirical-results.html#cb65-10" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(actuals)) {</span>
<span id="cb65-11"><a href="empirical-results.html#cb65-11" tabindex="-1"></a>    actuals <span class="ot">=</span> actuals <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span></span>
<span id="cb65-12"><a href="empirical-results.html#cb65-12" tabindex="-1"></a>  }</span>
<span id="cb65-13"><a href="empirical-results.html#cb65-13" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(preds)) {</span>
<span id="cb65-14"><a href="empirical-results.html#cb65-14" tabindex="-1"></a>    preds <span class="ot">=</span> preds <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span></span>
<span id="cb65-15"><a href="empirical-results.html#cb65-15" tabindex="-1"></a>  }</span>
<span id="cb65-16"><a href="empirical-results.html#cb65-16" tabindex="-1"></a>  </span>
<span id="cb65-17"><a href="empirical-results.html#cb65-17" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">sum</span>(actuals <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> preds <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-18"><a href="empirical-results.html#cb65-18" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">sum</span>(actuals <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> preds <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb65-19"><a href="empirical-results.html#cb65-19" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">sum</span>(actuals <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> preds <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-20"><a href="empirical-results.html#cb65-20" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">sum</span>(actuals <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> preds <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb65-21"><a href="empirical-results.html#cb65-21" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> tp <span class="sc">/</span> (tp <span class="sc">+</span> fp)</span>
<span id="cb65-22"><a href="empirical-results.html#cb65-22" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> tp <span class="sc">/</span> (tp <span class="sc">+</span> fn)</span>
<span id="cb65-23"><a href="empirical-results.html#cb65-23" tabindex="-1"></a>  </span>
<span id="cb65-24"><a href="empirical-results.html#cb65-24" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">tibble</span>(<span class="at">tp =</span> tp, <span class="co"># TP</span></span>
<span id="cb65-25"><a href="empirical-results.html#cb65-25" tabindex="-1"></a>    <span class="at">fn =</span> fn, <span class="co"># FN</span></span>
<span id="cb65-26"><a href="empirical-results.html#cb65-26" tabindex="-1"></a>    <span class="at">fp =</span> fp, <span class="co"># FP</span></span>
<span id="cb65-27"><a href="empirical-results.html#cb65-27" tabindex="-1"></a>    <span class="at">tn =</span> tn, <span class="co"># TN</span></span>
<span id="cb65-28"><a href="empirical-results.html#cb65-28" tabindex="-1"></a>    <span class="at">accuracy =</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> fn <span class="sc">+</span> fp <span class="sc">+</span> tn), <span class="co"># accuracy</span></span>
<span id="cb65-29"><a href="empirical-results.html#cb65-29" tabindex="-1"></a>    <span class="at">precision =</span> precision, <span class="co"># precision</span></span>
<span id="cb65-30"><a href="empirical-results.html#cb65-30" tabindex="-1"></a>    <span class="at">recall =</span> recall, <span class="co"># recall / sensitivity</span></span>
<span id="cb65-31"><a href="empirical-results.html#cb65-31" tabindex="-1"></a>    <span class="at">f1 =</span> <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="co"># F1 score</span></span>
<span id="cb65-32"><a href="empirical-results.html#cb65-32" tabindex="-1"></a>    <span class="at">specificity =</span> tn <span class="sc">/</span> (tn <span class="sc">+</span> fp), <span class="co"># specificity</span></span>
<span id="cb65-33"><a href="empirical-results.html#cb65-33" tabindex="-1"></a>    <span class="at">mcc =</span> (tn <span class="sc">*</span> tp <span class="sc">-</span> fn <span class="sc">*</span> fp) <span class="sc">/</span> <span class="fu">sqrt</span>((tp<span class="sc">+</span>fp))<span class="sc">/</span><span class="fu">sqrt</span>((tp<span class="sc">+</span>fn))<span class="sc">/</span><span class="fu">sqrt</span>((tn<span class="sc">+</span>fp))<span class="sc">/</span><span class="fu">sqrt</span>((tn<span class="sc">+</span>fn)) <span class="co"># mcc</span></span>
<span id="cb65-34"><a href="empirical-results.html#cb65-34" tabindex="-1"></a>    )</span>
<span id="cb65-35"><a href="empirical-results.html#cb65-35" tabindex="-1"></a>  )</span>
<span id="cb65-36"><a href="empirical-results.html#cb65-36" tabindex="-1"></a>}</span>
<span id="cb65-37"><a href="empirical-results.html#cb65-37" tabindex="-1"></a></span>
<span id="cb65-38"><a href="empirical-results.html#cb65-38" tabindex="-1"></a><span class="co">#&#39; computes performance metrics based on predicted probabilities for two classes.</span></span>
<span id="cb65-39"><a href="empirical-results.html#cb65-39" tabindex="-1"></a><span class="co">#&#39; optimal threshold for classification determined by MCC-F1 and ROC </span></span>
<span id="cb65-40"><a href="empirical-results.html#cb65-40" tabindex="-1"></a><span class="co">#&#39; optimality criteria</span></span>
<span id="cb65-41"><a href="empirical-results.html#cb65-41" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-42"><a href="empirical-results.html#cb65-42" tabindex="-1"></a><span class="co">#&#39; @param data data frame containing actual response (obs) and predicted </span></span>
<span id="cb65-43"><a href="empirical-results.html#cb65-43" tabindex="-1"></a><span class="co">#&#39;             probabilities for the positive class (delisted)</span></span>
<span id="cb65-44"><a href="empirical-results.html#cb65-44" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-45"><a href="empirical-results.html#cb65-45" tabindex="-1"></a><span class="co">#&#39; @return vector with labelled performance metrics</span></span>
<span id="cb65-46"><a href="empirical-results.html#cb65-46" tabindex="-1"></a>compute.summary <span class="ot">&lt;-</span> <span class="cf">function</span> (data, <span class="at">lev =</span> <span class="cn">NULL</span>, <span class="at">model =</span> <span class="cn">NULL</span>) {</span>
<span id="cb65-47"><a href="empirical-results.html#cb65-47" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(lev) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb65-48"><a href="empirical-results.html#cb65-48" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">&quot;Your outcome has&quot;</span>, <span class="fu">length</span>(lev), <span class="st">&quot;levels.&quot;</span>,</span>
<span id="cb65-49"><a href="empirical-results.html#cb65-49" tabindex="-1"></a>               <span class="st">&quot;The compute.summary() function isn&#39;t appropriate.&quot;</span>))</span>
<span id="cb65-50"><a href="empirical-results.html#cb65-50" tabindex="-1"></a>  }</span>
<span id="cb65-51"><a href="empirical-results.html#cb65-51" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">levels</span>(data[, <span class="st">&quot;pred&quot;</span>]) <span class="sc">==</span> lev)) {</span>
<span id="cb65-52"><a href="empirical-results.html#cb65-52" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Levels of observed and predicted data do not match.&quot;</span>)</span>
<span id="cb65-53"><a href="empirical-results.html#cb65-53" tabindex="-1"></a>  }</span>
<span id="cb65-54"><a href="empirical-results.html#cb65-54" tabindex="-1"></a></span>
<span id="cb65-55"><a href="empirical-results.html#cb65-55" tabindex="-1"></a>  <span class="co"># MCC-F1 cutpoint</span></span>
<span id="cb65-56"><a href="empirical-results.html#cb65-56" tabindex="-1"></a>  mccf1cutpoint <span class="ot">&lt;-</span> <span class="fu">compute.mccf1cutpoint</span>(data<span class="sc">$</span>delisted, data<span class="sc">$</span>obs)</span>
<span id="cb65-57"><a href="empirical-results.html#cb65-57" tabindex="-1"></a>  best_cutpoint.mccf1 <span class="ot">&lt;-</span> mccf1cutpoint<span class="sc">$</span>best_cutpoint</span>
<span id="cb65-58"><a href="empirical-results.html#cb65-58" tabindex="-1"></a>  metrics.mccf1 <span class="ot">&lt;-</span> <span class="fu">compute.metrics</span>(data<span class="sc">$</span>obs, data<span class="sc">$</span>delisted <span class="sc">&gt;=</span> best_cutpoint.mccf1)</span>
<span id="cb65-59"><a href="empirical-results.html#cb65-59" tabindex="-1"></a>  <span class="fu">colnames</span>(metrics.mccf1) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(metrics.mccf1), <span class="st">&quot;mccf1&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb65-60"><a href="empirical-results.html#cb65-60" tabindex="-1"></a>  metrics.mccf1 <span class="ot">&lt;-</span> metrics.mccf1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">mccf1.mccf1 =</span> mccf1cutpoint<span class="sc">$</span>mccf1metric)</span>
<span id="cb65-61"><a href="empirical-results.html#cb65-61" tabindex="-1"></a>  </span>
<span id="cb65-62"><a href="empirical-results.html#cb65-62" tabindex="-1"></a>  <span class="co"># ROC cutpoint</span></span>
<span id="cb65-63"><a href="empirical-results.html#cb65-63" tabindex="-1"></a>  roc_auc <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(data<span class="sc">$</span>delisted, data<span class="sc">$</span>obs)</span>
<span id="cb65-64"><a href="empirical-results.html#cb65-64" tabindex="-1"></a>  best_cutpoint.roc <span class="ot">&lt;-</span> roc_auc<span class="sc">$</span>best_cutpoint</span>
<span id="cb65-65"><a href="empirical-results.html#cb65-65" tabindex="-1"></a>  metrics.roc <span class="ot">&lt;-</span> <span class="fu">compute.metrics</span>(data<span class="sc">$</span>obs, data<span class="sc">$</span>delisted <span class="sc">&gt;=</span> best_cutpoint.roc)</span>
<span id="cb65-66"><a href="empirical-results.html#cb65-66" tabindex="-1"></a>  <span class="fu">colnames</span>(metrics.roc) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(metrics.roc), <span class="st">&quot;roc&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb65-67"><a href="empirical-results.html#cb65-67" tabindex="-1"></a>  metrics.roc <span class="ot">&lt;-</span> metrics.roc <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">auc.roc =</span> roc_auc<span class="sc">$</span>auc)</span>
<span id="cb65-68"><a href="empirical-results.html#cb65-68" tabindex="-1"></a>  </span>
<span id="cb65-69"><a href="empirical-results.html#cb65-69" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">cbind</span>(metrics.roc, metrics.mccf1))</span>
<span id="cb65-70"><a href="empirical-results.html#cb65-70" tabindex="-1"></a>  </span>
<span id="cb65-71"><a href="empirical-results.html#cb65-71" tabindex="-1"></a>  <span class="fu">return</span> (out)</span>
<span id="cb65-72"><a href="empirical-results.html#cb65-72" tabindex="-1"></a>}</span>
<span id="cb65-73"><a href="empirical-results.html#cb65-73" tabindex="-1"></a></span>
<span id="cb65-74"><a href="empirical-results.html#cb65-74" tabindex="-1"></a><span class="co">#&#39; computes ROC curve for given predictions (binary classification)</span></span>
<span id="cb65-75"><a href="empirical-results.html#cb65-75" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-76"><a href="empirical-results.html#cb65-76" tabindex="-1"></a><span class="co">#&#39; @param preds vector with predicted response</span></span>
<span id="cb65-77"><a href="empirical-results.html#cb65-77" tabindex="-1"></a><span class="co">#&#39; @param actuals vector representing the actual response</span></span>
<span id="cb65-78"><a href="empirical-results.html#cb65-78" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-79"><a href="empirical-results.html#cb65-79" tabindex="-1"></a><span class="co">#&#39; @return plot of ROC curve, best classification threshold/cutpoint,</span></span>
<span id="cb65-80"><a href="empirical-results.html#cb65-80" tabindex="-1"></a><span class="co">#&#39;         area under the curve (AUC), resulting contingency table</span></span>
<span id="cb65-81"><a href="empirical-results.html#cb65-81" tabindex="-1"></a>compute.roc <span class="ot">&lt;-</span> <span class="cf">function</span>(preds, actuals) {</span>
<span id="cb65-82"><a href="empirical-results.html#cb65-82" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(actuals)) {</span>
<span id="cb65-83"><a href="empirical-results.html#cb65-83" tabindex="-1"></a>    actuals <span class="ot">=</span> actuals <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span></span>
<span id="cb65-84"><a href="empirical-results.html#cb65-84" tabindex="-1"></a>  }</span>
<span id="cb65-85"><a href="empirical-results.html#cb65-85" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(preds)) {</span>
<span id="cb65-86"><a href="empirical-results.html#cb65-86" tabindex="-1"></a>    preds <span class="ot">=</span> preds <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span></span>
<span id="cb65-87"><a href="empirical-results.html#cb65-87" tabindex="-1"></a>  }</span>
<span id="cb65-88"><a href="empirical-results.html#cb65-88" tabindex="-1"></a></span>
<span id="cb65-89"><a href="empirical-results.html#cb65-89" tabindex="-1"></a>  auc_roc.result <span class="ot">&lt;-</span> <span class="fu">auc_roc</span>(preds, actuals, <span class="at">returnDT =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-90"><a href="empirical-results.html#cb65-90" tabindex="-1"></a></span>
<span id="cb65-91"><a href="empirical-results.html#cb65-91" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(auc_roc.result) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb65-92"><a href="empirical-results.html#cb65-92" tabindex="-1"></a>    <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">best_cutpoint =</span> auc_roc.result, <span class="at">auc =</span> <span class="fl">0.5</span>))</span>
<span id="cb65-93"><a href="empirical-results.html#cb65-93" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb65-94"><a href="empirical-results.html#cb65-94" tabindex="-1"></a>    <span class="co"># best classification threshold</span></span>
<span id="cb65-95"><a href="empirical-results.html#cb65-95" tabindex="-1"></a>    best_cutpoint <span class="ot">&lt;-</span> auc_roc.result <span class="sc">%&gt;%</span> </span>
<span id="cb65-96"><a href="empirical-results.html#cb65-96" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">dist =</span> <span class="fu">sqrt</span>((<span class="dv">1</span> <span class="sc">-</span> CumulativeTPR)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> CumulativeFPR<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> <span class="co"># Pythagoras (distance to (0,1))</span></span>
<span id="cb65-97"><a href="empirical-results.html#cb65-97" tabindex="-1"></a>      <span class="fu">filter</span>(dist <span class="sc">&lt;=</span> <span class="fu">min</span>(dist))</span>
<span id="cb65-98"><a href="empirical-results.html#cb65-98" tabindex="-1"></a></span>
<span id="cb65-99"><a href="empirical-results.html#cb65-99" tabindex="-1"></a>    plot.roc <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(auc_roc.result, <span class="fu">aes</span>(<span class="at">x =</span> CumulativeFPR, <span class="at">y =</span> CumulativeTPR)) <span class="sc">+</span></span>
<span id="cb65-100"><a href="empirical-results.html#cb65-100" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb65-101"><a href="empirical-results.html#cb65-101" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> best_cutpoint, <span class="fu">aes</span>(CumulativeFPR, CumulativeTPR), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb65-102"><a href="empirical-results.html#cb65-102" tabindex="-1"></a>      <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb65-103"><a href="empirical-results.html#cb65-103" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb65-104"><a href="empirical-results.html#cb65-104" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">&quot;ROC curve&quot;</span>,</span>
<span id="cb65-105"><a href="empirical-results.html#cb65-105" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">&quot;Delisting predictor&quot;</span>,</span>
<span id="cb65-106"><a href="empirical-results.html#cb65-106" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;False positive rate (1 - specificity)&quot;</span>,</span>
<span id="cb65-107"><a href="empirical-results.html#cb65-107" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">&quot;True positive rate&quot;</span></span>
<span id="cb65-108"><a href="empirical-results.html#cb65-108" tabindex="-1"></a>      )</span>
<span id="cb65-109"><a href="empirical-results.html#cb65-109" tabindex="-1"></a>    </span>
<span id="cb65-110"><a href="empirical-results.html#cb65-110" tabindex="-1"></a>    table.prediction <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb65-111"><a href="empirical-results.html#cb65-111" tabindex="-1"></a>        <span class="at">actuals =</span> actuals,</span>
<span id="cb65-112"><a href="empirical-results.html#cb65-112" tabindex="-1"></a>        <span class="at">preds =</span> preds <span class="sc">&gt;=</span> best_cutpoint<span class="sc">$</span>Pred</span>
<span id="cb65-113"><a href="empirical-results.html#cb65-113" tabindex="-1"></a>      )</span>
<span id="cb65-114"><a href="empirical-results.html#cb65-114" tabindex="-1"></a>    </span>
<span id="cb65-115"><a href="empirical-results.html#cb65-115" tabindex="-1"></a>    con.table <span class="ot">&lt;-</span> <span class="fu">table</span>(table.prediction<span class="sc">$</span>actuals, table.prediction<span class="sc">$</span>preds)</span>
<span id="cb65-116"><a href="empirical-results.html#cb65-116" tabindex="-1"></a>    </span>
<span id="cb65-117"><a href="empirical-results.html#cb65-117" tabindex="-1"></a>    <span class="fu">colnames</span>(con.table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;prediction active&quot;</span>, <span class="st">&quot;prediction delisted&quot;</span>)</span>
<span id="cb65-118"><a href="empirical-results.html#cb65-118" tabindex="-1"></a>    <span class="fu">row.names</span>(con.table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;active&quot;</span>, <span class="st">&quot;delisted&quot;</span>)</span>
<span id="cb65-119"><a href="empirical-results.html#cb65-119" tabindex="-1"></a>    <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">plot =</span> plot.roc,</span>
<span id="cb65-120"><a href="empirical-results.html#cb65-120" tabindex="-1"></a>                 <span class="at">best_cutpoint =</span> best_cutpoint<span class="sc">$</span>Pred,</span>
<span id="cb65-121"><a href="empirical-results.html#cb65-121" tabindex="-1"></a>                 <span class="at">best_cutpoint.text =</span> <span class="fu">paste</span>(<span class="st">&quot;Classification threshold&quot;</span>, </span>
<span id="cb65-122"><a href="empirical-results.html#cb65-122" tabindex="-1"></a>                                            <span class="fu">formatC</span>(best_cutpoint<span class="sc">$</span>Pred, <span class="at">digits =</span> <span class="dv">4</span>), </span>
<span id="cb65-123"><a href="empirical-results.html#cb65-123" tabindex="-1"></a>                                            <span class="st">&quot;minimizes distance of ROC curve to (0,1).&quot;</span>),</span>
<span id="cb65-124"><a href="empirical-results.html#cb65-124" tabindex="-1"></a>                 <span class="at">auc =</span> <span class="fu">tail</span>(auc_roc.result<span class="sc">$</span>CumulativeArea, <span class="dv">1</span>),</span>
<span id="cb65-125"><a href="empirical-results.html#cb65-125" tabindex="-1"></a>                 <span class="at">con_table =</span> con.table[<span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>]))</span>
<span id="cb65-126"><a href="empirical-results.html#cb65-126" tabindex="-1"></a>  }</span>
<span id="cb65-127"><a href="empirical-results.html#cb65-127" tabindex="-1"></a>}</span>
<span id="cb65-128"><a href="empirical-results.html#cb65-128" tabindex="-1"></a></span>
<span id="cb65-129"><a href="empirical-results.html#cb65-129" tabindex="-1"></a><span class="co">#&#39; computes MCCF1 curve for given predictions (binary classification)</span></span>
<span id="cb65-130"><a href="empirical-results.html#cb65-130" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-131"><a href="empirical-results.html#cb65-131" tabindex="-1"></a><span class="co">#&#39; @param preds vector with predicted response</span></span>
<span id="cb65-132"><a href="empirical-results.html#cb65-132" tabindex="-1"></a><span class="co">#&#39; @param actuals vector representing the actual response</span></span>
<span id="cb65-133"><a href="empirical-results.html#cb65-133" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-134"><a href="empirical-results.html#cb65-134" tabindex="-1"></a><span class="co">#&#39; @return plot of MCCF1 curve, best classification threshold/cutpoint,</span></span>
<span id="cb65-135"><a href="empirical-results.html#cb65-135" tabindex="-1"></a><span class="co">#&#39;         value of MCCF1 metric, resulting contingency table</span></span>
<span id="cb65-136"><a href="empirical-results.html#cb65-136" tabindex="-1"></a>compute.mccf1cutpoint <span class="ot">&lt;-</span> <span class="cf">function</span>(preds, actuals) {</span>
<span id="cb65-137"><a href="empirical-results.html#cb65-137" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(actuals)) {</span>
<span id="cb65-138"><a href="empirical-results.html#cb65-138" tabindex="-1"></a>    actuals <span class="ot">=</span> actuals <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span></span>
<span id="cb65-139"><a href="empirical-results.html#cb65-139" tabindex="-1"></a>  }</span>
<span id="cb65-140"><a href="empirical-results.html#cb65-140" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(preds)) {</span>
<span id="cb65-141"><a href="empirical-results.html#cb65-141" tabindex="-1"></a>    preds <span class="ot">=</span> preds <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span></span>
<span id="cb65-142"><a href="empirical-results.html#cb65-142" tabindex="-1"></a>  }</span>
<span id="cb65-143"><a href="empirical-results.html#cb65-143" tabindex="-1"></a>  </span>
<span id="cb65-144"><a href="empirical-results.html#cb65-144" tabindex="-1"></a>  mccf1.result <span class="ot">&lt;-</span> <span class="fu">mccf1</span>(preds, actuals)</span>
<span id="cb65-145"><a href="empirical-results.html#cb65-145" tabindex="-1"></a>  mccf1.summary <span class="ot">&lt;-</span> <span class="fu">summary.mccf1</span>(mccf1.result) <span class="co"># best threshold and mccf1 metric</span></span>
<span id="cb65-146"><a href="empirical-results.html#cb65-146" tabindex="-1"></a></span>
<span id="cb65-147"><a href="empirical-results.html#cb65-147" tabindex="-1"></a>  plot.mccf1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mccf1.result, <span class="fu">aes</span>(<span class="at">x =</span> f1, <span class="at">y =</span> mcc.nor)) <span class="sc">+</span></span>
<span id="cb65-148"><a href="empirical-results.html#cb65-148" tabindex="-1"></a>    <span class="fu">geom_path</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb65-149"><a href="empirical-results.html#cb65-149" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> mccf1.result <span class="sc">%&gt;%</span> <span class="fu">filter</span>(preds <span class="sc">==</span> mccf1.summary<span class="sc">$</span>best_threshold),</span>
<span id="cb65-150"><a href="empirical-results.html#cb65-150" tabindex="-1"></a>                <span class="fu">aes</span>(f1, mcc.nor), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb65-151"><a href="empirical-results.html#cb65-151" tabindex="-1"></a>    <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb65-152"><a href="empirical-results.html#cb65-152" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb65-153"><a href="empirical-results.html#cb65-153" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb65-154"><a href="empirical-results.html#cb65-154" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb65-155"><a href="empirical-results.html#cb65-155" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;MCC vs. F1-score&quot;</span>,</span>
<span id="cb65-156"><a href="empirical-results.html#cb65-156" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">&quot;Delisting predictor&quot;</span>,</span>
<span id="cb65-157"><a href="empirical-results.html#cb65-157" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;F1 score&quot;</span>,</span>
<span id="cb65-158"><a href="empirical-results.html#cb65-158" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">&quot;unit-normalized MCC&quot;</span></span>
<span id="cb65-159"><a href="empirical-results.html#cb65-159" tabindex="-1"></a>    )</span>
<span id="cb65-160"><a href="empirical-results.html#cb65-160" tabindex="-1"></a></span>
<span id="cb65-161"><a href="empirical-results.html#cb65-161" tabindex="-1"></a>  table.prediction <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb65-162"><a href="empirical-results.html#cb65-162" tabindex="-1"></a>      <span class="at">actuals =</span> actuals,</span>
<span id="cb65-163"><a href="empirical-results.html#cb65-163" tabindex="-1"></a>      <span class="at">preds =</span> preds <span class="sc">&gt;=</span> <span class="fu">as.numeric</span>(mccf1.summary<span class="sc">$</span>best_threshold)</span>
<span id="cb65-164"><a href="empirical-results.html#cb65-164" tabindex="-1"></a>    )</span>
<span id="cb65-165"><a href="empirical-results.html#cb65-165" tabindex="-1"></a>  </span>
<span id="cb65-166"><a href="empirical-results.html#cb65-166" tabindex="-1"></a>  con.table <span class="ot">&lt;-</span> <span class="fu">table</span>(table.prediction<span class="sc">$</span>actuals, table.prediction<span class="sc">$</span>preds)</span>
<span id="cb65-167"><a href="empirical-results.html#cb65-167" tabindex="-1"></a>  <span class="fu">colnames</span>(con.table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;prediction active&quot;</span>, <span class="st">&quot;prediction delisted&quot;</span>)</span>
<span id="cb65-168"><a href="empirical-results.html#cb65-168" tabindex="-1"></a>  <span class="fu">row.names</span>(con.table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;active&quot;</span>, <span class="st">&quot;delisted&quot;</span>)</span>
<span id="cb65-169"><a href="empirical-results.html#cb65-169" tabindex="-1"></a></span>
<span id="cb65-170"><a href="empirical-results.html#cb65-170" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">plot =</span> plot.mccf1,</span>
<span id="cb65-171"><a href="empirical-results.html#cb65-171" tabindex="-1"></a>               <span class="at">best_cutpoint =</span> mccf1.summary<span class="sc">$</span>best_threshold,</span>
<span id="cb65-172"><a href="empirical-results.html#cb65-172" tabindex="-1"></a>               <span class="at">best_cutpoint.text =</span> <span class="fu">paste</span>(<span class="st">&quot;Classification threshold&quot;</span>, </span>
<span id="cb65-173"><a href="empirical-results.html#cb65-173" tabindex="-1"></a>                                          <span class="fu">formatC</span>(<span class="fu">as.numeric</span>(mccf1.summary<span class="sc">$</span>best_threshold), <span class="at">digits =</span> <span class="dv">4</span>), </span>
<span id="cb65-174"><a href="empirical-results.html#cb65-174" tabindex="-1"></a>                                          <span class="st">&quot;maximizes MCCF1 metric.&quot;</span>),</span>
<span id="cb65-175"><a href="empirical-results.html#cb65-175" tabindex="-1"></a>               <span class="at">mccf1metric =</span> mccf1.summary<span class="sc">$</span>mccf1_metric,</span>
<span id="cb65-176"><a href="empirical-results.html#cb65-176" tabindex="-1"></a>               <span class="at">con_table =</span> con.table))</span>
<span id="cb65-177"><a href="empirical-results.html#cb65-177" tabindex="-1"></a>}</span>
<span id="cb65-178"><a href="empirical-results.html#cb65-178" tabindex="-1"></a></span>
<span id="cb65-179"><a href="empirical-results.html#cb65-179" tabindex="-1"></a><span class="co">#&#39; computes MCCF1 curve for given predictions (binary classification)</span></span>
<span id="cb65-180"><a href="empirical-results.html#cb65-180" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-181"><a href="empirical-results.html#cb65-181" tabindex="-1"></a><span class="co">#&#39; @param preds vector with predicted response</span></span>
<span id="cb65-182"><a href="empirical-results.html#cb65-182" tabindex="-1"></a><span class="co">#&#39; @param actuals vector representing the actual response</span></span>
<span id="cb65-183"><a href="empirical-results.html#cb65-183" tabindex="-1"></a><span class="co">#&#39; @param mccf1cutpoint true if computation uses MCCF1 curve, false if ROC curve</span></span>
<span id="cb65-184"><a href="empirical-results.html#cb65-184" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-185"><a href="empirical-results.html#cb65-185" tabindex="-1"></a><span class="co">#&#39; @return best classification cutpoint | additionally plot of curve,</span></span>
<span id="cb65-186"><a href="empirical-results.html#cb65-186" tabindex="-1"></a><span class="co">#&#39;         value of MCCF1/AUC metric, resulting contingency table</span></span>
<span id="cb65-187"><a href="empirical-results.html#cb65-187" tabindex="-1"></a>compute.cutpoint <span class="ot">&lt;-</span> <span class="cf">function</span>(preds, actuals, <span class="at">mccf1cutpoint =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb65-188"><a href="empirical-results.html#cb65-188" tabindex="-1"></a>  <span class="cf">if</span> (mccf1cutpoint) {</span>
<span id="cb65-189"><a href="empirical-results.html#cb65-189" tabindex="-1"></a>    <span class="fu">return</span> (<span class="fu">compute.mccf1cutpoint</span>(preds, actuals))</span>
<span id="cb65-190"><a href="empirical-results.html#cb65-190" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb65-191"><a href="empirical-results.html#cb65-191" tabindex="-1"></a>    <span class="fu">return</span> (<span class="fu">compute.roc</span>(preds, actuals))</span>
<span id="cb65-192"><a href="empirical-results.html#cb65-192" tabindex="-1"></a>  }</span>
<span id="cb65-193"><a href="empirical-results.html#cb65-193" tabindex="-1"></a>}</span></code></pre></div>
<p>Helper function to display variable importance</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="empirical-results.html#cb66-1" tabindex="-1"></a><span class="co">#&#39; visualize 20 most important features</span></span>
<span id="cb66-2"><a href="empirical-results.html#cb66-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb66-3"><a href="empirical-results.html#cb66-3" tabindex="-1"></a><span class="co">#&#39; @param data data frame containing feature name and relative variable</span></span>
<span id="cb66-4"><a href="empirical-results.html#cb66-4" tabindex="-1"></a><span class="co">#&#39;             importance (vimp) value for each feature of interest</span></span>
<span id="cb66-5"><a href="empirical-results.html#cb66-5" tabindex="-1"></a><span class="co">#&#39; @param subtitle subtitle of plot</span></span>
<span id="cb66-6"><a href="empirical-results.html#cb66-6" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb66-7"><a href="empirical-results.html#cb66-7" tabindex="-1"></a><span class="co">#&#39; @return barplot of the 20 most important features</span></span>
<span id="cb66-8"><a href="empirical-results.html#cb66-8" tabindex="-1"></a>plot.vimp <span class="ot">&lt;-</span> <span class="cf">function</span>(data, subtitle) {</span>
<span id="cb66-9"><a href="empirical-results.html#cb66-9" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb66-10"><a href="empirical-results.html#cb66-10" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(vimp)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-11"><a href="empirical-results.html#cb66-11" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-12"><a href="empirical-results.html#cb66-12" tabindex="-1"></a>    <span class="fu">ggplot</span>(</span>
<span id="cb66-13"><a href="empirical-results.html#cb66-13" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, <span class="sc">-</span>vimp), <span class="at">y =</span> vimp)</span>
<span id="cb66-14"><a href="empirical-results.html#cb66-14" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb66-15"><a href="empirical-results.html#cb66-15" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb66-16"><a href="empirical-results.html#cb66-16" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb66-17"><a href="empirical-results.html#cb66-17" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">formatC</span>(vimp <span class="sc">/</span> <span class="fu">max</span>(vimp), <span class="at">digits =</span> <span class="dv">2</span>)),</span>
<span id="cb66-18"><a href="empirical-results.html#cb66-18" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb66-19"><a href="empirical-results.html#cb66-19" tabindex="-1"></a>      <span class="at">colour =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb66-20"><a href="empirical-results.html#cb66-20" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb66-21"><a href="empirical-results.html#cb66-21" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb66-22"><a href="empirical-results.html#cb66-22" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Variable Importance (VIMP)&quot;</span>,</span>
<span id="cb66-23"><a href="empirical-results.html#cb66-23" tabindex="-1"></a>      <span class="at">subtitle =</span> subtitle,</span>
<span id="cb66-24"><a href="empirical-results.html#cb66-24" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">&quot;relative feature importance&quot;</span>,</span>
<span id="cb66-25"><a href="empirical-results.html#cb66-25" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;Features&quot;</span></span>
<span id="cb66-26"><a href="empirical-results.html#cb66-26" tabindex="-1"></a>    )</span>
<span id="cb66-27"><a href="empirical-results.html#cb66-27" tabindex="-1"></a>}</span></code></pre></div>
<p>Helper functions to illustrate performance metrics</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="empirical-results.html#cb67-1" tabindex="-1"></a><span class="co">#&#39; prints hyperparameters, plots, cutpoints and metrics of ROC and MCC-F1 curve</span></span>
<span id="cb67-2"><a href="empirical-results.html#cb67-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb67-3"><a href="empirical-results.html#cb67-3" tabindex="-1"></a><span class="co">#&#39; @param hyperparameters data frame containing hyperparameters of model of interest</span></span>
<span id="cb67-4"><a href="empirical-results.html#cb67-4" tabindex="-1"></a><span class="co">#&#39; @param actuals vector representing the actual response</span></span>
<span id="cb67-5"><a href="empirical-results.html#cb67-5" tabindex="-1"></a><span class="co">#&#39; @param pred.probability vector containing predicted probabilities of positive</span></span>
<span id="cb67-6"><a href="empirical-results.html#cb67-6" tabindex="-1"></a><span class="co">#&#39;                         class</span></span>
<span id="cb67-7"><a href="empirical-results.html#cb67-7" tabindex="-1"></a>illustrate.metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(hyperparameters, actuals, pred.probability) {</span>
<span id="cb67-8"><a href="empirical-results.html#cb67-8" tabindex="-1"></a>  <span class="fu">pander</span>(hyperparameters, <span class="at">caption =</span> <span class="st">&quot;Hyperparameters of the selected model&quot;</span>)</span>
<span id="cb67-9"><a href="empirical-results.html#cb67-9" tabindex="-1"></a>  </span>
<span id="cb67-10"><a href="empirical-results.html#cb67-10" tabindex="-1"></a>  <span class="co"># Determine best cutpoint based on AUC</span></span>
<span id="cb67-11"><a href="empirical-results.html#cb67-11" tabindex="-1"></a>  cutpoint.roc <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(pred.probability, actuals)</span>
<span id="cb67-12"><a href="empirical-results.html#cb67-12" tabindex="-1"></a>  <span class="fu">print</span>(cutpoint.roc<span class="sc">$</span>plot)</span>
<span id="cb67-13"><a href="empirical-results.html#cb67-13" tabindex="-1"></a>  <span class="fu">print</span>(cutpoint.roc<span class="sc">$</span>best_cutpoint.text)</span>
<span id="cb67-14"><a href="empirical-results.html#cb67-14" tabindex="-1"></a>  <span class="fu">pander</span>(cutpoint.roc<span class="sc">$</span>con_table, <span class="at">caption =</span> <span class="st">&quot;Classification table with ROC cutpoint&quot;</span>)</span>
<span id="cb67-15"><a href="empirical-results.html#cb67-15" tabindex="-1"></a>  </span>
<span id="cb67-16"><a href="empirical-results.html#cb67-16" tabindex="-1"></a>  <span class="co"># Determine best cutpoint which maximizes MCCF1-score</span></span>
<span id="cb67-17"><a href="empirical-results.html#cb67-17" tabindex="-1"></a>  cutpoint.mccf1 <span class="ot">&lt;-</span> <span class="fu">compute.mccf1cutpoint</span>(pred.probability, actuals)</span>
<span id="cb67-18"><a href="empirical-results.html#cb67-18" tabindex="-1"></a>  <span class="fu">print</span>(cutpoint.mccf1<span class="sc">$</span>plot)</span>
<span id="cb67-19"><a href="empirical-results.html#cb67-19" tabindex="-1"></a>  <span class="fu">print</span>(cutpoint.mccf1<span class="sc">$</span>best_cutpoint.text)</span>
<span id="cb67-20"><a href="empirical-results.html#cb67-20" tabindex="-1"></a>  <span class="fu">pander</span>(cutpoint.mccf1<span class="sc">$</span>con_table, <span class="at">caption =</span> <span class="st">&quot;Classification table with MCCF1 cutpoint&quot;</span>)</span>
<span id="cb67-21"><a href="empirical-results.html#cb67-21" tabindex="-1"></a>  </span>
<span id="cb67-22"><a href="empirical-results.html#cb67-22" tabindex="-1"></a>  <span class="co"># Display metrics for cutpoint rules ROC and MCCF1</span></span>
<span id="cb67-23"><a href="empirical-results.html#cb67-23" tabindex="-1"></a>  metrics.table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(actuals, pred.probability <span class="sc">&gt;=</span> <span class="fu">as.numeric</span>(cutpoint.roc<span class="sc">$</span>best_cutpoint)))</span>
<span id="cb67-24"><a href="empirical-results.html#cb67-24" tabindex="-1"></a>  metrics.table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(metrics.table, <span class="fu">compute.metrics</span>(actuals, pred.probability <span class="sc">&gt;=</span> <span class="fu">as.numeric</span>(cutpoint.mccf1<span class="sc">$</span>best_cutpoint)))</span>
<span id="cb67-25"><a href="empirical-results.html#cb67-25" tabindex="-1"></a>  metrics.table <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), metrics.table)</span>
<span id="cb67-26"><a href="empirical-results.html#cb67-26" tabindex="-1"></a>  <span class="fu">pander</span>(metrics.table)</span>
<span id="cb67-27"><a href="empirical-results.html#cb67-27" tabindex="-1"></a>  </span>
<span id="cb67-28"><a href="empirical-results.html#cb67-28" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">cutpoint.roc =</span> cutpoint.roc<span class="sc">$</span>best_cutpoint, <span class="at">cutpoint.mccf1 =</span> cutpoint.mccf1<span class="sc">$</span>best_cutpoint))</span>
<span id="cb67-29"><a href="empirical-results.html#cb67-29" tabindex="-1"></a>}</span>
<span id="cb67-30"><a href="empirical-results.html#cb67-30" tabindex="-1"></a></span>
<span id="cb67-31"><a href="empirical-results.html#cb67-31" tabindex="-1"></a><span class="co">#&#39; creates boxplots for performance metrics of models fitted with k-fold cross-</span></span>
<span id="cb67-32"><a href="empirical-results.html#cb67-32" tabindex="-1"></a><span class="co">#&#39; validation</span></span>
<span id="cb67-33"><a href="empirical-results.html#cb67-33" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb67-34"><a href="empirical-results.html#cb67-34" tabindex="-1"></a><span class="co">#&#39; @param resamples.mccf1 data frame with performance metrics for models on a</span></span>
<span id="cb67-35"><a href="empirical-results.html#cb67-35" tabindex="-1"></a><span class="co">#&#39;                        k-fold subset using MCCF1 cutpoint for classification</span></span>
<span id="cb67-36"><a href="empirical-results.html#cb67-36" tabindex="-1"></a><span class="co">#&#39; @param resamples.roc data frame with performance metrics for models on a</span></span>
<span id="cb67-37"><a href="empirical-results.html#cb67-37" tabindex="-1"></a><span class="co">#&#39;                        k-fold subset using ROC cutpoint for classification</span></span>
<span id="cb67-38"><a href="empirical-results.html#cb67-38" tabindex="-1"></a><span class="co">#&#39; @param model_identifier technical identifier of model name</span></span>
<span id="cb67-39"><a href="empirical-results.html#cb67-39" tabindex="-1"></a>illustrate.metrics.boxplot <span class="ot">&lt;-</span> <span class="cf">function</span>(resamples.mccf1, resamples.roc, model_identifier) {</span>
<span id="cb67-40"><a href="empirical-results.html#cb67-40" tabindex="-1"></a>  rf.metrics.cv.mccf1 <span class="ot">&lt;-</span> resamples.mccf1 <span class="sc">%&gt;%</span> </span>
<span id="cb67-41"><a href="empirical-results.html#cb67-41" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">c</span>(accuracy.mccf1, precision.mccf1, recall.mccf1, f1.mccf1, specificity.mccf1, mcc.mccf1)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-42"><a href="empirical-results.html#cb67-42" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb67-43"><a href="empirical-results.html#cb67-43" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb67-44"><a href="empirical-results.html#cb67-44" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span>,</span>
<span id="cb67-45"><a href="empirical-results.html#cb67-45" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb67-46"><a href="empirical-results.html#cb67-46" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb67-47"><a href="empirical-results.html#cb67-47" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb67-48"><a href="empirical-results.html#cb67-48" tabindex="-1"></a>      <span class="at">model =</span> model_identifier,</span>
<span id="cb67-49"><a href="empirical-results.html#cb67-49" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">&quot;mccf1&quot;</span>,</span>
<span id="cb67-50"><a href="empirical-results.html#cb67-50" tabindex="-1"></a>      <span class="at">metric =</span> <span class="fu">sub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(.*)&quot;</span>, <span class="st">&quot;&quot;</span>, metric)</span>
<span id="cb67-51"><a href="empirical-results.html#cb67-51" tabindex="-1"></a>    )</span>
<span id="cb67-52"><a href="empirical-results.html#cb67-52" tabindex="-1"></a>  </span>
<span id="cb67-53"><a href="empirical-results.html#cb67-53" tabindex="-1"></a>  rf.metrics.cv.roc <span class="ot">&lt;-</span> resamples.roc <span class="sc">%&gt;%</span> </span>
<span id="cb67-54"><a href="empirical-results.html#cb67-54" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">c</span>(accuracy.roc, precision.roc, recall.roc, f1.roc, specificity.roc, mcc.roc)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-55"><a href="empirical-results.html#cb67-55" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb67-56"><a href="empirical-results.html#cb67-56" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb67-57"><a href="empirical-results.html#cb67-57" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span>,</span>
<span id="cb67-58"><a href="empirical-results.html#cb67-58" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb67-59"><a href="empirical-results.html#cb67-59" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb67-60"><a href="empirical-results.html#cb67-60" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb67-61"><a href="empirical-results.html#cb67-61" tabindex="-1"></a>      <span class="at">model =</span> model_identifier,</span>
<span id="cb67-62"><a href="empirical-results.html#cb67-62" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">&quot;roc&quot;</span>,</span>
<span id="cb67-63"><a href="empirical-results.html#cb67-63" tabindex="-1"></a>      <span class="at">metric =</span> <span class="fu">sub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(.*)&quot;</span>, <span class="st">&quot;&quot;</span>, metric)</span>
<span id="cb67-64"><a href="empirical-results.html#cb67-64" tabindex="-1"></a>    )</span>
<span id="cb67-65"><a href="empirical-results.html#cb67-65" tabindex="-1"></a>  </span>
<span id="cb67-66"><a href="empirical-results.html#cb67-66" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">rbind</span>(rf.metrics.cv.mccf1, rf.metrics.cv.roc), <span class="fu">aes</span>(<span class="at">x =</span> metric, <span class="at">y =</span> value, <span class="at">col =</span> group)) <span class="sc">+</span> </span>
<span id="cb67-67"><a href="empirical-results.html#cb67-67" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb67-68"><a href="empirical-results.html#cb67-68" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb67-69"><a href="empirical-results.html#cb67-69" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Best model&quot;</span></span>
<span id="cb67-70"><a href="empirical-results.html#cb67-70" tabindex="-1"></a>    )</span>
<span id="cb67-71"><a href="empirical-results.html#cb67-71" tabindex="-1"></a>  </span>
<span id="cb67-72"><a href="empirical-results.html#cb67-72" tabindex="-1"></a>  <span class="fu">return</span> (plot)</span>
<span id="cb67-73"><a href="empirical-results.html#cb67-73" tabindex="-1"></a>}</span></code></pre></div>
<p>Helper function for MCCF1 curve computations</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="empirical-results.html#cb68-1" tabindex="-1"></a><span class="co">#&#39; computes MCCF1 metric</span></span>
<span id="cb68-2"><a href="empirical-results.html#cb68-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb68-3"><a href="empirical-results.html#cb68-3" tabindex="-1"></a><span class="co">#&#39; @param preds vector containing {0,1} binary predictions</span></span>
<span id="cb68-4"><a href="empirical-results.html#cb68-4" tabindex="-1"></a><span class="co">#&#39; @param actuals vector representing the actual responses out of {0,1}</span></span>
<span id="cb68-5"><a href="empirical-results.html#cb68-5" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb68-6"><a href="empirical-results.html#cb68-6" tabindex="-1"></a><span class="co">#&#39; @return MCCF1 metric</span></span>
<span id="cb68-7"><a href="empirical-results.html#cb68-7" tabindex="-1"></a>mccf1 <span class="ot">&lt;-</span> <span class="cf">function</span>(preds, actuals){</span>
<span id="cb68-8"><a href="empirical-results.html#cb68-8" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb68-9"><a href="empirical-results.html#cb68-9" tabindex="-1"></a>    <span class="at">preds =</span> preds,</span>
<span id="cb68-10"><a href="empirical-results.html#cb68-10" tabindex="-1"></a>    <span class="at">actuals =</span> actuals</span>
<span id="cb68-11"><a href="empirical-results.html#cb68-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb68-12"><a href="empirical-results.html#cb68-12" tabindex="-1"></a>  <span class="fu">arrange</span>(preds) <span class="sc">%&gt;%</span></span>
<span id="cb68-13"><a href="empirical-results.html#cb68-13" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-14"><a href="empirical-results.html#cb68-14" tabindex="-1"></a>    <span class="at">sumPositives =</span> <span class="fu">sum</span>(actuals <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb68-15"><a href="empirical-results.html#cb68-15" tabindex="-1"></a>    <span class="at">sumNegatives =</span> <span class="fu">sum</span>(actuals <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb68-16"><a href="empirical-results.html#cb68-16" tabindex="-1"></a>    <span class="at">cumulativeFN =</span> <span class="fu">cumsum</span>(actuals <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb68-17"><a href="empirical-results.html#cb68-17" tabindex="-1"></a>    <span class="at">cumulativeTN =</span> <span class="fu">cumsum</span>(actuals <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb68-18"><a href="empirical-results.html#cb68-18" tabindex="-1"></a>    <span class="at">cumulativeTP =</span> sumPositives <span class="sc">-</span> cumulativeFN,</span>
<span id="cb68-19"><a href="empirical-results.html#cb68-19" tabindex="-1"></a>    <span class="at">cumulativeFP =</span> sumNegatives <span class="sc">-</span> cumulativeTN,</span>
<span id="cb68-20"><a href="empirical-results.html#cb68-20" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">ifelse</span>(cumulativeTP <span class="sc">+</span> cumulativeFP <span class="sc">&gt;</span> <span class="dv">0</span>, cumulativeTP <span class="sc">/</span> (cumulativeTP <span class="sc">+</span> cumulativeFP), <span class="dv">0</span>), <span class="co"># precision</span></span>
<span id="cb68-21"><a href="empirical-results.html#cb68-21" tabindex="-1"></a>    <span class="at">recall =</span> <span class="fu">ifelse</span>(cumulativeTP <span class="sc">+</span> cumulativeFN <span class="sc">&gt;</span> <span class="dv">0</span>, cumulativeTP <span class="sc">/</span> (cumulativeTP <span class="sc">+</span> cumulativeFN), <span class="dv">0</span>), <span class="co"># recall / sensitivity</span></span>
<span id="cb68-22"><a href="empirical-results.html#cb68-22" tabindex="-1"></a>    <span class="at">f1 =</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>), <span class="co"># F-score</span></span>
<span id="cb68-23"><a href="empirical-results.html#cb68-23" tabindex="-1"></a>    <span class="at">mcc =</span> (cumulativeTN <span class="sc">*</span> cumulativeTP <span class="sc">-</span> cumulativeFN <span class="sc">*</span> cumulativeFP) <span class="sc">/</span></span>
<span id="cb68-24"><a href="empirical-results.html#cb68-24" tabindex="-1"></a>      <span class="fu">sqrt</span>((cumulativeTP<span class="sc">+</span>cumulativeFP))<span class="sc">/</span><span class="fu">sqrt</span>((cumulativeTP<span class="sc">+</span>cumulativeFN))<span class="sc">/</span><span class="fu">sqrt</span>((cumulativeTN<span class="sc">+</span>cumulativeFP))<span class="sc">/</span><span class="fu">sqrt</span>((cumulativeTN<span class="sc">+</span>cumulativeFN))</span>
<span id="cb68-25"><a href="empirical-results.html#cb68-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb68-26"><a href="empirical-results.html#cb68-26" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mcc.nor =</span> (mcc <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb68-27"><a href="empirical-results.html#cb68-27" tabindex="-1"></a></span>
<span id="cb68-28"><a href="empirical-results.html#cb68-28" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb68-29"><a href="empirical-results.html#cb68-29" tabindex="-1"></a>}</span>
<span id="cb68-30"><a href="empirical-results.html#cb68-30" tabindex="-1"></a></span>
<span id="cb68-31"><a href="empirical-results.html#cb68-31" tabindex="-1"></a><span class="co"># based on https://github.com/hoffmangroup/mccf1/blob/master/mccf1.R</span></span>
<span id="cb68-32"><a href="empirical-results.html#cb68-32" tabindex="-1"></a>summary.mccf1 <span class="ot">&lt;-</span> <span class="cf">function</span>(object, digits, <span class="at">bins =</span> <span class="dv">100</span>, ...){</span>
<span id="cb68-33"><a href="empirical-results.html#cb68-33" tabindex="-1"></a>  <span class="co"># get rid of NaN values in the vectors of mcc.nor and F1</span></span>
<span id="cb68-34"><a href="empirical-results.html#cb68-34" tabindex="-1"></a>  mcc.nor_truncated <span class="ot">&lt;-</span> object<span class="sc">$</span>mcc.nor[<span class="dv">2</span><span class="sc">:</span> (<span class="fu">length</span>(object<span class="sc">$</span>mcc.nor) <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb68-35"><a href="empirical-results.html#cb68-35" tabindex="-1"></a>  f_truncated <span class="ot">&lt;-</span> object<span class="sc">$</span>f1[<span class="dv">2</span><span class="sc">:</span> (<span class="fu">length</span>(object<span class="sc">$</span>f1) <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb68-36"><a href="empirical-results.html#cb68-36" tabindex="-1"></a></span>
<span id="cb68-37"><a href="empirical-results.html#cb68-37" tabindex="-1"></a>  <span class="co"># get the index of the point with largest normalized MCC (&quot;point&quot; refers to the point on the MCC-F1 curve)</span></span>
<span id="cb68-38"><a href="empirical-results.html#cb68-38" tabindex="-1"></a>  index_of_max_mcc <span class="ot">&lt;-</span> <span class="fu">which.max</span>(mcc.nor_truncated)</span>
<span id="cb68-39"><a href="empirical-results.html#cb68-39" tabindex="-1"></a>  <span class="co"># define points on the MCC-F1 curve located on the left of the point with the highest normalized MCC as &quot;left curve&quot;</span></span>
<span id="cb68-40"><a href="empirical-results.html#cb68-40" tabindex="-1"></a>  <span class="co"># get the left curve by getting the subvectors of MCC and F1 up to the index of the largest normalized MCC</span></span>
<span id="cb68-41"><a href="empirical-results.html#cb68-41" tabindex="-1"></a>  mcc_left <span class="ot">&lt;-</span> mcc.nor_truncated[<span class="dv">1</span><span class="sc">:</span> index_of_max_mcc]</span>
<span id="cb68-42"><a href="empirical-results.html#cb68-42" tabindex="-1"></a>  f_left <span class="ot">&lt;-</span> f_truncated[<span class="dv">1</span><span class="sc">:</span> index_of_max_mcc]</span>
<span id="cb68-43"><a href="empirical-results.html#cb68-43" tabindex="-1"></a>  <span class="co"># define points on the MCC-F1 curve located on the right of the point with the highest normalized MCC as &quot;right curve&quot;</span></span>
<span id="cb68-44"><a href="empirical-results.html#cb68-44" tabindex="-1"></a>  <span class="co"># get the right curve by getting the subvectors of MCC and F1 after the index of the largest normalized MCC</span></span>
<span id="cb68-45"><a href="empirical-results.html#cb68-45" tabindex="-1"></a>  mcc_right <span class="ot">&lt;-</span> mcc.nor_truncated[(index_of_max_mcc <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span> <span class="fu">length</span>(mcc.nor_truncated)]</span>
<span id="cb68-46"><a href="empirical-results.html#cb68-46" tabindex="-1"></a>  f_right <span class="ot">&lt;-</span> f_truncated[(index_of_max_mcc <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span> <span class="fu">length</span>(f_truncated)]</span>
<span id="cb68-47"><a href="empirical-results.html#cb68-47" tabindex="-1"></a></span>
<span id="cb68-48"><a href="empirical-results.html#cb68-48" tabindex="-1"></a>  <span class="co"># divide the range of normalized MCC into subranges</span></span>
<span id="cb68-49"><a href="empirical-results.html#cb68-49" tabindex="-1"></a>  unit_len <span class="ot">&lt;-</span> (<span class="fu">max</span>(mcc.nor_truncated) <span class="sc">-</span> <span class="fu">min</span>(mcc.nor_truncated)) <span class="sc">/</span> bins</span>
<span id="cb68-50"><a href="empirical-results.html#cb68-50" tabindex="-1"></a>  <span class="co"># calculate the sum of mean distances from the left curve to the point (1, 1)</span></span>
<span id="cb68-51"><a href="empirical-results.html#cb68-51" tabindex="-1"></a>  mean_distances_left <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb68-52"><a href="empirical-results.html#cb68-52" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> bins){</span>
<span id="cb68-53"><a href="empirical-results.html#cb68-53" tabindex="-1"></a>    <span class="co"># find all the points on the left curve with normalized MCC between unit_len*(i-1) and unit_len*i</span></span>
<span id="cb68-54"><a href="empirical-results.html#cb68-54" tabindex="-1"></a>    pos1 <span class="ot">&lt;-</span> <span class="fu">which</span>(mcc_left <span class="sc">&gt;=</span> <span class="fu">min</span>(mcc.nor_truncated) <span class="sc">+</span> (i<span class="dv">-1</span>) <span class="sc">*</span> unit_len)</span>
<span id="cb68-55"><a href="empirical-results.html#cb68-55" tabindex="-1"></a>    pos2 <span class="ot">&lt;-</span> <span class="fu">which</span>(mcc_left <span class="sc">&lt;=</span> <span class="fu">min</span>(mcc.nor_truncated) <span class="sc">+</span> i <span class="sc">*</span> unit_len)</span>
<span id="cb68-56"><a href="empirical-results.html#cb68-56" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb68-57"><a href="empirical-results.html#cb68-57" tabindex="-1"></a>    <span class="cf">for</span> (index <span class="cf">in</span> pos1){</span>
<span id="cb68-58"><a href="empirical-results.html#cb68-58" tabindex="-1"></a>      <span class="cf">if</span>  (index <span class="sc">%in%</span> pos2){</span>
<span id="cb68-59"><a href="empirical-results.html#cb68-59" tabindex="-1"></a>        pos <span class="ot">&lt;-</span> <span class="fu">c</span>(pos, index)</span>
<span id="cb68-60"><a href="empirical-results.html#cb68-60" tabindex="-1"></a>      }</span>
<span id="cb68-61"><a href="empirical-results.html#cb68-61" tabindex="-1"></a>    }</span>
<span id="cb68-62"><a href="empirical-results.html#cb68-62" tabindex="-1"></a>    sum_of_distance_within_subrange <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb68-63"><a href="empirical-results.html#cb68-63" tabindex="-1"></a>    <span class="cf">for</span> (index <span class="cf">in</span> pos){</span>
<span id="cb68-64"><a href="empirical-results.html#cb68-64" tabindex="-1"></a>      d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((mcc_left[index] <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (f_left[index] <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb68-65"><a href="empirical-results.html#cb68-65" tabindex="-1"></a>      sum_of_distance_within_subrange <span class="ot">&lt;-</span> sum_of_distance_within_subrange <span class="sc">+</span> d</span>
<span id="cb68-66"><a href="empirical-results.html#cb68-66" tabindex="-1"></a>    }</span>
<span id="cb68-67"><a href="empirical-results.html#cb68-67" tabindex="-1"></a>    mean_distances_left <span class="ot">&lt;-</span> <span class="fu">c</span>(mean_distances_left, sum_of_distance_within_subrange <span class="sc">/</span> <span class="fu">length</span>(pos))</span>
<span id="cb68-68"><a href="empirical-results.html#cb68-68" tabindex="-1"></a>  }</span>
<span id="cb68-69"><a href="empirical-results.html#cb68-69" tabindex="-1"></a></span>
<span id="cb68-70"><a href="empirical-results.html#cb68-70" tabindex="-1"></a>  <span class="co"># get rid of NAs in mean_distances_left and sum the mean distances</span></span>
<span id="cb68-71"><a href="empirical-results.html#cb68-71" tabindex="-1"></a>  num_of_na_left <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(mean_distances_left))</span>
<span id="cb68-72"><a href="empirical-results.html#cb68-72" tabindex="-1"></a>  sum_of_mean_distances_left_no_na <span class="ot">&lt;-</span> <span class="fu">sum</span>(mean_distances_left, <span class="at">na.rm =</span> T)</span>
<span id="cb68-73"><a href="empirical-results.html#cb68-73" tabindex="-1"></a></span>
<span id="cb68-74"><a href="empirical-results.html#cb68-74" tabindex="-1"></a>  <span class="co"># calculate the sum of mean distances from the right curve to the point (1, 1)</span></span>
<span id="cb68-75"><a href="empirical-results.html#cb68-75" tabindex="-1"></a>  mean_distances_right <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb68-76"><a href="empirical-results.html#cb68-76" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> bins){</span>
<span id="cb68-77"><a href="empirical-results.html#cb68-77" tabindex="-1"></a>    <span class="co"># find all the points on the right curve with normalized MCC between unit_len*(i-1) and unit_len*i</span></span>
<span id="cb68-78"><a href="empirical-results.html#cb68-78" tabindex="-1"></a>    pos1 <span class="ot">&lt;-</span> <span class="fu">which</span>(mcc_right <span class="sc">&gt;=</span> <span class="fu">min</span>(mcc.nor_truncated) <span class="sc">+</span> (i<span class="dv">-1</span>) <span class="sc">*</span> unit_len)</span>
<span id="cb68-79"><a href="empirical-results.html#cb68-79" tabindex="-1"></a>    pos2 <span class="ot">&lt;-</span> <span class="fu">which</span>(mcc_right <span class="sc">&lt;=</span> <span class="fu">min</span>(mcc.nor_truncated) <span class="sc">+</span> i <span class="sc">*</span> unit_len)</span>
<span id="cb68-80"><a href="empirical-results.html#cb68-80" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb68-81"><a href="empirical-results.html#cb68-81" tabindex="-1"></a>    <span class="cf">for</span> (index <span class="cf">in</span> pos1){</span>
<span id="cb68-82"><a href="empirical-results.html#cb68-82" tabindex="-1"></a>      <span class="cf">if</span>  (index <span class="sc">%in%</span> pos2){</span>
<span id="cb68-83"><a href="empirical-results.html#cb68-83" tabindex="-1"></a>        pos <span class="ot">&lt;-</span> <span class="fu">c</span>(pos, index)</span>
<span id="cb68-84"><a href="empirical-results.html#cb68-84" tabindex="-1"></a>      }</span>
<span id="cb68-85"><a href="empirical-results.html#cb68-85" tabindex="-1"></a>    }</span>
<span id="cb68-86"><a href="empirical-results.html#cb68-86" tabindex="-1"></a>    sum_of_distance_within_subrange <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb68-87"><a href="empirical-results.html#cb68-87" tabindex="-1"></a>    <span class="cf">for</span> (index <span class="cf">in</span> pos){</span>
<span id="cb68-88"><a href="empirical-results.html#cb68-88" tabindex="-1"></a>      d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((mcc_right[index] <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (f_right[index] <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb68-89"><a href="empirical-results.html#cb68-89" tabindex="-1"></a>      sum_of_distance_within_subrange  <span class="ot">&lt;-</span>  sum_of_distance_within_subrange <span class="sc">+</span> d</span>
<span id="cb68-90"><a href="empirical-results.html#cb68-90" tabindex="-1"></a>    }</span>
<span id="cb68-91"><a href="empirical-results.html#cb68-91" tabindex="-1"></a>    mean_distances_right <span class="ot">&lt;-</span> <span class="fu">c</span>(mean_distances_right, sum_of_distance_within_subrange <span class="sc">/</span> <span class="fu">length</span>(pos))</span>
<span id="cb68-92"><a href="empirical-results.html#cb68-92" tabindex="-1"></a>  }</span>
<span id="cb68-93"><a href="empirical-results.html#cb68-93" tabindex="-1"></a></span>
<span id="cb68-94"><a href="empirical-results.html#cb68-94" tabindex="-1"></a>  <span class="co"># get rid of NAs in mean_distances_right and sum the mean distances</span></span>
<span id="cb68-95"><a href="empirical-results.html#cb68-95" tabindex="-1"></a>  num_of_na_right <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(mean_distances_right))</span>
<span id="cb68-96"><a href="empirical-results.html#cb68-96" tabindex="-1"></a>  sum_of_mean_distances_right_no_na <span class="ot">&lt;-</span> <span class="fu">sum</span>(mean_distances_right, <span class="at">na.rm =</span> T)</span>
<span id="cb68-97"><a href="empirical-results.html#cb68-97" tabindex="-1"></a></span>
<span id="cb68-98"><a href="empirical-results.html#cb68-98" tabindex="-1"></a>  <span class="co"># calculate the MCC-F1 metric</span></span>
<span id="cb68-99"><a href="empirical-results.html#cb68-99" tabindex="-1"></a>  mccf1_metric <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> ((sum_of_mean_distances_left_no_na <span class="sc">+</span> sum_of_mean_distances_right_no_na) <span class="sc">/</span></span>
<span id="cb68-100"><a href="empirical-results.html#cb68-100" tabindex="-1"></a>                         (bins<span class="sc">*</span><span class="dv">2</span> <span class="sc">-</span> num_of_na_right <span class="sc">-</span> num_of_na_left)) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">2</span>)</span>
<span id="cb68-101"><a href="empirical-results.html#cb68-101" tabindex="-1"></a></span>
<span id="cb68-102"><a href="empirical-results.html#cb68-102" tabindex="-1"></a>  <span class="co"># find the best threshold</span></span>
<span id="cb68-103"><a href="empirical-results.html#cb68-103" tabindex="-1"></a>  best_threshold <span class="ot">&lt;-</span> object <span class="sc">%&gt;%</span></span>
<span id="cb68-104"><a href="empirical-results.html#cb68-104" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">dist =</span> <span class="fu">sqrt</span>((<span class="dv">1</span> <span class="sc">-</span> f1)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>mcc.nor)<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> <span class="co"># Pythagoras (distance to (1,1))</span></span>
<span id="cb68-105"><a href="empirical-results.html#cb68-105" tabindex="-1"></a>      <span class="fu">filter</span>(dist <span class="sc">&lt;=</span> <span class="fu">min</span>(dist, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb68-106"><a href="empirical-results.html#cb68-106" tabindex="-1"></a>  </span>
<span id="cb68-107"><a href="empirical-results.html#cb68-107" tabindex="-1"></a>  <span class="co"># output of the function is the MCC-F1 metric and the top threshold</span></span>
<span id="cb68-108"><a href="empirical-results.html#cb68-108" tabindex="-1"></a>  mccf1_result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mccf1_metric =</span> mccf1_metric, <span class="at">best_threshold =</span> best_threshold<span class="sc">$</span>preds[<span class="dv">1</span>])</span>
<span id="cb68-109"><a href="empirical-results.html#cb68-109" tabindex="-1"></a></span>
<span id="cb68-110"><a href="empirical-results.html#cb68-110" tabindex="-1"></a>  <span class="fu">return</span>(mccf1_result)</span>
<span id="cb68-111"><a href="empirical-results.html#cb68-111" tabindex="-1"></a>}</span></code></pre></div>

<div id="random-forest" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Random forest<a href="empirical-results.html#random-forest" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Feature names for random forest model</strong></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="empirical-results.html#cb69-1" tabindex="-1"></a><span class="fu">pander</span>(<span class="fu">names</span>(data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date)))</span></code></pre></div>
<p><em>capital_ratio</em>, <em>at_turn</em>, <em>inv_turn</em>, <em>rect_turn</em>, <em>pay_turn</em>, <em>cash_ratio</em>, <em>curr_ratio</em>, <em>aftret_eq</em>, <em>aftret_equity</em>, <em>gpm</em>, <em>opmad</em>, <em>roa</em>, <em>roe</em>, <em>de_ratio</em>, <em>debt_assets</em>, <em>pe_exi</em>, <em>response</em>, <em>capital_ratio_h</em>, <em>at_turn_h</em>, <em>inv_turn_h</em>, <em>rect_turn_h</em>, <em>pay_turn_h</em>, <em>cash_ratio_h</em>, <em>curr_ratio_h</em>, <em>aftret_eq_h</em>, <em>aftret_equity_h</em>, <em>gpm_h</em>, <em>opmad_h</em>, <em>roa_h</em>, <em>roe_h</em>, <em>de_ratio_h</em>, <em>debt_assets_h</em>, <em>pe_exi_h</em>, <em>gdpc1_chg</em>, <em>cpiaucsl_chg</em>, <em>fredfunds_chg</em> and <em>sp500_chg</em></p>
<p>The random forest implementation <code>randomForestSRC</code> provides three
hyperparameters.</p>
<ul>
<li><p><em>ntree</em>: number of trees (default: 500)</p></li>
<li><p><em>nodesize</em>: minimum size of terminal node (default: 5)</p></li>
<li><p><em>mtry</em>: number of variables to possibly split at each node (default:
number of variables divided by 3)</p></li>
</ul>
<p><strong>Find optimal mtry and nodesize tuning parameter using standardized out-of-sample
error</strong></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="empirical-results.html#cb70-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb70-2"><a href="empirical-results.html#cb70-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb70-3"><a href="empirical-results.html#cb70-3" tabindex="-1"></a>  <span class="co"># finds optimal mtry and nodesize tuning parameter for a random forest using</span></span>
<span id="cb70-4"><a href="empirical-results.html#cb70-4" tabindex="-1"></a>  <span class="co"># standardized out-of-sample-error</span></span>
<span id="cb70-5"><a href="empirical-results.html#cb70-5" tabindex="-1"></a>  rfr.reg.<span class="fl">1000.</span>tuned <span class="ot">&lt;-</span> <span class="fu">tune</span>(</span>
<span id="cb70-6"><a href="empirical-results.html#cb70-6" tabindex="-1"></a>    response <span class="sc">~</span> .,</span>
<span id="cb70-7"><a href="empirical-results.html#cb70-7" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(data.training <span class="sc">%&gt;%</span> </span>
<span id="cb70-8"><a href="empirical-results.html#cb70-8" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">ifelse</span>(response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-9"><a href="empirical-results.html#cb70-9" tabindex="-1"></a>                    <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date)),</span>
<span id="cb70-10"><a href="empirical-results.html#cb70-10" tabindex="-1"></a>    <span class="at">mtryStart =</span> <span class="fu">sqrt</span>(<span class="fu">ncol</span>(data.training) <span class="sc">-</span> <span class="dv">3</span>), <span class="co"># number of covariates used for each tree</span></span>
<span id="cb70-11"><a href="empirical-results.html#cb70-11" tabindex="-1"></a>    <span class="at">nodesizeTry =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">5</span>)), <span class="co"># minimum size of terminal node</span></span>
<span id="cb70-12"><a href="empirical-results.html#cb70-12" tabindex="-1"></a>    <span class="at">ntreeTry =</span> <span class="dv">1000</span>,</span>
<span id="cb70-13"><a href="empirical-results.html#cb70-13" tabindex="-1"></a>    <span class="at">sampsize =</span> <span class="cf">function</span>(x) {</span>
<span id="cb70-14"><a href="empirical-results.html#cb70-14" tabindex="-1"></a>        <span class="fu">min</span>(x <span class="sc">*</span> .<span class="dv">632</span>, <span class="fu">max</span>(<span class="dv">150</span>, x<span class="sc">^</span>(<span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span>)))</span>
<span id="cb70-15"><a href="empirical-results.html#cb70-15" tabindex="-1"></a>      }, <span class="co"># sampling without replacement</span></span>
<span id="cb70-16"><a href="empirical-results.html#cb70-16" tabindex="-1"></a>    <span class="at">nsplit =</span> <span class="dv">10</span>,</span>
<span id="cb70-17"><a href="empirical-results.html#cb70-17" tabindex="-1"></a>    <span class="at">stepFactor =</span> <span class="fl">1.25</span>, <span class="co"># at each iteration, mtry is inflated by this value</span></span>
<span id="cb70-18"><a href="empirical-results.html#cb70-18" tabindex="-1"></a>    <span class="at">improve =</span> <span class="fl">1e-3</span>,</span>
<span id="cb70-19"><a href="empirical-results.html#cb70-19" tabindex="-1"></a>    <span class="at">strikeout =</span> <span class="dv">5</span>,</span>
<span id="cb70-20"><a href="empirical-results.html#cb70-20" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">25</span>,</span>
<span id="cb70-21"><a href="empirical-results.html#cb70-21" tabindex="-1"></a>    <span class="at">trace =</span> <span class="cn">FALSE</span>,</span>
<span id="cb70-22"><a href="empirical-results.html#cb70-22" tabindex="-1"></a>    <span class="at">doBest =</span> <span class="cn">TRUE</span></span>
<span id="cb70-23"><a href="empirical-results.html#cb70-23" tabindex="-1"></a>  )</span>
<span id="cb70-24"><a href="empirical-results.html#cb70-24" tabindex="-1"></a>  <span class="fu">save</span>(rfr.reg.<span class="fl">1000.</span>tuned, <span class="at">file =</span> <span class="st">&quot;../data/rfr.reg.1000.tuned.RData&quot;</span>)</span>
<span id="cb70-25"><a href="empirical-results.html#cb70-25" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb70-26"><a href="empirical-results.html#cb70-26" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/rfr.reg.1000.tuned.RData&quot;</span>)</span>
<span id="cb70-27"><a href="empirical-results.html#cb70-27" tabindex="-1"></a>}</span>
<span id="cb70-28"><a href="empirical-results.html#cb70-28" tabindex="-1"></a></span>
<span id="cb70-29"><a href="empirical-results.html#cb70-29" tabindex="-1"></a><span class="co"># contour plot of standardized out-of-sample errors for different nodesize and mtry</span></span>
<span id="cb70-30"><a href="empirical-results.html#cb70-30" tabindex="-1"></a>plot.tune <span class="ot">&lt;-</span> <span class="cf">function</span>(o, <span class="at">linear =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb70-31"><a href="empirical-results.html#cb70-31" tabindex="-1"></a>  nodesize <span class="ot">&lt;-</span> o<span class="sc">$</span>results[, <span class="dv">1</span>]</span>
<span id="cb70-32"><a href="empirical-results.html#cb70-32" tabindex="-1"></a>  mtry <span class="ot">&lt;-</span> o<span class="sc">$</span>results[, <span class="dv">2</span>]</span>
<span id="cb70-33"><a href="empirical-results.html#cb70-33" tabindex="-1"></a>  oob_error <span class="ot">&lt;-</span> o<span class="sc">$</span>results[, <span class="dv">3</span>]</span>
<span id="cb70-34"><a href="empirical-results.html#cb70-34" tabindex="-1"></a>  <span class="co"># so &lt;- interp(x=x, y=y, z=z, linear = linear)</span></span>
<span id="cb70-35"><a href="empirical-results.html#cb70-35" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(oob_error)</span>
<span id="cb70-36"><a href="empirical-results.html#cb70-36" tabindex="-1"></a>  x0 <span class="ot">&lt;-</span> nodesize[idx]</span>
<span id="cb70-37"><a href="empirical-results.html#cb70-37" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mtry[idx]</span>
<span id="cb70-38"><a href="empirical-results.html#cb70-38" tabindex="-1"></a></span>
<span id="cb70-39"><a href="empirical-results.html#cb70-39" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">nodesize =</span> nodesize, <span class="at">mtry =</span> mtry, <span class="at">oob_error =</span> oob_error)) <span class="sc">+</span></span>
<span id="cb70-40"><a href="empirical-results.html#cb70-40" tabindex="-1"></a>    <span class="fu">geom_contour_filled</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(nodesize, mtry, <span class="at">z =</span> oob_error)) <span class="sc">+</span></span>
<span id="cb70-41"><a href="empirical-results.html#cb70-41" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb70-42"><a href="empirical-results.html#cb70-42" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Error rate for nodesize and mtry&quot;</span>,</span>
<span id="cb70-43"><a href="empirical-results.html#cb70-43" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">&quot;OOB errors&quot;</span></span>
<span id="cb70-44"><a href="empirical-results.html#cb70-44" tabindex="-1"></a>    )</span>
<span id="cb70-45"><a href="empirical-results.html#cb70-45" tabindex="-1"></a>}</span>
<span id="cb70-46"><a href="empirical-results.html#cb70-46" tabindex="-1"></a><span class="fu">plot.tune</span>(rfr.reg.<span class="fl">1000.</span>tuned)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.random_forest.tune-1.png" width="672" /></p>
<p>The contour plot shows a standardized out-of-sample error for random
forests with 1000 trees and different <em>nodesize</em> and <em>mtry</em>. The lowest
errors are observed for small <em>nodesizes</em> and large <em>mtry</em>.</p>
<p><strong>Metrics for varying nodesize and mtry</strong></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="empirical-results.html#cb71-1" tabindex="-1"></a>optimization.nodesize.mtry <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb71-2"><a href="empirical-results.html#cb71-2" tabindex="-1"></a>  <span class="at">nodesize =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-3"><a href="empirical-results.html#cb71-3" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-4"><a href="empirical-results.html#cb71-4" tabindex="-1"></a>  <span class="at">samples =</span> <span class="fu">character</span>(),</span>
<span id="cb71-5"><a href="empirical-results.html#cb71-5" tabindex="-1"></a>  <span class="at">tp =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-6"><a href="empirical-results.html#cb71-6" tabindex="-1"></a>  <span class="at">fn =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-7"><a href="empirical-results.html#cb71-7" tabindex="-1"></a>  <span class="at">fp =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-8"><a href="empirical-results.html#cb71-8" tabindex="-1"></a>  <span class="at">tn =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-9"><a href="empirical-results.html#cb71-9" tabindex="-1"></a>  <span class="at">accuracy =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-10"><a href="empirical-results.html#cb71-10" tabindex="-1"></a>  <span class="at">precision =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-11"><a href="empirical-results.html#cb71-11" tabindex="-1"></a>  <span class="at">recall =</span> <span class="fu">numeric</span>(),</span>
<span id="cb71-12"><a href="empirical-results.html#cb71-12" tabindex="-1"></a>  <span class="at">fscore =</span> <span class="fu">numeric</span>()</span>
<span id="cb71-13"><a href="empirical-results.html#cb71-13" tabindex="-1"></a>)</span>
<span id="cb71-14"><a href="empirical-results.html#cb71-14" tabindex="-1"></a></span>
<span id="cb71-15"><a href="empirical-results.html#cb71-15" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb71-16"><a href="empirical-results.html#cb71-16" tabindex="-1"></a>  <span class="cf">for</span> (nodesize <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>, <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">5</span>))) {</span>
<span id="cb71-17"><a href="empirical-results.html#cb71-17" tabindex="-1"></a>    <span class="cf">for</span> (mtry <span class="cf">in</span> <span class="fu">seq</span>(<span class="fu">ceiling</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(data.training))), <span class="fu">ncol</span>(data.training)<span class="sc">*</span><span class="fl">0.7</span>, <span class="at">by =</span> <span class="dv">5</span>)) {</span>
<span id="cb71-18"><a href="empirical-results.html#cb71-18" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;nodesize:&quot;</span>, nodesize, <span class="st">&quot;| mtry:&quot;</span>, mtry))</span>
<span id="cb71-19"><a href="empirical-results.html#cb71-19" tabindex="-1"></a>      rfr.nodesize.mtry.result <span class="ot">&lt;-</span> <span class="fu">rfsrc</span>(</span>
<span id="cb71-20"><a href="empirical-results.html#cb71-20" tabindex="-1"></a>        response <span class="sc">~</span> .,</span>
<span id="cb71-21"><a href="empirical-results.html#cb71-21" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">as.data.frame</span>(data.training <span class="sc">%&gt;%</span> </span>
<span id="cb71-22"><a href="empirical-results.html#cb71-22" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">ifelse</span>(response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb71-23"><a href="empirical-results.html#cb71-23" tabindex="-1"></a>                    <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date)),</span>
<span id="cb71-24"><a href="empirical-results.html#cb71-24" tabindex="-1"></a>        <span class="at">nodesize =</span> nodesize,</span>
<span id="cb71-25"><a href="empirical-results.html#cb71-25" tabindex="-1"></a>        <span class="at">ntree =</span> <span class="dv">1000</span>,</span>
<span id="cb71-26"><a href="empirical-results.html#cb71-26" tabindex="-1"></a>        <span class="at">mtry =</span> mtry,</span>
<span id="cb71-27"><a href="empirical-results.html#cb71-27" tabindex="-1"></a>        <span class="at">statistics =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-28"><a href="empirical-results.html#cb71-28" tabindex="-1"></a>        <span class="at">save.memory =</span> <span class="cn">TRUE</span></span>
<span id="cb71-29"><a href="empirical-results.html#cb71-29" tabindex="-1"></a>      )</span>
<span id="cb71-30"><a href="empirical-results.html#cb71-30" tabindex="-1"></a>      </span>
<span id="cb71-31"><a href="empirical-results.html#cb71-31" tabindex="-1"></a>      train_prediction_table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb71-32"><a href="empirical-results.html#cb71-32" tabindex="-1"></a>        <span class="at">actual =</span> (data.training <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">ifelse</span>(response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)))<span class="sc">$</span>response,</span>
<span id="cb71-33"><a href="empirical-results.html#cb71-33" tabindex="-1"></a>        <span class="at">predicted.inb =</span> rfr.nodesize.mtry.result<span class="sc">$</span>predicted,</span>
<span id="cb71-34"><a href="empirical-results.html#cb71-34" tabindex="-1"></a>        <span class="at">predicted.oob =</span> rfr.nodesize.mtry.result<span class="sc">$</span>predicted.oob</span>
<span id="cb71-35"><a href="empirical-results.html#cb71-35" tabindex="-1"></a>      )</span>
<span id="cb71-36"><a href="empirical-results.html#cb71-36" tabindex="-1"></a>      auc_roc.result <span class="ot">&lt;-</span> <span class="fu">auc_roc</span>(train_prediction_table<span class="sc">$</span>predicted.inb,</span>
<span id="cb71-37"><a href="empirical-results.html#cb71-37" tabindex="-1"></a>                                train_prediction_table<span class="sc">$</span>actual, <span class="at">returnDT=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-38"><a href="empirical-results.html#cb71-38" tabindex="-1"></a>      </span>
<span id="cb71-39"><a href="empirical-results.html#cb71-39" tabindex="-1"></a>      <span class="co"># best classification threshold</span></span>
<span id="cb71-40"><a href="empirical-results.html#cb71-40" tabindex="-1"></a>      best_cutpoint <span class="ot">&lt;-</span> auc_roc.result <span class="sc">%&gt;%</span> <span class="do">#######################################</span></span>
<span id="cb71-41"><a href="empirical-results.html#cb71-41" tabindex="-1"></a>        <span class="co"># Pythagoras (distance to (0,1))</span></span>
<span id="cb71-42"><a href="empirical-results.html#cb71-42" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">dist =</span> <span class="fu">sqrt</span>((<span class="dv">1</span> <span class="sc">-</span> CumulativeTPR)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> CumulativeFPR<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-43"><a href="empirical-results.html#cb71-43" tabindex="-1"></a>        <span class="fu">filter</span>(dist <span class="sc">&lt;=</span> <span class="fu">min</span>(dist))</span>
<span id="cb71-44"><a href="empirical-results.html#cb71-44" tabindex="-1"></a>      </span>
<span id="cb71-45"><a href="empirical-results.html#cb71-45" tabindex="-1"></a>      train_prediction_table <span class="ot">&lt;-</span> train_prediction_table <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb71-46"><a href="empirical-results.html#cb71-46" tabindex="-1"></a>          <span class="at">result.inb =</span> predicted.inb <span class="sc">&gt;</span> best_cutpoint<span class="sc">$</span>Pred,</span>
<span id="cb71-47"><a href="empirical-results.html#cb71-47" tabindex="-1"></a>          <span class="at">result.oob =</span> predicted.oob <span class="sc">&gt;</span> best_cutpoint<span class="sc">$</span>Pred</span>
<span id="cb71-48"><a href="empirical-results.html#cb71-48" tabindex="-1"></a>        )</span>
<span id="cb71-49"><a href="empirical-results.html#cb71-49" tabindex="-1"></a>      </span>
<span id="cb71-50"><a href="empirical-results.html#cb71-50" tabindex="-1"></a>      optimization.nodesize.mtry <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb71-51"><a href="empirical-results.html#cb71-51" tabindex="-1"></a>        optimization.nodesize.mtry, <span class="fu">append</span>(</span>
<span id="cb71-52"><a href="empirical-results.html#cb71-52" tabindex="-1"></a>        <span class="fu">compute.metrics</span>(train_prediction_table<span class="sc">$</span>actual <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb71-53"><a href="empirical-results.html#cb71-53" tabindex="-1"></a>        train_prediction_table<span class="sc">$</span>result.inb),</span>
<span id="cb71-54"><a href="empirical-results.html#cb71-54" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">nodesize =</span> nodesize, <span class="at">mtry =</span> mtry, <span class="at">samples =</span> <span class="dv">0</span>), <span class="at">after =</span> <span class="dv">0</span>))</span>
<span id="cb71-55"><a href="empirical-results.html#cb71-55" tabindex="-1"></a>      </span>
<span id="cb71-56"><a href="empirical-results.html#cb71-56" tabindex="-1"></a>      optimization.nodesize.mtry <span class="ot">&lt;-</span> <span class="fu">rbind</span>(optimization.nodesize.mtry, <span class="fu">append</span>(</span>
<span id="cb71-57"><a href="empirical-results.html#cb71-57" tabindex="-1"></a>        <span class="fu">compute.metrics</span>(train_prediction_table<span class="sc">$</span>actual <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb71-58"><a href="empirical-results.html#cb71-58" tabindex="-1"></a>        train_prediction_table<span class="sc">$</span>result.oob),</span>
<span id="cb71-59"><a href="empirical-results.html#cb71-59" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">nodesize =</span> nodesize, <span class="at">mtry =</span> mtry, <span class="at">samples =</span> <span class="dv">1</span>), <span class="at">after =</span> <span class="dv">0</span>))</span>
<span id="cb71-60"><a href="empirical-results.html#cb71-60" tabindex="-1"></a>    }</span>
<span id="cb71-61"><a href="empirical-results.html#cb71-61" tabindex="-1"></a>  }</span>
<span id="cb71-62"><a href="empirical-results.html#cb71-62" tabindex="-1"></a>  <span class="fu">colnames</span>(optimization.nodesize.mtry) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;nodesize&quot;</span>, <span class="st">&quot;mtry&quot;</span>, <span class="st">&quot;samples&quot;</span>, </span>
<span id="cb71-63"><a href="empirical-results.html#cb71-63" tabindex="-1"></a>                                            <span class="st">&quot;TP&quot;</span>, <span class="st">&quot;FN&quot;</span>, <span class="st">&quot;FP&quot;</span>, <span class="st">&quot;TN&quot;</span>, <span class="st">&quot;accuracy&quot;</span>, </span>
<span id="cb71-64"><a href="empirical-results.html#cb71-64" tabindex="-1"></a>                                            <span class="st">&quot;precision&quot;</span>, <span class="st">&quot;recall&quot;</span>, <span class="st">&quot;f1&quot;</span>, </span>
<span id="cb71-65"><a href="empirical-results.html#cb71-65" tabindex="-1"></a>                                            <span class="st">&quot;specificity&quot;</span>, <span class="st">&quot;mcc&quot;</span>)</span>
<span id="cb71-66"><a href="empirical-results.html#cb71-66" tabindex="-1"></a>  <span class="co"># convert binary variable to INB and OOB factors</span></span>
<span id="cb71-67"><a href="empirical-results.html#cb71-67" tabindex="-1"></a>  optimization.nodesize.mtry <span class="ot">&lt;-</span> optimization.nodesize.mtry <span class="sc">%&gt;%</span> </span>
<span id="cb71-68"><a href="empirical-results.html#cb71-68" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">samples =</span> <span class="fu">factor</span>(samples,</span>
<span id="cb71-69"><a href="empirical-results.html#cb71-69" tabindex="-1"></a>                            <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb71-70"><a href="empirical-results.html#cb71-70" tabindex="-1"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;INB&quot;</span>, <span class="st">&quot;OOB&quot;</span>)))</span>
<span id="cb71-71"><a href="empirical-results.html#cb71-71" tabindex="-1"></a>  <span class="fu">save</span>(optimization.nodesize.mtry, <span class="at">file =</span> <span class="st">&quot;../data/optimization.nodesize.mtry.RData&quot;</span>)</span>
<span id="cb71-72"><a href="empirical-results.html#cb71-72" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb71-73"><a href="empirical-results.html#cb71-73" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/optimization.nodesize.mtry.RData&quot;</span>)</span>
<span id="cb71-74"><a href="empirical-results.html#cb71-74" tabindex="-1"></a>}</span>
<span id="cb71-75"><a href="empirical-results.html#cb71-75" tabindex="-1"></a></span>
<span id="cb71-76"><a href="empirical-results.html#cb71-76" tabindex="-1"></a>plot.nodesize.metric <span class="ot">=</span> <span class="cf">function</span> (data, metric, mtry.fix) {</span>
<span id="cb71-77"><a href="empirical-results.html#cb71-77" tabindex="-1"></a>    plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(mtry <span class="sc">==</span> mtry.fix),</span>
<span id="cb71-78"><a href="empirical-results.html#cb71-78" tabindex="-1"></a>                   <span class="fu">aes</span>(<span class="at">x =</span> nodesize, <span class="at">col =</span> samples, <span class="at">linetype =</span> samples)) <span class="sc">+</span></span>
<span id="cb71-79"><a href="empirical-results.html#cb71-79" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="fu">aes_string</span>(<span class="at">y =</span> metric), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-80"><a href="empirical-results.html#cb71-80" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb71-81"><a href="empirical-results.html#cb71-81" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">&quot;Nodesize vs&quot;</span>, metric),</span>
<span id="cb71-82"><a href="empirical-results.html#cb71-82" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;RF: ntree = 1000 and mtry =&quot;</span>, mtry.fix),</span>
<span id="cb71-83"><a href="empirical-results.html#cb71-83" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;nodesize&quot;</span>,</span>
<span id="cb71-84"><a href="empirical-results.html#cb71-84" tabindex="-1"></a>        <span class="at">y =</span> metric,</span>
<span id="cb71-85"><a href="empirical-results.html#cb71-85" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">&quot;Evaluation type&quot;</span>,</span>
<span id="cb71-86"><a href="empirical-results.html#cb71-86" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">&quot;Evaluation type&quot;</span></span>
<span id="cb71-87"><a href="empirical-results.html#cb71-87" tabindex="-1"></a>      )</span>
<span id="cb71-88"><a href="empirical-results.html#cb71-88" tabindex="-1"></a>}</span>
<span id="cb71-89"><a href="empirical-results.html#cb71-89" tabindex="-1"></a></span>
<span id="cb71-90"><a href="empirical-results.html#cb71-90" tabindex="-1"></a>plot.mtry.metric <span class="ot">&lt;-</span> <span class="cf">function</span> (data, metric, nodesize.fix) {</span>
<span id="cb71-91"><a href="empirical-results.html#cb71-91" tabindex="-1"></a>    plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(nodesize <span class="sc">==</span> nodesize.fix), </span>
<span id="cb71-92"><a href="empirical-results.html#cb71-92" tabindex="-1"></a>                   <span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">col =</span> samples, <span class="at">linetype =</span> samples)) <span class="sc">+</span></span>
<span id="cb71-93"><a href="empirical-results.html#cb71-93" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="fu">aes_string</span>(<span class="at">y =</span> metric), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-94"><a href="empirical-results.html#cb71-94" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb71-95"><a href="empirical-results.html#cb71-95" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">&quot;Mtry vs&quot;</span>, metric),</span>
<span id="cb71-96"><a href="empirical-results.html#cb71-96" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;RF: ntree = 1000 and nodesize =&quot;</span>, nodesize.fix),</span>
<span id="cb71-97"><a href="empirical-results.html#cb71-97" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;mtry&quot;</span>,</span>
<span id="cb71-98"><a href="empirical-results.html#cb71-98" tabindex="-1"></a>        <span class="at">y =</span> metric,</span>
<span id="cb71-99"><a href="empirical-results.html#cb71-99" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">&quot;Evaluation type&quot;</span>,</span>
<span id="cb71-100"><a href="empirical-results.html#cb71-100" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">&quot;Evaluation type&quot;</span></span>
<span id="cb71-101"><a href="empirical-results.html#cb71-101" tabindex="-1"></a>      )</span>
<span id="cb71-102"><a href="empirical-results.html#cb71-102" tabindex="-1"></a>}</span>
<span id="cb71-103"><a href="empirical-results.html#cb71-103" tabindex="-1"></a></span>
<span id="cb71-104"><a href="empirical-results.html#cb71-104" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;accuracy&quot;</span>, <span class="st">&quot;precision&quot;</span>, <span class="st">&quot;recall&quot;</span>, <span class="st">&quot;f1&quot;</span>)</span>
<span id="cb71-105"><a href="empirical-results.html#cb71-105" tabindex="-1"></a>plot.nodesize.metrics.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(metrics, plot.nodesize.metric,</span>
<span id="cb71-106"><a href="empirical-results.html#cb71-106" tabindex="-1"></a>                            <span class="at">data =</span> optimization.nodesize.mtry, <span class="at">mtry.fix =</span> <span class="dv">17</span>)</span>
<span id="cb71-107"><a href="empirical-results.html#cb71-107" tabindex="-1"></a>plot.mtry.metrics.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(metrics, plot.mtry.metric,</span>
<span id="cb71-108"><a href="empirical-results.html#cb71-108" tabindex="-1"></a>                            <span class="at">data =</span> optimization.nodesize.mtry, <span class="at">nodesize.fix =</span> <span class="dv">15</span>)</span>
<span id="cb71-109"><a href="empirical-results.html#cb71-109" tabindex="-1"></a></span>
<span id="cb71-110"><a href="empirical-results.html#cb71-110" tabindex="-1"></a>plot.nodesize.metrics <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(plot.nodesize.metrics.list[[<span class="dv">1</span>]], plot.nodesize.metrics.list[[<span class="dv">2</span>]], </span>
<span id="cb71-111"><a href="empirical-results.html#cb71-111" tabindex="-1"></a>          plot.nodesize.metrics.list[[<span class="dv">3</span>]], plot.nodesize.metrics.list[[<span class="dv">4</span>]],</span>
<span id="cb71-112"><a href="empirical-results.html#cb71-112" tabindex="-1"></a>                  <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb71-113"><a href="empirical-results.html#cb71-113" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb71-114"><a href="empirical-results.html#cb71-114" tabindex="-1"></a>                  <span class="at">legend =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb71-115"><a href="empirical-results.html#cb71-115" tabindex="-1"></a>                  <span class="at">common.legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-116"><a href="empirical-results.html#cb71-116" tabindex="-1"></a>plot.mtry.metrics <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(plot.nodesize.metrics.list[[<span class="dv">1</span>]], plot.nodesize.metrics.list[[<span class="dv">2</span>]], </span>
<span id="cb71-117"><a href="empirical-results.html#cb71-117" tabindex="-1"></a>          plot.nodesize.metrics.list[[<span class="dv">3</span>]], plot.nodesize.metrics.list[[<span class="dv">4</span>]], plot.mtry.metrics.list[[<span class="dv">1</span>]], plot.mtry.metrics.list[[<span class="dv">2</span>]], </span>
<span id="cb71-118"><a href="empirical-results.html#cb71-118" tabindex="-1"></a>          plot.mtry.metrics.list[[<span class="dv">3</span>]], plot.mtry.metrics.list[[<span class="dv">4</span>]],</span>
<span id="cb71-119"><a href="empirical-results.html#cb71-119" tabindex="-1"></a>                  <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb71-120"><a href="empirical-results.html#cb71-120" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">4</span>,</span>
<span id="cb71-121"><a href="empirical-results.html#cb71-121" tabindex="-1"></a>                  <span class="at">legend =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb71-122"><a href="empirical-results.html#cb71-122" tabindex="-1"></a>                  <span class="at">common.legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-123"><a href="empirical-results.html#cb71-123" tabindex="-1"></a>plot.mtry.metrics</span></code></pre></div>
<p><img src="_main_files/figure-html/model.random_forest.metrics_evaluation-1.png" width="672" /></p>
<p>Parameter choice for random forest</p>
<ul>
<li><code>ntree</code>: 1000</li>
<li><code>nodesize</code>: 5</li>
<li><code>mtry</code>: 12</li>
</ul>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="empirical-results.html#cb72-1" tabindex="-1"></a><span class="co"># function and object definitions for custom model in caret package</span></span>
<span id="cb72-2"><a href="empirical-results.html#cb72-2" tabindex="-1"></a><span class="co"># https://topepo.github.io/caret/using-your-own-model-in-train.html</span></span>
<span id="cb72-3"><a href="empirical-results.html#cb72-3" tabindex="-1"></a>rf.parameters <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-4"><a href="empirical-results.html#cb72-4" tabindex="-1"></a>  <span class="at">parameter =</span> <span class="fu">c</span>(<span class="st">&quot;ntree&quot;</span>, <span class="st">&quot;nodesize&quot;</span>, <span class="st">&quot;mtry&quot;</span>),</span>
<span id="cb72-5"><a href="empirical-results.html#cb72-5" tabindex="-1"></a>  <span class="at">class =</span> <span class="fu">rep</span>(<span class="st">&quot;numeric&quot;</span>, <span class="dv">3</span>)</span>
<span id="cb72-6"><a href="empirical-results.html#cb72-6" tabindex="-1"></a>)</span>
<span id="cb72-7"><a href="empirical-results.html#cb72-7" tabindex="-1"></a></span>
<span id="cb72-8"><a href="empirical-results.html#cb72-8" tabindex="-1"></a>rf.grid <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, <span class="at">len =</span> <span class="cn">NULL</span>, <span class="at">search =</span> <span class="st">&quot;grid&quot;</span>) { }</span>
<span id="cb72-9"><a href="empirical-results.html#cb72-9" tabindex="-1"></a></span>
<span id="cb72-10"><a href="empirical-results.html#cb72-10" tabindex="-1"></a>rf.fit <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, wts, param, lev, last, weights, classProbs, ...) { </span>
<span id="cb72-11"><a href="empirical-results.html#cb72-11" tabindex="-1"></a>    rfr.result <span class="ot">&lt;-</span> <span class="fu">rfsrc</span>(</span>
<span id="cb72-12"><a href="empirical-results.html#cb72-12" tabindex="-1"></a>      y <span class="sc">~</span> .,</span>
<span id="cb72-13"><a href="empirical-results.html#cb72-13" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">data.frame</span>(x, <span class="at">y =</span> <span class="fu">as.factor</span>(y)),</span>
<span id="cb72-14"><a href="empirical-results.html#cb72-14" tabindex="-1"></a>      <span class="at">ntree =</span> param<span class="sc">$</span>ntree,</span>
<span id="cb72-15"><a href="empirical-results.html#cb72-15" tabindex="-1"></a>      <span class="at">nodesize =</span> param<span class="sc">$</span>nodesize,</span>
<span id="cb72-16"><a href="empirical-results.html#cb72-16" tabindex="-1"></a>      <span class="at">mtry =</span> param<span class="sc">$</span>mtry,</span>
<span id="cb72-17"><a href="empirical-results.html#cb72-17" tabindex="-1"></a>      <span class="at">statistics =</span> <span class="cn">TRUE</span>,</span>
<span id="cb72-18"><a href="empirical-results.html#cb72-18" tabindex="-1"></a>      <span class="at">save.memory =</span> <span class="cn">TRUE</span></span>
<span id="cb72-19"><a href="empirical-results.html#cb72-19" tabindex="-1"></a>    )</span>
<span id="cb72-20"><a href="empirical-results.html#cb72-20" tabindex="-1"></a>    </span>
<span id="cb72-21"><a href="empirical-results.html#cb72-21" tabindex="-1"></a>    <span class="fu">return</span> (rfr.result)</span>
<span id="cb72-22"><a href="empirical-results.html#cb72-22" tabindex="-1"></a>}</span>
<span id="cb72-23"><a href="empirical-results.html#cb72-23" tabindex="-1"></a></span>
<span id="cb72-24"><a href="empirical-results.html#cb72-24" tabindex="-1"></a>rf.predict <span class="ot">&lt;-</span> <span class="cf">function</span>(modelFit, newdata, <span class="at">preProc =</span> <span class="cn">NULL</span>, <span class="at">submodels =</span> <span class="cn">NULL</span>) {</span>
<span id="cb72-25"><a href="empirical-results.html#cb72-25" tabindex="-1"></a>  prediction <span class="ot">&lt;-</span> randomForestSRC<span class="sc">::</span><span class="fu">predict.rfsrc</span>(modelFit, <span class="fu">as.data.frame</span>(newdata))<span class="sc">$</span>class</span>
<span id="cb72-26"><a href="empirical-results.html#cb72-26" tabindex="-1"></a>  <span class="fu">return</span> (prediction)</span>
<span id="cb72-27"><a href="empirical-results.html#cb72-27" tabindex="-1"></a>}</span>
<span id="cb72-28"><a href="empirical-results.html#cb72-28" tabindex="-1"></a></span>
<span id="cb72-29"><a href="empirical-results.html#cb72-29" tabindex="-1"></a>rf.predict.prob <span class="ot">&lt;-</span> <span class="cf">function</span>(modelFit, newdata, <span class="at">preProc =</span> <span class="cn">NULL</span>, <span class="at">submodels =</span> <span class="cn">NULL</span>) {</span>
<span id="cb72-30"><a href="empirical-results.html#cb72-30" tabindex="-1"></a>  prediction <span class="ot">&lt;-</span> randomForestSRC<span class="sc">::</span><span class="fu">predict.rfsrc</span>(modelFit, <span class="fu">as.data.frame</span>(newdata))<span class="sc">$</span>predicted</span>
<span id="cb72-31"><a href="empirical-results.html#cb72-31" tabindex="-1"></a>  <span class="fu">return</span> (prediction)<span class="co">#data.frame(active = 1 - prediction, delisted = prediction))</span></span>
<span id="cb72-32"><a href="empirical-results.html#cb72-32" tabindex="-1"></a>}</span>
<span id="cb72-33"><a href="empirical-results.html#cb72-33" tabindex="-1"></a></span>
<span id="cb72-34"><a href="empirical-results.html#cb72-34" tabindex="-1"></a>rf.list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb72-35"><a href="empirical-results.html#cb72-35" tabindex="-1"></a>  <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;Classification&quot;</span>, <span class="st">&quot;Regression&quot;</span>),</span>
<span id="cb72-36"><a href="empirical-results.html#cb72-36" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;randomForestSRC&quot;</span>,</span>
<span id="cb72-37"><a href="empirical-results.html#cb72-37" tabindex="-1"></a>  <span class="at">library =</span> <span class="fu">c</span>(<span class="st">&quot;randomForestSRC&quot;</span>),</span>
<span id="cb72-38"><a href="empirical-results.html#cb72-38" tabindex="-1"></a>  <span class="at">parameters =</span> rf.parameters,</span>
<span id="cb72-39"><a href="empirical-results.html#cb72-39" tabindex="-1"></a>  <span class="at">grid =</span> rf.grid,</span>
<span id="cb72-40"><a href="empirical-results.html#cb72-40" tabindex="-1"></a>  <span class="at">fit =</span> rf.fit,</span>
<span id="cb72-41"><a href="empirical-results.html#cb72-41" tabindex="-1"></a>  <span class="at">predict =</span> rf.predict,</span>
<span id="cb72-42"><a href="empirical-results.html#cb72-42" tabindex="-1"></a>  <span class="at">prob =</span> rf.predict.prob,</span>
<span id="cb72-43"><a href="empirical-results.html#cb72-43" tabindex="-1"></a>  <span class="at">sort =</span> <span class="cf">function</span>(x) x</span>
<span id="cb72-44"><a href="empirical-results.html#cb72-44" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>Model fit</strong></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="empirical-results.html#cb73-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb73-2"><a href="empirical-results.html#cb73-2" tabindex="-1"></a>  <span class="do">### control the computational nuances of the train function ####################</span></span>
<span id="cb73-3"><a href="empirical-results.html#cb73-3" tabindex="-1"></a>  rf.fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>,</span>
<span id="cb73-4"><a href="empirical-results.html#cb73-4" tabindex="-1"></a>                               <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb73-5"><a href="empirical-results.html#cb73-5" tabindex="-1"></a>                               <span class="do">## Estimate class probabilities</span></span>
<span id="cb73-6"><a href="empirical-results.html#cb73-6" tabindex="-1"></a>                               <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb73-7"><a href="empirical-results.html#cb73-7" tabindex="-1"></a>                               <span class="do">## Evaluate performance using </span></span>
<span id="cb73-8"><a href="empirical-results.html#cb73-8" tabindex="-1"></a>                               <span class="do">## the following function</span></span>
<span id="cb73-9"><a href="empirical-results.html#cb73-9" tabindex="-1"></a>                               <span class="at">summaryFunction =</span> compute.summary,</span>
<span id="cb73-10"><a href="empirical-results.html#cb73-10" tabindex="-1"></a>                               <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb73-11"><a href="empirical-results.html#cb73-11" tabindex="-1"></a>  </span>
<span id="cb73-12"><a href="empirical-results.html#cb73-12" tabindex="-1"></a>  <span class="do">### fit model over different tuning parameters #################################</span></span>
<span id="cb73-13"><a href="empirical-results.html#cb73-13" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb73-14"><a href="empirical-results.html#cb73-14" tabindex="-1"></a>  rf.fit <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date), </span>
<span id="cb73-15"><a href="empirical-results.html#cb73-15" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb73-16"><a href="empirical-results.html#cb73-16" tabindex="-1"></a>                   <span class="at">method =</span> rf.list, </span>
<span id="cb73-17"><a href="empirical-results.html#cb73-17" tabindex="-1"></a>                   <span class="at">trControl =</span> rf.fitControl,</span>
<span id="cb73-18"><a href="empirical-results.html#cb73-18" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(</span>
<span id="cb73-19"><a href="empirical-results.html#cb73-19" tabindex="-1"></a>                     <span class="at">ntree =</span> <span class="dv">1000</span>,</span>
<span id="cb73-20"><a href="empirical-results.html#cb73-20" tabindex="-1"></a>                     <span class="at">nodesize =</span> <span class="dv">5</span>,</span>
<span id="cb73-21"><a href="empirical-results.html#cb73-21" tabindex="-1"></a>                     <span class="at">mtry =</span> <span class="dv">12</span>),</span>
<span id="cb73-22"><a href="empirical-results.html#cb73-22" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb73-23"><a href="empirical-results.html#cb73-23" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;mcc.mccf1&quot;</span> <span class="co"># specify which metric to optimize</span></span>
<span id="cb73-24"><a href="empirical-results.html#cb73-24" tabindex="-1"></a>                   ) </span>
<span id="cb73-25"><a href="empirical-results.html#cb73-25" tabindex="-1"></a>  <span class="fu">save</span>(rf.fit, <span class="at">file =</span> <span class="st">&quot;../data/rf.fit.RData&quot;</span>)</span>
<span id="cb73-26"><a href="empirical-results.html#cb73-26" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb73-27"><a href="empirical-results.html#cb73-27" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/rf.fit.RData&quot;</span>)</span>
<span id="cb73-28"><a href="empirical-results.html#cb73-28" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Model information and evaluation on training set</strong></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="empirical-results.html#cb74-1" tabindex="-1"></a>rf.bestTune.mccf1 <span class="ot">&lt;-</span> rf.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="empirical-results.html#cb74-2" tabindex="-1"></a>  <span class="fu">group_by</span>(ntree, nodesize, mtry) <span class="sc">%&gt;%</span></span>
<span id="cb74-3"><a href="empirical-results.html#cb74-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mccf1 =</span> <span class="fu">mean</span>(mcc.mccf1), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-4"><a href="empirical-results.html#cb74-4" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(mccf1))</span>
<span id="cb74-5"><a href="empirical-results.html#cb74-5" tabindex="-1"></a></span>
<span id="cb74-6"><a href="empirical-results.html#cb74-6" tabindex="-1"></a>rf.bestTune.roc <span class="ot">&lt;-</span> rf.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb74-7"><a href="empirical-results.html#cb74-7" tabindex="-1"></a>  <span class="fu">group_by</span>(ntree, nodesize, mtry) <span class="sc">%&gt;%</span></span>
<span id="cb74-8"><a href="empirical-results.html#cb74-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">auc =</span> <span class="fu">mean</span>(auc.roc), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-9"><a href="empirical-results.html#cb74-9" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(auc))</span>
<span id="cb74-10"><a href="empirical-results.html#cb74-10" tabindex="-1"></a></span>
<span id="cb74-11"><a href="empirical-results.html#cb74-11" tabindex="-1"></a><span class="co"># Hyperparameters of best models for MCCF1 and ROC cutpoints</span></span>
<span id="cb74-12"><a href="empirical-results.html#cb74-12" tabindex="-1"></a>hyperparameters.table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb74-13"><a href="empirical-results.html#cb74-13" tabindex="-1"></a>  <span class="at">cutpoint =</span> <span class="fu">c</span>(<span class="st">&quot;MCCF1&quot;</span>, <span class="st">&quot;ROC&quot;</span>),</span>
<span id="cb74-14"><a href="empirical-results.html#cb74-14" tabindex="-1"></a>  <span class="at">ntree =</span> <span class="fu">c</span>(rf.bestTune.mccf1<span class="sc">$</span>ntree, rf.bestTune.roc<span class="sc">$</span>ntree),</span>
<span id="cb74-15"><a href="empirical-results.html#cb74-15" tabindex="-1"></a>  <span class="at">nodesize =</span> <span class="fu">c</span>(rf.bestTune.mccf1<span class="sc">$</span>nodesize, rf.bestTune.roc<span class="sc">$</span>nodesize),</span>
<span id="cb74-16"><a href="empirical-results.html#cb74-16" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">c</span>(rf.bestTune.mccf1<span class="sc">$</span>mtry, rf.bestTune.roc<span class="sc">$</span>mtry)</span>
<span id="cb74-17"><a href="empirical-results.html#cb74-17" tabindex="-1"></a>)</span>
<span id="cb74-18"><a href="empirical-results.html#cb74-18" tabindex="-1"></a></span>
<span id="cb74-19"><a href="empirical-results.html#cb74-19" tabindex="-1"></a>pred.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf.fit, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb74-20"><a href="empirical-results.html#cb74-20" tabindex="-1"></a>rf.metrics <span class="ot">&lt;-</span> <span class="fu">illustrate.metrics</span>(hyperparameters.table, data.training<span class="sc">$</span>response, pred.probability<span class="sc">$</span>delisted)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.random_forest.best_model-1.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.2464 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.random_forest.best_model-2.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.3198 maximizes MCCF1 metric.&quot;</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="empirical-results.html#cb77-1" tabindex="-1"></a><span class="fu">illustrate.metrics.boxplot</span>(rf.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ntree <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>ntree[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb77-2"><a href="empirical-results.html#cb77-2" tabindex="-1"></a>                                                      nodesize <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>nodesize[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb77-3"><a href="empirical-results.html#cb77-3" tabindex="-1"></a>                                                      mtry <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>mtry[<span class="dv">1</span>]),</span>
<span id="cb77-4"><a href="empirical-results.html#cb77-4" tabindex="-1"></a>                           rf.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ntree <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>ntree[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb77-5"><a href="empirical-results.html#cb77-5" tabindex="-1"></a>                                                      nodesize <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>nodesize[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb77-6"><a href="empirical-results.html#cb77-6" tabindex="-1"></a>                                                      mtry <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>mtry[<span class="dv">2</span>]),</span>
<span id="cb77-7"><a href="empirical-results.html#cb77-7" tabindex="-1"></a>                           <span class="st">&quot;rf&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.random_forest.best_model-3.png" width="672" /></p>
<p><strong>Performance evaluation on test set</strong></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="empirical-results.html#cb78-1" tabindex="-1"></a><span class="co"># prediction scores on test data: (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb78-2"><a href="empirical-results.html#cb78-2" tabindex="-1"></a>pred.test.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf.fit, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb78-3"><a href="empirical-results.html#cb78-3" tabindex="-1"></a></span>
<span id="cb78-4"><a href="empirical-results.html#cb78-4" tabindex="-1"></a><span class="co"># metrics on test set using best threshold determined based on train data</span></span>
<span id="cb78-5"><a href="empirical-results.html#cb78-5" tabindex="-1"></a>rf.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted <span class="sc">&gt;=</span> rf.metrics<span class="sc">$</span>cutpoint.roc),</span>
<span id="cb78-6"><a href="empirical-results.html#cb78-6" tabindex="-1"></a>      <span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted <span class="sc">&gt;=</span> rf.metrics<span class="sc">$</span>cutpoint.mccf1)) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="empirical-results.html#cb78-7" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">splitting =</span> <span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), .)</span>
<span id="cb78-8"><a href="empirical-results.html#cb78-8" tabindex="-1"></a><span class="fu">pander</span>(rf.summary.test, <span class="at">caption =</span> <span class="st">&quot;Random forest on test data&quot;</span>)</span></code></pre></div>
<table>
<caption>Random forest on test data (continued below)</caption>
<colgroup>
<col width="15%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="8%" />
<col width="14%" />
<col width="15%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">splitting</th>
<th align="center">tp</th>
<th align="center">fn</th>
<th align="center">fp</th>
<th align="center">tn</th>
<th align="center">accuracy</th>
<th align="center">precision</th>
<th align="center">recall</th>
<th align="center">f1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ROC</td>
<td align="center">320</td>
<td align="center">116</td>
<td align="center">425</td>
<td align="center">1357</td>
<td align="center">0.7561</td>
<td align="center">0.4295</td>
<td align="center">0.7339</td>
<td align="center">0.5419</td>
</tr>
<tr class="even">
<td align="center">MCCF1</td>
<td align="center">265</td>
<td align="center">171</td>
<td align="center">240</td>
<td align="center">1542</td>
<td align="center">0.8147</td>
<td align="center">0.5248</td>
<td align="center">0.6078</td>
<td align="center">0.5632</td>
</tr>
</tbody>
</table>
<table style="width:32%;">
<colgroup>
<col width="19%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">specificity</th>
<th align="center">mcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.7615</td>
<td align="center">0.4169</td>
</tr>
<tr class="even">
<td align="center">0.8653</td>
<td align="center">0.4484</td>
</tr>
</tbody>
</table>
<p><strong>Variable importance</strong></p>
<p><strong>Definition <a href="https://www.randomforestsrc.org/articles/rfsrc-subsample.html">Permutation (Breiman-Cutler)
Importance</a></strong>:
In the OOB cases for a tree, randomly permute all values of the j-th
variable. Put these new covariate values down the tree and compute a new
internal error rate. The amount by which this new error exceeds the
original OOB error is defined as the importance of the j-th variable for
the tree. Averaging over the forest yields variable importance (VIMP).</p>
<p>The following chunk determines the variable importance of all the
features in the model data set using the permutation importance method.
The twenty features with the highest variable importance are displayed
in the barplot.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="empirical-results.html#cb79-1" tabindex="-1"></a>rfr.vimp.results <span class="ot">&lt;-</span> <span class="fu">vimp</span>(rf.fit<span class="sc">$</span>finalModel, <span class="at">importance =</span> <span class="st">&quot;permute&quot;</span>)</span>
<span id="cb79-2"><a href="empirical-results.html#cb79-2" tabindex="-1"></a>rfr.vimp <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb79-3"><a href="empirical-results.html#cb79-3" tabindex="-1"></a>  <span class="at">feature =</span> rfr.vimp.results<span class="sc">$</span>xvar.names,</span>
<span id="cb79-4"><a href="empirical-results.html#cb79-4" tabindex="-1"></a>  <span class="at">vimp =</span> <span class="dv">100</span> <span class="sc">*</span> rfr.vimp.results<span class="sc">$</span>importance[,<span class="st">&quot;all&quot;</span>]</span>
<span id="cb79-5"><a href="empirical-results.html#cb79-5" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(vimp))</span>
<span id="cb79-6"><a href="empirical-results.html#cb79-6" tabindex="-1"></a></span>
<span id="cb79-7"><a href="empirical-results.html#cb79-7" tabindex="-1"></a><span class="fu">plot.vimp</span>(rfr.vimp, <span class="st">&quot;Permutation (Beiman-Cutler) Importance&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/random_forest.vimp-1.png" width="672" /></p>
<p>The price-to-earnings ratio feature <code>pe_exi</code> is the most important financial ratio feature. The histogram with delisting frequency for <code>pe_exi</code> indicates indeed high predictive power between the
<code>pe_exi</code> values near zero and the relative delisting frequency.<br />
The financial ratio features <code>aftret_equity</code>, <code>opmad</code> and `roe`` follow in the importance ranking. This is plausible as the histograms with delisting frequency (see Exploratory Data Analysis section) indicated predictive power for delisting. If the (after-tax) return on equity is low and/or the operative profit margin is negative, then the delisting frequency is relatively high.</p>
<p><strong>Marginal plots</strong></p>
<p><strong>Definition <a href="https://www.randomforestsrc.org/articles/partial.html">Partial Dependence
Function</a></strong>: Let
<span class="math inline">\(F(x)\)</span> be the target function in a supervised problem where
<span class="math inline">\(x = (x_1, \dots, x_p)\)</span>. Let <span class="math inline">\(x_s\)</span> denote <span class="math inline">\(x\)</span> restricted to coordinate
indices <span class="math inline">\(s \subset \{1,\dots,p\}\)</span>. Likewise using the notation
<span class="math inline">\(\backslash s=\{1,…,p\}\backslash s\)</span> to denote the complement of <span class="math inline">\(s\)</span>,
let <span class="math inline">\(x∖backslash s\)</span> denote the coordinates of <span class="math inline">\(x\)</span> with indices not in
<span class="math inline">\(s\)</span>. The (marginal) partial dependence function is <span class="math display">\[
\overline{F}(x_s) = \int F(x_s,x_{\backslash s}) \cdot p_{\backslash s}(x_{\backslash s})dx_{\backslash s}
\]</span> where
<span class="math inline">\(p_{\backslash s}(x_{\backslash s}) = \int p(x) dx_{\backslash s}\)</span> is
the marginal probability density of <span class="math inline">\(x_{\backslash s}\)</span>.</p>
<p>The target function <span class="math inline">\(F(x)\)</span> is usually not known for supervised learning
problems. In a random forest, the target function is estimated by an
ensemble of trees. Let <span class="math inline">\(\hat{F}\)</span> denote this estimator. Let
<span class="math inline">\(X_1,\dots, X_n\)</span> denote the features from the learning data, then the
estimated partial dependence function is <span class="math display">\[
\hat{\overline{F}}(x_s) = \frac{1}{n} \sum_{i=1}^n \hat{F}(x_s, X_{i,\backslash s})
\]</span> The plots of the estimated marginal partial dependence function for
the twenty most important features are displayed below.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="empirical-results.html#cb80-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb80-2"><a href="empirical-results.html#cb80-2" tabindex="-1"></a>  rf.partial_plots <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb80-3"><a href="empirical-results.html#cb80-3" tabindex="-1"></a>  counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb80-4"><a href="empirical-results.html#cb80-4" tabindex="-1"></a>  <span class="cf">for</span> (feature_identifier <span class="cf">in</span> (rfr.vimp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">20</span>))<span class="sc">$</span>feature) {</span>
<span id="cb80-5"><a href="empirical-results.html#cb80-5" tabindex="-1"></a>    min <span class="ot">&lt;-</span> <span class="fu">min</span>(rf.fit<span class="sc">$</span>finalModel<span class="sc">$</span>xvar[feature_identifier])</span>
<span id="cb80-6"><a href="empirical-results.html#cb80-6" tabindex="-1"></a>    max <span class="ot">&lt;-</span> <span class="fu">max</span>(rf.fit<span class="sc">$</span>finalModel<span class="sc">$</span>xvar[feature_identifier])</span>
<span id="cb80-7"><a href="empirical-results.html#cb80-7" tabindex="-1"></a>    sequence_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(min, max, <span class="at">length.out =</span> <span class="dv">30</span>)</span>
<span id="cb80-8"><a href="empirical-results.html#cb80-8" tabindex="-1"></a>    </span>
<span id="cb80-9"><a href="empirical-results.html#cb80-9" tabindex="-1"></a>    <span class="co"># partial effect for feature feature_identifier</span></span>
<span id="cb80-10"><a href="empirical-results.html#cb80-10" tabindex="-1"></a>    partial.obj <span class="ot">&lt;-</span> <span class="fu">partial</span>(rf.fit<span class="sc">$</span>finalModel,</span>
<span id="cb80-11"><a href="empirical-results.html#cb80-11" tabindex="-1"></a>      <span class="at">partial.xvar =</span> feature_identifier,</span>
<span id="cb80-12"><a href="empirical-results.html#cb80-12" tabindex="-1"></a>      <span class="at">partial.values =</span> sequence_values</span>
<span id="cb80-13"><a href="empirical-results.html#cb80-13" tabindex="-1"></a>    )</span>
<span id="cb80-14"><a href="empirical-results.html#cb80-14" tabindex="-1"></a></span>
<span id="cb80-15"><a href="empirical-results.html#cb80-15" tabindex="-1"></a>    <span class="do">## helper function for extracting the partial effects</span></span>
<span id="cb80-16"><a href="empirical-results.html#cb80-16" tabindex="-1"></a>    pdta <span class="ot">&lt;-</span> <span class="fu">get.partial.plot.data</span>(partial.obj)</span>
<span id="cb80-17"><a href="empirical-results.html#cb80-17" tabindex="-1"></a>    </span>
<span id="cb80-18"><a href="empirical-results.html#cb80-18" tabindex="-1"></a>    rf.partial_plots[[counter]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> pdta<span class="sc">$</span>x, <span class="at">y =</span> pdta<span class="sc">$</span>yhat)</span>
<span id="cb80-19"><a href="empirical-results.html#cb80-19" tabindex="-1"></a>    counter <span class="ot">=</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb80-20"><a href="empirical-results.html#cb80-20" tabindex="-1"></a>  }</span>
<span id="cb80-21"><a href="empirical-results.html#cb80-21" tabindex="-1"></a>  <span class="fu">save</span>(rf.partial_plots, <span class="at">file =</span> <span class="st">&quot;../data/rf.partial_plots.RData&quot;</span>)</span>
<span id="cb80-22"><a href="empirical-results.html#cb80-22" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb80-23"><a href="empirical-results.html#cb80-23" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/rf.partial_plots.RData&quot;</span>)</span>
<span id="cb80-24"><a href="empirical-results.html#cb80-24" tabindex="-1"></a>}</span>
<span id="cb80-25"><a href="empirical-results.html#cb80-25" tabindex="-1"></a></span>
<span id="cb80-26"><a href="empirical-results.html#cb80-26" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb80-27"><a href="empirical-results.html#cb80-27" tabindex="-1"></a><span class="co"># marginal plots of 20 most important features on test data</span></span>
<span id="cb80-28"><a href="empirical-results.html#cb80-28" tabindex="-1"></a><span class="cf">for</span> (feature_identifier <span class="cf">in</span> (rfr.vimp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">20</span>))<span class="sc">$</span>feature) {</span>
<span id="cb80-29"><a href="empirical-results.html#cb80-29" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb80-30"><a href="empirical-results.html#cb80-30" tabindex="-1"></a>    (data.test <span class="sc">%&gt;%</span></span>
<span id="cb80-31"><a href="empirical-results.html#cb80-31" tabindex="-1"></a>        <span class="fu">inner_join</span>(com <span class="sc">%&gt;%</span> <span class="fu">select</span>(permno, public_date, years_to_delisting), <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date))),</span>
<span id="cb80-32"><a href="empirical-results.html#cb80-32" tabindex="-1"></a>    feature_identifier,</span>
<span id="cb80-33"><a href="empirical-results.html#cb80-33" tabindex="-1"></a>    feature_identifier,</span>
<span id="cb80-34"><a href="empirical-results.html#cb80-34" tabindex="-1"></a>    <span class="at">marginal.data =</span> pred.test.probability<span class="sc">$</span>delisted</span>
<span id="cb80-35"><a href="empirical-results.html#cb80-35" tabindex="-1"></a>  )</span>
<span id="cb80-36"><a href="empirical-results.html#cb80-36" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb80-37"><a href="empirical-results.html#cb80-37" tabindex="-1"></a>  </span>
<span id="cb80-38"><a href="empirical-results.html#cb80-38" tabindex="-1"></a>  <span class="co"># marginal plots of 20 most important features and feature pe_exi on test data</span></span>
<span id="cb80-39"><a href="empirical-results.html#cb80-39" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb80-40"><a href="empirical-results.html#cb80-40" tabindex="-1"></a>      <span class="at">data =</span> rf.partial_plots[[counter]],</span>
<span id="cb80-41"><a href="empirical-results.html#cb80-41" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)</span>
<span id="cb80-42"><a href="empirical-results.html#cb80-42" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-43"><a href="empirical-results.html#cb80-43" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb80-44"><a href="empirical-results.html#cb80-44" tabindex="-1"></a>    <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb80-45"><a href="empirical-results.html#cb80-45" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb80-46"><a href="empirical-results.html#cb80-46" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Partial dependence plot&quot;</span>,</span>
<span id="cb80-47"><a href="empirical-results.html#cb80-47" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">&quot;Random forest&quot;</span>,</span>
<span id="cb80-48"><a href="empirical-results.html#cb80-48" tabindex="-1"></a>      <span class="at">x =</span> feature_identifier,</span>
<span id="cb80-49"><a href="empirical-results.html#cb80-49" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">&quot;Prediction&quot;</span></span>
<span id="cb80-50"><a href="empirical-results.html#cb80-50" tabindex="-1"></a>    )</span>
<span id="cb80-51"><a href="empirical-results.html#cb80-51" tabindex="-1"></a></span>
<span id="cb80-52"><a href="empirical-results.html#cb80-52" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb80-53"><a href="empirical-results.html#cb80-53" tabindex="-1"></a>  counter <span class="ot">=</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb80-54"><a href="empirical-results.html#cb80-54" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/model.random_forest.partial_plots-1.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-2.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-3.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-4.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-5.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-6.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-7.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-8.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-9.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-10.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-11.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-12.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-13.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-14.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-15.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-16.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-17.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-18.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-19.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-20.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-21.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-22.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-23.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-24.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-25.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-26.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-27.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-28.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-29.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-30.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-31.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-32.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-33.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-34.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-35.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-36.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-37.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-38.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-39.png" width="672" /><img src="_main_files/figure-html/model.random_forest.partial_plots-40.png" width="672" /></p>
<ul>
<li><p><code>pe_exi1</code> and <code>pe_exi2</code>: If the price-to-earnings ratio (per share)
is around zero (market value per share around zero), more delistings occur than with an in absolute terms larger price-to-earnings ratio. If the PE ratio is negative, the market value of a share is large compared to a small negative loss. If the PE ratio is positive, the market value per share is lower than the earnings per share which signifies underpricing of the share.<br />
</p></li>
<li><p><code>cash_ratio1</code>, <code>quick_ratio1</code>: If the ratio between cash (plus
short-term investments) and liabilities increases, the partial
dependence function decreases.<br />
</p></li>
<li><p><code>opmbd1</code>, <code>opmbd2</code>: The observed and modeled delisting frequency is
relatively high for negative operative profit margins. The frequency
drops the more the operative profit margin gets positive.<br />
</p></li>
<li><p><code>roe1</code>: If the returns on equity are negative, the observed and
modeled delisting frequency is higher thant for positive values.</p></li>
<li><p><code>aftret_equity</code>: If the net income over total shareholder’s equity
is negative, the observed and modeled delisting frequency is higher
than for positive ratios.<br />
</p></li>
<li><p><code>fredfund_chg</code>: The the Federal Reserve decreases the federal funds
rate in periods of economic crisis. In these times, relatively many
companies delist. In times of good conjuncture, the Federal Reserve
rises interest rates. <strong>(Will this result in problems for the years
2021-2023?)</strong><br />
</p></li>
<li><p><code>roe_h</code>: The random forest models a higher delisting frequency for
companies whose return on equity decreased than for companies whose
return on equity increased in the past up to seven years.<br />
</p></li>
<li><p><code>at_turn_h</code>: If the asset turnover declined over the past seven
years<br />
</p></li>
<li><p><code>cpiaucsl</code>: The modeled delisting frequency is the highest for negative or small positive CPI rate changes. There is a decrease followed by a global minimum in modeled delisting between an annual inflation rate of 0.06 and 0.09. For CPI rate changes higher than 0.09, the modeled delisting frequency increases.<br />
</p></li>
<li><p><code>cash_ratio_h</code>, <code>quick_ratio_h</code>: If the cash ratio increased in the
past, the modeled delisting frequency is lower than for a decrease
of the ratio in the past.<br />
</p></li>
<li><p><code>aftret_equity_h</code>, <code>aftret_eq_h</code>: If the net income to equity ratio
increased in the past, the modeled delisting frequency is lower than
for a decrease of the ratio in the past.<br />
</p></li>
<li><p><code>roe_h</code>, <code>roa_h</code>: ?????????????????<br />
</p></li>
<li><p><code>debt_assets_h</code>: ????????????<br />
</p></li>
<li><p><code>pay_turn_h</code>: Cost of goods sold / Average of Accout payables</p></li>
<li><p><code>pe_exi_h</code>: If the PE ratio increased in the past, the</p></li>
<li><p><code>gdpc1_chg</code>: If the gross domestic product change is large, delisting is relatively high.</p></li>
<li><p><em>R packages for neural networks, SVN?</em></p></li>
</ul>
<p>Further models possibly coming soon: Logistic Regression with Lasso
regularization, Neural Network, SVM, Boosting</p>

</div>
<div id="logistic-regression" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Logistic Regression<a href="empirical-results.html#logistic-regression" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><span class="math display">\[
\underset{(\beta_0,\beta)\in R^{(p+1)}}{\min} -\left[ \frac{1}{N} \sum_{i=1}^N y_i \cdot (\beta_0 + x_i^T\beta) - \log(1 + e^{\beta_0+x_i^T\beta}) \right] + \lambda \left[\frac{1-\alpha}{2} \lVert \beta \rVert_2 + \alpha \lVert \beta \rVert_1 \right]
\]</span></p>
<p><strong>Model fit</strong></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="empirical-results.html#cb81-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb81-2"><a href="empirical-results.html#cb81-2" tabindex="-1"></a>  <span class="do">### control the computational nuances of the train function ##################</span></span>
<span id="cb81-3"><a href="empirical-results.html#cb81-3" tabindex="-1"></a>  lr.fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>,</span>
<span id="cb81-4"><a href="empirical-results.html#cb81-4" tabindex="-1"></a>                             <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb81-5"><a href="empirical-results.html#cb81-5" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="co"># estimate class probabilities</span></span>
<span id="cb81-6"><a href="empirical-results.html#cb81-6" tabindex="-1"></a>                             <span class="co"># evaluate performance using the following function</span></span>
<span id="cb81-7"><a href="empirical-results.html#cb81-7" tabindex="-1"></a>                             <span class="at">summaryFunction =</span> compute.summary,</span>
<span id="cb81-8"><a href="empirical-results.html#cb81-8" tabindex="-1"></a>                             <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb81-9"><a href="empirical-results.html#cb81-9" tabindex="-1"></a>  <span class="do">### fit model over different tuning parameters ###############################</span></span>
<span id="cb81-10"><a href="empirical-results.html#cb81-10" tabindex="-1"></a>  lr.fit <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date),</span>
<span id="cb81-11"><a href="empirical-results.html#cb81-11" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb81-12"><a href="empirical-results.html#cb81-12" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;glmnet&quot;</span>, </span>
<span id="cb81-13"><a href="empirical-results.html#cb81-13" tabindex="-1"></a>                   <span class="at">trControl =</span> lr.fitControl, </span>
<span id="cb81-14"><a href="empirical-results.html#cb81-14" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(</span>
<span id="cb81-15"><a href="empirical-results.html#cb81-15" tabindex="-1"></a>                     <span class="at">alpha =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb81-16"><a href="empirical-results.html#cb81-16" tabindex="-1"></a>                     <span class="at">lambda =</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">6</span>, <span class="at">by =</span> <span class="dv">1</span>))</span>
<span id="cb81-17"><a href="empirical-results.html#cb81-17" tabindex="-1"></a>                   ),</span>
<span id="cb81-18"><a href="empirical-results.html#cb81-18" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb81-19"><a href="empirical-results.html#cb81-19" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;mcc.mccf1&quot;</span>) <span class="co"># specify which metric to optimize</span></span>
<span id="cb81-20"><a href="empirical-results.html#cb81-20" tabindex="-1"></a>  <span class="fu">save</span>(lr.fit, <span class="at">file =</span> <span class="st">&quot;../data/lr.fit.RData&quot;</span>)</span>
<span id="cb81-21"><a href="empirical-results.html#cb81-21" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb81-22"><a href="empirical-results.html#cb81-22" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/lr.fit.RData&quot;</span>)</span>
<span id="cb81-23"><a href="empirical-results.html#cb81-23" tabindex="-1"></a>}</span>
<span id="cb81-24"><a href="empirical-results.html#cb81-24" tabindex="-1"></a></span>
<span id="cb81-25"><a href="empirical-results.html#cb81-25" tabindex="-1"></a><span class="fu">ggplot</span>(lr.fit) <span class="sc">+</span></span>
<span id="cb81-26"><a href="empirical-results.html#cb81-26" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb81-27"><a href="empirical-results.html#cb81-27" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Logistic regression with elastic net regularization&quot;</span>,</span>
<span id="cb81-28"><a href="empirical-results.html#cb81-28" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;MCC vs. mixing percentage alpha&quot;</span>,</span>
<span id="cb81-29"><a href="empirical-results.html#cb81-29" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Mixing percentage alpha&quot;</span>,</span>
<span id="cb81-30"><a href="empirical-results.html#cb81-30" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;MCC (10-fold cross-validation)&quot;</span></span>
<span id="cb81-31"><a href="empirical-results.html#cb81-31" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/model.lr.fit-1.png" width="672" /></p>
<p><strong>Model information and evaluation on training set</strong></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="empirical-results.html#cb82-1" tabindex="-1"></a>lr.bestTune.mccf1 <span class="ot">&lt;-</span> lr.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb82-2"><a href="empirical-results.html#cb82-2" tabindex="-1"></a>  <span class="fu">group_by</span>(alpha, lambda) <span class="sc">%&gt;%</span></span>
<span id="cb82-3"><a href="empirical-results.html#cb82-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mccf1 =</span> <span class="fu">mean</span>(mcc.mccf1), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-4"><a href="empirical-results.html#cb82-4" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(mccf1))</span>
<span id="cb82-5"><a href="empirical-results.html#cb82-5" tabindex="-1"></a></span>
<span id="cb82-6"><a href="empirical-results.html#cb82-6" tabindex="-1"></a>lr.bestTune.roc <span class="ot">&lt;-</span> lr.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb82-7"><a href="empirical-results.html#cb82-7" tabindex="-1"></a>  <span class="fu">group_by</span>(alpha, lambda) <span class="sc">%&gt;%</span></span>
<span id="cb82-8"><a href="empirical-results.html#cb82-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">auc =</span> <span class="fu">mean</span>(auc.roc), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-9"><a href="empirical-results.html#cb82-9" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(auc))</span>
<span id="cb82-10"><a href="empirical-results.html#cb82-10" tabindex="-1"></a></span>
<span id="cb82-11"><a href="empirical-results.html#cb82-11" tabindex="-1"></a><span class="co"># Hyperparameters of best models for MCC-F1 and ROC cutpoints</span></span>
<span id="cb82-12"><a href="empirical-results.html#cb82-12" tabindex="-1"></a>hyperparameters.table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb82-13"><a href="empirical-results.html#cb82-13" tabindex="-1"></a>  <span class="at">cutpoint =</span> <span class="fu">c</span>(<span class="st">&quot;MCCF1&quot;</span>, <span class="st">&quot;ROC&quot;</span>),</span>
<span id="cb82-14"><a href="empirical-results.html#cb82-14" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fu">c</span>(lr.bestTune.mccf1<span class="sc">$</span>alpha, lr.bestTune.roc<span class="sc">$</span>alpha),</span>
<span id="cb82-15"><a href="empirical-results.html#cb82-15" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">c</span>(lr.bestTune.mccf1<span class="sc">$</span>lambda, lr.bestTune.roc<span class="sc">$</span>lambda),</span>
<span id="cb82-16"><a href="empirical-results.html#cb82-16" tabindex="-1"></a>)</span>
<span id="cb82-17"><a href="empirical-results.html#cb82-17" tabindex="-1"></a></span>
<span id="cb82-18"><a href="empirical-results.html#cb82-18" tabindex="-1"></a>pred.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr.fit, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb82-19"><a href="empirical-results.html#cb82-19" tabindex="-1"></a>lr.metrics <span class="ot">&lt;-</span> <span class="fu">illustrate.metrics</span>(hyperparameters.table, data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.lr.best_model-1.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.2439 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.lr.best_model-2.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.3142 maximizes MCCF1 metric.&quot;</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="empirical-results.html#cb85-1" tabindex="-1"></a><span class="fu">illustrate.metrics.boxplot</span>(lr.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(alpha <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>alpha[<span class="dv">1</span>]</span>
<span id="cb85-2"><a href="empirical-results.html#cb85-2" tabindex="-1"></a>                                                      <span class="sc">&amp;</span> lambda <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>lambda[<span class="dv">1</span>]),</span>
<span id="cb85-3"><a href="empirical-results.html#cb85-3" tabindex="-1"></a>                           lr.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(alpha <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>alpha[<span class="dv">2</span>]</span>
<span id="cb85-4"><a href="empirical-results.html#cb85-4" tabindex="-1"></a>                                                      <span class="sc">&amp;</span> lambda <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>lambda[<span class="dv">2</span>]),</span>
<span id="cb85-5"><a href="empirical-results.html#cb85-5" tabindex="-1"></a>                           <span class="st">&quot;lr&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.lr.best_model-3.png" width="672" />
<strong>Performance evaluation on test set</strong></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="empirical-results.html#cb86-1" tabindex="-1"></a><span class="co"># MCCF1 variant: prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb86-2"><a href="empirical-results.html#cb86-2" tabindex="-1"></a>pred.test.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr.fit, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb86-3"><a href="empirical-results.html#cb86-3" tabindex="-1"></a></span>
<span id="cb86-4"><a href="empirical-results.html#cb86-4" tabindex="-1"></a><span class="co"># ROC variant: fit model using best hyperparameters and </span></span>
<span id="cb86-5"><a href="empirical-results.html#cb86-5" tabindex="-1"></a><span class="co">#              find best threshold and</span></span>
<span id="cb86-6"><a href="empirical-results.html#cb86-6" tabindex="-1"></a><span class="co">#              prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb86-7"><a href="empirical-results.html#cb86-7" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb86-8"><a href="empirical-results.html#cb86-8" tabindex="-1"></a>lr.fit.roc <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date),</span>
<span id="cb86-9"><a href="empirical-results.html#cb86-9" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb86-10"><a href="empirical-results.html#cb86-10" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;glmnet&quot;</span>, </span>
<span id="cb86-11"><a href="empirical-results.html#cb86-11" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb86-12"><a href="empirical-results.html#cb86-12" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="at">summaryFunction =</span> compute.summary), </span>
<span id="cb86-13"><a href="empirical-results.html#cb86-13" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(</span>
<span id="cb86-14"><a href="empirical-results.html#cb86-14" tabindex="-1"></a>                     <span class="at">alpha =</span> lr.bestTune.roc<span class="sc">$</span>alpha,</span>
<span id="cb86-15"><a href="empirical-results.html#cb86-15" tabindex="-1"></a>                     <span class="at">lambda =</span> lr.bestTune.roc<span class="sc">$</span>lambda</span>
<span id="cb86-16"><a href="empirical-results.html#cb86-16" tabindex="-1"></a>                   ),</span>
<span id="cb86-17"><a href="empirical-results.html#cb86-17" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb86-18"><a href="empirical-results.html#cb86-18" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;auc.roc&quot;</span>) <span class="co"># specify which metric to optimize</span></span>
<span id="cb86-19"><a href="empirical-results.html#cb86-19" tabindex="-1"></a>lr.metrics.roc.cutpoint <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(</span>
<span id="cb86-20"><a href="empirical-results.html#cb86-20" tabindex="-1"></a>  <span class="fu">predict</span>(lr.fit.roc, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted,</span>
<span id="cb86-21"><a href="empirical-results.html#cb86-21" tabindex="-1"></a>  data.training<span class="sc">$</span>response)<span class="sc">$</span>best_cutpoint</span>
<span id="cb86-22"><a href="empirical-results.html#cb86-22" tabindex="-1"></a>pred.test.probability.roc <span class="ot">&lt;-</span> <span class="fu">predict</span>(lr.fit.roc, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb86-23"><a href="empirical-results.html#cb86-23" tabindex="-1"></a></span>
<span id="cb86-24"><a href="empirical-results.html#cb86-24" tabindex="-1"></a><span class="co"># metrics on test set using best threshold determined based on train data</span></span>
<span id="cb86-25"><a href="empirical-results.html#cb86-25" tabindex="-1"></a>lr.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability.roc<span class="sc">$</span>delisted <span class="sc">&gt;=</span> lr.metrics.roc.cutpoint),</span>
<span id="cb86-26"><a href="empirical-results.html#cb86-26" tabindex="-1"></a>      <span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted <span class="sc">&gt;=</span> lr.metrics<span class="sc">$</span>cutpoint.mccf1)) <span class="sc">%&gt;%</span></span>
<span id="cb86-27"><a href="empirical-results.html#cb86-27" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">splitting =</span> <span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), .)</span>
<span id="cb86-28"><a href="empirical-results.html#cb86-28" tabindex="-1"></a><span class="fu">pander</span>(lr.summary.test, <span class="at">caption =</span> <span class="st">&quot;Logistic regression on test data&quot;</span>)</span></code></pre></div>
<table>
<caption>Logistic regression on test data (continued below)</caption>
<colgroup>
<col width="15%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="8%" />
<col width="14%" />
<col width="15%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">splitting</th>
<th align="center">tp</th>
<th align="center">fn</th>
<th align="center">fp</th>
<th align="center">tn</th>
<th align="center">accuracy</th>
<th align="center">precision</th>
<th align="center">recall</th>
<th align="center">f1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ROC</td>
<td align="center">282</td>
<td align="center">154</td>
<td align="center">516</td>
<td align="center">1266</td>
<td align="center">0.6979</td>
<td align="center">0.3534</td>
<td align="center">0.6468</td>
<td align="center">0.4571</td>
</tr>
<tr class="even">
<td align="center">MCCF1</td>
<td align="center">137</td>
<td align="center">299</td>
<td align="center">157</td>
<td align="center">1625</td>
<td align="center">0.7944</td>
<td align="center">0.466</td>
<td align="center">0.3142</td>
<td align="center">0.3753</td>
</tr>
</tbody>
</table>
<table style="width:32%;">
<colgroup>
<col width="19%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">specificity</th>
<th align="center">mcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.7104</td>
<td align="center">0.2958</td>
</tr>
<tr class="even">
<td align="center">0.9119</td>
<td align="center">0.265</td>
</tr>
</tbody>
</table>
<p><strong>Variable importance</strong></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="empirical-results.html#cb87-1" tabindex="-1"></a>lr.vimp.results <span class="ot">&lt;-</span> <span class="fu">varImp</span>(lr.fit)<span class="sc">$</span>importance</span>
<span id="cb87-2"><a href="empirical-results.html#cb87-2" tabindex="-1"></a>lr.vimp <span class="ot">&lt;-</span> lr.vimp.results <span class="sc">%&gt;%</span></span>
<span id="cb87-3"><a href="empirical-results.html#cb87-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature =</span> <span class="fu">rownames</span>(lr.vimp.results),</span>
<span id="cb87-4"><a href="empirical-results.html#cb87-4" tabindex="-1"></a>         <span class="at">vimp =</span> Overall) <span class="sc">%&gt;%</span> </span>
<span id="cb87-5"><a href="empirical-results.html#cb87-5" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(vimp))</span>
<span id="cb87-6"><a href="empirical-results.html#cb87-6" tabindex="-1"></a></span>
<span id="cb87-7"><a href="empirical-results.html#cb87-7" tabindex="-1"></a><span class="fu">plot.vimp</span>(lr.vimp, <span class="st">&quot;Importance based on value of t-statistic for each model parameter&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.lr.vimp-1.png" width="672" /></p>
<p><strong>Marginal plots</strong></p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="empirical-results.html#cb88-1" tabindex="-1"></a><span class="co"># marginal plots of 20 most important features and feature pe_exi on test data</span></span>
<span id="cb88-2"><a href="empirical-results.html#cb88-2" tabindex="-1"></a><span class="cf">for</span> (feature_identifier <span class="cf">in</span> <span class="fu">c</span>((lr.vimp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">20</span>))<span class="sc">$</span>feature, <span class="st">&quot;pe_exi&quot;</span>)) {</span>
<span id="cb88-3"><a href="empirical-results.html#cb88-3" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb88-4"><a href="empirical-results.html#cb88-4" tabindex="-1"></a>      (data.test <span class="sc">%&gt;%</span> </span>
<span id="cb88-5"><a href="empirical-results.html#cb88-5" tabindex="-1"></a>        <span class="fu">inner_join</span>(com <span class="sc">%&gt;%</span> <span class="fu">select</span>(permno, public_date, years_to_delisting), <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date))),</span>
<span id="cb88-6"><a href="empirical-results.html#cb88-6" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb88-7"><a href="empirical-results.html#cb88-7" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb88-8"><a href="empirical-results.html#cb88-8" tabindex="-1"></a>      <span class="at">marginal.data =</span> pred.test.probability<span class="sc">$</span>delisted</span>
<span id="cb88-9"><a href="empirical-results.html#cb88-9" tabindex="-1"></a>  )</span>
<span id="cb88-10"><a href="empirical-results.html#cb88-10" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb88-11"><a href="empirical-results.html#cb88-11" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/model.lr.marginal-1.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-2.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-3.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-4.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-5.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-6.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-7.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-8.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-9.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-10.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-11.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-12.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-13.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-14.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-15.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-16.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-17.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-18.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-19.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-20.png" width="672" /><img src="_main_files/figure-html/model.lr.marginal-21.png" width="672" /></p>

</div>
<div id="support-vector-machine" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Support Vector Machine<a href="empirical-results.html#support-vector-machine" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!-- SVM vignette: https://cran.r-project.org/web/packages/kernlab/vignettes/kernlab.pdf -->
<p>Let the training data consist of <span class="math inline">\(N\)</span> pairs <span class="math inline">\((x_1,y_1),(x_2,y_2),\ldots,(x_N,y_N)\)</span>, with <span class="math inline">\(x_i \in \mathbb{R}^p\)</span> and <span class="math inline">\(y_i\in\{0,1\}\)</span>. Define a hyperplane by
<span class="math display">\[
\{x:f(x)=x^T\beta+\beta_0=0\}
\]</span>
where <span class="math inline">\(\beta\)</span> is a vector.
<span class="math display">\[
\begin{align*}
  \hat{f}(x) &amp;= \text{sign} \left( h(x)^T \hat{\beta} + \hat{\beta_0} \right) = \text{sign} \left( h(x)^T \left( \sum_{i=1}^N \hat{\alpha_i} y_i h(x_i) \right) + \hat{\beta_0} \right) \\
    &amp;= \text{sign} \left( \sum_{i=1}^N \hat{\alpha}_i y_i \langle h(x), h(x_i) \rangle + \hat{\beta_0} \right) = \text{sign} \left( \sum_{i=1}^N \hat{\alpha}_i y_i K(x,x_i) + \hat{\beta_0} \right)
\end{align*}
\]</span></p>
<p><strong>Model fit</strong></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="empirical-results.html#cb89-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb89-2"><a href="empirical-results.html#cb89-2" tabindex="-1"></a>  <span class="do">### control the computational nuances of the train function ####################</span></span>
<span id="cb89-3"><a href="empirical-results.html#cb89-3" tabindex="-1"></a>  svm.fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>,</span>
<span id="cb89-4"><a href="empirical-results.html#cb89-4" tabindex="-1"></a>                             <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb89-5"><a href="empirical-results.html#cb89-5" tabindex="-1"></a>                             <span class="do">## Estimate class probabilities</span></span>
<span id="cb89-6"><a href="empirical-results.html#cb89-6" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb89-7"><a href="empirical-results.html#cb89-7" tabindex="-1"></a>                             <span class="do">## Evaluate performance using </span></span>
<span id="cb89-8"><a href="empirical-results.html#cb89-8" tabindex="-1"></a>                             <span class="do">## the following function</span></span>
<span id="cb89-9"><a href="empirical-results.html#cb89-9" tabindex="-1"></a>                             <span class="at">summaryFunction =</span> compute.summary,</span>
<span id="cb89-10"><a href="empirical-results.html#cb89-10" tabindex="-1"></a>                             <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb89-11"><a href="empirical-results.html#cb89-11" tabindex="-1"></a>  </span>
<span id="cb89-12"><a href="empirical-results.html#cb89-12" tabindex="-1"></a>  <span class="do">### fit model over different tuning parameters #################################</span></span>
<span id="cb89-13"><a href="empirical-results.html#cb89-13" tabindex="-1"></a>  svm.fit <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date), </span>
<span id="cb89-14"><a href="empirical-results.html#cb89-14" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb89-15"><a href="empirical-results.html#cb89-15" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;svmPoly&quot;</span>, </span>
<span id="cb89-16"><a href="empirical-results.html#cb89-16" tabindex="-1"></a>                   <span class="at">trControl =</span> svm.fitControl,</span>
<span id="cb89-17"><a href="empirical-results.html#cb89-17" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(</span>
<span id="cb89-18"><a href="empirical-results.html#cb89-18" tabindex="-1"></a>                     <span class="at">degree =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>),</span>
<span id="cb89-19"><a href="empirical-results.html#cb89-19" tabindex="-1"></a>                     <span class="at">scale =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>),</span>
<span id="cb89-20"><a href="empirical-results.html#cb89-20" tabindex="-1"></a>                     <span class="at">C =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="dv">1</span>)),</span>
<span id="cb89-21"><a href="empirical-results.html#cb89-21" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb89-22"><a href="empirical-results.html#cb89-22" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;mcc.mccf1&quot;</span></span>
<span id="cb89-23"><a href="empirical-results.html#cb89-23" tabindex="-1"></a>                   ) <span class="co"># specify which metric to optimize</span></span>
<span id="cb89-24"><a href="empirical-results.html#cb89-24" tabindex="-1"></a>  <span class="fu">save</span>(svm.fit, <span class="at">file =</span> <span class="st">&quot;../data/svm.fit.RData&quot;</span>)</span>
<span id="cb89-25"><a href="empirical-results.html#cb89-25" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb89-26"><a href="empirical-results.html#cb89-26" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/svm.fit.RData&quot;</span>)</span>
<span id="cb89-27"><a href="empirical-results.html#cb89-27" tabindex="-1"></a>}</span>
<span id="cb89-28"><a href="empirical-results.html#cb89-28" tabindex="-1"></a></span>
<span id="cb89-29"><a href="empirical-results.html#cb89-29" tabindex="-1"></a><span class="fu">ggplot</span>(svm.fit) <span class="sc">+</span></span>
<span id="cb89-30"><a href="empirical-results.html#cb89-30" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb89-31"><a href="empirical-results.html#cb89-31" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Support Vector Machine with elastic net regularization&quot;</span>,</span>
<span id="cb89-32"><a href="empirical-results.html#cb89-32" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Degree of kernel vs. F1-score&quot;</span>,</span>
<span id="cb89-33"><a href="empirical-results.html#cb89-33" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Degree of kernel&quot;</span>,</span>
<span id="cb89-34"><a href="empirical-results.html#cb89-34" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;F1-score (repeated cross-validation)&quot;</span></span>
<span id="cb89-35"><a href="empirical-results.html#cb89-35" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/model.svm.fit-1.png" width="672" /></p>
<p><strong>Model information and evaluation on training set</strong></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="empirical-results.html#cb90-1" tabindex="-1"></a>svm.bestTune.mccf1 <span class="ot">&lt;-</span> svm.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb90-2"><a href="empirical-results.html#cb90-2" tabindex="-1"></a>  <span class="fu">group_by</span>(degree, scale, C) <span class="sc">%&gt;%</span></span>
<span id="cb90-3"><a href="empirical-results.html#cb90-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mccf1 =</span> <span class="fu">mean</span>(mcc.mccf1), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-4"><a href="empirical-results.html#cb90-4" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(mccf1))</span>
<span id="cb90-5"><a href="empirical-results.html#cb90-5" tabindex="-1"></a></span>
<span id="cb90-6"><a href="empirical-results.html#cb90-6" tabindex="-1"></a>svm.bestTune.roc <span class="ot">&lt;-</span> svm.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb90-7"><a href="empirical-results.html#cb90-7" tabindex="-1"></a>  <span class="fu">group_by</span>(degree, scale, C) <span class="sc">%&gt;%</span></span>
<span id="cb90-8"><a href="empirical-results.html#cb90-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">auc =</span> <span class="fu">mean</span>(auc.roc), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-9"><a href="empirical-results.html#cb90-9" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(auc))</span>
<span id="cb90-10"><a href="empirical-results.html#cb90-10" tabindex="-1"></a></span>
<span id="cb90-11"><a href="empirical-results.html#cb90-11" tabindex="-1"></a><span class="co"># Hyperparameters of best models for MCC-F1 and ROC cutpoints</span></span>
<span id="cb90-12"><a href="empirical-results.html#cb90-12" tabindex="-1"></a>hyperparameters.table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb90-13"><a href="empirical-results.html#cb90-13" tabindex="-1"></a>  <span class="at">cutpoint =</span> <span class="fu">c</span>(<span class="st">&quot;MCCF1&quot;</span>, <span class="st">&quot;ROC&quot;</span>),</span>
<span id="cb90-14"><a href="empirical-results.html#cb90-14" tabindex="-1"></a>  <span class="at">degree =</span> <span class="fu">c</span>(svm.bestTune.mccf1<span class="sc">$</span>degree, svm.bestTune.roc<span class="sc">$</span>degree),</span>
<span id="cb90-15"><a href="empirical-results.html#cb90-15" tabindex="-1"></a>  <span class="at">scale =</span> <span class="fu">c</span>(svm.bestTune.mccf1<span class="sc">$</span>scale, svm.bestTune.roc<span class="sc">$</span>scale),</span>
<span id="cb90-16"><a href="empirical-results.html#cb90-16" tabindex="-1"></a>  <span class="at">C =</span> <span class="fu">c</span>(svm.bestTune.mccf1<span class="sc">$</span>C, svm.bestTune.roc<span class="sc">$</span>C)</span>
<span id="cb90-17"><a href="empirical-results.html#cb90-17" tabindex="-1"></a>)</span>
<span id="cb90-18"><a href="empirical-results.html#cb90-18" tabindex="-1"></a></span>
<span id="cb90-19"><a href="empirical-results.html#cb90-19" tabindex="-1"></a>pred.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(svm.fit, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb90-20"><a href="empirical-results.html#cb90-20" tabindex="-1"></a>svm.metrics <span class="ot">&lt;-</span> <span class="fu">illustrate.metrics</span>(hyperparameters.table, data.training<span class="sc">$</span>response, pred.probability<span class="sc">$</span>delisted)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.svm.best_model-1.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.1792 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.svm.best_model-2.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.1877 maximizes MCCF1 metric.&quot;</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="empirical-results.html#cb93-1" tabindex="-1"></a><span class="fu">illustrate.metrics.boxplot</span>(svm.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(degree <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>degree[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb93-2"><a href="empirical-results.html#cb93-2" tabindex="-1"></a>                                                      scale <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>scale[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb93-3"><a href="empirical-results.html#cb93-3" tabindex="-1"></a>                                                      C <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>C[<span class="dv">1</span>]),</span>
<span id="cb93-4"><a href="empirical-results.html#cb93-4" tabindex="-1"></a>                           svm.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(degree <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>degree[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb93-5"><a href="empirical-results.html#cb93-5" tabindex="-1"></a>                                                      scale <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>scale[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb93-6"><a href="empirical-results.html#cb93-6" tabindex="-1"></a>                                                      C <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>C[<span class="dv">2</span>]),</span>
<span id="cb93-7"><a href="empirical-results.html#cb93-7" tabindex="-1"></a>                           <span class="st">&quot;svm&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.svm.best_model-3.png" width="672" /></p>
<p><strong>Performance evaluation on test set</strong></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="empirical-results.html#cb94-1" tabindex="-1"></a><span class="co"># MCCF1 variant: prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb94-2"><a href="empirical-results.html#cb94-2" tabindex="-1"></a>pred.test.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(svm.fit, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb94-3"><a href="empirical-results.html#cb94-3" tabindex="-1"></a></span>
<span id="cb94-4"><a href="empirical-results.html#cb94-4" tabindex="-1"></a><span class="co"># ROC variant: fit model using best hyperparameters and </span></span>
<span id="cb94-5"><a href="empirical-results.html#cb94-5" tabindex="-1"></a><span class="co">#              find best threshold and</span></span>
<span id="cb94-6"><a href="empirical-results.html#cb94-6" tabindex="-1"></a><span class="co">#              prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb94-7"><a href="empirical-results.html#cb94-7" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb94-8"><a href="empirical-results.html#cb94-8" tabindex="-1"></a>svm.fit.roc <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date),</span>
<span id="cb94-9"><a href="empirical-results.html#cb94-9" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb94-10"><a href="empirical-results.html#cb94-10" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;svmPoly&quot;</span>,</span>
<span id="cb94-11"><a href="empirical-results.html#cb94-11" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb94-12"><a href="empirical-results.html#cb94-12" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="at">summaryFunction =</span> compute.summary), </span>
<span id="cb94-13"><a href="empirical-results.html#cb94-13" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(</span>
<span id="cb94-14"><a href="empirical-results.html#cb94-14" tabindex="-1"></a>                     <span class="at">degree =</span> svm.bestTune.roc<span class="sc">$</span>degree,</span>
<span id="cb94-15"><a href="empirical-results.html#cb94-15" tabindex="-1"></a>                     <span class="at">scale =</span> svm.bestTune.roc<span class="sc">$</span>scale,</span>
<span id="cb94-16"><a href="empirical-results.html#cb94-16" tabindex="-1"></a>                     <span class="at">C =</span> svm.bestTune.roc<span class="sc">$</span>C</span>
<span id="cb94-17"><a href="empirical-results.html#cb94-17" tabindex="-1"></a>                   ),</span>
<span id="cb94-18"><a href="empirical-results.html#cb94-18" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb94-19"><a href="empirical-results.html#cb94-19" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;auc.roc&quot;</span>) <span class="co"># specify which metric to optimize</span></span>
<span id="cb94-20"><a href="empirical-results.html#cb94-20" tabindex="-1"></a>svm.metrics.roc.cutpoint <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(</span>
<span id="cb94-21"><a href="empirical-results.html#cb94-21" tabindex="-1"></a>  <span class="fu">predict</span>(svm.fit.roc, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted,</span>
<span id="cb94-22"><a href="empirical-results.html#cb94-22" tabindex="-1"></a>  data.training<span class="sc">$</span>response)<span class="sc">$</span>best_cutpoint</span>
<span id="cb94-23"><a href="empirical-results.html#cb94-23" tabindex="-1"></a>pred.test.probability.roc <span class="ot">&lt;-</span> <span class="fu">predict</span>(svm.fit.roc, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb94-24"><a href="empirical-results.html#cb94-24" tabindex="-1"></a></span>
<span id="cb94-25"><a href="empirical-results.html#cb94-25" tabindex="-1"></a><span class="co"># metrics on test set using best threshold determined based on train data</span></span>
<span id="cb94-26"><a href="empirical-results.html#cb94-26" tabindex="-1"></a>svm.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability.roc<span class="sc">$</span>delisted <span class="sc">&gt;=</span> svm.metrics.roc.cutpoint),</span>
<span id="cb94-27"><a href="empirical-results.html#cb94-27" tabindex="-1"></a>      <span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted <span class="sc">&gt;=</span> svm.metrics<span class="sc">$</span>cutpoint.mccf1)) <span class="sc">%&gt;%</span></span>
<span id="cb94-28"><a href="empirical-results.html#cb94-28" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">splitting =</span> <span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), .)</span>
<span id="cb94-29"><a href="empirical-results.html#cb94-29" tabindex="-1"></a><span class="fu">pander</span>(svm.summary.test, <span class="at">caption =</span> <span class="st">&quot;Support Vector Machine on test data&quot;</span>)</span></code></pre></div>
<table>
<caption>Support Vector Machine on test data (continued below)</caption>
<colgroup>
<col width="15%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="8%" />
<col width="14%" />
<col width="15%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">splitting</th>
<th align="center">tp</th>
<th align="center">fn</th>
<th align="center">fp</th>
<th align="center">tn</th>
<th align="center">accuracy</th>
<th align="center">precision</th>
<th align="center">recall</th>
<th align="center">f1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ROC</td>
<td align="center">313</td>
<td align="center">123</td>
<td align="center">532</td>
<td align="center">1250</td>
<td align="center">0.7047</td>
<td align="center">0.3704</td>
<td align="center">0.7179</td>
<td align="center">0.4887</td>
</tr>
<tr class="even">
<td align="center">MCCF1</td>
<td align="center">262</td>
<td align="center">174</td>
<td align="center">354</td>
<td align="center">1428</td>
<td align="center">0.7619</td>
<td align="center">0.4253</td>
<td align="center">0.6009</td>
<td align="center">0.4981</td>
</tr>
</tbody>
</table>
<table style="width:32%;">
<colgroup>
<col width="19%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">specificity</th>
<th align="center">mcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.7015</td>
<td align="center">0.3432</td>
</tr>
<tr class="even">
<td align="center">0.8013</td>
<td align="center">0.3569</td>
</tr>
</tbody>
</table>
<!-- no variable importance measure available -->
<p><strong>Marginal plots</strong></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="empirical-results.html#cb95-1" tabindex="-1"></a><span class="co"># marginal plots of features in com.features.fin on test data</span></span>
<span id="cb95-2"><a href="empirical-results.html#cb95-2" tabindex="-1"></a><span class="cf">for</span> (feature_identifier <span class="cf">in</span> com.features.fin<span class="sc">$</span>identifier) {</span>
<span id="cb95-3"><a href="empirical-results.html#cb95-3" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb95-4"><a href="empirical-results.html#cb95-4" tabindex="-1"></a>      (data.test <span class="sc">%&gt;%</span> </span>
<span id="cb95-5"><a href="empirical-results.html#cb95-5" tabindex="-1"></a>        <span class="fu">inner_join</span>(com <span class="sc">%&gt;%</span> <span class="fu">select</span>(permno, public_date, years_to_delisting), <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date))),</span>
<span id="cb95-6"><a href="empirical-results.html#cb95-6" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb95-7"><a href="empirical-results.html#cb95-7" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb95-8"><a href="empirical-results.html#cb95-8" tabindex="-1"></a>      <span class="at">marginal.data =</span> pred.test.probability<span class="sc">$</span>delisted</span>
<span id="cb95-9"><a href="empirical-results.html#cb95-9" tabindex="-1"></a>  )</span>
<span id="cb95-10"><a href="empirical-results.html#cb95-10" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb95-11"><a href="empirical-results.html#cb95-11" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/model.svm.marginal-1.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-2.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-3.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-4.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-5.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-6.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-7.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-8.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-9.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-10.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-11.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-12.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-13.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-14.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-15.png" width="672" /><img src="_main_files/figure-html/model.svm.marginal-16.png" width="672" /></p>

</div>
<div id="neural-net" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Neural net<a href="empirical-results.html#neural-net" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="empirical-results.html#cb96-1" tabindex="-1"></a><span class="co"># function and object definitions for custom model in caret package</span></span>
<span id="cb96-2"><a href="empirical-results.html#cb96-2" tabindex="-1"></a><span class="co"># https://topepo.github.io/caret/using-your-own-model-in-train.html</span></span>
<span id="cb96-3"><a href="empirical-results.html#cb96-3" tabindex="-1"></a></span>
<span id="cb96-4"><a href="empirical-results.html#cb96-4" tabindex="-1"></a>preProcValues <span class="ot">&lt;-</span> <span class="fu">preProcess</span>(data.training, <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>))</span>
<span id="cb96-5"><a href="empirical-results.html#cb96-5" tabindex="-1"></a></span>
<span id="cb96-6"><a href="empirical-results.html#cb96-6" tabindex="-1"></a><span class="co"># adjusted from https://github.com/topepo/caret/blob/master/models/files/mlpKerasDropout.R</span></span>
<span id="cb96-7"><a href="empirical-results.html#cb96-7" tabindex="-1"></a>keras.list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">&quot;Multilayer Perceptron Network&quot;</span>,</span>
<span id="cb96-8"><a href="empirical-results.html#cb96-8" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">&quot;keras&quot;</span>,</span>
<span id="cb96-9"><a href="empirical-results.html#cb96-9" tabindex="-1"></a>                  <span class="at">library =</span> <span class="st">&quot;keras&quot;</span>,</span>
<span id="cb96-10"><a href="empirical-results.html#cb96-10" tabindex="-1"></a>                  <span class="at">loop =</span> <span class="cn">NULL</span>,</span>
<span id="cb96-11"><a href="empirical-results.html#cb96-11" tabindex="-1"></a>                  <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;Classification&quot;</span>, <span class="st">&quot;Regression&quot;</span>),</span>
<span id="cb96-12"><a href="empirical-results.html#cb96-12" tabindex="-1"></a>                  <span class="at">parameters =</span> <span class="fu">data.frame</span>(</span>
<span id="cb96-13"><a href="empirical-results.html#cb96-13" tabindex="-1"></a>                    <span class="at">parameter =</span> <span class="fu">c</span>(<span class="st">&#39;layer1&#39;</span>, <span class="st">&#39;layer2&#39;</span>, <span class="st">&quot;layer3&quot;</span>, </span>
<span id="cb96-14"><a href="empirical-results.html#cb96-14" tabindex="-1"></a>                                  <span class="st">&quot;batch_size&quot;</span>,<span class="st">&quot;activation&quot;</span>, <span class="st">&quot;regularization_factor&quot;</span>,</span>
<span id="cb96-15"><a href="empirical-results.html#cb96-15" tabindex="-1"></a>                                  <span class="st">&quot;dropout_rate&quot;</span>),</span>
<span id="cb96-16"><a href="empirical-results.html#cb96-16" tabindex="-1"></a>                    <span class="at">class =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&#39;numeric&#39;</span>, <span class="dv">4</span>), <span class="st">&quot;character&quot;</span>, <span class="fu">rep</span>(<span class="st">&quot;numeric&quot;</span>, <span class="dv">2</span>)),</span>
<span id="cb96-17"><a href="empirical-results.html#cb96-17" tabindex="-1"></a>                    <span class="at">label =</span> <span class="fu">c</span>(<span class="st">&quot;#units in hidden layer 1&quot;</span>,</span>
<span id="cb96-18"><a href="empirical-results.html#cb96-18" tabindex="-1"></a>                              <span class="st">&quot;#units in hidden layer 2&quot;</span>,</span>
<span id="cb96-19"><a href="empirical-results.html#cb96-19" tabindex="-1"></a>                              <span class="st">&quot;#units in hidden layer 3&quot;</span>,</span>
<span id="cb96-20"><a href="empirical-results.html#cb96-20" tabindex="-1"></a>                              <span class="st">&quot;batch size&quot;</span>, <span class="st">&quot;activation Function&quot;</span>,</span>
<span id="cb96-21"><a href="empirical-results.html#cb96-21" tabindex="-1"></a>                              <span class="st">&quot;regularization factor&quot;</span>, <span class="st">&quot;dropout rate&quot;</span>)</span>
<span id="cb96-22"><a href="empirical-results.html#cb96-22" tabindex="-1"></a>                  ),</span>
<span id="cb96-23"><a href="empirical-results.html#cb96-23" tabindex="-1"></a>                  <span class="at">grid =</span> <span class="cf">function</span>(x, y, <span class="at">len =</span> <span class="cn">NULL</span>, <span class="at">search =</span> <span class="st">&quot;grid&quot;</span>) {</span>
<span id="cb96-24"><a href="empirical-results.html#cb96-24" tabindex="-1"></a>                    afuncs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sigmoid&quot;</span>, <span class="st">&quot;relu&quot;</span>, <span class="st">&quot;tanh&quot;</span>)</span>
<span id="cb96-25"><a href="empirical-results.html#cb96-25" tabindex="-1"></a>                    <span class="cf">if</span>(search <span class="sc">==</span> <span class="st">&quot;grid&quot;</span>) {</span>
<span id="cb96-26"><a href="empirical-results.html#cb96-26" tabindex="-1"></a>                      out <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb96-27"><a href="empirical-results.html#cb96-27" tabindex="-1"></a>                        <span class="at">layer1 =</span> ((<span class="dv">1</span><span class="sc">:</span>len) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb96-28"><a href="empirical-results.html#cb96-28" tabindex="-1"></a>                        <span class="at">layer2 =</span> ((<span class="dv">1</span><span class="sc">:</span>len) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb96-29"><a href="empirical-results.html#cb96-29" tabindex="-1"></a>                        <span class="at">layer3 =</span> ((<span class="dv">1</span><span class="sc">:</span>len) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb96-30"><a href="empirical-results.html#cb96-30" tabindex="-1"></a>                        <span class="at">batch_size =</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(x)<span class="sc">/</span><span class="dv">3</span>),</span>
<span id="cb96-31"><a href="empirical-results.html#cb96-31" tabindex="-1"></a>                        <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>,</span>
<span id="cb96-32"><a href="empirical-results.html#cb96-32" tabindex="-1"></a>                        <span class="at">regularization_factor =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.001</span>),</span>
<span id="cb96-33"><a href="empirical-results.html#cb96-33" tabindex="-1"></a>                        <span class="at">dropout_rate =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.2</span>)</span>
<span id="cb96-34"><a href="empirical-results.html#cb96-34" tabindex="-1"></a>                      )</span>
<span id="cb96-35"><a href="empirical-results.html#cb96-35" tabindex="-1"></a>                    } <span class="cf">else</span> {</span>
<span id="cb96-36"><a href="empirical-results.html#cb96-36" tabindex="-1"></a>                      n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb96-37"><a href="empirical-results.html#cb96-37" tabindex="-1"></a>                      out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb96-38"><a href="empirical-results.html#cb96-38" tabindex="-1"></a>                        <span class="at">layer1 =</span> <span class="fu">sample</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> len),</span>
<span id="cb96-39"><a href="empirical-results.html#cb96-39" tabindex="-1"></a>                        <span class="at">layer2 =</span> <span class="fu">sample</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> len),</span>
<span id="cb96-40"><a href="empirical-results.html#cb96-40" tabindex="-1"></a>                        <span class="at">layer3 =</span> <span class="fu">sample</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> len),</span>
<span id="cb96-41"><a href="empirical-results.html#cb96-41" tabindex="-1"></a>                        <span class="at">batch_size =</span> <span class="fu">floor</span>(n<span class="sc">*</span><span class="fu">runif</span>(len, <span class="at">min =</span> .<span class="dv">1</span>)),</span>
<span id="cb96-42"><a href="empirical-results.html#cb96-42" tabindex="-1"></a>                        <span class="at">activation =</span> <span class="fu">sample</span>(</span>
<span id="cb96-43"><a href="empirical-results.html#cb96-43" tabindex="-1"></a>                          afuncs, </span>
<span id="cb96-44"><a href="empirical-results.html#cb96-44" tabindex="-1"></a>                          <span class="at">size =</span> len, </span>
<span id="cb96-45"><a href="empirical-results.html#cb96-45" tabindex="-1"></a>                          <span class="at">replace =</span> <span class="cn">TRUE</span></span>
<span id="cb96-46"><a href="empirical-results.html#cb96-46" tabindex="-1"></a>                        ),</span>
<span id="cb96-47"><a href="empirical-results.html#cb96-47" tabindex="-1"></a>                        <span class="at">regularization_factor =</span> <span class="fl">0.01</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="dv">1</span><span class="sc">:</span>len),</span>
<span id="cb96-48"><a href="empirical-results.html#cb96-48" tabindex="-1"></a>                        <span class="at">dropout_rate =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="at">length.out =</span> len)</span>
<span id="cb96-49"><a href="empirical-results.html#cb96-49" tabindex="-1"></a>                      )</span>
<span id="cb96-50"><a href="empirical-results.html#cb96-50" tabindex="-1"></a>                    }</span>
<span id="cb96-51"><a href="empirical-results.html#cb96-51" tabindex="-1"></a>                    out</span>
<span id="cb96-52"><a href="empirical-results.html#cb96-52" tabindex="-1"></a>                  },</span>
<span id="cb96-53"><a href="empirical-results.html#cb96-53" tabindex="-1"></a>                  <span class="at">fit =</span> <span class="cf">function</span>(x, y, wts, param, lev, last, classProbs, ...) {</span>
<span id="cb96-54"><a href="empirical-results.html#cb96-54" tabindex="-1"></a>                    <span class="fu">require</span>(dplyr)</span>
<span id="cb96-55"><a href="empirical-results.html#cb96-55" tabindex="-1"></a>                    K <span class="ot">&lt;-</span> keras<span class="sc">::</span><span class="fu">backend</span>()</span>
<span id="cb96-56"><a href="empirical-results.html#cb96-56" tabindex="-1"></a>                    K<span class="sc">$</span><span class="fu">clear_session</span>()</span>
<span id="cb96-57"><a href="empirical-results.html#cb96-57" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(x)) x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x)</span>
<span id="cb96-58"><a href="empirical-results.html#cb96-58" tabindex="-1"></a>                    model <span class="ot">&lt;-</span> keras<span class="sc">::</span><span class="fu">keras_model_sequential</span>()</span>
<span id="cb96-59"><a href="empirical-results.html#cb96-59" tabindex="-1"></a>                    model <span class="sc">%&gt;%</span></span>
<span id="cb96-60"><a href="empirical-results.html#cb96-60" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dense</span>(<span class="at">name =</span> <span class="st">&quot;DeepLayer1&quot;</span>,</span>
<span id="cb96-61"><a href="empirical-results.html#cb96-61" tabindex="-1"></a>                                  <span class="at">units =</span> param<span class="sc">$</span>layer1,</span>
<span id="cb96-62"><a href="empirical-results.html#cb96-62" tabindex="-1"></a>                                  <span class="at">activation =</span> <span class="fu">as.character</span>(param<span class="sc">$</span>activation),</span>
<span id="cb96-63"><a href="empirical-results.html#cb96-63" tabindex="-1"></a>                                  <span class="at">input_shape =</span> <span class="fu">dim</span>(x)[<span class="dv">2</span>],</span>
<span id="cb96-64"><a href="empirical-results.html#cb96-64" tabindex="-1"></a>                                  <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(param<span class="sc">$</span>regularization_factor)) <span class="sc">%&gt;%</span>  </span>
<span id="cb96-65"><a href="empirical-results.html#cb96-65" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dropout</span>(</span>
<span id="cb96-66"><a href="empirical-results.html#cb96-66" tabindex="-1"></a>                        <span class="at">rate =</span> param<span class="sc">$</span>dropout_rate</span>
<span id="cb96-67"><a href="empirical-results.html#cb96-67" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb96-68"><a href="empirical-results.html#cb96-68" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dense</span>(<span class="at">name =</span> <span class="st">&quot;DeepLayer2&quot;</span>,</span>
<span id="cb96-69"><a href="empirical-results.html#cb96-69" tabindex="-1"></a>                                  <span class="at">units =</span> param<span class="sc">$</span>layer2,</span>
<span id="cb96-70"><a href="empirical-results.html#cb96-70" tabindex="-1"></a>                                  <span class="at">activation =</span> <span class="fu">as.character</span>(param<span class="sc">$</span>activation),</span>
<span id="cb96-71"><a href="empirical-results.html#cb96-71" tabindex="-1"></a>                                  <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(param<span class="sc">$</span>regularization_factor)) <span class="sc">%&gt;%</span> </span>
<span id="cb96-72"><a href="empirical-results.html#cb96-72" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dropout</span>(</span>
<span id="cb96-73"><a href="empirical-results.html#cb96-73" tabindex="-1"></a>                        <span class="at">rate =</span> param<span class="sc">$</span>dropout_rate</span>
<span id="cb96-74"><a href="empirical-results.html#cb96-74" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb96-75"><a href="empirical-results.html#cb96-75" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dense</span>(<span class="at">name =</span> <span class="st">&quot;DeepLayer3&quot;</span>,</span>
<span id="cb96-76"><a href="empirical-results.html#cb96-76" tabindex="-1"></a>                                  <span class="at">units =</span> param<span class="sc">$</span>layer3,</span>
<span id="cb96-77"><a href="empirical-results.html#cb96-77" tabindex="-1"></a>                                  <span class="at">activation =</span> <span class="fu">as.character</span>(param<span class="sc">$</span>activation),</span>
<span id="cb96-78"><a href="empirical-results.html#cb96-78" tabindex="-1"></a>                                  <span class="at">kernel_regularizer =</span> <span class="fu">regularizer_l2</span>(param<span class="sc">$</span>regularization_factor)) <span class="sc">%&gt;%</span> </span>
<span id="cb96-79"><a href="empirical-results.html#cb96-79" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dropout</span>(</span>
<span id="cb96-80"><a href="empirical-results.html#cb96-80" tabindex="-1"></a>                        <span class="at">rate =</span> param<span class="sc">$</span>dropout_rate</span>
<span id="cb96-81"><a href="empirical-results.html#cb96-81" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb96-82"><a href="empirical-results.html#cb96-82" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">layer_dense</span>(<span class="at">name =</span> <span class="st">&quot;OutputLayer&quot;</span>,</span>
<span id="cb96-83"><a href="empirical-results.html#cb96-83" tabindex="-1"></a>                                  <span class="at">units =</span> <span class="dv">1</span>,</span>
<span id="cb96-84"><a href="empirical-results.html#cb96-84" tabindex="-1"></a>                                  <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb96-85"><a href="empirical-results.html#cb96-85" tabindex="-1"></a></span>
<span id="cb96-86"><a href="empirical-results.html#cb96-86" tabindex="-1"></a>                    y <span class="ot">&lt;-</span> <span class="fu">class2ind</span>(y)</span>
<span id="cb96-87"><a href="empirical-results.html#cb96-87" tabindex="-1"></a>                    </span>
<span id="cb96-88"><a href="empirical-results.html#cb96-88" tabindex="-1"></a>                    model <span class="sc">%&gt;%</span></span>
<span id="cb96-89"><a href="empirical-results.html#cb96-89" tabindex="-1"></a>                      keras<span class="sc">::</span><span class="fu">compile</span>(</span>
<span id="cb96-90"><a href="empirical-results.html#cb96-90" tabindex="-1"></a>                        <span class="at">loss =</span> <span class="st">&quot;binary_crossentropy&quot;</span>,</span>
<span id="cb96-91"><a href="empirical-results.html#cb96-91" tabindex="-1"></a>                        <span class="at">optimizer =</span> <span class="st">&quot;adam&quot;</span>, <span class="co"># https://arxiv.org/abs/1412.6980v8</span></span>
<span id="cb96-92"><a href="empirical-results.html#cb96-92" tabindex="-1"></a>                        <span class="at">metric =</span> <span class="st">&quot;binary_accuracy&quot;</span></span>
<span id="cb96-93"><a href="empirical-results.html#cb96-93" tabindex="-1"></a>                      )</span>
<span id="cb96-94"><a href="empirical-results.html#cb96-94" tabindex="-1"></a>                    model <span class="sc">%&gt;%</span> keras<span class="sc">::</span><span class="fu">fit</span>(</span>
<span id="cb96-95"><a href="empirical-results.html#cb96-95" tabindex="-1"></a>                      <span class="at">x =</span> x, </span>
<span id="cb96-96"><a href="empirical-results.html#cb96-96" tabindex="-1"></a>                      <span class="at">y =</span> y[,<span class="dv">2</span>],</span>
<span id="cb96-97"><a href="empirical-results.html#cb96-97" tabindex="-1"></a>                      <span class="at">batch_size =</span> param<span class="sc">$</span>batch_size,</span>
<span id="cb96-98"><a href="empirical-results.html#cb96-98" tabindex="-1"></a>                      <span class="at">epochs =</span> <span class="dv">100</span>,</span>
<span id="cb96-99"><a href="empirical-results.html#cb96-99" tabindex="-1"></a>                      ...</span>
<span id="cb96-100"><a href="empirical-results.html#cb96-100" tabindex="-1"></a>                    )</span>
<span id="cb96-101"><a href="empirical-results.html#cb96-101" tabindex="-1"></a>                    </span>
<span id="cb96-102"><a href="empirical-results.html#cb96-102" tabindex="-1"></a>                    <span class="cf">if</span> (last) {</span>
<span id="cb96-103"><a href="empirical-results.html#cb96-103" tabindex="-1"></a>                      model <span class="ot">&lt;-</span> keras<span class="sc">::</span><span class="fu">serialize_model</span>(model)</span>
<span id="cb96-104"><a href="empirical-results.html#cb96-104" tabindex="-1"></a>                    }</span>
<span id="cb96-105"><a href="empirical-results.html#cb96-105" tabindex="-1"></a>                    </span>
<span id="cb96-106"><a href="empirical-results.html#cb96-106" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">object =</span> model)</span>
<span id="cb96-107"><a href="empirical-results.html#cb96-107" tabindex="-1"></a>                  },</span>
<span id="cb96-108"><a href="empirical-results.html#cb96-108" tabindex="-1"></a>                  <span class="at">predict =</span> <span class="cf">function</span>(modelFit, newdata, <span class="at">submodels =</span> <span class="cn">NULL</span>) {</span>
<span id="cb96-109"><a href="empirical-results.html#cb96-109" tabindex="-1"></a></span>
<span id="cb96-110"><a href="empirical-results.html#cb96-110" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">inherits</span>(modelFit<span class="sc">$</span>object, <span class="st">&quot;raw&quot;</span>))</span>
<span id="cb96-111"><a href="empirical-results.html#cb96-111" tabindex="-1"></a>                      modelFit<span class="sc">$</span>object <span class="ot">&lt;-</span> keras<span class="sc">::</span><span class="fu">unserialize_model</span>(modelFit<span class="sc">$</span>object)</span>
<span id="cb96-112"><a href="empirical-results.html#cb96-112" tabindex="-1"></a>                    </span>
<span id="cb96-113"><a href="empirical-results.html#cb96-113" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(newdata)) </span>
<span id="cb96-114"><a href="empirical-results.html#cb96-114" tabindex="-1"></a>                      newdata <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(newdata)</span>
<span id="cb96-115"><a href="empirical-results.html#cb96-115" tabindex="-1"></a>                    </span>
<span id="cb96-116"><a href="empirical-results.html#cb96-116" tabindex="-1"></a>                    out <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelFit<span class="sc">$</span>object, newdata)</span>
<span id="cb96-117"><a href="empirical-results.html#cb96-117" tabindex="-1"></a>                    <span class="co"># check for model type</span></span>
<span id="cb96-118"><a href="empirical-results.html#cb96-118" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">ncol</span>(out) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb96-119"><a href="empirical-results.html#cb96-119" tabindex="-1"></a>                      out <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;active&quot;</span>,<span class="fu">length</span>(out))<span class="co">#cbind(1-out[, 1], out[,1])</span></span>
<span id="cb96-120"><a href="empirical-results.html#cb96-120" tabindex="-1"></a>                    } <span class="cf">else</span> {</span>
<span id="cb96-121"><a href="empirical-results.html#cb96-121" tabindex="-1"></a>                      out <span class="ot">&lt;-</span> modelFit<span class="sc">$</span>obsLevels[<span class="fu">apply</span>(out, <span class="dv">1</span>, which.max)]</span>
<span id="cb96-122"><a href="empirical-results.html#cb96-122" tabindex="-1"></a>                    }</span>
<span id="cb96-123"><a href="empirical-results.html#cb96-123" tabindex="-1"></a></span>
<span id="cb96-124"><a href="empirical-results.html#cb96-124" tabindex="-1"></a>                    out</span>
<span id="cb96-125"><a href="empirical-results.html#cb96-125" tabindex="-1"></a>                  },</span>
<span id="cb96-126"><a href="empirical-results.html#cb96-126" tabindex="-1"></a>                  <span class="at">prob =</span>  <span class="cf">function</span>(modelFit, newdata, <span class="at">submodels =</span> <span class="cn">NULL</span>) {</span>
<span id="cb96-127"><a href="empirical-results.html#cb96-127" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">inherits</span>(modelFit<span class="sc">$</span>object, <span class="st">&quot;raw&quot;</span>))</span>
<span id="cb96-128"><a href="empirical-results.html#cb96-128" tabindex="-1"></a>                      modelFit<span class="sc">$</span>object <span class="ot">&lt;-</span> keras<span class="sc">::</span><span class="fu">unserialize_model</span>(modelFit<span class="sc">$</span>object)</span>
<span id="cb96-129"><a href="empirical-results.html#cb96-129" tabindex="-1"></a>                    </span>
<span id="cb96-130"><a href="empirical-results.html#cb96-130" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(newdata)) </span>
<span id="cb96-131"><a href="empirical-results.html#cb96-131" tabindex="-1"></a>                      newdata <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(newdata)</span>
<span id="cb96-132"><a href="empirical-results.html#cb96-132" tabindex="-1"></a></span>
<span id="cb96-133"><a href="empirical-results.html#cb96-133" tabindex="-1"></a>                    out <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelFit<span class="sc">$</span>object, newdata)</span>
<span id="cb96-134"><a href="empirical-results.html#cb96-134" tabindex="-1"></a>                    out <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span><span class="sc">-</span>out, out)</span>
<span id="cb96-135"><a href="empirical-results.html#cb96-135" tabindex="-1"></a>                    <span class="fu">colnames</span>(out) <span class="ot">&lt;-</span> modelFit<span class="sc">$</span>obsLevels</span>
<span id="cb96-136"><a href="empirical-results.html#cb96-136" tabindex="-1"></a>                    <span class="fu">as.data.frame</span>(out, <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-137"><a href="empirical-results.html#cb96-137" tabindex="-1"></a>                  },</span>
<span id="cb96-138"><a href="empirical-results.html#cb96-138" tabindex="-1"></a>                  <span class="at">varImp =</span> <span class="cn">NULL</span>,</span>
<span id="cb96-139"><a href="empirical-results.html#cb96-139" tabindex="-1"></a>                  <span class="at">tags =</span> <span class="fu">c</span>(<span class="st">&quot;Neural Network&quot;</span>),</span>
<span id="cb96-140"><a href="empirical-results.html#cb96-140" tabindex="-1"></a>                  <span class="at">sort =</span> <span class="cf">function</span>(x) x,</span>
<span id="cb96-141"><a href="empirical-results.html#cb96-141" tabindex="-1"></a>                  <span class="at">notes =</span> <span class="fu">paste</span>(<span class="st">&quot;After `train` completes, the keras model object is serialized&quot;</span>,</span>
<span id="cb96-142"><a href="empirical-results.html#cb96-142" tabindex="-1"></a>                                <span class="st">&quot;so that it can be used between R session. When predicting, the&quot;</span>, </span>
<span id="cb96-143"><a href="empirical-results.html#cb96-143" tabindex="-1"></a>                                <span class="st">&quot;code will temporarily unsearalize the object. To make the&quot;</span>, </span>
<span id="cb96-144"><a href="empirical-results.html#cb96-144" tabindex="-1"></a>                                <span class="st">&quot;predictions more efficient, the user might want to use &quot;</span>, </span>
<span id="cb96-145"><a href="empirical-results.html#cb96-145" tabindex="-1"></a>                                <span class="st">&quot;`keras::unsearlize_model(object$finalModel$object)` in the current&quot;</span>, </span>
<span id="cb96-146"><a href="empirical-results.html#cb96-146" tabindex="-1"></a>                                <span class="st">&quot;R session so that that operation is only done once.&quot;</span>,</span>
<span id="cb96-147"><a href="empirical-results.html#cb96-147" tabindex="-1"></a>                                <span class="st">&quot;Also, this model cannot be run in parallel due to&quot;</span>,</span>
<span id="cb96-148"><a href="empirical-results.html#cb96-148" tabindex="-1"></a>                                <span class="st">&quot;the nature of how tensorflow does the computations.&quot;</span>,</span>
<span id="cb96-149"><a href="empirical-results.html#cb96-149" tabindex="-1"></a>                                <span class="st">&quot;Finally, the cost parameter weights the first&quot;</span>,</span>
<span id="cb96-150"><a href="empirical-results.html#cb96-150" tabindex="-1"></a>                                <span class="st">&quot;class in the outcome vector.&quot;</span>,</span>
<span id="cb96-151"><a href="empirical-results.html#cb96-151" tabindex="-1"></a>                                <span class="st">&quot;Unlike other packages used by `train`, the `dplyr`&quot;</span>,</span>
<span id="cb96-152"><a href="empirical-results.html#cb96-152" tabindex="-1"></a>                                <span class="st">&quot;package is fully loaded when this model is used.&quot;</span>),</span>
<span id="cb96-153"><a href="empirical-results.html#cb96-153" tabindex="-1"></a>                  <span class="at">check =</span> <span class="cf">function</span>(pkg) {</span>
<span id="cb96-154"><a href="empirical-results.html#cb96-154" tabindex="-1"></a>                    testmod <span class="ot">&lt;-</span> <span class="fu">try</span>(keras<span class="sc">::</span><span class="fu">keras_model_sequential</span>(),</span>
<span id="cb96-155"><a href="empirical-results.html#cb96-155" tabindex="-1"></a>                                   <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb96-156"><a href="empirical-results.html#cb96-156" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">inherits</span>(testmod, <span class="st">&quot;try-error&quot;</span>))</span>
<span id="cb96-157"><a href="empirical-results.html#cb96-157" tabindex="-1"></a>                      <span class="fu">stop</span>(<span class="st">&quot;Could not start a sequential model. &quot;</span>,</span>
<span id="cb96-158"><a href="empirical-results.html#cb96-158" tabindex="-1"></a>                           <span class="st">&quot;`tensorflow` might not be installed. &quot;</span>,</span>
<span id="cb96-159"><a href="empirical-results.html#cb96-159" tabindex="-1"></a>                           <span class="st">&quot;See `?install_tensorflow`.&quot;</span>, </span>
<span id="cb96-160"><a href="empirical-results.html#cb96-160" tabindex="-1"></a>                           <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb96-161"><a href="empirical-results.html#cb96-161" tabindex="-1"></a>                    <span class="cn">TRUE</span></span>
<span id="cb96-162"><a href="empirical-results.html#cb96-162" tabindex="-1"></a>                  })</span></code></pre></div>
<p><strong>Model fit</strong></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="empirical-results.html#cb97-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb97-2"><a href="empirical-results.html#cb97-2" tabindex="-1"></a>  <span class="do">### control the computational nuances of the train function ####################</span></span>
<span id="cb97-3"><a href="empirical-results.html#cb97-3" tabindex="-1"></a>  keras.fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>,</span>
<span id="cb97-4"><a href="empirical-results.html#cb97-4" tabindex="-1"></a>                             <span class="at">number =</span> <span class="dv">6</span>,</span>
<span id="cb97-5"><a href="empirical-results.html#cb97-5" tabindex="-1"></a>                             <span class="do">## Estimate class probabilities</span></span>
<span id="cb97-6"><a href="empirical-results.html#cb97-6" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb97-7"><a href="empirical-results.html#cb97-7" tabindex="-1"></a>                             <span class="co">#preProc = c(&quot;center&quot;, &quot;scaling&quot;),</span></span>
<span id="cb97-8"><a href="empirical-results.html#cb97-8" tabindex="-1"></a>                             <span class="do">## Evaluate performance using </span></span>
<span id="cb97-9"><a href="empirical-results.html#cb97-9" tabindex="-1"></a>                             <span class="do">## the following function</span></span>
<span id="cb97-10"><a href="empirical-results.html#cb97-10" tabindex="-1"></a>                             <span class="at">summaryFunction =</span> compute.summary,</span>
<span id="cb97-11"><a href="empirical-results.html#cb97-11" tabindex="-1"></a>                             <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span></span>
<span id="cb97-12"><a href="empirical-results.html#cb97-12" tabindex="-1"></a>                             )</span>
<span id="cb97-13"><a href="empirical-results.html#cb97-13" tabindex="-1"></a>  </span>
<span id="cb97-14"><a href="empirical-results.html#cb97-14" tabindex="-1"></a>  <span class="do">### fit model over different tuning parameters #################################</span></span>
<span id="cb97-15"><a href="empirical-results.html#cb97-15" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb97-16"><a href="empirical-results.html#cb97-16" tabindex="-1"></a>  keras.fit <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(<span class="at">y =</span> data.training<span class="sc">$</span>response,</span>
<span id="cb97-17"><a href="empirical-results.html#cb97-17" tabindex="-1"></a>                   <span class="at">x =</span> <span class="fu">as.matrix</span>(data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date, <span class="sc">-</span>response)), </span>
<span id="cb97-18"><a href="empirical-results.html#cb97-18" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb97-19"><a href="empirical-results.html#cb97-19" tabindex="-1"></a>                   <span class="at">method =</span> keras.list, </span>
<span id="cb97-20"><a href="empirical-results.html#cb97-20" tabindex="-1"></a>                   <span class="at">trControl =</span> keras.fitControl, </span>
<span id="cb97-21"><a href="empirical-results.html#cb97-21" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(</span>
<span id="cb97-22"><a href="empirical-results.html#cb97-22" tabindex="-1"></a>                     <span class="at">layer1 =</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">38</span>),</span>
<span id="cb97-23"><a href="empirical-results.html#cb97-23" tabindex="-1"></a>                     <span class="at">layer2 =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">25</span>),</span>
<span id="cb97-24"><a href="empirical-results.html#cb97-24" tabindex="-1"></a>                     <span class="at">layer3 =</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">18</span>),</span>
<span id="cb97-25"><a href="empirical-results.html#cb97-25" tabindex="-1"></a>                     <span class="at">batch_size =</span> <span class="fu">c</span>(<span class="dv">16</span>),</span>
<span id="cb97-26"><a href="empirical-results.html#cb97-26" tabindex="-1"></a>                     <span class="at">activation =</span> <span class="fu">c</span>(<span class="st">&quot;relu&quot;</span>),</span>
<span id="cb97-27"><a href="empirical-results.html#cb97-27" tabindex="-1"></a>                     <span class="at">regularization_factor =</span> <span class="fu">c</span>(<span class="dv">0</span>),</span>
<span id="cb97-28"><a href="empirical-results.html#cb97-28" tabindex="-1"></a>                     <span class="at">dropout_rate =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)),</span>
<span id="cb97-29"><a href="empirical-results.html#cb97-29" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;mcc.mccf1&quot;</span></span>
<span id="cb97-30"><a href="empirical-results.html#cb97-30" tabindex="-1"></a>                   ) <span class="co"># specify which metric to optimize</span></span>
<span id="cb97-31"><a href="empirical-results.html#cb97-31" tabindex="-1"></a>  <span class="co"># Source: Dropout https://jmlr.org/papers/v15/srivastava14a.html</span></span>
<span id="cb97-32"><a href="empirical-results.html#cb97-32" tabindex="-1"></a>  <span class="fu">save</span>(keras.fit, <span class="at">file =</span> <span class="st">&quot;../data/keras.fit.RData&quot;</span>)</span>
<span id="cb97-33"><a href="empirical-results.html#cb97-33" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb97-34"><a href="empirical-results.html#cb97-34" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/keras.fit.RData&quot;</span>)</span>
<span id="cb97-35"><a href="empirical-results.html#cb97-35" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Model information and evaluation on training set</strong></p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="empirical-results.html#cb98-1" tabindex="-1"></a>keras.bestTune.mccf1 <span class="ot">&lt;-</span> keras.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="empirical-results.html#cb98-2" tabindex="-1"></a>  <span class="fu">group_by</span>(layer1, layer2, layer3, batch_size, activation, regularization_factor, dropout_rate) <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="empirical-results.html#cb98-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mccf1 =</span> <span class="fu">mean</span>(mcc.mccf1), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-4"><a href="empirical-results.html#cb98-4" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(mccf1))</span>
<span id="cb98-5"><a href="empirical-results.html#cb98-5" tabindex="-1"></a></span>
<span id="cb98-6"><a href="empirical-results.html#cb98-6" tabindex="-1"></a>keras.bestTune.roc <span class="ot">&lt;-</span> keras.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb98-7"><a href="empirical-results.html#cb98-7" tabindex="-1"></a>  <span class="fu">group_by</span>(layer1, layer2, layer3, batch_size, activation, regularization_factor, dropout_rate) <span class="sc">%&gt;%</span></span>
<span id="cb98-8"><a href="empirical-results.html#cb98-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">auc =</span> <span class="fu">mean</span>(auc.roc), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-9"><a href="empirical-results.html#cb98-9" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(auc))</span>
<span id="cb98-10"><a href="empirical-results.html#cb98-10" tabindex="-1"></a></span>
<span id="cb98-11"><a href="empirical-results.html#cb98-11" tabindex="-1"></a><span class="co"># Hyperparameters of best models for MCC-F1 and ROC cutpoints</span></span>
<span id="cb98-12"><a href="empirical-results.html#cb98-12" tabindex="-1"></a>hyperparameters.table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb98-13"><a href="empirical-results.html#cb98-13" tabindex="-1"></a>  <span class="at">cutpoint =</span> <span class="fu">c</span>(<span class="st">&quot;MCCF1&quot;</span>, <span class="st">&quot;ROC&quot;</span>),</span>
<span id="cb98-14"><a href="empirical-results.html#cb98-14" tabindex="-1"></a>  <span class="at">layer1 =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>layer1, keras.bestTune.roc<span class="sc">$</span>layer1),</span>
<span id="cb98-15"><a href="empirical-results.html#cb98-15" tabindex="-1"></a>  <span class="at">layer2 =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>layer2, keras.bestTune.roc<span class="sc">$</span>layer2),</span>
<span id="cb98-16"><a href="empirical-results.html#cb98-16" tabindex="-1"></a>  <span class="at">layer3 =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>layer3, keras.bestTune.roc<span class="sc">$</span>layer3),</span>
<span id="cb98-17"><a href="empirical-results.html#cb98-17" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>batch_size, keras.bestTune.roc<span class="sc">$</span>batch_size),</span>
<span id="cb98-18"><a href="empirical-results.html#cb98-18" tabindex="-1"></a>  <span class="at">activation =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>activation, keras.bestTune.roc<span class="sc">$</span>activation),</span>
<span id="cb98-19"><a href="empirical-results.html#cb98-19" tabindex="-1"></a>  <span class="at">regularization_factor =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>regularization_factor, keras.bestTune.roc<span class="sc">$</span>regularization_factor),</span>
<span id="cb98-20"><a href="empirical-results.html#cb98-20" tabindex="-1"></a>  <span class="at">dropout_rate =</span> <span class="fu">c</span>(keras.bestTune.mccf1<span class="sc">$</span>dropout_rate, keras.bestTune.roc<span class="sc">$</span>dropout_rate)</span>
<span id="cb98-21"><a href="empirical-results.html#cb98-21" tabindex="-1"></a>)</span>
<span id="cb98-22"><a href="empirical-results.html#cb98-22" tabindex="-1"></a></span>
<span id="cb98-23"><a href="empirical-results.html#cb98-23" tabindex="-1"></a>pred.probability <span class="ot">&lt;-</span> keras.fit <span class="sc">%&gt;%</span> </span>
<span id="cb98-24"><a href="empirical-results.html#cb98-24" tabindex="-1"></a>   <span class="fu">predict</span>(data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date), <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span></code></pre></div>
<pre><code>## 208/208 - 0s - 363ms/epoch - 2ms/step</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="empirical-results.html#cb100-1" tabindex="-1"></a>keras.metrics <span class="ot">&lt;-</span> <span class="fu">illustrate.metrics</span>(hyperparameters.table, data.training<span class="sc">$</span>response, pred.probability<span class="sc">$</span>delisted)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.neuralnet.best_model-1.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.1862 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.neuralnet.best_model-2.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.2751 maximizes MCCF1 metric.&quot;</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="empirical-results.html#cb103-1" tabindex="-1"></a><span class="fu">illustrate.metrics.boxplot</span>(keras.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(layer1 <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>layer1[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb103-2"><a href="empirical-results.html#cb103-2" tabindex="-1"></a>                                                      layer2 <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>layer2[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb103-3"><a href="empirical-results.html#cb103-3" tabindex="-1"></a>                                                      layer3 <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>layer3[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb103-4"><a href="empirical-results.html#cb103-4" tabindex="-1"></a>                                                      batch_size <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>batch_size[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb103-5"><a href="empirical-results.html#cb103-5" tabindex="-1"></a>                                                      activation <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>activation[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb103-6"><a href="empirical-results.html#cb103-6" tabindex="-1"></a>                                                      regularization_factor <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>regularization_factor[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb103-7"><a href="empirical-results.html#cb103-7" tabindex="-1"></a>                                                      dropout_rate <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>dropout_rate[<span class="dv">1</span>]),</span>
<span id="cb103-8"><a href="empirical-results.html#cb103-8" tabindex="-1"></a>                           keras.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(layer1 <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>layer1[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb103-9"><a href="empirical-results.html#cb103-9" tabindex="-1"></a>                                                      layer2 <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>layer2[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb103-10"><a href="empirical-results.html#cb103-10" tabindex="-1"></a>                                                      layer3 <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>layer3[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb103-11"><a href="empirical-results.html#cb103-11" tabindex="-1"></a>                                                      batch_size <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>batch_size[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb103-12"><a href="empirical-results.html#cb103-12" tabindex="-1"></a>                                                      activation <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>activation[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb103-13"><a href="empirical-results.html#cb103-13" tabindex="-1"></a>                                                      regularization_factor <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>regularization_factor[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb103-14"><a href="empirical-results.html#cb103-14" tabindex="-1"></a>                                                      dropout_rate <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>dropout_rate[<span class="dv">2</span>]),</span>
<span id="cb103-15"><a href="empirical-results.html#cb103-15" tabindex="-1"></a>                           <span class="st">&quot;keras&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.neuralnet.best_model-3.png" width="672" /></p>
<p><strong>Performance evaluation on test set</strong></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="empirical-results.html#cb104-1" tabindex="-1"></a><span class="co"># MCCF1 variant: prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb104-2"><a href="empirical-results.html#cb104-2" tabindex="-1"></a>pred.test.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(keras.fit, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span></code></pre></div>
<pre><code>## 70/70 - 0s - 126ms/epoch - 2ms/step</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="empirical-results.html#cb106-1" tabindex="-1"></a><span class="co"># ROC variant: fit model using best hyperparameters and </span></span>
<span id="cb106-2"><a href="empirical-results.html#cb106-2" tabindex="-1"></a><span class="co">#              find best threshold and</span></span>
<span id="cb106-3"><a href="empirical-results.html#cb106-3" tabindex="-1"></a><span class="co">#              prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb106-4"><a href="empirical-results.html#cb106-4" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb106-5"><a href="empirical-results.html#cb106-5" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb106-6"><a href="empirical-results.html#cb106-6" tabindex="-1"></a>  keras.fit.roc <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date),</span>
<span id="cb106-7"><a href="empirical-results.html#cb106-7" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb106-8"><a href="empirical-results.html#cb106-8" tabindex="-1"></a>                   <span class="at">method =</span> keras.list,</span>
<span id="cb106-9"><a href="empirical-results.html#cb106-9" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb106-10"><a href="empirical-results.html#cb106-10" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="at">summaryFunction =</span> compute.summary), </span>
<span id="cb106-11"><a href="empirical-results.html#cb106-11" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(</span>
<span id="cb106-12"><a href="empirical-results.html#cb106-12" tabindex="-1"></a>                     <span class="at">layer1 =</span> keras.bestTune.roc<span class="sc">$</span>layer1,</span>
<span id="cb106-13"><a href="empirical-results.html#cb106-13" tabindex="-1"></a>                     <span class="at">layer2 =</span> keras.bestTune.roc<span class="sc">$</span>layer2,</span>
<span id="cb106-14"><a href="empirical-results.html#cb106-14" tabindex="-1"></a>                     <span class="at">layer3 =</span> keras.bestTune.roc<span class="sc">$</span>layer3,</span>
<span id="cb106-15"><a href="empirical-results.html#cb106-15" tabindex="-1"></a>                     <span class="at">batch_size =</span> keras.bestTune.roc<span class="sc">$</span>batch_size,</span>
<span id="cb106-16"><a href="empirical-results.html#cb106-16" tabindex="-1"></a>                     <span class="at">activation =</span> keras.bestTune.roc<span class="sc">$</span>activation,</span>
<span id="cb106-17"><a href="empirical-results.html#cb106-17" tabindex="-1"></a>                     <span class="at">regularization_factor =</span> keras.bestTune.roc<span class="sc">$</span>regularization_factor,</span>
<span id="cb106-18"><a href="empirical-results.html#cb106-18" tabindex="-1"></a>                     <span class="at">dropout_rate =</span> keras.bestTune.roc<span class="sc">$</span>dropout_rate</span>
<span id="cb106-19"><a href="empirical-results.html#cb106-19" tabindex="-1"></a>                   ),</span>
<span id="cb106-20"><a href="empirical-results.html#cb106-20" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb106-21"><a href="empirical-results.html#cb106-21" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;auc.roc&quot;</span>) <span class="co"># specify which metric to optimize</span></span>
<span id="cb106-22"><a href="empirical-results.html#cb106-22" tabindex="-1"></a>  <span class="fu">save</span>(keras.fit.roc, <span class="at">file =</span> <span class="st">&quot;../data/keras.fit.roc.RData&quot;</span>)</span>
<span id="cb106-23"><a href="empirical-results.html#cb106-23" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb106-24"><a href="empirical-results.html#cb106-24" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/keras.fit.roc.RData&quot;</span>)</span>
<span id="cb106-25"><a href="empirical-results.html#cb106-25" tabindex="-1"></a>}</span>
<span id="cb106-26"><a href="empirical-results.html#cb106-26" tabindex="-1"></a>keras.metrics.roc.cutpoint <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(</span>
<span id="cb106-27"><a href="empirical-results.html#cb106-27" tabindex="-1"></a>  <span class="fu">predict</span>(keras.fit.roc, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted,</span>
<span id="cb106-28"><a href="empirical-results.html#cb106-28" tabindex="-1"></a>  data.training<span class="sc">$</span>response)<span class="sc">$</span>best_cutpoint</span></code></pre></div>
<pre><code>## 208/208 - 0s - 229ms/epoch - 1ms/step</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="empirical-results.html#cb108-1" tabindex="-1"></a>pred.test.probability.roc <span class="ot">&lt;-</span> <span class="fu">predict</span>(keras.fit.roc, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span></code></pre></div>
<pre><code>## 70/70 - 0s - 94ms/epoch - 1ms/step</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="empirical-results.html#cb110-1" tabindex="-1"></a><span class="co"># metrics on test set using best threshold determined based on train data</span></span>
<span id="cb110-2"><a href="empirical-results.html#cb110-2" tabindex="-1"></a>keras.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability.roc<span class="sc">$</span>delisted <span class="sc">&gt;=</span> keras.metrics<span class="sc">$</span>cutpoint.roc),</span>
<span id="cb110-3"><a href="empirical-results.html#cb110-3" tabindex="-1"></a>      <span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted <span class="sc">&gt;=</span> keras.metrics<span class="sc">$</span>cutpoint.mccf1)) <span class="sc">%&gt;%</span></span>
<span id="cb110-4"><a href="empirical-results.html#cb110-4" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">splitting =</span> <span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), .)</span>
<span id="cb110-5"><a href="empirical-results.html#cb110-5" tabindex="-1"></a><span class="fu">pander</span>(keras.summary.test, <span class="at">caption =</span> <span class="st">&quot;Neural net on test data&quot;</span>)</span></code></pre></div>
<table>
<caption>Neural net on test data (continued below)</caption>
<colgroup>
<col width="15%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="8%" />
<col width="14%" />
<col width="15%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">splitting</th>
<th align="center">tp</th>
<th align="center">fn</th>
<th align="center">fp</th>
<th align="center">tn</th>
<th align="center">accuracy</th>
<th align="center">precision</th>
<th align="center">recall</th>
<th align="center">f1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ROC</td>
<td align="center">288</td>
<td align="center">148</td>
<td align="center">546</td>
<td align="center">1236</td>
<td align="center">0.6871</td>
<td align="center">0.3453</td>
<td align="center">0.6606</td>
<td align="center">0.4535</td>
</tr>
<tr class="even">
<td align="center">MCCF1</td>
<td align="center">239</td>
<td align="center">197</td>
<td align="center">334</td>
<td align="center">1448</td>
<td align="center">0.7606</td>
<td align="center">0.4171</td>
<td align="center">0.5482</td>
<td align="center">0.4737</td>
</tr>
</tbody>
</table>
<table style="width:32%;">
<colgroup>
<col width="19%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">specificity</th>
<th align="center">mcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.6936</td>
<td align="center">0.2906</td>
</tr>
<tr class="even">
<td align="center">0.8126</td>
<td align="center">0.3275</td>
</tr>
</tbody>
</table>
<p><strong>Marginal plots</strong></p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="empirical-results.html#cb111-1" tabindex="-1"></a><span class="co"># marginal plots of features in com.features.fin on test data</span></span>
<span id="cb111-2"><a href="empirical-results.html#cb111-2" tabindex="-1"></a><span class="cf">for</span> (feature_identifier <span class="cf">in</span> com.features.fin<span class="sc">$</span>identifier) {</span>
<span id="cb111-3"><a href="empirical-results.html#cb111-3" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb111-4"><a href="empirical-results.html#cb111-4" tabindex="-1"></a>      (data.test <span class="sc">%&gt;%</span> </span>
<span id="cb111-5"><a href="empirical-results.html#cb111-5" tabindex="-1"></a>        <span class="fu">inner_join</span>(com <span class="sc">%&gt;%</span> <span class="fu">select</span>(permno, public_date, years_to_delisting), <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date))),</span>
<span id="cb111-6"><a href="empirical-results.html#cb111-6" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb111-7"><a href="empirical-results.html#cb111-7" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb111-8"><a href="empirical-results.html#cb111-8" tabindex="-1"></a>      <span class="at">marginal.data =</span> pred.test.probability<span class="sc">$</span>delisted</span>
<span id="cb111-9"><a href="empirical-results.html#cb111-9" tabindex="-1"></a>    )</span>
<span id="cb111-10"><a href="empirical-results.html#cb111-10" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb111-11"><a href="empirical-results.html#cb111-11" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/model.neuralnet.marginal-1.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-2.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-3.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-4.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-5.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-6.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-7.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-8.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-9.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-10.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-11.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-12.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-13.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-14.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-15.png" width="672" /><img src="_main_files/figure-html/model.neuralnet.marginal-16.png" width="672" /></p>

</div>
<div id="boosting" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Boosting<a href="empirical-results.html#boosting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://cran.r-project.org/web/packages/gbm/vignettes/gbm.pdf" class="uri">https://cran.r-project.org/web/packages/gbm/vignettes/gbm.pdf</a></p>
<p>Hyperparameters<br />
</p>
<ul>
<li><p><code>n.trees</code>: number of iterations <span class="math inline">\(T\)</span><br />
</p></li>
<li><p><code>interaction.depth</code>: depth of each tree <span class="math inline">\(K\)</span><br />
</p></li>
<li><p><code>shrinkage</code>: shrinkage (or learning rate) parameter <span class="math inline">\(\lambda\)</span><br />
</p></li>
<li><p>```bag.fraction````: subsampling rate <span class="math inline">\(p\)</span></p></li>
</ul>
<p>Initialize <span class="math inline">\(\hat{f}(x)\)</span> to be a constant and compute <span class="math inline">\(\hat{f}(x) = \arg \min_\rho L(y_i,\rho)\)</span><br />
For <span class="math inline">\(t\)</span> in <span class="math inline">\(1,\dots,T\)</span> do</p>
<ol style="list-style-type: decimal">
<li><p>Compute the negative gradient as the working response
<span class="math display">\[
z_i = - \left. \frac{\partial}{\partial f(x_i)} L(y_i, f(x_i)) \right|_{f(x_i)=\hat{f}(x_i)} \qquad \forall i \in \{1,\dots,N\}
\]</span></p></li>
<li><p>Randomly select <span class="math inline">\(p \cdot N\)</span> cases from the data set.</p></li>
<li><p>Fit a regression tree with <span class="math inline">\(K\)</span> terminal nodes, <span class="math inline">\(g(x) = E(z|x)\)</span>. This tree is fit using only those randomly selected observations from step 2.</p></li>
<li><p>Compute the optimal terminal node predictions, <span class="math inline">\(\rho_1,\dots,\rho_K\)</span>, as
<span class="math display">\[
\rho_k = \arg \min_\rho \sum_{x_i \in S_k}^{N} L(y_i, \hat{f}(x_i) + \rho)
\]</span>
where <span class="math inline">\(S_k\)</span> is the set of <span class="math inline">\(x\)</span>s that define terminal node <span class="math inline">\(k\)</span>. This step uses only the randomly selected observations.</p></li>
<li><p>Update the <span class="math inline">\(\hat{f}(x)\)</span> as <span class="math inline">\(\hat{f}(x) \leftarrow \hat{f}(x) + \lambda \rho_{k(x)}\)</span> where <span class="math inline">\(k(x)\)</span> indicates the index of the terminal node into which an observation with features <span class="math inline">\(x\)</span> would fall.</p></li>
</ol>
<p><strong>Model fit</strong></p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="empirical-results.html#cb112-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb112-2"><a href="empirical-results.html#cb112-2" tabindex="-1"></a>  <span class="do">### control the computational nuances of the train function ####################</span></span>
<span id="cb112-3"><a href="empirical-results.html#cb112-3" tabindex="-1"></a>  boosting.fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>,</span>
<span id="cb112-4"><a href="empirical-results.html#cb112-4" tabindex="-1"></a>                             <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb112-5"><a href="empirical-results.html#cb112-5" tabindex="-1"></a>                             <span class="do">## Estimate class probabilities</span></span>
<span id="cb112-6"><a href="empirical-results.html#cb112-6" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb112-7"><a href="empirical-results.html#cb112-7" tabindex="-1"></a>                             <span class="do">## Evaluate performance using </span></span>
<span id="cb112-8"><a href="empirical-results.html#cb112-8" tabindex="-1"></a>                             <span class="do">## the following function</span></span>
<span id="cb112-9"><a href="empirical-results.html#cb112-9" tabindex="-1"></a>                             <span class="at">summaryFunction =</span> compute.summary,</span>
<span id="cb112-10"><a href="empirical-results.html#cb112-10" tabindex="-1"></a>                             <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb112-11"><a href="empirical-results.html#cb112-11" tabindex="-1"></a>  </span>
<span id="cb112-12"><a href="empirical-results.html#cb112-12" tabindex="-1"></a>  <span class="do">### fit model over different tuning parameters #################################</span></span>
<span id="cb112-13"><a href="empirical-results.html#cb112-13" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb112-14"><a href="empirical-results.html#cb112-14" tabindex="-1"></a>  boosting.fit <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date) <span class="sc">%&gt;%</span> </span>
<span id="cb112-15"><a href="empirical-results.html#cb112-15" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">as.factor</span>(response)), </span>
<span id="cb112-16"><a href="empirical-results.html#cb112-16" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb112-17"><a href="empirical-results.html#cb112-17" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;gbm&quot;</span>, </span>
<span id="cb112-18"><a href="empirical-results.html#cb112-18" tabindex="-1"></a>                   <span class="at">trControl =</span> boosting.fitControl, </span>
<span id="cb112-19"><a href="empirical-results.html#cb112-19" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(</span>
<span id="cb112-20"><a href="empirical-results.html#cb112-20" tabindex="-1"></a>                        <span class="at">n.trees =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">250</span>, <span class="dv">500</span>),</span>
<span id="cb112-21"><a href="empirical-results.html#cb112-21" tabindex="-1"></a>                        <span class="at">interaction.depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">8</span>), <span class="co"># Hands-On Machine Learning with R: https://bradleyboehmke.github.io/HOML/</span></span>
<span id="cb112-22"><a href="empirical-results.html#cb112-22" tabindex="-1"></a>                        <span class="at">shrinkage =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>),</span>
<span id="cb112-23"><a href="empirical-results.html#cb112-23" tabindex="-1"></a>                        <span class="at">n.minobsinnode =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>)),</span>
<span id="cb112-24"><a href="empirical-results.html#cb112-24" tabindex="-1"></a>                        <span class="co"># bag.fraction = 0.5 by default</span></span>
<span id="cb112-25"><a href="empirical-results.html#cb112-25" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, </span>
<span id="cb112-26"><a href="empirical-results.html#cb112-26" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;mcc.mccf1&quot;</span></span>
<span id="cb112-27"><a href="empirical-results.html#cb112-27" tabindex="-1"></a>                   ) <span class="co"># specify which metric to optimize</span></span>
<span id="cb112-28"><a href="empirical-results.html#cb112-28" tabindex="-1"></a>  <span class="fu">save</span>(boosting.fit, <span class="at">file =</span> <span class="st">&quot;../data/boosting.fit.RData&quot;</span>)</span>
<span id="cb112-29"><a href="empirical-results.html#cb112-29" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb112-30"><a href="empirical-results.html#cb112-30" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/boosting.fit.RData&quot;</span>)</span>
<span id="cb112-31"><a href="empirical-results.html#cb112-31" tabindex="-1"></a>}</span>
<span id="cb112-32"><a href="empirical-results.html#cb112-32" tabindex="-1"></a></span>
<span id="cb112-33"><a href="empirical-results.html#cb112-33" tabindex="-1"></a><span class="co"># effect of hyperparameters</span></span>
<span id="cb112-34"><a href="empirical-results.html#cb112-34" tabindex="-1"></a><span class="fu">ggplot</span>(boosting.fit) <span class="sc">+</span></span>
<span id="cb112-35"><a href="empirical-results.html#cb112-35" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb112-36"><a href="empirical-results.html#cb112-36" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Gradient boosting with regression trees as base-learners&quot;</span>,</span>
<span id="cb112-37"><a href="empirical-results.html#cb112-37" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;MCC vs. min. terminal node size &amp; shrinkage parameter alpha&quot;</span>,</span>
<span id="cb112-38"><a href="empirical-results.html#cb112-38" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Min. terminal node size &amp; shrinkage parameter&quot;</span>,</span>
<span id="cb112-39"><a href="empirical-results.html#cb112-39" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;MCC (10-fold cross-validation)&quot;</span></span>
<span id="cb112-40"><a href="empirical-results.html#cb112-40" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/model.boosting.fit-1.png" width="672" /></p>
<p><strong>Model information and evaluation on training set</strong></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="empirical-results.html#cb113-1" tabindex="-1"></a>boosting.bestTune.mccf1 <span class="ot">&lt;-</span> boosting.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb113-2"><a href="empirical-results.html#cb113-2" tabindex="-1"></a>  <span class="fu">group_by</span>(n.trees, interaction.depth, shrinkage, n.minobsinnode) <span class="sc">%&gt;%</span></span>
<span id="cb113-3"><a href="empirical-results.html#cb113-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mccf1 =</span> <span class="fu">mean</span>(mcc.mccf1), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb113-4"><a href="empirical-results.html#cb113-4" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(mccf1))</span>
<span id="cb113-5"><a href="empirical-results.html#cb113-5" tabindex="-1"></a></span>
<span id="cb113-6"><a href="empirical-results.html#cb113-6" tabindex="-1"></a>boosting.bestTune.roc <span class="ot">&lt;-</span> boosting.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span></span>
<span id="cb113-7"><a href="empirical-results.html#cb113-7" tabindex="-1"></a>  <span class="fu">group_by</span>(n.trees, interaction.depth, shrinkage, n.minobsinnode) <span class="sc">%&gt;%</span></span>
<span id="cb113-8"><a href="empirical-results.html#cb113-8" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">auc =</span> <span class="fu">mean</span>(auc.roc), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb113-9"><a href="empirical-results.html#cb113-9" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(auc))</span>
<span id="cb113-10"><a href="empirical-results.html#cb113-10" tabindex="-1"></a></span>
<span id="cb113-11"><a href="empirical-results.html#cb113-11" tabindex="-1"></a><span class="co"># Hyperparameters of best models for MCC-F1 and ROC cutpoints</span></span>
<span id="cb113-12"><a href="empirical-results.html#cb113-12" tabindex="-1"></a>hyperparameters.table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb113-13"><a href="empirical-results.html#cb113-13" tabindex="-1"></a>  <span class="at">cutpoint =</span> <span class="fu">c</span>(<span class="st">&quot;MCCF1&quot;</span>, <span class="st">&quot;ROC&quot;</span>),</span>
<span id="cb113-14"><a href="empirical-results.html#cb113-14" tabindex="-1"></a>  <span class="at">n.trees =</span> <span class="fu">c</span>(boosting.bestTune.mccf1<span class="sc">$</span>n.trees, boosting.bestTune.roc<span class="sc">$</span>n.trees),</span>
<span id="cb113-15"><a href="empirical-results.html#cb113-15" tabindex="-1"></a>  <span class="at">interaction.depth =</span> <span class="fu">c</span>(boosting.bestTune.mccf1<span class="sc">$</span>interaction.depth, boosting.bestTune.roc<span class="sc">$</span>interaction.depth),</span>
<span id="cb113-16"><a href="empirical-results.html#cb113-16" tabindex="-1"></a>  <span class="at">shrinkage =</span> <span class="fu">c</span>(boosting.bestTune.mccf1<span class="sc">$</span>shrinkage, boosting.bestTune.roc<span class="sc">$</span>shrinkage),</span>
<span id="cb113-17"><a href="empirical-results.html#cb113-17" tabindex="-1"></a>  <span class="at">n.minobsinnode =</span> <span class="fu">c</span>(boosting.bestTune.mccf1<span class="sc">$</span>n.minobsinnode, boosting.bestTune.roc<span class="sc">$</span>n.minobsinnode)</span>
<span id="cb113-18"><a href="empirical-results.html#cb113-18" tabindex="-1"></a>  </span>
<span id="cb113-19"><a href="empirical-results.html#cb113-19" tabindex="-1"></a>)</span>
<span id="cb113-20"><a href="empirical-results.html#cb113-20" tabindex="-1"></a></span>
<span id="cb113-21"><a href="empirical-results.html#cb113-21" tabindex="-1"></a>pred.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(boosting.fit, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb113-22"><a href="empirical-results.html#cb113-22" tabindex="-1"></a>boosting.metrics <span class="ot">&lt;-</span> <span class="fu">illustrate.metrics</span>(hyperparameters.table, data.training<span class="sc">$</span>response, pred.probability<span class="sc">$</span>delisted)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.boosting.best_model-1.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.2046 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.boosting.best_model-2.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.2304 maximizes MCCF1 metric.&quot;</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="empirical-results.html#cb116-1" tabindex="-1"></a><span class="fu">illustrate.metrics.boxplot</span>(boosting.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n.trees <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>n.trees[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb116-2"><a href="empirical-results.html#cb116-2" tabindex="-1"></a>                                                      interaction.depth <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>interaction.depth[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb116-3"><a href="empirical-results.html#cb116-3" tabindex="-1"></a>                                                      shrinkage <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>shrinkage[<span class="dv">1</span>] <span class="sc">&amp;</span></span>
<span id="cb116-4"><a href="empirical-results.html#cb116-4" tabindex="-1"></a>                                                      n.minobsinnode <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>n.minobsinnode[<span class="dv">1</span>]),</span>
<span id="cb116-5"><a href="empirical-results.html#cb116-5" tabindex="-1"></a>                           boosting.fit<span class="sc">$</span>resample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n.trees <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>n.trees[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb116-6"><a href="empirical-results.html#cb116-6" tabindex="-1"></a>                                                      interaction.depth <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>interaction.depth[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb116-7"><a href="empirical-results.html#cb116-7" tabindex="-1"></a>                                                      shrinkage <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>shrinkage[<span class="dv">2</span>] <span class="sc">&amp;</span></span>
<span id="cb116-8"><a href="empirical-results.html#cb116-8" tabindex="-1"></a>                                                      n.minobsinnode <span class="sc">==</span> hyperparameters.table<span class="sc">$</span>n.minobsinnode[<span class="dv">2</span>]),</span>
<span id="cb116-9"><a href="empirical-results.html#cb116-9" tabindex="-1"></a>                           <span class="st">&quot;boosting&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.boosting.best_model-3.png" width="672" /></p>
<p><strong>Performance evaluation on test set</strong></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="empirical-results.html#cb117-1" tabindex="-1"></a><span class="co"># MCCF1 variant: prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb117-2"><a href="empirical-results.html#cb117-2" tabindex="-1"></a>pred.test.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(boosting.fit, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb117-3"><a href="empirical-results.html#cb117-3" tabindex="-1"></a></span>
<span id="cb117-4"><a href="empirical-results.html#cb117-4" tabindex="-1"></a><span class="co"># ROC variant: fit model using best hyperparameters and </span></span>
<span id="cb117-5"><a href="empirical-results.html#cb117-5" tabindex="-1"></a><span class="co">#              find best threshold and</span></span>
<span id="cb117-6"><a href="empirical-results.html#cb117-6" tabindex="-1"></a><span class="co">#              prediction scores on test data (&quot;active&quot;, &quot;delisted&quot;)</span></span>
<span id="cb117-7"><a href="empirical-results.html#cb117-7" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb117-8"><a href="empirical-results.html#cb117-8" tabindex="-1"></a>boosting.fit.roc <span class="ot">&lt;-</span> <span class="fu">train</span>(response <span class="sc">~</span> ., <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date),</span>
<span id="cb117-9"><a href="empirical-results.html#cb117-9" tabindex="-1"></a>                   <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb117-10"><a href="empirical-results.html#cb117-10" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">&quot;gbm&quot;</span>, </span>
<span id="cb117-11"><a href="empirical-results.html#cb117-11" tabindex="-1"></a>                   <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb117-12"><a href="empirical-results.html#cb117-12" tabindex="-1"></a>                             <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="at">summaryFunction =</span> compute.summary),</span>
<span id="cb117-13"><a href="empirical-results.html#cb117-13" tabindex="-1"></a>                   <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(</span>
<span id="cb117-14"><a href="empirical-results.html#cb117-14" tabindex="-1"></a>                        <span class="at">n.trees =</span> boosting.bestTune.roc<span class="sc">$</span>n.trees,</span>
<span id="cb117-15"><a href="empirical-results.html#cb117-15" tabindex="-1"></a>                        <span class="at">interaction.depth =</span> boosting.bestTune.roc<span class="sc">$</span>interaction.depth,</span>
<span id="cb117-16"><a href="empirical-results.html#cb117-16" tabindex="-1"></a>                        <span class="at">shrinkage =</span> boosting.bestTune.roc<span class="sc">$</span>shrinkage,</span>
<span id="cb117-17"><a href="empirical-results.html#cb117-17" tabindex="-1"></a>                        <span class="at">n.minobsinnode =</span> boosting.bestTune.roc<span class="sc">$</span>n.minobsinnode),</span>
<span id="cb117-18"><a href="empirical-results.html#cb117-18" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">&quot;auc.roc&quot;</span>) <span class="co"># specify which metric to optimize</span></span>
<span id="cb117-19"><a href="empirical-results.html#cb117-19" tabindex="-1"></a>boosting.metrics.roc.cutpoint <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(</span>
<span id="cb117-20"><a href="empirical-results.html#cb117-20" tabindex="-1"></a>  <span class="fu">predict</span>(boosting.fit.roc, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted,</span>
<span id="cb117-21"><a href="empirical-results.html#cb117-21" tabindex="-1"></a>  data.training<span class="sc">$</span>response)<span class="sc">$</span>best_cutpoint</span>
<span id="cb117-22"><a href="empirical-results.html#cb117-22" tabindex="-1"></a>pred.test.probability <span class="ot">&lt;-</span> <span class="fu">predict</span>(boosting.fit, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb117-23"><a href="empirical-results.html#cb117-23" tabindex="-1"></a></span>
<span id="cb117-24"><a href="empirical-results.html#cb117-24" tabindex="-1"></a><span class="co"># metrics on test set using best threshold determined based on train data</span></span>
<span id="cb117-25"><a href="empirical-results.html#cb117-25" tabindex="-1"></a>boosting.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability.roc<span class="sc">$</span>delisted <span class="sc">&gt;=</span> boosting.metrics.roc.cutpoint),</span>
<span id="cb117-26"><a href="empirical-results.html#cb117-26" tabindex="-1"></a>      <span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test.probability<span class="sc">$</span>delisted <span class="sc">&gt;=</span> boosting.metrics<span class="sc">$</span>cutpoint.mccf1)) <span class="sc">%&gt;%</span></span>
<span id="cb117-27"><a href="empirical-results.html#cb117-27" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">splitting =</span> <span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), .)</span>
<span id="cb117-28"><a href="empirical-results.html#cb117-28" tabindex="-1"></a><span class="fu">pander</span>(boosting.summary.test, <span class="at">caption =</span> <span class="st">&quot;Gradient boosting on test data&quot;</span>)</span></code></pre></div>
<p><strong>Variable importance</strong></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="empirical-results.html#cb118-1" tabindex="-1"></a><span class="co"># returns the reduction attributable to each variable in sum of squared error </span></span>
<span id="cb118-2"><a href="empirical-results.html#cb118-2" tabindex="-1"></a><span class="co"># in predicting the gradient on each iteration. It describes the relative </span></span>
<span id="cb118-3"><a href="empirical-results.html#cb118-3" tabindex="-1"></a><span class="co"># influence  of each variable in reducing the loss function</span></span>
<span id="cb118-4"><a href="empirical-results.html#cb118-4" tabindex="-1"></a>boosting.vimp.results <span class="ot">&lt;-</span> <span class="fu">varImp</span>(boosting.fit)<span class="sc">$</span>importance</span>
<span id="cb118-5"><a href="empirical-results.html#cb118-5" tabindex="-1"></a>boosting.vimp <span class="ot">&lt;-</span> boosting.vimp.results <span class="sc">%&gt;%</span></span>
<span id="cb118-6"><a href="empirical-results.html#cb118-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature =</span> <span class="fu">rownames</span>(boosting.vimp.results),</span>
<span id="cb118-7"><a href="empirical-results.html#cb118-7" tabindex="-1"></a>         <span class="at">vimp =</span> Overall) <span class="sc">%&gt;%</span> </span>
<span id="cb118-8"><a href="empirical-results.html#cb118-8" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(vimp))</span>
<span id="cb118-9"><a href="empirical-results.html#cb118-9" tabindex="-1"></a></span>
<span id="cb118-10"><a href="empirical-results.html#cb118-10" tabindex="-1"></a><span class="fu">plot.vimp</span>(boosting.vimp, <span class="st">&quot;Importance based on sum of SSE reductions&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.boosting.vimp-1.png" width="672" /></p>
<p><strong>Marginal plots</strong></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="empirical-results.html#cb119-1" tabindex="-1"></a><span class="co"># marginal plots of 20 most important features on test data</span></span>
<span id="cb119-2"><a href="empirical-results.html#cb119-2" tabindex="-1"></a><span class="cf">for</span> (feature_identifier <span class="cf">in</span> (boosting.vimp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">20</span>))<span class="sc">$</span>feature) {</span>
<span id="cb119-3"><a href="empirical-results.html#cb119-3" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">hist_delisting_frequency</span>(</span>
<span id="cb119-4"><a href="empirical-results.html#cb119-4" tabindex="-1"></a>      (data.test <span class="sc">%&gt;%</span> </span>
<span id="cb119-5"><a href="empirical-results.html#cb119-5" tabindex="-1"></a>        <span class="fu">inner_join</span>(com <span class="sc">%&gt;%</span> <span class="fu">select</span>(permno, public_date, years_to_delisting), <span class="at">by =</span> <span class="fu">join_by</span>(permno, public_date))),</span>
<span id="cb119-6"><a href="empirical-results.html#cb119-6" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb119-7"><a href="empirical-results.html#cb119-7" tabindex="-1"></a>      feature_identifier,</span>
<span id="cb119-8"><a href="empirical-results.html#cb119-8" tabindex="-1"></a>      <span class="at">marginal.data =</span> pred.test.probability<span class="sc">$</span>delisted</span>
<span id="cb119-9"><a href="empirical-results.html#cb119-9" tabindex="-1"></a>    )</span>
<span id="cb119-10"><a href="empirical-results.html#cb119-10" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb119-11"><a href="empirical-results.html#cb119-11" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/model.boosting.marginal-1.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-2.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-3.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-4.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-5.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-6.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-7.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-8.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-9.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-10.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-11.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-12.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-13.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-14.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-15.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-16.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-17.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-18.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-19.png" width="672" /><img src="_main_files/figure-html/model.boosting.marginal-20.png" width="672" /></p>

</div>
<div id="ensemble" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Ensemble<a href="empirical-results.html#ensemble" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="empirical-results.html#cb120-1" tabindex="-1"></a>ensemble_variants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mccf1 =</span> <span class="cn">NULL</span>, <span class="at">roc =</span> <span class="cn">NULL</span>)</span></code></pre></div>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="empirical-results.html#cb121-1" tabindex="-1"></a><span class="cf">if</span> (REDO_MODEL_FITTING) {</span>
<span id="cb121-2"><a href="empirical-results.html#cb121-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb121-3"><a href="empirical-results.html#cb121-3" tabindex="-1"></a>  my_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb121-4"><a href="empirical-results.html#cb121-4" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;boot&quot;</span>,</span>
<span id="cb121-5"><a href="empirical-results.html#cb121-5" tabindex="-1"></a>    <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb121-6"><a href="empirical-results.html#cb121-6" tabindex="-1"></a>    <span class="at">savePredictions =</span> <span class="st">&quot;final&quot;</span>,</span>
<span id="cb121-7"><a href="empirical-results.html#cb121-7" tabindex="-1"></a>    <span class="at">returnResamp =</span> <span class="st">&quot;final&quot;</span>,</span>
<span id="cb121-8"><a href="empirical-results.html#cb121-8" tabindex="-1"></a>    <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb121-9"><a href="empirical-results.html#cb121-9" tabindex="-1"></a>    <span class="at">index =</span> <span class="fu">createResample</span>(data.training<span class="sc">$</span>response, <span class="at">times =</span> <span class="dv">2</span>),</span>
<span id="cb121-10"><a href="empirical-results.html#cb121-10" tabindex="-1"></a>    <span class="at">summaryFunction =</span> compute.summary</span>
<span id="cb121-11"><a href="empirical-results.html#cb121-11" tabindex="-1"></a>  )</span>
<span id="cb121-12"><a href="empirical-results.html#cb121-12" tabindex="-1"></a></span>
<span id="cb121-13"><a href="empirical-results.html#cb121-13" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ensemble_variants)) {</span>
<span id="cb121-14"><a href="empirical-results.html#cb121-14" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb121-15"><a href="empirical-results.html#cb121-15" tabindex="-1"></a>      metric <span class="ot">&lt;-</span> <span class="st">&quot;mcc.mccf1&quot;</span></span>
<span id="cb121-16"><a href="empirical-results.html#cb121-16" tabindex="-1"></a>      rf.bestTune <span class="ot">&lt;-</span> rf.bestTune.mccf1</span>
<span id="cb121-17"><a href="empirical-results.html#cb121-17" tabindex="-1"></a>      lr.bestTune <span class="ot">&lt;-</span> lr.bestTune.mccf1</span>
<span id="cb121-18"><a href="empirical-results.html#cb121-18" tabindex="-1"></a>      svm.bestTune <span class="ot">&lt;-</span> svm.bestTune.mccf1</span>
<span id="cb121-19"><a href="empirical-results.html#cb121-19" tabindex="-1"></a>      keras.bestTune <span class="ot">&lt;-</span> keras.bestTune.mccf1</span>
<span id="cb121-20"><a href="empirical-results.html#cb121-20" tabindex="-1"></a>      boosting.bestTune <span class="ot">&lt;-</span> boosting.bestTune.mccf1</span>
<span id="cb121-21"><a href="empirical-results.html#cb121-21" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb121-22"><a href="empirical-results.html#cb121-22" tabindex="-1"></a>      metric <span class="ot">&lt;-</span> <span class="st">&quot;auc.roc&quot;</span></span>
<span id="cb121-23"><a href="empirical-results.html#cb121-23" tabindex="-1"></a>      rf.bestTune <span class="ot">&lt;-</span> rf.bestTune.roc</span>
<span id="cb121-24"><a href="empirical-results.html#cb121-24" tabindex="-1"></a>      lr.bestTune <span class="ot">&lt;-</span> lr.bestTune.roc</span>
<span id="cb121-25"><a href="empirical-results.html#cb121-25" tabindex="-1"></a>      svm.bestTune <span class="ot">&lt;-</span> svm.bestTune.roc</span>
<span id="cb121-26"><a href="empirical-results.html#cb121-26" tabindex="-1"></a>      keras.bestTune <span class="ot">&lt;-</span> keras.bestTune.roc</span>
<span id="cb121-27"><a href="empirical-results.html#cb121-27" tabindex="-1"></a>      boosting.bestTune <span class="ot">&lt;-</span> boosting.bestTune.roc</span>
<span id="cb121-28"><a href="empirical-results.html#cb121-28" tabindex="-1"></a>    }</span>
<span id="cb121-29"><a href="empirical-results.html#cb121-29" tabindex="-1"></a>    </span>
<span id="cb121-30"><a href="empirical-results.html#cb121-30" tabindex="-1"></a>    model_list <span class="ot">&lt;-</span> <span class="fu">caretList</span>(</span>
<span id="cb121-31"><a href="empirical-results.html#cb121-31" tabindex="-1"></a>      response <span class="sc">~</span> .,</span>
<span id="cb121-32"><a href="empirical-results.html#cb121-32" tabindex="-1"></a>      <span class="at">data =</span> data.training <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>permno, <span class="sc">-</span>public_date),</span>
<span id="cb121-33"><a href="empirical-results.html#cb121-33" tabindex="-1"></a>      <span class="at">trControl =</span> my_control,</span>
<span id="cb121-34"><a href="empirical-results.html#cb121-34" tabindex="-1"></a>      <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>),</span>
<span id="cb121-35"><a href="empirical-results.html#cb121-35" tabindex="-1"></a>      <span class="at">metric =</span> metric, <span class="co"># either &quot;mcc.roc&quot; or &quot;mcc.mccf1&quot;</span></span>
<span id="cb121-36"><a href="empirical-results.html#cb121-36" tabindex="-1"></a>      <span class="at">tuneList=</span><span class="fu">list</span>(</span>
<span id="cb121-37"><a href="empirical-results.html#cb121-37" tabindex="-1"></a>        <span class="at">rfr =</span> <span class="fu">caretModelSpec</span>(<span class="at">method =</span> rf.list,</span>
<span id="cb121-38"><a href="empirical-results.html#cb121-38" tabindex="-1"></a>                             <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(<span class="at">ntree =</span> rf.bestTune<span class="sc">$</span>ntree,</span>
<span id="cb121-39"><a href="empirical-results.html#cb121-39" tabindex="-1"></a>                                                   <span class="at">nodesize =</span> rf.bestTune<span class="sc">$</span>nodesize,</span>
<span id="cb121-40"><a href="empirical-results.html#cb121-40" tabindex="-1"></a>                                                   <span class="at">mtry =</span> rf.bestTune<span class="sc">$</span>mtry)),</span>
<span id="cb121-41"><a href="empirical-results.html#cb121-41" tabindex="-1"></a>        <span class="at">lr =</span> <span class="fu">caretModelSpec</span>(<span class="at">method =</span> <span class="st">&quot;glmnet&quot;</span>,</span>
<span id="cb121-42"><a href="empirical-results.html#cb121-42" tabindex="-1"></a>                            <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(<span class="at">alpha =</span> lr.bestTune<span class="sc">$</span>alpha, <span class="at">lambda =</span> lr.bestTune<span class="sc">$</span>lambda),</span>
<span id="cb121-43"><a href="empirical-results.html#cb121-43" tabindex="-1"></a>                            <span class="at">trace=</span><span class="cn">FALSE</span>),</span>
<span id="cb121-44"><a href="empirical-results.html#cb121-44" tabindex="-1"></a>        <span class="at">svm =</span> <span class="fu">caretModelSpec</span>(<span class="at">method =</span> <span class="st">&quot;svmPoly&quot;</span>,</span>
<span id="cb121-45"><a href="empirical-results.html#cb121-45" tabindex="-1"></a>                            <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(</span>
<span id="cb121-46"><a href="empirical-results.html#cb121-46" tabindex="-1"></a>                               <span class="at">degree =</span> svm.bestTune<span class="sc">$</span>degree,</span>
<span id="cb121-47"><a href="empirical-results.html#cb121-47" tabindex="-1"></a>                               <span class="at">scale =</span> svm.bestTune<span class="sc">$</span>scale,</span>
<span id="cb121-48"><a href="empirical-results.html#cb121-48" tabindex="-1"></a>                               <span class="at">C =</span> svm.bestTune<span class="sc">$</span>C),</span>
<span id="cb121-49"><a href="empirical-results.html#cb121-49" tabindex="-1"></a>                            <span class="at">trace=</span><span class="cn">FALSE</span>),</span>
<span id="cb121-50"><a href="empirical-results.html#cb121-50" tabindex="-1"></a>        <span class="at">keras =</span> <span class="fu">caretModelSpec</span>(<span class="at">method =</span> keras.list,</span>
<span id="cb121-51"><a href="empirical-results.html#cb121-51" tabindex="-1"></a>                            <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(</span>
<span id="cb121-52"><a href="empirical-results.html#cb121-52" tabindex="-1"></a>                               <span class="at">layer1 =</span> keras.bestTune<span class="sc">$</span>layer1,</span>
<span id="cb121-53"><a href="empirical-results.html#cb121-53" tabindex="-1"></a>                               <span class="at">layer2 =</span> keras.bestTune<span class="sc">$</span>layer2,</span>
<span id="cb121-54"><a href="empirical-results.html#cb121-54" tabindex="-1"></a>                               <span class="at">layer3 =</span> keras.bestTune<span class="sc">$</span>layer3,</span>
<span id="cb121-55"><a href="empirical-results.html#cb121-55" tabindex="-1"></a>                               <span class="at">batch_size =</span> keras.bestTune<span class="sc">$</span>batch_size,</span>
<span id="cb121-56"><a href="empirical-results.html#cb121-56" tabindex="-1"></a>                               <span class="at">activation =</span> keras.bestTune<span class="sc">$</span>activation,</span>
<span id="cb121-57"><a href="empirical-results.html#cb121-57" tabindex="-1"></a>                               <span class="at">regularization_factor =</span> keras.bestTune<span class="sc">$</span>regularization_factor,</span>
<span id="cb121-58"><a href="empirical-results.html#cb121-58" tabindex="-1"></a>                               <span class="at">dropout_rate =</span> keras.bestTune<span class="sc">$</span>dropout_rate),</span>
<span id="cb121-59"><a href="empirical-results.html#cb121-59" tabindex="-1"></a>                            <span class="at">trace=</span><span class="cn">FALSE</span>),</span>
<span id="cb121-60"><a href="empirical-results.html#cb121-60" tabindex="-1"></a>        <span class="at">boosting =</span> <span class="fu">caretModelSpec</span>(<span class="at">method =</span> <span class="st">&quot;gbm&quot;</span>,</span>
<span id="cb121-61"><a href="empirical-results.html#cb121-61" tabindex="-1"></a>                        <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(</span>
<span id="cb121-62"><a href="empirical-results.html#cb121-62" tabindex="-1"></a>                          <span class="at">n.trees =</span> boosting.bestTune<span class="sc">$</span>n.trees,</span>
<span id="cb121-63"><a href="empirical-results.html#cb121-63" tabindex="-1"></a>                          <span class="at">interaction.depth =</span> boosting.bestTune<span class="sc">$</span>interaction.depth,</span>
<span id="cb121-64"><a href="empirical-results.html#cb121-64" tabindex="-1"></a>                          <span class="at">shrinkage =</span> boosting.bestTune<span class="sc">$</span>shrinkage,</span>
<span id="cb121-65"><a href="empirical-results.html#cb121-65" tabindex="-1"></a>                          <span class="at">n.minobsinnode =</span> boosting.bestTune<span class="sc">$</span>n.minobsinnode))</span>
<span id="cb121-66"><a href="empirical-results.html#cb121-66" tabindex="-1"></a>      )</span>
<span id="cb121-67"><a href="empirical-results.html#cb121-67" tabindex="-1"></a>    )</span>
<span id="cb121-68"><a href="empirical-results.html#cb121-68" tabindex="-1"></a>    </span>
<span id="cb121-69"><a href="empirical-results.html#cb121-69" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb121-70"><a href="empirical-results.html#cb121-70" tabindex="-1"></a>      ensemble_variants<span class="sc">$</span>mccf1 <span class="ot">&lt;-</span> model_list</span>
<span id="cb121-71"><a href="empirical-results.html#cb121-71" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb121-72"><a href="empirical-results.html#cb121-72" tabindex="-1"></a>      ensemble_variants<span class="sc">$</span>roc <span class="ot">&lt;-</span> model_list</span>
<span id="cb121-73"><a href="empirical-results.html#cb121-73" tabindex="-1"></a>    }</span>
<span id="cb121-74"><a href="empirical-results.html#cb121-74" tabindex="-1"></a>  }</span>
<span id="cb121-75"><a href="empirical-results.html#cb121-75" tabindex="-1"></a>  <span class="fu">save</span>(ensemble_variants, <span class="at">file =</span> <span class="st">&quot;../data/ensemble_variants_no_gap.RData&quot;</span>)</span>
<span id="cb121-76"><a href="empirical-results.html#cb121-76" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb121-77"><a href="empirical-results.html#cb121-77" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&quot;../data/ensemble_variants.RData&quot;</span>)</span>
<span id="cb121-78"><a href="empirical-results.html#cb121-78" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="empirical-results.html#cb122-1" tabindex="-1"></a>ensemble.summary.test <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb122-2"><a href="empirical-results.html#cb122-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ensemble_variants)) {</span>
<span id="cb122-3"><a href="empirical-results.html#cb122-3" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">1</span>) { <span class="co"># MCCF1 threshold</span></span>
<span id="cb122-4"><a href="empirical-results.html#cb122-4" tabindex="-1"></a>    model_list <span class="ot">&lt;-</span> ensemble_variants<span class="sc">$</span>mccf1</span>
<span id="cb122-5"><a href="empirical-results.html#cb122-5" tabindex="-1"></a>    metric <span class="ot">&lt;-</span> <span class="st">&quot;mcc.mccf1&quot;</span></span>
<span id="cb122-6"><a href="empirical-results.html#cb122-6" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="co"># ROC threshold</span></span>
<span id="cb122-7"><a href="empirical-results.html#cb122-7" tabindex="-1"></a>    model_list <span class="ot">&lt;-</span> ensemble_variants<span class="sc">$</span>roc</span>
<span id="cb122-8"><a href="empirical-results.html#cb122-8" tabindex="-1"></a>    metric <span class="ot">&lt;-</span> <span class="st">&quot;auc.roc&quot;</span></span>
<span id="cb122-9"><a href="empirical-results.html#cb122-9" tabindex="-1"></a>  }</span>
<span id="cb122-10"><a href="empirical-results.html#cb122-10" tabindex="-1"></a>  </span>
<span id="cb122-11"><a href="empirical-results.html#cb122-11" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb122-12"><a href="empirical-results.html#cb122-12" tabindex="-1"></a>  ensemble <span class="ot">&lt;-</span> <span class="fu">caretStack</span>(model_list, <span class="at">method =</span> <span class="st">&quot;glm&quot;</span>, <span class="at">metric =</span> metric,</span>
<span id="cb122-13"><a href="empirical-results.html#cb122-13" tabindex="-1"></a>              <span class="co"># tuneGrid = expand.grid(</span></span>
<span id="cb122-14"><a href="empirical-results.html#cb122-14" tabindex="-1"></a>              <span class="co">#   alpha = 0, # only ridge (L2) regularization</span></span>
<span id="cb122-15"><a href="empirical-results.html#cb122-15" tabindex="-1"></a>              <span class="co">#   lambda = c(0, 0.0001, 0.001, 0.01, 0.1)</span></span>
<span id="cb122-16"><a href="empirical-results.html#cb122-16" tabindex="-1"></a>              <span class="co"># ),</span></span>
<span id="cb122-17"><a href="empirical-results.html#cb122-17" tabindex="-1"></a>              <span class="at">trControl =</span> <span class="fu">trainControl</span>(</span>
<span id="cb122-18"><a href="empirical-results.html#cb122-18" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb122-19"><a href="empirical-results.html#cb122-19" tabindex="-1"></a>               <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb122-20"><a href="empirical-results.html#cb122-20" tabindex="-1"></a>               <span class="at">summaryFunction =</span> compute.summary</span>
<span id="cb122-21"><a href="empirical-results.html#cb122-21" tabindex="-1"></a>               ),</span>
<span id="cb122-22"><a href="empirical-results.html#cb122-22" tabindex="-1"></a>              )</span>
<span id="cb122-23"><a href="empirical-results.html#cb122-23" tabindex="-1"></a></span>
<span id="cb122-24"><a href="empirical-results.html#cb122-24" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(ensemble<span class="sc">$</span>ens_model<span class="sc">$</span>finalModel))</span>
<span id="cb122-25"><a href="empirical-results.html#cb122-25" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">confint</span>(ensemble<span class="sc">$</span>ens_model<span class="sc">$</span>finalModel))</span>
<span id="cb122-26"><a href="empirical-results.html#cb122-26" tabindex="-1"></a>  </span>
<span id="cb122-27"><a href="empirical-results.html#cb122-27" tabindex="-1"></a>  model_preds <span class="ot">&lt;-</span> <span class="fu">lapply</span>(model_list, predict, <span class="at">newdata=</span>data.training, <span class="at">type=</span><span class="st">&quot;prob&quot;</span>)</span>
<span id="cb122-28"><a href="empirical-results.html#cb122-28" tabindex="-1"></a>  model_preds <span class="ot">&lt;-</span> <span class="fu">lapply</span>(model_preds, <span class="cf">function</span>(x) x[, <span class="st">&quot;delisted&quot;</span>])</span>
<span id="cb122-29"><a href="empirical-results.html#cb122-29" tabindex="-1"></a>  model_preds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(model_preds)</span>
<span id="cb122-30"><a href="empirical-results.html#cb122-30" tabindex="-1"></a>  </span>
<span id="cb122-31"><a href="empirical-results.html#cb122-31" tabindex="-1"></a>  model_preds<span class="sc">$</span>ensemble <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(ensemble, <span class="at">newdata =</span> data.training, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb122-32"><a href="empirical-results.html#cb122-32" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">cor</span>(model_preds))</span>
<span id="cb122-33"><a href="empirical-results.html#cb122-33" tabindex="-1"></a>  <span class="fu">pander</span>(<span class="fu">cor</span>(model_preds), <span class="at">caption =</span> <span class="st">&quot;Correlation of prediction scores&quot;</span>)</span>
<span id="cb122-34"><a href="empirical-results.html#cb122-34" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">illustrate.metrics</span>(<span class="fu">tibble</span>(<span class="at">ensemble=</span><span class="st">&quot;ensemble&quot;</span>), data.training<span class="sc">$</span>response, model_preds<span class="sc">$</span>ensemble))</span>
<span id="cb122-35"><a href="empirical-results.html#cb122-35" tabindex="-1"></a>  </span>
<span id="cb122-36"><a href="empirical-results.html#cb122-36" tabindex="-1"></a>  pred.test <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(ensemble, <span class="at">newdata =</span> data.test, <span class="at">type=</span><span class="st">&quot;prob&quot;</span>)</span>
<span id="cb122-37"><a href="empirical-results.html#cb122-37" tabindex="-1"></a>  </span>
<span id="cb122-38"><a href="empirical-results.html#cb122-38" tabindex="-1"></a>  model_identifiers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ensemble&quot;</span>, <span class="st">&quot;randomForestSRC&quot;</span>, <span class="st">&quot;gbm&quot;</span>, <span class="st">&quot;keras&quot;</span>, <span class="st">&quot;kernlab&quot;</span>, <span class="st">&quot;glmnet&quot;</span>)</span>
<span id="cb122-39"><a href="empirical-results.html#cb122-39" tabindex="-1"></a>  model_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Ensemble&quot;</span>, <span class="st">&quot;Random Forest&quot;</span>, <span class="st">&quot;Gradient boosting&quot;</span>, <span class="st">&quot;Neural net&quot;</span>, <span class="st">&quot;SVM&quot;</span>, <span class="st">&quot;Logistic regression&quot;</span>)</span>
<span id="cb122-40"><a href="empirical-results.html#cb122-40" tabindex="-1"></a></span>
<span id="cb122-41"><a href="empirical-results.html#cb122-41" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">1</span>) { <span class="co"># MCCF1 threshold</span></span>
<span id="cb122-42"><a href="empirical-results.html#cb122-42" tabindex="-1"></a>    ensemble.cutpoint.mccf1 <span class="ot">&lt;-</span> <span class="fu">compute.mccf1cutpoint</span>(model_preds<span class="sc">$</span>ensemble, data.training<span class="sc">$</span>response)<span class="sc">$</span>best_cutpoint</span>
<span id="cb122-43"><a href="empirical-results.html#cb122-43" tabindex="-1"></a>    ensemble.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(ensemble.summary.test, <span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test <span class="sc">&gt;=</span> ensemble.cutpoint.mccf1))</span>
<span id="cb122-44"><a href="empirical-results.html#cb122-44" tabindex="-1"></a>    <span class="co"># MCCF1 curve</span></span>
<span id="cb122-45"><a href="empirical-results.html#cb122-45" tabindex="-1"></a>    plot.mccf1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> f1, <span class="at">y =</span> mcc.nor, <span class="at">col=</span>col)) <span class="sc">+</span></span>
<span id="cb122-46"><a href="empirical-results.html#cb122-46" tabindex="-1"></a>            <span class="fu">labs</span>(</span>
<span id="cb122-47"><a href="empirical-results.html#cb122-47" tabindex="-1"></a>              <span class="at">title =</span> <span class="st">&quot;MCC-F1 curve&quot;</span>,</span>
<span id="cb122-48"><a href="empirical-results.html#cb122-48" tabindex="-1"></a>              <span class="at">subtitle =</span> <span class="st">&quot;Base models and ensemble model&quot;</span>,</span>
<span id="cb122-49"><a href="empirical-results.html#cb122-49" tabindex="-1"></a>              <span class="at">x =</span> <span class="st">&quot;F1 score&quot;</span>,</span>
<span id="cb122-50"><a href="empirical-results.html#cb122-50" tabindex="-1"></a>              <span class="at">y =</span> <span class="st">&quot;unit-normalized MCC&quot;</span></span>
<span id="cb122-51"><a href="empirical-results.html#cb122-51" tabindex="-1"></a>            )</span>
<span id="cb122-52"><a href="empirical-results.html#cb122-52" tabindex="-1"></a></span>
<span id="cb122-53"><a href="empirical-results.html#cb122-53" tabindex="-1"></a>    <span class="cf">for</span> (model <span class="cf">in</span> ensemble<span class="sc">$</span>models) {</span>
<span id="cb122-54"><a href="empirical-results.html#cb122-54" tabindex="-1"></a>      preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted</span>
<span id="cb122-55"><a href="empirical-results.html#cb122-55" tabindex="-1"></a>      mccf1.result <span class="ot">&lt;-</span> <span class="fu">mccf1</span>(preds, data.test<span class="sc">$</span>response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>)</span>
<span id="cb122-56"><a href="empirical-results.html#cb122-56" tabindex="-1"></a>      plot.mccf1 <span class="ot">&lt;-</span> plot.mccf1 <span class="sc">+</span></span>
<span id="cb122-57"><a href="empirical-results.html#cb122-57" tabindex="-1"></a>            <span class="fu">geom_path</span>(<span class="at">data =</span> mccf1.result <span class="sc">%&gt;%</span> </span>
<span id="cb122-58"><a href="empirical-results.html#cb122-58" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">col =</span> model<span class="sc">$</span>modelInfo<span class="sc">$</span>library[<span class="dv">1</span>], <span class="at">linewidth =</span> <span class="dv">1</span>))</span>
<span id="cb122-59"><a href="empirical-results.html#cb122-59" tabindex="-1"></a>    }</span>
<span id="cb122-60"><a href="empirical-results.html#cb122-60" tabindex="-1"></a></span>
<span id="cb122-61"><a href="empirical-results.html#cb122-61" tabindex="-1"></a>    plot.mccf1 <span class="ot">&lt;-</span> plot.mccf1 <span class="sc">+</span> <span class="fu">geom_path</span>(<span class="at">data =</span> <span class="fu">mccf1</span>(pred.test, data.test<span class="sc">$</span>response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb122-62"><a href="empirical-results.html#cb122-62" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">col =</span> <span class="st">&quot;ensemble&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb122-63"><a href="empirical-results.html#cb122-63" tabindex="-1"></a>                  <span class="fu">scale_color_discrete</span>(<span class="st">&quot;&quot;</span>, <span class="at">breaks =</span> model_identifiers, <span class="at">labels =</span> model_labels)</span>
<span id="cb122-64"><a href="empirical-results.html#cb122-64" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="co"># ROC threshold</span></span>
<span id="cb122-65"><a href="empirical-results.html#cb122-65" tabindex="-1"></a>    ensemble.cutpoint.roc <span class="ot">&lt;-</span> <span class="fu">compute.roc</span>(model_preds<span class="sc">$</span>ensemble, data.training<span class="sc">$</span>response)<span class="sc">$</span>best_cutpoint</span>
<span id="cb122-66"><a href="empirical-results.html#cb122-66" tabindex="-1"></a>    ensemble.summary.test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">compute.metrics</span>(data.test<span class="sc">$</span>response, pred.test <span class="sc">&gt;=</span> ensemble.cutpoint.roc),</span>
<span id="cb122-67"><a href="empirical-results.html#cb122-67" tabindex="-1"></a>                                   ensemble.summary.test)</span>
<span id="cb122-68"><a href="empirical-results.html#cb122-68" tabindex="-1"></a>    <span class="co"># ROC curve</span></span>
<span id="cb122-69"><a href="empirical-results.html#cb122-69" tabindex="-1"></a>    plot.roc <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> CumulativeFPR, <span class="at">y =</span> CumulativeTPR, <span class="at">col=</span>col)) <span class="sc">+</span></span>
<span id="cb122-70"><a href="empirical-results.html#cb122-70" tabindex="-1"></a>        <span class="fu">labs</span>(</span>
<span id="cb122-71"><a href="empirical-results.html#cb122-71" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">&quot;ROC curve&quot;</span>,</span>
<span id="cb122-72"><a href="empirical-results.html#cb122-72" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">&quot;Base models and ensemble model&quot;</span>,</span>
<span id="cb122-73"><a href="empirical-results.html#cb122-73" tabindex="-1"></a>          <span class="at">x =</span> <span class="st">&quot;False positive rate (1 - specificity)&quot;</span>,</span>
<span id="cb122-74"><a href="empirical-results.html#cb122-74" tabindex="-1"></a>          <span class="at">y =</span> <span class="st">&quot;True positive rate&quot;</span></span>
<span id="cb122-75"><a href="empirical-results.html#cb122-75" tabindex="-1"></a>        )</span>
<span id="cb122-76"><a href="empirical-results.html#cb122-76" tabindex="-1"></a>    </span>
<span id="cb122-77"><a href="empirical-results.html#cb122-77" tabindex="-1"></a>    <span class="cf">for</span> (model <span class="cf">in</span> ensemble<span class="sc">$</span>models) {</span>
<span id="cb122-78"><a href="empirical-results.html#cb122-78" tabindex="-1"></a>      auc_roc.result <span class="ot">&lt;-</span> <span class="fu">auc_roc</span>( <span class="co"># plot data for ROC curve</span></span>
<span id="cb122-79"><a href="empirical-results.html#cb122-79" tabindex="-1"></a>        <span class="fu">predict</span>(model, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted,</span>
<span id="cb122-80"><a href="empirical-results.html#cb122-80" tabindex="-1"></a>        data.test<span class="sc">$</span>response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>,</span>
<span id="cb122-81"><a href="empirical-results.html#cb122-81" tabindex="-1"></a>        <span class="at">returnDT =</span> <span class="cn">TRUE</span>)</span>
<span id="cb122-82"><a href="empirical-results.html#cb122-82" tabindex="-1"></a>      preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data.test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)<span class="sc">$</span>delisted</span>
<span id="cb122-83"><a href="empirical-results.html#cb122-83" tabindex="-1"></a>      plot.roc <span class="ot">&lt;-</span> plot.roc <span class="sc">+</span></span>
<span id="cb122-84"><a href="empirical-results.html#cb122-84" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">as_tibble</span>(auc_roc.result) <span class="sc">%&gt;%</span> </span>
<span id="cb122-85"><a href="empirical-results.html#cb122-85" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">col =</span> model<span class="sc">$</span>modelInfo<span class="sc">$</span>library[<span class="dv">1</span>], <span class="at">linewidth =</span> <span class="dv">1</span>))</span>
<span id="cb122-86"><a href="empirical-results.html#cb122-86" tabindex="-1"></a>    }</span>
<span id="cb122-87"><a href="empirical-results.html#cb122-87" tabindex="-1"></a>    plot.roc <span class="ot">&lt;-</span> plot.roc <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">as_tibble</span>(</span>
<span id="cb122-88"><a href="empirical-results.html#cb122-88" tabindex="-1"></a>                <span class="fu">auc_roc</span>(pred.test, data.test<span class="sc">$</span>response <span class="sc">==</span> <span class="st">&quot;delisted&quot;</span>, <span class="at">returnDT =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb122-89"><a href="empirical-results.html#cb122-89" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">col =</span> <span class="st">&quot;ensemble&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb122-90"><a href="empirical-results.html#cb122-90" tabindex="-1"></a>              <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb122-91"><a href="empirical-results.html#cb122-91" tabindex="-1"></a>              <span class="fu">scale_color_discrete</span>(<span class="st">&quot;&quot;</span>, <span class="at">breaks =</span> model_identifiers, <span class="at">labels =</span> model_labels)</span>
<span id="cb122-92"><a href="empirical-results.html#cb122-92" tabindex="-1"></a>  }</span>
<span id="cb122-93"><a href="empirical-results.html#cb122-93" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## Call:
## NULL
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.2590  -0.5686  -0.4048  -0.3226   2.5184  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)   2.7275     0.2456  11.104  &lt; 2e-16 ***
## rfr          -5.6041     0.6151  -9.111  &lt; 2e-16 ***
## lr            1.7449     0.4582   3.808 0.000140 ***
## svm           0.1236     0.2730   0.453 0.650762    
## keras        -0.0266     0.1725  -0.154 0.877474    
## boosting     -1.8881     0.5547  -3.404 0.000664 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4786.3  on 4888  degrees of freedom
## Residual deviance: 3887.6  on 4883  degrees of freedom
## AIC: 3899.6
## 
## Number of Fisher Scoring iterations: 5
## 
##                  2.5 %     97.5 %
## (Intercept)  2.2464980  3.2097172
## rfr         -6.8120815 -4.3999826
## lr           0.8529504  2.6495669
## svm         -0.4078428  0.6633009
## keras       -0.3628714  0.3135745
## boosting    -2.9813809 -0.8061725
## 208/208 - 0s - 363ms/epoch - 2ms/step
## 208/208 - 0s - 283ms/epoch - 1ms/step
##                rfr        lr       svm     keras  boosting  ensemble
## rfr      1.0000000 0.6655141 0.5800887 0.6836591 0.9219664 0.9603817
## lr       0.6655141 1.0000000 0.5307103 0.5108240 0.6829585 0.5934105
## svm      0.5800887 0.5307103 1.0000000 0.5305829 0.5914585 0.5829582
## keras    0.6836591 0.5108240 0.5305829 1.0000000 0.6386746 0.6554106
## boosting 0.9219664 0.6829585 0.5914585 0.6386746 1.0000000 0.9506085
## ensemble 0.9603817 0.5934105 0.5829582 0.6554106 0.9506085 1.0000000</code></pre>
<p><img src="_main_files/figure-html/model.ensemble.test-1.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.1865 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.ensemble.test-2.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.2179 maximizes MCCF1 metric.&quot;
## $cutpoint.roc
## [1] 0.1864974
## 
## $cutpoint.mccf1
## [1] 0.217907
## 
## 70/70 - 0s - 110ms/epoch - 2ms/step
## 70/70 - 0s - 242ms/epoch - 3ms/step
## 
## Call:
## NULL
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.2888  -0.5692  -0.4064  -0.3256   2.4980  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)   2.8708     0.2286  12.556  &lt; 2e-16 ***
## rfr          -5.3360     0.6126  -8.711  &lt; 2e-16 ***
## lr            1.3777     0.4050   3.402 0.000669 ***
## svm           0.2306     0.2623   0.879 0.379277    
## keras        -0.2404     0.1646  -1.460 0.144213    
## boosting     -1.8508     0.5567  -3.324 0.000886 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4786.3  on 4888  degrees of freedom
## Residual deviance: 3894.9  on 4883  degrees of freedom
## AIC: 3906.9
## 
## Number of Fisher Scoring iterations: 5
## 
##                  2.5 %     97.5 %
## (Intercept)  2.4238247  3.3204663
## rfr         -6.5385126 -4.1364072
## lr           0.5889190  2.1769137
## svm         -0.2798739  0.7491591
## keras       -0.5616508  0.0839334
## boosting    -2.9479473 -0.7647371
## 208/208 - 0s - 393ms/epoch - 2ms/step
## 208/208 - 0s - 347ms/epoch - 2ms/step
##                rfr        lr       svm     keras  boosting  ensemble
## rfr      1.0000000 0.6648830 0.5347826 0.7245870 0.9237242 0.9624202
## lr       0.6648830 1.0000000 0.4710980 0.5982605 0.6934042 0.6129214
## svm      0.5347826 0.4710980 1.0000000 0.5230359 0.5474162 0.5418012
## keras    0.7245870 0.5982605 0.5230359 1.0000000 0.6959119 0.7189632
## boosting 0.9237242 0.6934042 0.5474162 0.6959119 1.0000000 0.9522992
## ensemble 0.9624202 0.6129214 0.5418012 0.7189632 0.9522992 1.0000000</code></pre>
<p><img src="_main_files/figure-html/model.ensemble.test-3.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.1675 minimizes distance of ROC curve to (0,1).&quot;</code></pre>
<p><img src="_main_files/figure-html/model.ensemble.test-4.png" width="672" /></p>
<pre><code>## [1] &quot;Classification threshold 0.3036 maximizes MCCF1 metric.&quot;
## $cutpoint.roc
## [1] 0.1674565
## 
## $cutpoint.mccf1
## [1] 0.3035905
## 
## 70/70 - 0s - 142ms/epoch - 2ms/step
## 70/70 - 0s - 125ms/epoch - 2ms/step
## 70/70 - 0s - 235ms/epoch - 3ms/step</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="empirical-results.html#cb128-1" tabindex="-1"></a><span class="co"># metrics on test set using best threshold determined based on train data</span></span>
<span id="cb128-2"><a href="empirical-results.html#cb128-2" tabindex="-1"></a>ensemble.summary.test <span class="ot">&lt;-</span> ensemble.summary.test <span class="sc">%&gt;%</span></span>
<span id="cb128-3"><a href="empirical-results.html#cb128-3" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">splitting =</span> <span class="fu">c</span>(<span class="st">&quot;ROC&quot;</span>, <span class="st">&quot;MCCF1&quot;</span>), .) </span>
<span id="cb128-4"><a href="empirical-results.html#cb128-4" tabindex="-1"></a><span class="fu">pander</span>(ensemble.summary.test, <span class="at">caption =</span> <span class="st">&quot;Ensemble on test data&quot;</span>)</span></code></pre></div>
<table>
<caption>Ensemble on test data (continued below)</caption>
<colgroup>
<col width="15%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="8%" />
<col width="14%" />
<col width="15%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">splitting</th>
<th align="center">tp</th>
<th align="center">fn</th>
<th align="center">fp</th>
<th align="center">tn</th>
<th align="center">accuracy</th>
<th align="center">precision</th>
<th align="center">recall</th>
<th align="center">f1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ROC</td>
<td align="center">338</td>
<td align="center">98</td>
<td align="center">443</td>
<td align="center">1339</td>
<td align="center">0.7561</td>
<td align="center">0.4328</td>
<td align="center">0.7752</td>
<td align="center">0.5555</td>
</tr>
<tr class="even">
<td align="center">MCCF1</td>
<td align="center">293</td>
<td align="center">143</td>
<td align="center">328</td>
<td align="center">1454</td>
<td align="center">0.7876</td>
<td align="center">0.4718</td>
<td align="center">0.672</td>
<td align="center">0.5544</td>
</tr>
</tbody>
</table>
<table style="width:32%;">
<colgroup>
<col width="19%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">specificity</th>
<th align="center">mcc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.7514</td>
<td align="center">0.4382</td>
</tr>
<tr class="even">
<td align="center">0.8159</td>
<td align="center">0.4319</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="empirical-results.html#cb129-1" tabindex="-1"></a><span class="fu">ggarrange</span>(plot.roc, plot.mccf1, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb129-2"><a href="empirical-results.html#cb129-2" tabindex="-1"></a>          <span class="at">legend =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">common.legend =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/model.ensemble.test-5.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/03_model_functions.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
